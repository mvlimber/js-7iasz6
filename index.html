<!DOCTYPE html>
<html>

<head>
  <base target="_top">
  <title>MyCondos</title>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
  <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />


  <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>

  <script src="https://www.gstatic.com/firebasejs/8.2.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com//firebasejs/8.2.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.2.0/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.2.0/firebase-storage.js"></script>

  <script>
    var firebaseConfig = {
        apiKey: "AIzaSyDVT644vSE0ue8KyDy-o9YwbYPX3m0ZmSc",
        authDomain: "slimmeeigendomdb.firebaseapp.com",
        projectId: "slimmeeigendomdb",
        storageBucket: "slimmeeigendomdb.appspot.com",
        messagingSenderId: "636221237434",
        appId: "1:636221237434:web:3db507acbf4a6a1e0d7a83",
        measurementId: "G-2JL08QYJJ3"
      };
      firebase.initializeApp(firebaseConfig);
      var firestore=firebase.firestore();
      var fileStorageRef =firebase.storage().ref();
  </script>
  <style>
    .content {
      max-width: 500px;
      margin: auto;
    }
  </style>
</head>

<body>
  <center>
    <div id="loginPanel" <h6 style="font-size:36px;color:#00796b">MyCondos</h6>
      <h6 style="font-size:12px;color:black">Stay connected to your properties</h6>
      <h6 style="font-size:20px;color:black">Please login </h6>
      <div style="width:500px">
        <form class="col s12" target="_top">
          <div class="input-field col s12">
            <input id="login_email" type="email" maxlength="50" class="validate" required aria-required="true">
            <label for="login_email">Email</label>
            <span class="helper-text" data-error="please enter valid email" ></span>
          </div>
          <div class="input-field col s12">
            <input id="login_password" type="password" class="validate" required aria-required="true">
            <label for="login_password">Password</label>
          </div>
        </form>
      </div>

      <button class="btn waves-effect waves-light" type="submit" onclick="login()">Log in<i class="material-icons right">perm_identity</i></button>
      <br>
      <button class="btn-flat" onclick="showPasswordSet()">
        <font color='blue'>Forgot password? First time user?</font>
      </button>
    </div>

    <div id="setPasswordPanel" class="displayHidden">
      <h6 style="font-size:36px;color:#00796b">MyCondos</h6>
      <h6 style="font-size:12px;color:black">Stay connected to your properties</h6>
      <h6 style="font-size:20px;color:black">Please enter your email address and</h6>
      <h6 style="font-size:20px;color:black">further instructions will be sent by email.</h6>
      <div style="width:500px">
        <form class="col s12">
          <div class="input-field col s12">
            <input id="passwordSet_email" type="email" maxlength="50" class="validate" required aria-required="true">
            <label for="passwordSet_email">Email</label>
            <span class="helper-text" data-error="please enter valid email" ></span>
          </div>
        </form>
      </div>

      <button class="btn waves-effect waves-light" type="submit" onclick="passwordSet()">Submit<i class="material-icons right">send</i></button>
      <br>
    </div>
  </center>

  <div id="applicationPanel" class="displayHidden">
    <div class="col s12">
      <ul class="tabs">
        <li class="tab"><a class="active" href="#Home"><b>Home</b></a></li>
        <li class="tab"><a href="#Reports"><b>Reports</b></a></li>
        <li class="tab"><a href="#Transactions" onclick="loadTransactions()"><b>Transactions</b></a></li>
        <!--
        <li class="tab"><a href="#Meters" onclick="loadMeters()"><b>Meters</b></a></li>
        <li class="tab"><a href="#Members" onclick="loadMembers()"><b>Members</b></a></li>
        <li class="tab"><a href="#Properties" onclick="loadProperties()"><b>Properties</b></a></li>
        -->
      </ul>
    </div>

    <div id="Home" class="col s12">
        <p>Welcome  to MyCondos! Your role is Administrator. </p>
        <br>
        <h6>Annoucements</h6>
        <p> Chère / Cher Copropriétaire,
    A défaut d'une Assemblée Générale au cours de laquelle nous pouvions vous tenir au courant de la
    situation générale de notre immeuble et des travaux en cours, nous vous proposons de trouver ici touts les infos sur notre immeuble. </p>
        <table>
          <tr>
            <td>Name Co-property</td>
            <td>Azur</td>
          </tr>
          <tr>
            <td>Address</td>
            <td>Helihavenlaan 1-3, 1000, Brussels, Belgium</td>
          </tr>
        </table>
    </div>
    <!------------------------------------------------------------------------------------------------------>        
    <div id="Reports" class="col s12">
       <h6>Individual Reports</h6>
    </div>
    <!------------------------------------------------------------------------------------------------------>        
    <div id="Transactions" class="col s12">
      <h5> Financial transactions</h5>
      <table class="striped">
        <thead>
          <tr>
            <th> Name </th>
            <th> Amount</th>
            <th> Transaction Date</th>
            <th> Communication </th>
            <th> Classification</th>
          </tr>
        </thead>
        <tbody id="transactionsTable">
        </tbody>
      </table>
      <h6> <b id="totalAmounts"> </b></h6>

      <div id="modalTransactionClassify" class="modal">
        <div class="modal-content">
          <a style="float: right" class="modal-close waves-light btn-small"><i class="material-icons right">cancel</i> Cancel</a>
          <form class="col s12">
              <div class="input-field col s12 m4">
                <input id="transaction_account" type="text" readonly>
                <label for="transaction_account">Account</label>
              </div>
              <div class="input-field col s12 m8">
                <input id="transaction_name" type="text" readonly>
                <label for="transaction_name">Name</label>
              </div>
              <div class="input-field col s12 m4">
                <input id="transaction_amount" type="text" readonly>
                <label for="transaction_amount">Amount</label>
              </div>
              <div class="input-field col s12 m8">
                <input id="transaction_date" type="text" readonly>
                <label for="transaction_date">Transaction Date</label>
              </div>
              <div class="input-field col s12">
                <input id="transaction_communication" type="text" readonly>
                <label for="transaction_communication">Communication</label>
              </div>
            <h5>Enter classification</h5>
              <div class="input-field col s6">
                    <select id="transaction_classification" required required="true">
                      <option value="" disabled selected>Select the classification</option>
                      <option>61050 - NETTOYAGE</option>
                      <option>61051 - ENTRETIENT</option>
                      <option>61052 - REPARATION</option>
                    </select>
                    <label>Classification<b><font color='red'>*</font></b></label>
              </div>
          </form>
        </div>
        <div class="modal-footer">
          <button style="float: right" class="btn-small waves-light" type="submit" onclick="classifyTransaction()">Submit<i class="material-icons right">send</i></button>
          <a style="float: right" class="modal-close waves-light btn-small"><i class="material-icons right">cancel</i> Cancel</a>
        </div>
      </div>
    </div>

  </div>
  
 
 

  <script>
    function showPasswordSet() {
      document.getElementById("loginPanel").setAttribute("class","displayHidden");
      document.getElementById("setPasswordPanel").setAttribute("class","displayBlock");
    };

    function validateLoginEntries() {
      var valid= true;
      if (!document.getElementById("login_email").checkValidity()) {
        M.toast({html:"Please enter your email"});
        valid=false;
      };
      if (!document.getElementById("login_password").checkValidity()) {
        M.toast({html:"Please enter your password"});
        valid=false;
      };
      return valid;
    };

    function openApplication() {
      document.getElementById("loginPanel").setAttribute("class","displayHidden");
      document.getElementById("applicationPanel").setAttribute("class","displayBlock");
    };
    
    function login(){
      if (validateLoginEntries()) {
        var email = document.getElementById("login_email").value;
        var password = document.getElementById("login_password").value;

        var docUserRef = firestore.collection("Users").doc(email);
        docUserRef.get().then(function(user){
          if (user.exists)  {
            firebase.auth().setPersistence(firebase.auth.Auth.Persistence.SESSION)
              .then(function() {
                  firebase.auth().signInWithEmailAndPassword(email, password)
                    .then(function(user){openApplication();
                    })
                    .catch(function(error) {
                      M.toast({html:"Invalid email or password"});
                    });
              })
              .catch (function(error) {
                M.toast({html:error.message + "...authentication server not accessible"});
              });  
          }
          else {
            M.toast({html:"Unknown email: Please contact your administartor"});
          };
        });
      };
    };

    function showLogin() {
      setTimeout(function(){  
      document.getElementById("setPasswordPanel").setAttribute("class","displayHidden");
      document.getElementById("loginPanel").setAttribute("class","displayBlock"); }, 3000);
    };
    
    function validatePasswordSetEntries() {
        var valid= true;
        if (!document.getElementById("passwordSet_email").checkValidity()) {
          M.toast({html:"Please enter your email"});
          valid=false;
        };
        return valid;
    };

      
    function passwordSet(){
      if (validatePasswordSetEntries()) {
        var email = document.getElementById("passwordSet_email").value;
            firebase.auth().sendPasswordResetEmail(email).then(function() {
                M.toast({html:"Please follow instructions sent by mail"});
                showLogin();
              }).catch(function(error) {
                M.toast({html:"Unknown email: Please contact your administrator"});
              });
      };
    };
  </script>
  <!--   Application scripts starts here -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      var elems = document.querySelectorAll('select');
      var instances = M.FormSelect.init(elems);
      elems = document.querySelectorAll('.sidenav');
      instances = M.Sidenav.init(elems);    
      const options = {
        duration: 300,
        onShow: null,
        swipeable: false,
        responsiveThreshold: Infinity
      };
      const tabsContainer = document.querySelector(".tabs");
      M.Tabs.init(tabsContainer,options);
      
      elems = document.querySelectorAll('.datepicker');
      instances = M.Datepicker.init(elems);

      elems = document.querySelectorAll('.modal');
      instances = M.Modal.init(elems, {dismissible:false});
    });

    var refCoproperty = firestore.doc("CoProperties/OrncEBHp37pJYisfxf79");
    var refCopropertyFiles = fileStorageRef.child("OrncEBHp37pJYisfxf79");
    const editMode = "_edit";
        
    function emptyHTMLSet(set) {
      while(set.hasChildNodes()){
        set.removeChild(set.firstChild);
      };
    };

  </script>
  <!--   Transaction scripts start here -->
  <script>
    var totalAmount = 0;
          var transactionsTable = document.getElementById("transactionsTable");
          function loadTransaction (objectFS){
              var object = objectFS.data();
              var objectsRow= document.createElement('tr');
              
              var cellContent = document.createTextNode(object.name);
              var cell = document.createElement('td');
              var cellButtonIcon;
              cell.appendChild(cellContent);
              objectsRow.appendChild(cell);
              
              totalAmount = totalAmount + parseInt(object.amount);
              cellContent = document.createTextNode(object.amount);
              cell = document.createElement('td');
              cell.appendChild(cellContent);
              objectsRow.appendChild(cell);  
              
              cellContent = document.createTextNode(object.date);
              cell = document.createElement('td');
              cell.appendChild(cellContent);
              objectsRow.appendChild(cell); 
              
              cellContent = document.createTextNode(object.communication);
              cell = document.createElement('td');
              cell.appendChild(cellContent);
              objectsRow.appendChild(cell); 
              
              cellContent = document.createTextNode(object.classification);
              cell = document.createElement('td');
              cell.appendChild(cellContent);
              objectsRow.appendChild(cell); 

              cellContent = document.createElement('button');
              cellContent.setAttribute("data-target", "modalTransactionClassify");
              cellContent.setAttribute('class','btn-small waves-light modal-trigger');
              cellContent.setAttribute('onclick','setSelectedTransaction('+JSON.stringify(objectFS.id)+','+JSON.stringify(object)+')');
              cellButtonIcon = document.createElement('i');
              cellButtonIcon.setAttribute('class','material-icons right');
              cellButtonIcon.innerHTML="add";           
              cellContent.appendChild(cellButtonIcon);
              cellContent.innerHTML = "Classify";


              cell = document.createElement('td');
              cell.appendChild(cellContent);
              objectsRow.appendChild(cell);    
              
              transactionsTable.appendChild (objectsRow);
            };
          
        function refreshTransactions(){
          emptyHTMLSet(transactionsTable);
          totalAmount = 0;
          refCoproperty.collection("Transactions").orderBy("date","desc").get().then(function(objectsFSArray){
              objectsFSArray.forEach(function(objectFS){
                loadTransaction(objectFS);
                document.getElementById("totalAmounts").innerHTML = "Total Amounts = " + totalAmount;
              })
            });
        };

        var transactionsLoaded = false;
        function loadTransactions(){
          if (!transactionsLoaded) {
            refreshTransactions();
            transactionsLoaded = true;
          };
        };

      function classifyTransaction() {
        if (validateTransactionEntries()) {  
            refCoproperty.collection("Transactions").doc(selectedTransactionId).set(getTransactionEntries())
          .then(function(docref) {
              M.Modal.getInstance(document.getElementById("modalTransactionClassify")).close();
              refreshTransactions();
          }).catch(function(error) {
            console.error("Error writing document: ", error);
          });
        };
      };
    function validateTransactionEntries() {
      var valid = true
      if (!document.getElementById("transaction_classification").checkValidity()) {
        M.toast({html:"Please enter classification"});
        valid=false;
      };
      return valid;
    };

    function getTransactionEntries() {
      return {
        account: document.getElementById("transaction_account").value,
        name: document.getElementById("transaction_name").value,
        amount: document.getElementById("transaction_amount").value,
        date: document.getElementById("transaction_date").value,
        communication:document.getElementById("transaction_communication").value,
        classification: document.getElementById("transaction_classification").value
      };
    };

    var selectedTransactionId;
    var selectedTransactionObject;
    function setSelectedTransaction(id,object) {
      selectedTransactionId = id;
      selectedTransactionObject = object;
    
      document.getElementById("transaction_account").value=object.account;
      document.getElementById("transaction_name").value=object.name;
      document.getElementById("transaction_amount").value=object.amount;
      document.getElementById("transaction_date").value=object.date;
      document.getElementById("transaction_communication").value=object.communication;
      document.getElementById("transaction_classification").value=object.classification;
      var elems = document.querySelectorAll('select');
      M.FormSelect.init(elems);
      M.updateTextFields();
    };
  </script>
  <!--   Meter scripts start here -->
  <script>
  </script>
  <!--   Member scripts start here -->
  <script>
  </script>
  <!--   property scripts start here -->
  <script>
  </script>
</body>

</html>