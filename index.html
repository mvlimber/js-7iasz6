<!DOCTYPE html>
<html>

<head>
  <base target="_top">
  <title style:"color:#00796b bold">MyCondos</title>
  <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
  <link rel="icon"
    href="https://firebasestorage.googleapis.com/v0/b/slimmeeigendomdb.appspot.com/o/Building-32.png?alt=media&token=9754f9c3-9d56-42fc-bd61-839ce2354a95">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.98.0/css/materialize.min.css">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />


  <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
  <!--<script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.98.0/js/materialize.min.js"></script>-->

  <script src="https://www.gstatic.com/firebasejs/8.2.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com//firebasejs/8.2.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.2.0/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.2.0/firebase-storage.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.3.1/jspdf.umd.min.js"></script>

  <script>
    var firebaseConfig = {
        apiKey: "AIzaSyDVT644vSE0ue8KyDy-o9YwbYPX3m0ZmSc",
        authDomain: "slimmeeigendomdb.firebaseapp.com",
        projectId: "slimmeeigendomdb",
        storageBucket: "slimmeeigendomdb.appspot.com",
        messagingSenderId: "636221237434",
        appId: "1:636221237434:web:3db507acbf4a6a1e0d7a83",
        measurementId: "G-2JL08QYJJ3"
      };
      firebase.initializeApp(firebaseConfig);
      var firestore=firebase.firestore();
      var fileStorageRef =firebase.storage().ref();
  </script>
  <style>
    .content {
      max-width: 500px;
      margin: auto;
    }
  </style>

</head>

<body>
  <center>
    <div id="loginPanel" <h6 style="font-size:36px;color:#00796b">MyCondos</h6>
      <h6 style="font-size:12px;color:black">Stay connected to your properties</h6>
      <h6 style="font-size:20px;color:black">Please login </h6>
      <div style="width:500px">
        <form class="col s12" target="_top">
          <div class="input-field col s12">
            <input id="login_email" type="email" maxlength="50" class="validate" required aria-required="true">
            <label for="login_email">Email</label>
            <span class="helper-text" data-error="please enter valid email" ></span>
          </div>
          <div class="input-field col s12">
            <input id="login_password" type="password" class="validate" required aria-required="true">
            <label for="login_password">Password</label>
          </div>
        </form>
      </div>

      <button class="btn waves-effect waves-light" type="submit" onclick="login()">Log in<i class="material-icons right">perm_identity</i></button>
      <br>
      <button class="btn-flat" onclick="showPasswordReset()">
        <font color='blue'>Forgot password? </font>
      </button>
      <br>
      <button class="btn-flat" onclick="showPasswordSet()">
        <font color='blue'>First time user?</font>
      </button>
    </div>

    <div id="setPasswordPanel" class="displayHidden">
      <h6 style="font-size:36px;color:#00796b">MyCondos</h6>
      <h6 style="font-size:12px;color:black">Stay connected to your properties</h6>
      <h6 style="font-size:20px;color:black">Create password</h6>
      <div style="width:500px">
        <form class="col s12">
          <div class="input-field col s12">
            <input id="passwordSet_email" type="email" maxlength="50" class="validate" required aria-required="true">
            <label for="passwordSet_email">Email</label>
            <span class="helper-text" data-error="please enter valid email" ></span>
          </div>
        </form>
      </div>
      <h6 style="font-size:16px;color:black">An email will be sent to the above address</h6>
      <h6 style="font-size:16px;color:black">with a link to set your password.</h6>
      <br>
      <h6 style="font-size:16px;color:black">Note that your administrator should yet </h6>
      <h6 style="font-size:16px;color:black">have entered your email address.</h6>
      <br>
      <button class="btn waves-effect waves-light" type="submit" onclick="passwordSet()">Submit<i class="material-icons right">send</i></button>
      <br><br>
      <button class="btn-flat" onclick="backToLoginFromSetPW()">
        <font color='blue'>Back to Login</font>
      </button>
    </div>

    <div id="resetPasswordPanel" class="displayHidden">
      <h6 style="font-size:36px;color:#00796b">MyCondos</h6>
      <h6 style="font-size:12px;color:black">Stay connected to your properties</h6>
      <h6 style="font-size:20px;color:black">Reset password</h6>
      <div style="width:500px">
        <form class="col s12">
          <div class="input-field col s12">
            <input id="passwordReset_email" type="email" maxlength="50" class="validate" required aria-required="true">
            <label for="passwordReset_email">Email</label>
            <span class="helper-text" data-error="please enter valid email" ></span>
          </div>
        </form>
      </div>
      <h6 style="font-size:16px;color:black">An email will be sent to the above address</h6>
      <h6 style="font-size:16px;color:black">with a link to set your new password.</h6>
      <br>
      <button class="btn waves-effect waves-light" type="submit" onclick="passwordReset()">Submit<i class="material-icons right">send</i></button>
      <br><br>
      <button class="btn-flat" onclick="backToLoginFromResetPW()">
        <font color='blue'>Back to Login</font>
      </button>
    </div>
  </center>

  <div id="applicationPanel" class="displayHidden">
    <header>
      <nav id="header" class="nav-fixed teal lighten-1">
        <div class="nav-wrapper container center-align">
          <a href="javascript:void(0)" class="brand-logo right right-align" id="logo-container"
            style="font-size:24px">MyCondos: Home</a>
          <a href="#" data-target="slide-out" class="btn-collapsible sidenav-trigger left left-align"
            onclick="showMenu()"><i class="material-icons">menu</i></a>
        </div>
      </nav>
      <ul class="side-nav fixed tabs collapsible" id="slide-out">
        <li>
          <div class="userView">
            <div class="background">
              <img style="width:100%" src="https://img1.goodfon.com/wallpaper/big/6/d8/android-material-fon-linii.jpg">
            </div>
            <img width="150" height="100"" class="center" src="https://firebasestorage.googleapis.com/v0/b/slimmeeigendomdb.appspot.com/o/Azur_small.gif?alt=media&token=289506e5-49da-435a-877d-bd00757f3aac">
            <span class="white-text name" style="font-size:18px">Condomynium: Azur</span>
          </div>
        </li>
        <li id="homeTab" class="tab side text-teal"><a class=" active waves-effect" href="#Home" style="font-size:22px"
            onclick="loadHome()">Home</a>
        </li>
        <li class="tab side text-teal"><a class="waves-effect" href="#Reports" style="font-size:22px"
            onclick="loadReports()">Reports</a></li>
        <li class="tab side text-teal"><a class="waves-effect" href="#Transactions" style="font-size:22px"
            onclick="loadTransactions()">Transactions</a></li>
        <li id="tabTransactionRules" style="display:none" class="tab side text-teal"><a class="waves-effect" href="#TransactionRules" style="font-size:22px"
              onclick="loadTransactionRules()">Transaction Rules</a></li>
        <li class="tab side text-teal"><a class="waves-effect" href="#MeterReadings" style="font-size:22px"
            onclick="loadMeterReadings()">Meter Readings</a></li>
        <li class="tab side text-teal"><a class="waves-effect" href="#Members" style="font-size:22px"
            onclick="loadMembers()">Members</a></li>
        <li class="tab side text-teal"><a class="waves-effect" href="#Properties" style="font-size:22px"
            onclick="loadProperties()">Properties</a></li>
        <li id="tabSettings" style="display:none" class="tab side text-teal"><a class="waves-effect" href="#Settings"
            style="font-size:22px" onclick="loadSettings()">Settings</a></li>
      </ul>

      <script>
        function showMenu(){
          var el = document.getElementById("slide-out");
          M.Sidenav.init(el);
          var instance = M.Sidenav.getInstance(el);
          instance.open();
        };
        function hideMenu(){
          var el = document.getElementById("slide-out");
          M.Sidenav.init(el);
          var instance = M.Sidenav.getInstance(el);
          instance.close();
        };
        var elemshier = document.querySelectorAll('.sidenav');
        var instanceshier = M.Sidenav.init(elemshier);

        var collapsibleElemhier = document.querySelector('.collapsible');
        var collapsibleInstancehier = M.Collapsible.init(collapsibleElemhier);
        
        const tabsContainer = document.querySelector(".tabs");
        M.Tabs.init(tabsContainer);
        var instance = M.Tabs.getInstance(document.getElementById("slide-out"));
        instance.select("#Home");
      </script>
    </header>
    <main>
      <div class="row">
        <div id="Home" class="col s12">
          <h6 style="font-size:20px "><b>Announcements</b></h6>
          <br>
          <ul class="collapsible">
            <li>
              <div class="collapsible-header"><i class="material-icons">account_balance</i>Assemblée Générale Update Apr
                2, 2020</div>
              <div class="collapsible-body"><span>Chère / Cher Copropriétaire,
            A défaut d'une Assemblée Générale au cours de laquelle nous pouvions vous tenir au courant de la
            situation générale de notre immeuble et des travaux en cours, nous vous proposons de trouver ici touts les
            infos sur notre immeuble.</span></div>
            </li>
            <li>
              <div class="collapsible-header"><i class="material-icons">build</i>Travaux Update Mar 29, 2020</div>
              <div class="collapsible-body">
                <span>Chère / Cher Copropriétaire,
            Le réamenagement du jardin démarrera le mois de Mai. Veuillez nous excuser pour des éventuels inconvénients ayant la vision de retrouver après un jardin bien plus joli.</span>
              </div>
            </li>
          </ul>
          <br>
          <h6 style="font-size:20px "><b>Condomynium</b></h6>
          <div class="row">
            <div class="col s12 m6">
              <table>
                <tr>
                  <td>Name</td>
                  <td id="Home_CopropertyName"></td>
                </tr>
                <tr>
                  <td>Address</td>
                  <td id="Home_CopropertyAddress"></td>
                </tr>
                <tr>
                  <td>Administrator</td>
                  <td>Marc Van Limberghen</td>
                </tr>
              </table>
            </div>
            <div class="col s12 m6">
              <img width="300" height="175"" class="center" src="https://firebasestorage.googleapis.com/v0/b/slimmeeigendomdb.appspot.com/o/Azur_small.gif?alt=media&token=289506e5-49da-435a-877d-bd00757f3aac">
            </div>
          </div>
        </div>
        <!------------------------------------------------------------------------------------------------------>
        <div id="Reports" class="col s12">
          <div id="reportRemove" class="modal">
            <div class="modal-content">
              <h5> You are about to permanently remove the report</h5>
              <p id="report_to_remove"> </p>
            </div>
            <div class="modal-footer">
              <button style="float: right;margin-left: 20px" class="btn-small waves-light" type="submit" onclick="removeReport(report_to_remove)">Confirm<i class="material-icons right">send</i></button>
              <a style="float: right"
                class="modal-close waves-light btn-small"><i class="material-icons right">cancel</i>
                Cancel</a>
            </div>
          </div>
          <div id="reportAdd" class="modal">
            <div class="modal-content">
              <a style="float: right"
                class="modal-close waves-light btn-small"><i class="material-icons right">cancel</i>
                Cancel</a>
              <h5> New Report</h5>
              <div class="row">
                <form>
                  <div class="input-field" id="report_file_edit">
                  </div>
                  <div class="file-field input-field col s12 m6">
                    <div class="btn-small">
                      <span>PDF Document<b><font color='red'>*</font></b><i class="material-icons right">attach_file</i></span>
                      <input type="file" id="reportFile">
                    </div>
                    <div class="file-path-wrapper">
                      <input class="file-path validate" type="text" id="reportFileText">
                    </div>
                  </div>
                </form>
                <form>
                  <div class="input-field col s12 m6">
                    <input id="report_type_edit" type="text" required required="true" maxlength="50">
                    <label for="report_type_edit">Type<b><font color='red'>*</font></b></label>
                    <span class="helper-text" data-error="maximum 50 characters" ></span>
                  </div>
                </form>
              </div>
            </div>
            <div class="modal-footer">
              <button style="float: right;margin-left: 20px" class="btn-small waves-light" type="submit" onclick="writeReport()">Submit<i class="material-icons right">send</i></button>
              <a style="float: right"
                class="modal-close waves-light btn-small"><i class="material-icons right">cancel</i>
                Cancel</a>
            </div>
          </div>
          <div id="chargesReportAdd" class="modal">
            <div class="modal-content">
              <a style="float: right"
                class="modal-close waves-light btn-small"><i class="material-icons right">cancel</i>
                Cancel</a>
              <h5>Generate new charges report</h5>
              <div class="row">
                <form>
                  <div class="input-field col s12 m6">
                    <input id="chargesReport_closeDate" type="date" required required="true">
                    <label for="chargesReport_closeDate">Accountancy close date<b><font color='red'>*</font></b></label>
                  </div>
                  <div class="input-field col s12 m6">
                    <select id="chargesReport_metersIncluded" required aria-required="true">
                    <option value="" disabled selected>Indicate if meter readings should be included</option>
                    <option>Yes</option>
                    <option>No</option>
                    </select>
                    <label>Include Meter Readings<b><font color='red'>*</font></b></label>
                  </div>
                </form>
              </div>
            </div>
            <div class="modal-footer">
              <h6 style="float: right;margin-left: 20px">Generating the report might take a few seconds. Please confirm
                the generated report after review</h6>
              <br><br>
              <button style="float: right;margin-left: 20px" class="btn-small waves-light" type="submit" onclick="prepareChargesReport()">Submit<i class="material-icons right">send</i></button>
              <a style="float: right"
                class="modal-close waves-light btn-small"><i class="material-icons right">cancel</i>
                Cancel</a>
            </div>
          </div>
          <h6 style="font-size:20px "><b>Charges reports generated by the application</b></h6>
          <table class="striped">
            <thead>
              <tr>
                <th>Period</th>
                <th>Meter readings included?</th>
              </tr>
            </thead>
            <tbody id="chargesReportsTable">
            </tbody>

          </table>
          <br>
          <div id="Reports_Generate" class="displayHidden">
            <button id="ChargesReport_Generate" style="float: right" data-target="chargesReportAdd" class="btn-small waves-light modal-trigger" onclick="emptyFieldsChargesReportAdd()"><i class="material-icons right">add</i>Generate New Charges Report</button>
          </div>
          <br><br>
          <h6 style="font-size:20px "><b>Reports uploaded by users</b></h6>
          <table class="striped">
            <thead>
              <tr>
                <th> File name </th>
                <th> Document Type</th>
                <th> Upload Date </th>
              </tr>
            </thead>
            <tbody id="reportsTable">
            </tbody>
          </table>
          <br>
          <div id="Reports_Add" class="displayHidden">
            <button style="float: right" data-target="reportAdd" class="btn-small waves-light modal-trigger" onclick="emptyReportFields()"><i class="material-icons right">add</i>New Report</button>
          </div>
        </div>
        <!------------------------------------------------------------------------------------------------------>
        <div id="Transactions" class="col s12">
          <table class="striped">
            <thead>
              <tr>
                <th>Type</th>
                <th>Counterparty</th>
                <th>
                  <p style="text-align: right">Amount</p>
                </th>
                <th>
                  <p style="text-align: right">Date</p>
                </th>
                <th>
                  <p style="writing-mode: vertical-rl">Evidence?</p>
                </th>
              </tr>
            </thead>
            <tbody id="transactionsTable">
            </tbody>
          </table>
          <div class="displayHidden" <h6> <b>Total amount is </b><b id="totalAmount"></b></h6>
          </div>
          <br>
          <div id="Transactions_Add" class="displayHidden">
            <button style="float: right" data-target="transactionAdd" class="btn-small waves-light modal-trigger" onclick="resetSelectedTransaction()"><i class="material-icons right">add</i>New transaction</button>
            <br><br>
            <button style="float: right" data-target="transactionLoad" class="btn-small waves-light modal-trigger" onclick="emptyTransactionLoadFields()"><i class="material-icons right">add</i>Load transactions</button>
          </div>
          <div id="transactionAdd" class="modal">
            <div class="modal-content">
              <a style="float: right"
                class="modal-close waves-light btn-small"><i class="material-icons right">cancel</i>
                Cancel</a>
              <h5>Enter transaction data</h5>
              <form>
                <div class="input-field col s12 m4">
                  <select id="transaction_type_add" required required="true" onchange="enableSelectProperties()"></select>
                  <label>Type<b><font color='red'>*</font></b></label>
                </div>
                <div class="input-field col s12 m4">
                  <select id="transaction_costCenter_add" required required="true"></select>
                  <label>Cost Center<b><font color='red'>*</font></b></label>
                </div>
                <div class="input-field col s12 m4">
                  <input id="transaction_name_add" type="text" class="validate" maxlength="50" required required="true">
                  <label for="transaction_name_add">Counterparty<b><font color='red'>*</font></b></label>
                  <span class="helper-text" data-error="Maximum 50 characters"></span>
                </div>
                <div class="input-field col s12 m4">
                  <input id="transaction_account_add" type="text" maxlength="19" class="validate"
                    pattern="^BE\d{14}$|^BE\d{2}\s\d{4}\s\d{4}\s\d{4}$">
                  <label for="transaction_account_add">Account</label>
                  <span class="helper-text" data-error="BE followed by 14 digits, blancs for printing format allowed. Example: BE40 9799 2578 3625">BE followed by max 14 digits, blancs allowed. Example: BE40 9799 2578 3625</span>
                </div>
                <div class="input-field col s12 m8">
                  <input id="transaction_communication_add" type="text" class="validate" maxlength="80" >
                  <label for="transaction_communication_add">Communication</label>
                  <span class="helper-text" data-error="Maximum 80 characters"></span>
                </div>
                <div class="input-field col s12 m4">
                  <input id="transaction_amount_add" type="number" class="validate" min="-999999" max="999999" step="0.01" required required="true">
                  <label for="transaction_amount_add">Amount<b><font color='red'>*</font></b></label>
                  <span class="helper-text" data-error="Positive or negative amount below 1 Million. Example: -10234.56">Positive or negative amount. Example: -1234.56"</span>
                </div>
                <div class="input-field col s12 m4">
                  <input id="transaction_date_add" type="text" class="datepicker validate"  required required="true" onchange="copyToBookDate()">
                  <label for="transaction_date_add">Transaction Date<b><font color='red'>*</font></b></label>
                  <span class="helper-text" data-error="Required field"></span>
                </div>
                <div class="input-field col s12 m4">
                  <input id="transaction_bookDate_add" type="text" class="datepicker validate"  required required="true">
                  <label for="transaction_bookDate_add">Accountancy Date<b><font color='red'>*</font></b></label>
                  <span class="helper-text" data-error="Required field">By default copied from Transaction Date</span>
                </div>
                <div id="transaction_properties_add_frame" style="display:none">
                  <h5>For private transactions: please assign amount to properties</h5>
                  <div class="input-field col s12 m4">
                    <select id="transaction_properties_add">
                    </select>
                    <label>Property<b><font color='red'>*</font></b></label>
                  </div>
                  <div class="input-field col s12 m4">
                    <input id="transaction_distribution_amount_add" type="number" class="validate" min="-999999" max="999999" step="0.01" required required="true">
                    <label for="transaction_distribution_amount_add">Amount<b><font color='red'>*</font></b></label>
                    <span class="helper-text" data-error="Positive or negative amount below 1 Million. Example: -10234.56">Positive or negative amount. Example: -1234.56"</span>
                  </div>
                  <button style="float: left;margin-left: 20px;margin-bottom: 3px" class="btn-small waves-light" type="button" onclick="addTransactionDistribution()"><i class="material-icons right">add</i>Assign amount to property</button>
                  <br>
                  <table class="striped">
                    <thead>
                      <tr>
                        <th>Property</th>
                        <th>Amount</th>
                      </tr>
                    </thead>
                    <tbody id="transaction_distribution_table_add">
                    </tbody>
                  </table>
                </div>

              </form>
              <br>
              <button id="transaction_save_button" style="float: right;margin-left: 20px;margin-bottom: 3px" class="btn-small waves-light" type="submit" onclick="writeTransaction()">Save and go to adding evidence<i class="material-icons right">send</i></button>
              <a style="float: right;margin-bottom: 3px"
                class="modal-close waves-light btn-small"><i class="material-icons right">cancel</i>
                Cancel</a>
            </div>
          </div>

          <div id="transactionLoad" class="modal">
            <div class="modal-content">
              <a style="float: right"
                class="modal-close waves-light btn-small"><i class="material-icons right">cancel</i>
                Cancel</a>
              <h5> Load file with transactions</h5>
              <div class="row">
                <form>
                  <div class="input-field" id="transactionLoad_file_edit">
                  </div>
                  <div class="file-field input-field col s12 m6">
                    <div class="btn-small">
                      <span>CSV File<b><font color='red'>*</font></b><i class="material-icons right">attach_file</i></span>
                      <input type="file" id="transactionLoadFile">
                    </div>
                    <div class="file-path-wrapper">
                      <input class="file-path validate" type="text" id="transactionLoadFileText">
                    </div>
                  </div>
                </form>
              </div>
            </div>
            <div class="modal-footer">
              <button style="float: right;margin-left: 20px" class="btn-small waves-light" type="submit" onclick="loadTransactionsFile()">Load<i class="material-icons right">send</i></button>
              <a style="float: right"
                class="modal-close waves-light btn-small"><i class="material-icons right">cancel</i>
                Cancel</a>
            </div>
          </div>

          <div id="transactionLoadConfirm" class="modal">
            <div class="modal-content">
              <a style="float: right"
                class="modal-close waves-light btn-small"><i class="material-icons right">cancel</i>
                Cancel</a>
              <h5>Please review and confirm all these transactions to be uploaded</h5>
              <table class="striped">
                <thead>
                  <tr>
                    <th>Type</th>
                    <th>Counterparty</th>
                    <th>Amount</th>
                    <th>Date</th>
                    <th>Account</th>
                    <th>Communication</th>
                  </tr>
                </thead>
                <tbody id="transactionsLoadConfirmTable">
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
              <button style="float: right;margin-left: 20px" class="btn-small waves-light" type="submit" onclick="writeTransactionsFile()">Confirm<i class="material-icons right">send</i></button>
              <a style="float: right"
                class="modal-close waves-light btn-small"><i class="material-icons right">cancel</i>
                Cancel</a>
            </div>
          </div>

          <div id="transactionView" class="modal">
            <div class="modal-content">
              <a style="float: right"
                class="modal-close waves-light btn-small"><i class="material-icons right">cancel</i>
                Close</a>
              <h5> View Transaction</h5>
              <div class="w3-panel w3-border" style="box-shadow: 5px 10px 8px #888888">
                <form class="col s12">
                  <div class="input-field col s12 m4">
                    <input id="transaction_type" type="text" readonly>
                    <label for="transaction_type">type</label>
                  </div>
                  <div class="input-field col s12 m4">
                    <input id="transaction_costCenter" type="text" readonly>
                    <label for="transaction_type">cost center</label>
                  </div>
                  <div class="input-field col s12 m4">
                    <input id="transaction_name" type="text" readonly>
                    <label for="transaction_name">Counterparty</label>
                  </div>
                  <div class="input-field col s12 m4">
                    <input id="transaction_account" type="text" readonly>
                    <label for="transaction_account">Account</label>
                  </div>
                  <div class="input-field col s12 m8">
                    <input id="transaction_communication" type="text" readonly>
                    <label for="transaction_communication">Communication</label>
                  </div>
                  <div class="input-field col s12 m4">
                    <input id="transaction_amount" type="text" readonly>
                    <label for="transaction_amount">Amount</label>
                  </div>
                  <div class="input-field col s12 m4">
                    <input id="transaction_date" type="text" readonly>
                    <label for="transaction_date">Transaction Date</label>
                  </div>
                  <div class="input-field col s12 m4">
                    <input id="transaction_bookDate" type="text" readonly>
                    <label for="transaction_bookDate">Accountancy Date</label>
                  </div>
                  <div id="transaction_properties_frame" style="display:none">
                    <h6><b>Private transaction: Amount assigned to:</b></h6>
                    <table class="striped">
                      <thead>
                        <tr>
                          <th>Property</th>
                          <th>Amount</th>
                        </tr>
                      </thead>
                      <tbody id="transaction_distribution_table">
                      </tbody>
                    </table>
                  </div>
                </form>
                <div id="Transactions_Edit" class="displayHidden">
                  <button id="transaction_edit_button" style="float: right;margin-bottom: 3px" data-target="transactionAdd" class="btn-small waves-light modal-trigger" onclick="editTransaction(selectedTransactionId, transaction)">Edit<i class="material-icons right">edit</i></button>
                </div>
              </div>
              <div class="w3-panel w3-border" style="box-shadow: 5px 10px 8px #888888">
                <h6 style="font-size:20px ">Transaction Evidence</h6>
                <table class="striped">
                  <thead>
                    <tr>
                      <th> File name</th>
                      <th> Document Type</th>
                    </tr>
                  </thead>
                  <tbody id="transactionEvidenceTable">
                  </tbody>
                </table>
                <br>
                <div id="Transactions_EvidenceAdd" class="displayHidden">
                  <button style="float: right;margin-bottom: 3px" data-target="transactionEvidenceAdd" class="btn-small waves-light modal-trigger" onclick="emptyTransactionEvidenceFields()"><i class="material-icons right">add</i>New Evidence</button>
                </div>
              </div>
              <a style="float: right;margin-bottom: 3px"
                class="modal-close waves-light btn-small"><i class="material-icons right">cancel</i>
                Close</a>
            </div>
          </div>

          <div id="transactionEvidenceRemove" class="modal">
            <div class="modal-content">
              <h5> You are about to permanently remove the evidence</h5>
              <p id="transactionEvidence_to_remove"> </p>
            </div>
            <div class="modal-footer">
              <button style="float: right;margin-left: 20px" class="btn-small waves-light" type="submit" onclick="removeTransactionEvidence(transactionEvidence_to_remove)">Confirm<i class="material-icons right">send</i></button>
              <a style="float: right"
                class="modal-close waves-light btn-small"><i class="material-icons right">cancel</i>
                Cancel</a>
            </div>
          </div>
          <div id="transactionEvidenceAdd" class="modal">
            <div class="modal-content">
              <a style="float: right"
                class="modal-close waves-light btn-small"><i class="material-icons right">cancel</i>
                Cancel</a>
              <h5> New Transaction Evidence</h5>
              <div class="row">
                <form>
                  <div class="input-field" id="transactionEvidence_file_edit">
                  </div>
                  <div class="file-field input-field col s12 m6">
                    <div class="btn-small">
                      <span>PDF Document<b><font color='red'>*</font></b><i class="material-icons right">attach_file</i></span>
                      <input type="file" id="transactionEvidenceFile">
                    </div>
                    <div class="file-path-wrapper">
                      <input class="file-path validate" type="text" id="transactionEvidenceFileText">
                    </div>
                  </div>
                </form>
                <form>
                  <div class="input-field col s12 m6">
                    <input id="transactionEvidence_type_edit" type="text" required required="true" maxlength="50">
                    <label for="transactionEvidence_type_edit">Type<b><font color='red'>*</font></b></label>
                    <span class="helper-text" data-error="maximum 50 characters" ></span>
                  </div>
                </form>
              </div>
            </div>
            <div class="modal-footer">
              <button style="float: right;margin-left: 20px" class="btn-small waves-light" type="submit" onclick="writeTransactionEvidence()">Submit<i class="material-icons right">send</i></button>
              <a style="float: right"
                class="modal-close waves-light btn-small"><i class="material-icons right">cancel</i>
                Cancel</a>
            </div>
          </div>

        </div>
        <!------------------------------------------------------------------------------------------------------>
        <div id="TransactionRules" class="col s12">
          <table class="striped">
            <thead>
              <tr>
                <th>If:Account</th>
                <th>If:Communication</th>
                <th>Then:Type</th>
                <th>Then:Owner</th>
              </tr>
            </thead>
            <tbody id="transactionRulesTable">
            </tbody>
          </table>
          <button style="float: right" data-target="transactionRuleEdit" class="btn-small waves-light modal-trigger" onclick="resetSelectedTransactionRule()"><i class="material-icons right">add</i>New transaction rule</button>
          <div id="transactionRuleEdit" class="modal">
            <div class="modal-content">
              <a style="float: right"
                class="modal-close waves-light btn-small"><i class="material-icons right">cancel</i>
                Cancel</a>
              <h5>Enter transaction rule data</h5>
              <form>
                <div class="input-field col s12 m4">
                  <input id="transactionRule_account" type="text" maxlength="19" class="validate"
                    pattern="^BE\d{14}$|^BE\d{2}\s\d{4}\s\d{4}\s\d{4}$" required required="true">
                  <label for="transactionRule_account">If:Account<b><font color='red'>*</font></b></label>
                  <span class="helper-text" data-error="BE followed by 14 digits, blancs for printing format allowed. Example: BE40 9799 2578 3625">BE followed by max 14 digits, blancs allowed. Example: BE40 9799 2578 3625</span>
                </div>
                <div class="input-field col s12 m8">
                  <input id="transactionRule_name" type="text" class="validate" maxlength="50">
                  <label for="transactionRule_name">Info:Counterpart</label>
                  <span class="helper-text" data-error="Maximum 50 characters"></span>
                </div>
                <div class="input-field col s12 m12">
                  <input id="transactionRule_communication" type="text" class="validate" maxlength="80" >
                  <label for="transactionRule_communication">If:Communication</label>
                  <span class="helper-text" data-error="Maximum 80 characters"></span>
                </div>
                <div class="input-field col s12 m4">
                  <select id="transactionRule_type" required required="true"></select>
                  <label>Then:Type<b><font color='red'>*</font></b></label>
                </div>
                <div class="input-field col s12 m4">
                  <select id="transactionRule_costCenter" required required="true"></select>
                  <label>Cost Center<b><font color='red'>*</font></b></label>
                </div>
                <div class="input-field col s12 m4">
                  <select id="transactionRule_owner" >
                    <option value="" disabled selected>Select Owner</option>
                  </select>
                  <label for="transactionRule__owner">Then:Owner</label>
                </div>
                
              </form>
              <br>
              <button style="float: right;margin-left: 20px;margin-bottom: 3px" class="btn-small waves-light" type="submit" onclick="writeTransactionRule()">Save<i class="material-icons right">send</i></button>
              <a style="float: right;margin-left: 20px;margin-bottom: 3px"
                class="modal-close waves-light btn-small"><i class="material-icons right">cancel</i>
                Cancel</a>
              <button id="transactionRuleDeleteButton" style="float: right;margin-left: 20px;margin-bottom: 3px;display:block" data-target="transactionRuleRemove" class="btn-small waves-light red modal-trigger">Delete<i class="material-icons right">delete</i></button>
            </div>
          </div>
          <div id="transactionRuleRemove" class="modal">
          <div class="modal-content">
            <h5> Please confirm you want to permanently remove this transaction rule</h5>
          </div>
          <div class="modal-footer">
            <button style="float: right;margin-left: 20px" class="modal-close btn-small waves-light" type="submit" onclick="deleteTransactionRule()">Confirm<i class="material-icons right">send</i></button>
            <a style="float: right"
              class="modal-close waves-light btn-small"><i class="material-icons right">cancel</i>
              Cancel</a>
          </div>
          </div>  
        </div>
        <!------------------------------------------------------------------------------------------------------>

        <div id="MeterReadings" class="col s12">
          <table class="striped">
            <thead>
              <tr>
                <th align=center>Type</th>
                <th align=center>
                  <p style="writing-mode: vertical-rl">Property</p>
                </th>
                <th align=center>
                  <p style="writing-mode: vertical-rl">Reading?</p>
                </th>
                <th align=center>
                  <p style="writing-mode: vertical-rl">Picture?</p>
                </th>
                <th align=center>Date</th>
              </tr>
            </thead>
            <tbody id="meterReadingsTable">
            </tbody>
          </table>

          <div id="pictureRemove" class="modal">
            <div class="modal-content">
              <h5> You are about to remove the meter reading picture</h5>
            </div>
            <div class="modal-footer">
              <button style="float: right;margin-left: 20px" class="btn-small waves-light" type="submit" onclick="removePicture()">Confirm<i class="material-icons right">send</i></button>
              <a style="float: right"
                class="modal-close waves-light btn-small"><i class="material-icons right">cancel</i>
                Cancel</a>
            </div>
          </div>

          <div id="meterReadingWrite" class="modal">
            <div class="modal-content">
              <a style="float: right"
                class="modal-close waves-light btn-small"><i class="material-icons right">cancel</i> Close</a>
              <h5>Meter info</h5>
              <form>
                <div class="input-field col s12 m6">
                  <input id="meterReading_property_edit" type="text" readonly>
                  <label for="meterReading_property_edit">Property</label>
                </div>
                <div class="input-field col s12 m6">
                  <input id="meterReading_type_edit" type="text" readonly>
                  <label for="meterReading_type_edit">Type</label>
                </div>
                <div class="input-field col s12 m6">
                  <input id="meterReading_id_edit" type="text" readonly>
                  <label for="meterReading_id_edit">ID Meter</label>
                </div>
                <div class="input-field col s12 m6">
                  <input id="meterReading_lastReading_edit" type="text" readonly>
                  <label for="meterReading_lastReading_edit">Last Reading</label>
                </div>
              </form>
              <h6><b>Please enter Meter Reading here below:</b></h6>
              <div class="row">
                <form>
                  <div class="input-field col s12 m6">
                    <div class="input-field">
                      <input id="meterReading_reading_edit" type="number" class="validate" max="9999999999" required required="true">
                      <label for="meterReading_reading_edit">Reading<b><font color='red'>*</font></b></label>
                      <span class="helper-text" data-error="Include decimals but ignore separator if present. Max 10 digits. Example: 06614639">Include decimals but ignore separator if present. Example: 06614639</span>
                    </div>
                    <br>
                    <div class="input-field ">
                      <input id="meterReading_date_edit" type="text" class="datepicker validate" required required="true">
                      <label for="meterReading_date_edit">Reading Date<b><font color='red'>*</font></b></label>
                      <span class="helper-text" data-error="required field" ></span>
                    </div>
                  </div>
                </form>
                <div class="col s12 m6">
                  <div id="meterReading_picture_frame_edit">
                    <div id="meterReading_picture_show_edit" class="col s12 m6">
                    </div>
                    <button style="float:right;margin-left: 20px;margin-top: 3px" class="btn-small waves-light red modal-trigger" data-target="pictureRemove" type="submit" >Remove Picture<i class="material-icons right">delete</i></button>
                  </div>
                  <form id="meterReading_picture_form" class="displayHidden">
                    <div class="input-field " id="meterReading_picture">
                    </div>
                    <div class="file-field input-field col s12 m6">
                      <div class="btn-small">
                        <span>Picture<i class="material-icons right">attach_file</i></span>
                        <input type="file" id="meterReading_picture_file">
                      </div>
                      <div class="file-path-wrapper">
                        <input class="file-path validate" type="text" id="meterReading_picture_text">
                      </div>
                    </div>
                  </form>
                </div>
              </div>


              <button style="float: right;margin-left: 20px;margin-bottom: 3px" class="btn-small waves-light" type="submit" onclick="writeMeterReading()">Submit<i class="material-icons right">send</i></button>
              <a style="float: right;margin-bottom: 3px"
                class="modal-close waves-light btn-small"><i class="material-icons right">cancel</i> Cancel</a>
            </div>
          </div>

          <div id="meterReadingRead" class="modal">
            <div class="modal-content">
              <a style="float: right"
                class="modal-close waves-light btn-small"><i class="material-icons right">cancel</i> Close</a>
              <h5>Meter info</h5>
              <form>
                <div class="input-field col s12 m6">
                  <input id="meterReading_property" type="text" readonly>
                  <label for="meterReading_property">Property</label>
                </div>
                <div class="input-field col s12 m6">
                  <input id="meterReading_type" type="text" readonly>
                  <label for="meterReading_type">Type</label>
                </div>
                <div class="input-field col s12 m6">
                  <input id="meterReading_id" type="text" readonly>
                  <label for="meterReading_id">ID Meter</label>
                </div>
                <div class="input-field col s12 m6">
                  <input id="meterReading_lastReading" type="text" readonly>
                  <label for="meterReading_lastReading">Last Reading</label>
                </div>
              </form>
              <div class="row">
                <form>
                  <div class="input-field col s12 m6">
                    <div class="input-field">
                      <input id="meterReading_reading" type="text" readonly>
                      <label for="meterReading_reading">Reading</label>
                    </div>
                    <div class="input-field ">
                      <input id="meterReading_date" type="text" readonly>
                      <label for="meterReading_date">Reading Date</label>
                    </div>
                  </div>
                </form>
                <div class="col s12 m6">
                  <div id="meterReading_picture_frame">
                    <div id="meterReading_picture_show" class="col s12 m6">
                    </div>
                  </div>
                </div>
              </div>
              <a style="float: right;margin-bottom: 3px"
                class="modal-close waves-light btn-small"><i class="material-icons right">cancel</i>Close</a>
            </div>
          </div>

        </div>
        <!------------------------------------------------------------------------------------------------------>
        <div id="Members" class="col s12">
          <table class="striped">
            <thead>
              <tr>
                <th style="white-space: nowrap"> First and Last Name </th>
                <th> Email </th>
                <th> Mobile </th>
              </tr>
            </thead>
            <tbody id="membersTable">
            </tbody>
          </table>
          <br>
          <div id="Members_Add" class="displayHidden">
            <button style="float: right" data-target="memberWrite" class="btn-small waves-light modal-trigger" onclick="resetSelectedMember()"><i class="material-icons right">add</i>New Member</button>
          </div>
        </div>
        <!--- shared views ------------------------------------------------------------------------------------>
        <div id="memberView" class="modal">
          <a style="float: right;margin-top: 3px;margin-right: 5px"
            class="modal-close waves-light btn-small"><i class="material-icons right">cancel</i>Close</a>
          <div class="modal-content">
            <h5> View member</h5>
            <div class="w3-panel w3-border" style="box-shadow: 5px 10px 8px #888888">
              <form class="col s12">
                <div class="input-field col s12 m4">
                  <i class="material-icons prefix">account_circle</i>
                  <input id="member_firstName" type="text" readonly>
                  <label for="member_firstName" >First Name</label>
                </div>
                <div class="input-field col s12 m8">
                  <i class="material-icons prefix">account_circle</i>
                  <input id="member_lastName" type="text" readonly>
                  <label for="member_lastName" >Last Name</label>
                </div>
                <div class="input-field col s12">
                  <input id="member_email" type="email" readonly>
                  <label for="member_email" >Email</label>
                </div>
                <div class="input-field col s12 m6">
                  <i class="material-icons prefix">phone</i>
                  <input id="member_phoneHome" type="tel" readonly>
                  <label for="member_phoneHome">Telephone Home</label>
                </div>
                <div class="input-field col s12 m6">
                  <i class="material-icons prefix">phone</i>
                  <input id="member_phoneMobile" type="tel" readonly>
                  <label for="member_phoneMobile">Mobile</label>
                </div>
                <p> </p>
                <div class="input-field col s12 m4">
                  <input  id="member_country" type="text" readonly >
                  <label for="member_country" >Country</label>
                </div>
                <div class="input-field col s12 m6">
                  <input  id="member_town" type="text" readonly >
                  <label for="member_town">Town</label>
                </div>
                <div class="input-field col s12 m2">
                  <input  id="member_zip" type="number" readonly>
                  <label for="member_zip" >Zip</label>
                </div>
                <div class="input-field col s12 m4">
                  <input  id="member_street" type="text" readonly >
                  <label for="member_street">Street</label>
                </div>
                <div class="input-field col s6 m2">
                  <input  id="member_houseNumber" type="text" readonly >
                  <label for="member_houseNumber">Number</label>
                </div>
                <div class="input-field col s6 m2">
                  <input  id="member_bus" type="number" readonly >
                  <label for="member_bus">Bus</label>
                </div>
                <div id="Members_Edit" class="displayHidden">
                  <button style="float: right;margin-bottom: 3px" data-target="memberWrite" class="btn-small waves-light modal-trigger" onclick="setSelectedMember(selectedMemberId, selectedMemberObject,editMode)">Edit<i class="material-icons right">edit</i></button>
                </div>
              </form>
            </div>
            <div class="w3-panel w3-border" style="box-shadow: 5px 10px 8px #888888">
              <div class="col s12 m4">
                <h6>Owner of:</h6>
                <p id="member_ownerOf"> </p>
              </div>
              <div class="col s12 m4">
                <h6>Occupant of:</h6>
                <p id="member_occupantOf"> </p>
              </div>
            </div>
          </div>
          <a style="float:right;margin-bottom: 3px;margin-right: 5px"
            class="modal-close waves-light btn-small"><i class="material-icons right">cancel</i>Close</a>
        </div>

        <div id="memberWrite" class="modal">
          <div class="modal-content">
            <a style="float: right" class="modal-close waves-light btn-small"><i class="material-icons right">cancel</i>
              Cancel</a>
            <h5> Enter member data</h5>
            <form class="col s12">
              <div class="input-field col s12 m4">
                <i class="material-icons prefix">account_circle</i>
                <input id="member_firstName_edit" type="text" class="validate" maxlength="50" required aria-required="true">
                <label for="member_firstName_edit" >First Name<b><font color='red'>*</font></b></label>
                <span class="helper-text" data-error="maximum 50 characters" ></span>
              </div>
              <div class="input-field col s12 m8">
                <i class="material-icons prefix">account_circle</i>
                <input id="member_lastName_edit" type="text" class="validate" maxlength="50" required aria-required="true">
                <label for="member_lastName_edit" >Last Name <b><font color='red'>*</font></b></label>
                <span class="helper-text" data-error="maximum 50 characters" ></span>
              </div>
              <div class="input-field col s12">
                <input id="member_email_edit" type="email" class="validate" maxlength="70" >
                <label for="member_email_edit" >Email</label>
                <span class="helper-text" data-error="email must contain @" ></span>
              </div>
              <div class="input-field col s12 m6">
                <i class="material-icons prefix">phone</i>
                <input id="member_phoneHome_edit" type="tel" pattern="([+]?[0-9]|[ ])*" maxlength="30" class="validate">
                <label for="member_phoneHome_edit">Telephone Home</label>
                <span class="helper-text" data-error="Only +, digits or spaces, max 30. Example: +32 2 456 789" >Only digits or spaces. Example: +32 2 456 789</span>
              </div>
              <div class="input-field col s12 m6">
                <i class="material-icons prefix">phone</i>
                <input id="member_phoneMobile_edit" type="tel" pattern="([+]?[0-9]|[ ])*" maxlength="30" class="validate">
                <label for="member_phoneMobile_edit">Mobile</label>
                <span class="helper-text" data-error="Only digits or spaces, max 30. Example: +32 476 123 456" >Only digits or spaces. Example: +32 476 123 456</span>
              </div>
              <div class="col s12 m12">
                <button style="float: left" class="btn-small waves-light" type="button" onclick="insertAdrressCoproperty()">Copy adress condomynium<i class="material-icons right">content_copy</i></button>
              </div>
              <div class="input-field col s12 m4">
                <input  id="member_country_edit" type="text" class="validate" maxlength="50" >
                <label for="member_country_edit" >Country</label>
                <span class="helper-text" data-error="Max 50 characters"></span>
              </div>
              <div class="input-field col s6 m6">
                <input  id="member_town_edit" type="text" class="validate" maxlength="50" >
                <label for="member_town_edit">Town</label>
                <span class="helper-text" data-error="Max 50 characters"></span>
              </div>
              <div class="input-field col s6 m2">
                <input  id="member_zip_edit" type="text" class="validate" min="0" maxlength="10">
                <label for="member_zip_edit" >Zip</label>
                <span class="helper-text" data-error="Max 10 characters. For Belgium 4 digits. Example Belgium: 1730">"Example Belgium: 1730"</span>
              </div>

              <div class="input-field col s12 m4">
                <input  id="member_street_edit" type="text" class="validate" maxlength="50" >
                <label for="member_street_edit">Street</label>
                <span class="helper-text" data-error="Max 50 characters"></span>
              </div>
              <div class="input-field col s6 m2">
                <input  id="member_houseNumber_edit" type="text" class="validate" maxlength="10" >
                <label for="member_houseNumber_edit">Number</label>
                <span class="helper-text" data-error="Max 10 characters. Example 26A">Max 10 characters. Example 26A</span>
              </div>
              <div class="input-field col s6 m2">
                <input  id="member_bus_edit" type="text" class="validate" maxlength="3" >
                <label for="member_bus_edit">Bus</label>
                <span class="helper-text" data-error="Max 3 characters. Example 12" >Max 3 characters. Example 12</span>
              </div>
            </form>
            <button style="float: right;margin-left: 20px;margin-bottom: 3px" class="btn-small waves-light" type="submit" onclick="writeMember()">Submit<i class="material-icons right">send</i></button>
            <a style="float: right;margin-bottom: 3px"
              class="modal-close waves-light btn-small"><i class="material-icons right">cancel</i>
              Cancel</a>
          </div>

        </div>

        <div id="propertyView" class="modal">
          <a style="float: right;margin-top: 3px;margin-right: 5px"
            class="modal-close waves-light btn-small"><i class="material-icons right">cancel</i>Close</a>
          <div class="modal-content">
            <h5> View property</h5>
            <div class="w3-panel w3-border" style="box-shadow: 5px 10px 8px #888888">
              <form class="col s12">
                <div class="input-field col s6 m6">
                  <input id="property_code" type="text" readonly>
                  <label for="property_code">Code</label>
                </div>
                <div class="input-field col s6 m6">
                  <input id="property_quota" type="number" readonly>
                  <label for="property_quota">Quota</label>
                </div>
                <div class="input-field col s6 m6">
                  <input id="property_type" type="text" readonly>
                  <label for="property_type">Type</label>
                </div>
                <div class="input-field col s6 m6">
                  <input id="property_cellar" type="text" readonly>
                  <label for="property_cellar">Cellar(s)</label>
                </div>
                <div id="Properties_Edit" class="displayHidden">
                  <button style="float: right;margin-bottom: 3px" data-target="propertyWrite" class="btn-small waves-light modal-trigger" onclick="setEditPropertyEntries()">Edit<i class="material-icons right">edit</i></button>
                </div>
              </form>
            </div>
            <div class="w3-panel w3-border" style="box-shadow: 5px 10px 8px #888888">
              <div>
                <h7>Owner: </h7>
                <button id="property_owner" data-target="memberView" class="modal-trigger" style="border:none;background-color:Transparent"></button>

                <div class="displayHidden" id="previousOwnersButton">
                  <button style="float:right;margin-left: 20px;margin-bottom: 3px" data-target="previousOwners" class="btn-small waves-light modal-trigger" onclick="showPreviousOwnersTable()">Previous Owners</button>
                </div>
                <div id="Properties_OwnersAdd" class="displayHidden">
                  <button style="float:right;margin-bottom: 3px" data-target="newOwner" class="btn-small waves-light modal-trigger" onclick="newOwner()">New Owner<i class="material-icons right">add</i></button>
                </div>
              </div>
            </div>
            <div class="w3-panel w3-border" style="box-shadow: 5px 10px 8px #888888">
              <div>
                <h7>Meters</h7>
                <table class="striped">
                  <thead>
                    
                    <th>Type</th>
                    <th>Meter ID</th>
                    <th>Status</th>
                  </thead>
                  <tbody id="property_meters">
                  </tbody>
                </table>
              </div>
              <div id="Properties_MetersAdd" class="displayHidden">
                <button style="float: right;margin-bottom: 3px" class="btn-small waves-light modal-trigger" data-target="meterWrite" onclick="addMeter()">Add Meter<i class="material-icons right">add</i></button>
              </div>
            </div>

            <div class="w3-panel w3-border" style="box-shadow: 5px 10px 8px #888888">
              <div>
                <h7>Occupants</h7>
                <table class="striped">
                  <tbody id="property_occupants">
                  </tbody>
                </table>
              </div>
              <div id="Properties_OccupantsAdd" class="displayHidden">
                <div class="input-field col s12 m4">
                  <select id="property_occupant_add" onchange="enableOccupantAdd()">
                  </select>
                </div>
                <div class="input-field col s12 m4">
                  <button id="buttonOccupantAdd" class="btn-small waves-light disabled" onclick="addOccupant()">Add as Occupant<i class="material-icons right">add</i></button>
                </div>
              </div>
            </div>

          </div>

          <a style="float:right;margin-bottom: 3px"
            class="modal-close waves-light btn-small"><i class="material-icons right">cancel</i>Close</a>

        </div>

        <div id="meterWrite" class="modal">
          <div class="modal-content">
            <a style="float: right" class="modal-close waves-light btn-small"><i class="material-icons right">cancel</i>
              Close</a>
            <h5> Enter meter</h5>
            <form class="col s12">
              <div class="input-field col s12 m4">
                <select id="meter_type" required aria-required="true"></select>
                <label for="meter_type">Type<b><font color='red'>*</font></b></label>
              </div>
              <div class="input-field col s12 m4">
                <input id="meter_id" type="text" maxlength="10" class="validate" required aria-required="true" pattern="([A-Z]|[0-9]){4,10}">
                <label for="meter_id">ID meter<b><font color='red'>*</font></b></label>
                <span class="helper-text" data-error="4 to 10 digts or capital letters. Example 99DB517508">4 to 10 digts or capital letters. Example 99DB517508</span>
              </div>
              <div class="input-field col s12 m4">
                <select id="meter_status" required aria-required="true"></select>
                <label for="meter_status">Status<b><font color='red'>*</font></b></label>
              </div>
              <div id="meter_firstReadingPanel" class="input-field col s12 m4">
                <input id="meter_firstReading" type="number" class="validate" max="9999999999" required required="true">
                <label for="meter_firstReading">Reading<b><font color='red'>*</font></b></label>
                <span class="helper-text" data-error="Include decimals but ignore separator if present. Max 10 digits. Example: 06614639">Include decimals but ignore separator if present. Example: 06614639</span>
              </div>

            </form>
            <button style="float: right;margin-left: 20px;margin-bottom: 3px" class="btn-small waves-light" type="submit" onclick="writeMeter()">Submit<i class="material-icons right">send</i></button>
            <a style="float: right;margin-bottom: 3px"
              class="modal-close waves-light btn-small"><i class="material-icons right">cancel</i> Cancel</a>
          </div>
        </div>
        <!------------------------------------------------------------------------------------------>
        <div id="Properties" class="col s12">
          <table class="striped">
            <thead>
              <tr>
                <th>Code</th>
                <th>Quota</th>
                <th>Type</th>
                <th>Owner</th>
              </tr>
            </thead>
            <tbody id="propertiesTable">
            </tbody>
          </table>
          <h6><b id="totalQuotas"></b></h6>
          <div id="Properties_Add" class="displayHidden">
            <button style="float: right" data-target="propertyAdd" class="btn-small waves-light modal-trigger" onclick="resetSelectedProperty()"><i class="material-icons right">add</i>New Property</button>
          </div>


          <div id="previousOwners" class="modal">
            <div class="modal-content">
              <a style="float: right"
                class="modal-close waves-light btn-small"><i class="material-icons right">cancel</i> Close</a>
              <h5> Previous Owners:</h5>
              <table class="striped">
                <thead>
                  <tr>
                    <th> Member </th>
                    <th> Transfer Date </th>
                  </tr>
                </thead>
                <tbody id="propertyPreviousOwnersTable">
                </tbody>
              </table>
              <a style="float: right"
                class="modal-close waves-light btn-small"><i class="material-icons right">cancel</i> Close</a>
            </div>
          </div>

          <div id="propertyAdd" class="modal">
            <div class="modal-content">
              <a style="float: right"
                class="modal-close waves-light btn-small"><i class="material-icons right">cancel</i> Cancel</a>
              <h5> New Property</h5>
              <form class="col s12">
                <div class="input-field col s6 m6">
                  <input id="property_code_add" type="text" pattern="([A-Z]|[0-9]){1,4}" class="validate" required aria-required="true">
                  <label for="property_code_add">Code<b><font color='red'>*</font></b></label>
                  <span class="helper-text" data-error="Max 4 capitals or numbers. Example: A1">Max 4 capitals or numbers. Example: A1</span>
                </div>
                <div class="input-field col s6 m6">
                  <input id="property_quota_add" type="number" class="validate" min="0" max="999" required aria-required="true">
                  <label for="property_quota_add">Quota<b><font color='red'>*</font></b></label>
                  <span class="helper-text" data-error="A number of max 3 digits. Example: 22">A number of max 3 digits. Example: 22</span>
                </div>
                <div class="row">
                  <div class="input-field col s6 m6">
                    <select id="property_type_add" required aria-required="true"></select>
                    <label for="property_type_add">Type<b><font color='red'>*</font></b></label>
                  </div>
                  <div class="input-field col s12 m6">
                    <select id="property_owner_add" required aria-required="true">
                      <option value="" disabled selected>Select the owner</option>
                    </select>
                    <label for="property_owner_add">Owner<b><font color='red'>*</font></b></label>
                  </div>
                </div>
                <div class="input-field col s6 m6">
                  <input id="property_cellar_add" type="text" maxlength="10" class="validate">
                  <label for="property_cellar_add">Cellar(s)</label>
                  <span class="helper-text" data-error="A string of max 10 digits: Example: C1, C2">A string of max 10 digits: Example: C1,C2</span>
                </div>
              </form>
              <button style="float: right;margin-left: 20px;margin-bottom: 3px" class="btn-small waves-light" type="submit" onclick="addProperty()">Save and complete by adding meters<i class="material-icons right">send</i></button>
              <a style="float: right;margin-bottom: 3px"
                class="modal-close waves-light btn-small"><i class="material-icons right">cancel</i> Cancel</a>
            </div>
          </div>

          <div id="newOwner" class="modal">
            <div class="modal-content">
              <a style="float: right"
                class="modal-close waves-light btn-small"><i class="material-icons right">cancel</i> Cancel</a>
              <h5> Transfer property to new owner</h5>
              <form class="col s12">
                <div class="input-field col s12 m6">
                  <select id="property_newOwner" required aria-required="true">
                      <option value="" disabled selected>Select the new owner</option>
                    </select>
                  <label for="property_newOwner">New Owner<b><font color='red'>*</font></b></label>
                </div>
                <div class="input-field col s12 m6">
                  <input id="property_transferDate" type="text" class="datepicker validate" required required="true">
                  <label for="property_transferDate">Transfer Date<b><font color='red'>*</font></b></label>
                  <span class="helper-text" data-error="required field" ></span>
                </div>
              </form>
              <button style="float: right;margin-left: 20px;margin-bottom: 3px" class="btn-small waves-light" type="submit" onclick="writeNewOwner()">Submit<i class="material-icons right">send</i></button>
              <a style="float: right;margin-bottom: 3px"
                class="modal-close waves-light btn-small"><i class="material-icons right">cancel</i> Cancel</a>
            </div>
          </div>

          <div id="previousOwner" class="modal">
            <div class="modal-content">
              <a style="float: right"
                class="modal-close waves-light btn-small"><i class="material-icons right">cancel</i> Cancel</a>
              <h5> Previous Owner</h5>
              <form class="col s12">
                <div class="input-field col s12 m6">
                  <select id="property_previousOwner" required aria-required="true">
                      <option value="" disabled selected>Correct the previous owner</option>
                    </select>
                  <label for="property_previousOwner">Previous Owner<b><font color='red'>*</font></b></label>
                </div>
                <div class="input-field col s12 m6">
                  <input id="property_transferDatePrevious" type="text" class="datepicker validate" required required="true">
                  <label for="property_transferDatePrevious">Transfer Date<b><font color='red'>*</font></b></label>
                  <span class="helper-text" data-error="required field" ></span>
                </div>
              </form>
              <button style="float: right;margin-left: 20px" class="btn-small waves-light" type="submit" onclick="writePreviousOwner()">Submit<i class="material-icons right">send</i></button>
              <a style="float: right"
                class="modal-close waves-light btn-small"><i class="material-icons right">cancel</i> Cancel</a>
            </div>
          </div>

          <div id="propertyWrite" class="modal">
            <div class="modal-content">
              <a style="float: right"
                class="modal-close waves-light btn-small"><i class="material-icons right">cancel</i> Cancel</a>
              <h5> Edit property data</h5>
              <form class="col s12">
                <div class="input-field col s6 m6">
                  <input id="property_code_edit" type="text" pattern="([A-Z]|[0-9]){1,4}" class="validate" required aria-required="true">
                  <label for="property_code_edit">Code<b><font color='red'>*</font></b></label>
                  <span class="helper-text" data-error="Max 4 capitals or numbers. Example: A1">Max 4 capitals or numbers. Example: A1</span>
                </div>
                <div class="input-field col s6 m6">
                  <input id="property_quota_edit" type="number" class="validate" min="0" max="999" required aria-required="true">
                  <label for="property_quota_edit">Quota<b><font color='red'>*</font></b></label>
                  <span class="helper-text" data-error="A number of max 3 digits. Example: 22">A number of max 3 digits. Example: 22</span>
                </div>
                <div class="row">
                  <div class="input-field col s6 m6">
                    <select id="property_type_edit" required aria-required="true"></select>
                    <label for="property_type_edit">Type<b><font color='red'>*</font></b></label>
                  </div>
                  <div class="input-field col s6 m6">
                    <input id="property_cellar_edit" type="text" maxlength="10" class="validate">
                    <label for="property_cellar_edit">Cellar(s)</label>
                    <span class="helper-text" data-error="A string of max 10 digits: Example: C1, C2">A string of max 10 digits: Example: C1,C2</span>
                  </div>
                </div>
              </form>
              <button style="float: right;margin-left: 20px;margin-bottom: 3px" class="btn-small waves-light" type="submit" onclick="writeProperty()">Submit<i class="material-icons right">send</i></button>
              <a style="float: right;margin-bottom: 3px"
                class="modal-close waves-light btn-small"><i class="material-icons right">cancel</i> Cancel</a>
            </div>
          </div>
        </div>
        <div id="Settings" class="col s12">
          <h5>Cost Centers</h5>
          <table class="striped">
          <thead id="costCenters_tableHead">
          </thead>
          <tbody id="costCenters_tableBody">
          </tbody>
          </table>
          <br>
          <button style="float: right;margin-bottom: 3px" class="btn-small waves-light modal-trigger" data-target="costCenterAdd" ">New Cost Center<i class="material-icons right">add</i></button>
          <br><br><br>
          <h5>Meters common parts</h5>
          <table class="striped">
            <thead>
              <th>Type</th>
              <th>Meter ID</th>
              <th>Status</th>
            </thead>
            <tbody id="coproperty_meters">
            </tbody>
          </table>
          <br>
          <button style="float: right;margin-bottom: 3px" class="btn-small waves-light modal-trigger" data-target="meterWrite" onclick="addCopropertyMeter()">Add Meter<i class="material-icons right">add</i></button>
          <div id="costCenterAdd" class="modal">
            <div class="modal-content">
            <a style="float: right"
              class="modal-close waves-light btn-small"><i class="material-icons right">cancel</i> Cancel</a>
            <h5> New Cost Center</h5>
            <form class="col s12">
              <div class="input-field col s6 m6">
                <input id="costCenter_name_add" type="text" class="validate" required aria-required="true">
                <label for="costCenter_name_add">Name<b><font color='red'>*</font></b></label>
                <span class="helper-text" data-error="Required field"></span>
              </div>
            </form>
            <button style="float: right;margin-left: 20px;margin-bottom: 3px" class="btn-small waves-light" type="submit" onclick="costCenterAddPrepare()">Save<i class="material-icons right">send</i></button>
            <a style="float: right;margin-bottom: 3px"
              class="modal-close waves-light btn-small"><i class="material-icons right">cancel</i> Cancel</a>
            </div>
          </div>
          <div id="costCenterNameEdit" class="modal">
          <div class="modal-content">
          <a style="float: right"
            class="modal-close waves-light btn-small"><i class="material-icons right">cancel</i> Cancel</a>
          <h5> Enter name cost center</h5>
          <form class="col s12">
            <div class="input-field col s6 m6">
              <input id="costCenter_name_edit" type="text" class="validate" required aria-required="true">
              <label for="costCenter_name_edit">Name<b><font color='red'>*</font></b></label>
              <span class="helper-text" data-error="Required field"></span>
            </div>
          </form>
          <button style="float: right;margin-left: 20px;margin-bottom: 3px" class="btn-small waves-light" type="submit" onclick="costCenterNameEditPrepare()">Save<i class="material-icons right">send</i></button>
          <a style="float: right;margin-bottom: 3px"
            class="modal-close waves-light btn-small"><i class="material-icons right">cancel</i> Cancel</a>
          </div>
          </div>
          <div id="costCenterQuotaEdit" class="modal">
          <div class="modal-content">
          <a style="float: right"
            class="modal-close waves-light btn-small"><i class="material-icons right">cancel</i> Cancel</a>
          <h5> Enter quota</h5>
          <form class="col s12">
            <div class="input-field col s6 m6">
            <input id="costCenter_quota_edit" type="number" class="validate" min="0" max="999" required aria-required="true">
            <label for="costCenter_quota_edit">Quota<b><font color='red'>*</font></b></label>
            <span class="helper-text" data-error="A number of max 3 digits. Example: 22">A number of max 3 digits. Example: 22</span>
            </div>
          </form>
          <button style="float: right;margin-left: 20px;margin-bottom: 3px" class="btn-small waves-light" type="submit" onclick="costCenterQuotaEditPrepare()">Save<i class="material-icons right">send</i></button>
          <a style="float: right;margin-bottom: 3px"
            class="modal-close waves-light btn-small"><i class="material-icons right">cancel</i> Cancel</a>
          </div>
          </div>
        </div>
      </div>
    </main>
    <script>
      var lastCloseDate;
      var lastReguDate;
      
      var currencyStyle = {
        style: "currency",
        currency: "EUR"
      };
      var currentUserProperties;
      var currentUser = {
        email: "",
        role: "",
        id:"",
        owns: function(propertyId){
          var x = [];
          if (!currentUserProperties) {
            currentUserProperties = [];
            refCoproperty.collection("Properties").where("owner","==",this.id).get().then(function(propertiesFS){
              propertiesFS.forEach(function (propertyFS){
                currentUserProperties.push(propertyFS.id);                
              });             
              return currentUserProperties.includes(propertyId);
            });
          } else {
          return currentUserProperties.includes(propertyId);
          };
        }
      };
      var roleAdministrator = 1;

      function showPasswordSet() {
      document.getElementById("loginPanel").setAttribute("class","displayHidden");
      document.getElementById("setPasswordPanel").setAttribute("class","displayBlock");
      };

      function showPasswordReset() {
      document.getElementById("loginPanel").setAttribute("class","displayHidden");
      document.getElementById("resetPasswordPanel").setAttribute("class","displayBlock");
      };

    function validateLoginEntries() {
      var valid= true;
      if (!document.getElementById("login_email").checkValidity()) {
        M.toast({html:"Please enter your email"});
        valid=false;
      };
      if (!document.getElementById("login_password").checkValidity()) {
        M.toast({html:"Please enter your password"});
        valid=false;
      };
      return valid;
    };

    function openApplication() {
      loadHome();
          document.getElementById("loginPanel").setAttribute("class","displayHidden");
          document.getElementById("applicationPanel").setAttribute("class","displayBlock");
       
    };
    
    function login(){
      if (validateLoginEntries()) {
        var email = document.getElementById("login_email").value.toLowerCase();
        var password = document.getElementById("login_password").value;

        var docUserRef = firestore.collection("Users").doc(email);
        docUserRef.get().then(function(user){
          if (user.exists)  {
            firebase.auth().setPersistence(firebase.auth.Auth.Persistence.SESSION)
              .then(function() {
                  firebase.auth().signInWithEmailAndPassword(email, password)
                    .then(function(user){
                      
                      refCoproperty.collection("Members").where("email", "==" ,email).get().then(function(membersFS){ currentUser.email = email;
                        currentUser.id = membersFS.docs[0].id;
                        if (membersFS.docs[0].data().role) {
                          currentUser.role = roleAdministrator;
                          document.getElementById("Reports_Generate").setAttribute("class","displayBlock");
                          document.getElementById("Reports_Add").setAttribute("class","displayBlock");
                          document.getElementById("Transactions_Add").setAttribute("class","displayBlock");
                          document.getElementById("Transactions_Edit").setAttribute("class","displayBlock");
                          document.getElementById("Transactions_EvidenceAdd").setAttribute("class","displayBlock");
                          document.getElementById("Members_Add").setAttribute("class","displayBlock");
                          document.getElementById("Members_Edit").setAttribute("class","displayBlock");
                          document.getElementById("Properties_Add").setAttribute("class","displayBlock");
                          document.getElementById("Properties_Edit").setAttribute("class","displayBlock");
                          document.getElementById("Properties_MetersAdd").setAttribute("class","displayBlock");
                          document.getElementById("Properties_OwnersAdd").setAttribute("class","displayBlock");
                          document.getElementById("tabTransactionRules").style.display = "block";
                          document.getElementById("tabSettings").style.display = "block";
                        };
                        openApplication();
                      }).catch(function(error) {
                        M.toast({html:"You are not registered as an active user: Please contact your administrator"});
                      }); 
                    })
                    .catch(function(error) {
                      M.toast({html:"Invalid email or password"});
                    });
              })
              .catch (function(error) {
                M.toast({html:error.message + "...authentication server not accessible"});
              });  
          }
          else {
            M.toast({html:"Unknown email: Please contact your administrator"});
          };
        });
      };
    };

    function backToLoginFromSetPW() {
      document.getElementById("setPasswordPanel").setAttribute("class","displayHidden");
      document.getElementById("loginPanel").setAttribute("class","displayBlock"); 
    };
    function backToLoginFromResetPW() {
      document.getElementById("resetPasswordPanel").setAttribute("class","displayHidden");
      document.getElementById("loginPanel").setAttribute("class","displayBlock"); 
    };
    
    function validatePasswordSetEntries() {
        var valid= true;
        if (!document.getElementById("passwordSet_email").checkValidity()) {
          M.toast({html:"Please enter your email"});
          valid=false;
        };
        return valid;
    };

      
    function passwordSet(){
      if (validatePasswordSetEntries()) {
        var email = document.getElementById("passwordSet_email").value;
        var docUserRef = firestore.collection("Users").doc(email);
        docUserRef.get().then(function(user){
          if (user.exists)  {
            firebase.auth().sendPasswordResetEmail(email).then(function() {
                M.toast({html:"Please follow instructions sent by mail"});
                setTimeout(function(){backToLoginFromSetPW();}, 6000);
            }).catch(function(error) {
              M.toast({html:"Error sending mail to set password set" + error});
            });
          } else {M.toast({html:"Unknown email: Please contact your administrator"});
          };
        }).catch(function(error) {
            M.toast({html:"Unknown email: Please contact your administrator"});
        });
      };
    };
    
    function validatePasswordResetEntries() {
        var valid= true;
        if (!document.getElementById("passwordReset_email").checkValidity()) {
          M.toast({html:"Please enter your email"});
          valid=false;
        };
        return valid;
    };
    
    
    function passwordReset(){
      if (validatePasswordResetEntries()) {
        var email = document.getElementById("passwordReset_email").value;
        var docUserRef = firestore.collection("Users").doc(email);
        docUserRef.get().then(function(user){
          if (user.exists)  {
            firebase.auth().sendPasswordResetEmail(email).then(function() {
                M.toast({html:"Please follow instructions sent by mail"});
                setTimeout(function(){backToLoginFromResetPW();}, 6000);
            }).catch(function(error) {
              M.toast({html:"Error sending password reset mail" + error});
            });
          } else {M.toast({html:"Unknown email: Please contact your administrator"});
          };
        }).catch(function(error) {
            M.toast({html:"Unknown email: Please contact your administrator"});
        });
      };
    };
    </script>
    <!--   Application scripts starts here -->
    <script>
      const options = {
        duration: 300,
        onShow: null,
        swipeable: false,
        responsiveThreshold: Infinity
    };
    var elems = document.querySelectorAll('select');
    var instances = M.FormSelect.init(elems); 

    const tabsContainer = document.querySelector(".tabs");
    M.Tabs.init(tabsContainer,options);
    elems = document.querySelectorAll('.datepicker');
    instances = M.Datepicker.init(elems, {maxDate: new Date(),format: 'yyyy-mm-dd'});

    
    elems = document.querySelectorAll('.modal');
    instances = M.Modal.init(elems, {dismissible:false,preventScrolling:false});

    const thisCoproperty = "OrncEBHp37pJYisfxf79";
    var refCoproperty = firestore.collection("CoProperties").doc(thisCoproperty);
    var refCopropertyFiles = fileStorageRef.child(thisCoproperty);
    var editMode = "_edit";
        
    function emptyHTMLSet(set) {
      while(set.hasChildNodes()){
        set.removeChild(set.firstChild);
      };
    };

    elems = document.querySelectorAll('.sidenav');
    instances = M.Sidenav.init(elems);
    /*
    var collapsibleElem = document.querySelector('.collapsible');
    var collapsibleInstance = M.Collapsible.init(collapsibleElem);
    */
    var elems = document.querySelectorAll('.collapsible');
    var instances = M.Collapsible.init(elems);

    var PropType = {
      APART: 'apartment',
      GARAG: 'garage'
    };

    var TransTypeRead = {
      MAINT : 'repair/maintenance',
      RENOV: 'installation/renovation',
      INSUR: 'insurance building',
      SERVI: 'services',
      EQUIP: 'small equipment',
      ELECT: 'electricity',
      WATER: 'water',
      HEATI: 'heating',
      PRIVA: 'private',
      TBSET: 'to be set'
    };

    var TransType = {
      MAINT : 'repair/maintenance',
      RENOV: 'installation/renovation',
      INSUR: 'insurance building',
      SERVI: 'services',
      EQUIP: 'small equipment',
      ELECT: 'electricity',
      WATER: 'water',
      HEATI: 'heating',
      PRIVA: 'private'
    };

    var MeterStatus = {
      ACTIF: 'active',
      PASSI: 'removed'
    };

    var MeterType = {
      COLWA: 'cold water',
      HOTWA: 'hot water',
      HEATI: 'heating'
    };

    function insertSelectOptions (elBeforeID, keyValuePairs, defaultString, defaultKey) {
      // either defaulString or defaultKey should be nul
      var el = document.getElementById(elBeforeID);
      if (defaultString) {
        var defaultt = document.createElement("option");
        defaultt.setAttribute("value", "");
        defaultt.innerHTML = "Select " + defaultString;
        el.insertAdjacentElement('beforeend', defaultt);
      };
      Object.keys(keyValuePairs).forEach(function(key){
        var newEl = document.createElement("option");
        if (key == defaultKey) {newEl.setAttribute("selected", "");};
        newEl.setAttribute("value", key);
        newEl.innerHTML = keyValuePairs[key];
        el.insertAdjacentElement('beforeend', newEl);
      });
    };
    insertSelectOptions("property_type_add", PropType, "type");
    insertSelectOptions("property_type_edit", PropType, "type");
    insertSelectOptions("transaction_type_add", TransType, "type");
    insertSelectOptions("transactionRule_type", TransType, "type");
    insertSelectOptions("meter_type", MeterType, "type");
    insertSelectOptions("meter_status", MeterStatus, "", "ACTIF");
    </script>
    <!--   Home scripts start here -->
    <script>
      var currentCoproperty;
      var currentCopropertyId;
      function refreshHome(){
        refCoproperty.get().then(function(copropertyFS){
          currentCopropertyId = copropertyFS.id;
          currentCoproperty = copropertyFS.data();
          
          emptyHTMLSet(document.getElementById("Home_CopropertyName"));
          var textN = document.createTextNode(currentCoproperty.name);
          document.getElementById("Home_CopropertyName").appendChild(textN);
          textN = document.createTextNode(currentCoproperty.street + " " + currentCoproperty.houseNumber + ", "+ currentCoproperty.zip + " " + currentCoproperty.town);
          document.getElementById("Home_CopropertyAddress").appendChild(textN);
          refCoproperty.collection("ChargesReports").orderBy("endDate","desc").get().then(function(chargesReportsFS){
            readCloseAndReguDate(chargesReportsFS);
          });
        });
      };
      
      var homeLoaded = false;
      function loadHome() {
        hideMenu();
        document.getElementById("logo-container").innerHTML = "MyCondos: Home";
        if (!homeLoaded) {
          refreshHome();
          homeLoaded = true;
        };
      };
    
      function checkBookDate (bookDate){
        if (bookDate.localeCompare(lastCloseDate) < 1) { return false} 
        else { return true};
      };

    </script>
    <!--   Reports scripts start here -->
    <script>
      function emptyReportFields(){
        document.getElementById("reportFile").value = "";
        document.getElementById("reportFileText").value = "";
        document.getElementById("report_type_edit").value = "";
      };
      
      function showReport(url) {
          window.open(url,"_blank");
      };

      function loadReport (objectFS){
        var object = objectFS.data();
        var objectsRow= document.createElement('tr');
        
        var cellContent = document.createElement("button");
        cellContent.setAttribute('style','border:none;background-color:Transparent');
        cellContent.setAttribute('class','modal-trigger');
        cellContent.setAttribute('data-target','fileShow');
        refCopropertyFiles.child("Reports").child(objectFS.id).getDownloadURL().then(function(url) {
          
        cellContent.setAttribute('onclick','showReport('+JSON.stringify(url)+')');
        cellContent.innerHTML = "<font color='#0000FF'>" + object.fileName + "</font>";
        var cell = document.createElement('td');
        cell.appendChild(cellContent);
        objectsRow.appendChild(cell);
        
        cellContent = document.createTextNode(object.type);
        cell = document.createElement('td');
        cell.appendChild(cellContent);
        objectsRow.appendChild(cell);  
        
        cellContent = document.createTextNode(object.date);
        cell = document.createElement('td');
        cell.appendChild(cellContent);
        objectsRow.appendChild(cell); 
        if (currentUser.role == roleAdministrator) {
          cellContent = document.createElement('button');
          cellContent.setAttribute('class','modal-trigger btn-small waves-light red');
          cellContent.setAttribute("data-target", "reportRemove");
          cellContent.setAttribute('onclick','popupRemoveReport('+JSON.stringify(objectFS.id)+','+JSON.stringify(object.fileName)+')');
          var cellButtonIcon = document.createElement('i');
          cellButtonIcon.setAttribute('class','material-icons right');
          cellButtonIcon.innerHTML="delete";           
          cellContent.appendChild(cellButtonIcon);
          cellContent.innerHTML = "Remove";

          cell = document.createElement('td');
          cell.appendChild(cellContent);
          objectsRow.appendChild(cell);    
        };
        reportsTable.appendChild (objectsRow);
        });
      };

      function refreshReports(){
        emptyHTMLSet(reportsTable);
        refCoproperty.collection("Reports").orderBy("date", "desc").get().then(function(objectsFSArray){
          objectsFSArray.forEach(function(objectFS){
            loadReport(objectFS);
          });
        });
      };

      var reportsLoaded = false;
      function loadReports() {
      hideMenu();
      document.getElementById("logo-container").innerHTML = "MyCondos: Reports";
      loadChargesReports();
      if (!reportsLoaded) {
            refreshReports();
            reportsLoaded = true;
          };
      };

      var reportFile;
      function validateReportEntries() {
        var valid = true
        if (!(document.getElementById("report_type_edit").value)) {
          M.toast({html:"Please enter Type"});
          valid=false;
        };
      
        reportFile = document.getElementById('reportFile').files[0];
        let allowed_mime_types = ['application/pdf'];
        let allowed_size_kb = 5000;
        if (reportFile) {
          if(allowed_mime_types.indexOf(reportFile.type) == -1) {
            M.toast({html:"Incorrect file type (only pdf allowed)"});
            valid=false;
          };
          if(reportFile.size > allowed_size_kb*1024) {
            M.toast({html:"File exceeds max size 500KB"});
            valid=false;
          };
        } else {
            M.toast({html:"Please select PDF File"});
            valid=false;
        };
        return valid;
      };

      function getReportEntries() {
        var d = new Date();
        return {
          fileName: reportFile.name,
          type: document.getElementById("report_type_edit").value,
          date: d.toDateString()
        };
      };


      function writeReport() {
        if (validateReportEntries()) {  
          var entries = getReportEntries();
          refCoproperty.collection("Reports").add(entries).then(function(docref) {
            if (reportFile) {
              var fileRef = refCopropertyFiles.child("Reports").child(docref.id);  
              fileRef.put(reportFile).then (function (){});
              M.Modal.getInstance(document.getElementById("reportAdd")).close();
              refreshReports();
            } else {
              M.toast({html:"System error writing file"});
            };
          }).catch(function(error) {
            M.toast({html:"System error writing document: " + error});
          });
        };
      };

      var report_to_remove;
      function popupRemoveReport(report,filename){
        document.getElementById("report_to_remove").innerHTML=filename;
        report_to_remove = report;
      }
      
      function removeReport(report){
        refCoproperty.collection("Reports").doc(report).delete().then(function(){
          refreshReports();
          var fileRef = refCopropertyFiles.child("Reports").child(report);
          fileRef.delete().then(function() {
          }).catch(function(error) {
            M.toast({html:"System error removing report file:" + error});           
          });
          M.Modal.getInstance(document.getElementById("reportRemove")).close();
        }).catch(function(error) {
            M.toast({html:"System error removing report:" + error});
        });
      };

    function emptyFieldsChargesReportAdd() {
      document.getElementById("chargesReport_closeDate").value = "";
      document.getElementById("chargesReport_metersIncluded").value = "";
      var elems = document.querySelectorAll('select');
      M.FormSelect.init(elems);
      M.updateTextFields();
    };
    
    function validateChargesReportAdd() {
        var valid = true
        if (!document.getElementById("chargesReport_closeDate").checkValidity()) {
          M.toast({html:"Please enter accountancy close date"});
          valid=false;
        } else {
          checkDate = checkBookDate(document.getElementById("chargesReport_closeDate").value);
          if (!checkBookDate(document.getElementById("chargesReport_closeDate").value)) {
            M.toast({html:"Accountancy close date must be later than last close date being " + lastCloseDate});
            valid=false;
          };
        };
        return valid;
      };

      function prepareChargesReport() {
      if (validateChargesReportAdd()) {
        var metersIn = (document.getElementById("chargesReport_metersIncluded").value == "Yes");
        generateChargesReport(document.getElementById("chargesReport_closeDate").value, metersIn);
      };
    };

    function loadChargesReport (objectFS){
        var object = objectFS.data();
        if ((!object.confirmed) && (currentUser.role !== roleAdministrator)) {return};
        var objectsRow= document.createElement('tr');
        
        var cellContent = document.createElement("button");
        cellContent.setAttribute('style','border:none;background-color:Transparent');
        cellContent.setAttribute('class','modal-trigger');
        cellContent.setAttribute('data-target','fileShow');
        refCopropertyFiles.child("ChargesReports").child(objectFS.id).getDownloadURL().then(function(url) {
          
        cellContent.setAttribute('onclick','showReport('+JSON.stringify(url)+')');
        cellContent.innerHTML = "<font color='#0000FF'>" + object.startDate + " to " +object.endDate + "</font>";
        var cell = document.createElement('td');
        cell.appendChild(cellContent);
        objectsRow.appendChild(cell);
        
        if (object.metersIncluded) {cellContent = document.createTextNode("Yes");}
        else {cellContent = document.createTextNode("No");};
        cell = document.createElement('td');
        cell.appendChild(cellContent);
        objectsRow.appendChild(cell);  
        
        if (!object.confirmed) {
          cellContent = document.createElement('button');
          cellContent.setAttribute('class','btn-small waves-light');
          cellContent.setAttribute('onclick','popupChargesReportConfirmed('+JSON.stringify(objectFS.id)+')');
          var cellButtonIcon = document.createElement('i');
          cellButtonIcon.setAttribute('class','material-icons right');
          cellButtonIcon.innerHTML="verified_user";           
          cellContent.appendChild(cellButtonIcon);
          cellContent.innerHTML = "Confirm";

          cell = document.createElement('td');
          cell.appendChild(cellContent);
          objectsRow.appendChild(cell);  

          cellContent = document.createElement('button');
          cellContent.setAttribute('class','btn-small waves-light red');
          cellContent.setAttribute('onclick','popupChargesReportRemoved('+JSON.stringify(objectFS.id)+')');
          var cellButtonIcon = document.createElement('i');
          cellButtonIcon.setAttribute('class','material-icons right');
          cellButtonIcon.innerHTML="delete";           
          cellContent.appendChild(cellButtonIcon);
          cellContent.innerHTML = "Remove";

          cell = document.createElement('td');
          cell.appendChild(cellContent);
          objectsRow.appendChild(cell);   

          document.getElementById("ChargesReport_Generate").setAttribute("class", "btn-small waves-light modal-trigger disabled"); 
        };
        chargesReportsTable.appendChild (objectsRow);
        });
      };

      function readCloseAndReguDate (chargesReportsFS) {
        if  (chargesReportsFS.docs.length > 0) {
              lastCloseDate= chargesReportsFS.docs[0].data().endDate;
              var i = 0;
              while ((i < chargesReportsFS.docs.length) && (!chargesReportsFS.docs[i].data().metersIncluded)) {i = i+1};
              if (i < chargesReportsFS.docs.length) {lastReguDate = chargesReportsFS.docs[i].data().endDate}
              else {lastReguDate = currentCoproperty.initialStartDate};
            }
            else {
              lastCloseDate = currentCoproperty.initialStartDate;
              lastReguDate = currentCoproperty.initialStartDate;
            };
      };

      function refreshChargesReports(){
        emptyHTMLSet(chargesReportsTable);
        refCoproperty.collection("ChargesReports").orderBy("endDate","desc").get().then(function(chargesReportsFS){
            readCloseAndReguDate (chargesReportsFS);
            chargesReportsFS.forEach(function(objectFS){
              loadChargesReport(objectFS);
            });
            meterReadingsLoaded = false;
            transactionsLoaded = false;
          });
      };

      var chargesReportsLoaded = false;
      function loadChargesReports() {
      if (!chargesReportsLoaded) {
            refreshChargesReports();
            chargesReportsLoaded = true;
          };
      };

      function popupChargesReportConfirmed(chargesReportId) {
        refCoproperty.collection("ChargesReports").doc(chargesReportId).update({confirmed:true}).then(function(){
          refreshChargesReports();
          document.getElementById("ChargesReport_Generate").setAttribute("class", "btn-small waves-light modal-trigger");
          M.toast({html:"Charges report now visible to owners"});
        }).catch(function(error) {
          M.toast({html:"Error confirming charges report: " + error});
        });
      };

      function popupChargesReportRemoved(chargesReportId) {
        refCoproperty.collection("ChargesReports").doc(chargesReportId).delete().then(function(){
          refCopropertyFiles.child("ChargesReports").child(chargesReportId).delete().then({});
          refreshChargesReports();
          document.getElementById("ChargesReport_Generate").setAttribute("class", "btn-small waves-light modal-trigger");
          M.toast({html:"Charges report removed: correct your data and generate a new charges report anytime"});
        }).catch(function(error) {
          M.toast({html:"Error removing charges report: " + error});
        });
      };

    </script>
    <!--   Transaction scripts start here -->
    <script>
      var transactionsTable = document.getElementById("transactionsTable");
      var distributedAmount = 0;
      var selectedTransactionId;
      function TransactionObject() {
        this.type = "";
        this.costCenter="";
        this.account = "";
        this.name = "";
        this.amount = "";
        this.date = "";
        this.bookDate = "";
        this.communication = "";
        this.distribution= [];
        this.evidence = [];
      };
      var transaction;

      function loadTransaction (objectFS){
          var object = objectFS.data();
          var objectsRow= document.createElement('tr');
          
          var cellContent = document.createElement('button');
          cellContent.setAttribute("data-target", "transactionView");
          cellContent.setAttribute('class','modal-trigger');
          cellContent.setAttribute('style','border:none;background-color:Transparent');
          cellContent.setAttribute('onclick','setSelectedTransaction('+JSON.stringify(objectFS.id)+','+JSON.stringify(object)+')');
          var cellButtonIcon = document.createElement('i');
          cellButtonIcon.setAttribute('class','material-icons right');
          cellButtonIcon.innerHTML="add";           
          cellContent.appendChild(cellButtonIcon);
          cellContent.innerHTML = "<font color='blue'>" + TransTypeRead[object.type] + "</font>";
          var cell = document.createElement('td');
          cell.appendChild(cellContent);
          objectsRow.appendChild(cell);   

          cellContent = document.createTextNode(object.name);
          cell = document.createElement('td');
          cell.appendChild(cellContent);
          objectsRow.appendChild(cell); 

          var amount = object.amount;
          /* totalAmount = totalAmount + amount;*/
          cellContent = document.createTextNode(amount.toLocaleString("nl-BE", currencyStyle));
          cell = document.createElement('td');
          cell.setAttribute("style", "text-align: right"); 
          cell.appendChild(cellContent);
          objectsRow.appendChild(cell);  
          
          cellContent = document.createTextNode(object.bookDate);
          cell = document.createElement('td');
          cell.setAttribute("style", "text-align: right"); 
          cell.appendChild(cellContent);
          objectsRow.appendChild(cell); 
          
          
          refCoproperty.collection("Transactions").doc(objectFS.id).collection("Evidence").get().then(function(objectsFSArray){
            if (objectsFSArray.docs.length > 0) {
              cellContent = document.createElement("i");
              cellContent.setAttribute("class","material-icons  green ");
              cellContent.innerHTML = "done";
            } else {
              cellContent = document.createElement("i");
              cellContent.setAttribute("class","material-icons  red ");
              cellContent.innerHTML = "clear";
            };
          
          cell = document.createElement('td');
          cell.appendChild(cellContent);
          objectsRow.appendChild(cell);
          
          
          transactionsTable.appendChild (objectsRow);
          });
        };
          
        function refreshTransactions(){
          emptyHTMLSet(transactionsTable);
          refCoproperty.collection("Transactions").orderBy("bookDate","desc").get().then(function(objectsFSArray){
              objectsFSArray.forEach(function(objectFS){
                loadTransaction(objectFS);
              });        
            });
        };

        var transactionsLoaded = false;
        function loadTransactions(){
          hideMenu();
          document.getElementById("logo-container").innerHTML = "MyCondos: Transactions";
          if (!transactionsLoaded) {
            refreshTransactions();
            transactionsLoaded = true;
          };
        };
      
      function writeTransaction() {
        if (validateTransactionAdd()) { 
          var entries =  getTransactionEntriesAdd();
          if (entries.type == "PRIVA") {entries.distribution = transaction.distribution;};
          if (selectedTransactionId) {
            refCoproperty.collection("Transactions").doc(selectedTransactionId).set(entries).then(function(docref) {
              refreshTransactions();
              setSelectedTransaction(selectedTransactionId,entries)
              M.Modal.getInstance(document.getElementById("transactionAdd")).close();
            }).catch(function(error) {
              M.toast({html:"Error updating transaction: " + error});
            });
          } else {
            refCoproperty.collection("Transactions").add(entries).then(function(docref) {
              refreshTransactions();
              setSelectedTransaction(docref.id,entries);
              M.Modal.getInstance(document.getElementById("transactionAdd")).close();
              M.Modal.getInstance(document.getElementById("transactionView")).open();
            }).catch(function(error) {
              M.toast({html:"Error adding transaction: " + error});
            });
          };
        };
      };
            
    function copyToBookDate(){
      if (!document.getElementById("transaction_bookDate_add").checkValidity()) {
        document.getElementById("transaction_bookDate_add").value = document.getElementById("transaction_date_add").value;
        M.updateTextFields();
      };
    };
    
    function validateTransactionAdd() {
      var valid = true;
      if (!document.getElementById("transaction_type_add").checkValidity()) {
        M.toast({html:"Please enter type"});
        valid=false;
      };
      if (!document.getElementById("transaction_costCenter_add").checkValidity()) {
        M.toast({html:"Please enter cost center"});
        valid=false;
      };
      if (!document.getElementById("transaction_account_add").checkValidity()) {
        M.toast({html:"Please enter valid account"});
        valid=false;
      };
      if (!document.getElementById("transaction_name_add").checkValidity()) {
        M.toast({html:"Please enter counter party"});
        valid=false;
      };
      if (!document.getElementById("transaction_amount_add").checkValidity()) {
        M.toast({html:"Please enter amount"});
        valid=false;
      };
      if (!document.getElementById("transaction_date_add").checkValidity()) {
        M.toast({html:"Please enter transaction date"});
        valid=false;
      };
      if (!document.getElementById("transaction_bookDate_add").checkValidity()) {
        M.toast({html:"Please enter accountancy date"});
        valid=false;
      }else if (!checkBookDate(document.getElementById("transaction_bookDate_add").value)) {
          M.toast({html:"Accountancy date must be after last close data accountancy"});
          valid=false;
      };
      if (!document.getElementById("transaction_communication_add").checkValidity()) {
        M.toast({html:"Please enter valid communication"});
        valid=false;
      };
      if (document.getElementById("transaction_type_add").value == "PRIVA") {
        var amount = parseFloat(document.getElementById("transaction_amount_add").value);
        if (!(((amount >= distributedAmount) && ((amount - distributedAmount) < 0.05)) ||  ((amount <= distributedAmount) && ((distributedAmount - amount) < 0.05)))) {
          M.toast({html:"Transactaction amount too differnt from total assigned amounts: please correct"});
          valid=false;
        };
      };
      return valid;
    };
    
    function getTransactionEntriesAdd() {
      return {
        type: document.getElementById("transaction_type_add").value,
        costCenter:document.getElementById("transaction_costCenter_add").value,
        account: document.getElementById("transaction_account_add").value,
        name: document.getElementById("transaction_name_add").value,
        amount: Number(document.getElementById("transaction_amount_add").value),
        date: document.getElementById("transaction_date_add").value,
        bookDate: document.getElementById("transaction_bookDate_add").value,
        communication:document.getElementById("transaction_communication_add").value,
      };
    };
    
    function setSelectedTransaction(id,object) {
      selectedTransactionId = id;
      transaction = object;
      document.getElementById("transaction_type").value=TransTypeRead[object.type];
      document.getElementById("transaction_account").value=object.account;
      document.getElementById("transaction_name").value=object.name;
      document.getElementById("transaction_amount").value=object.amount.toLocaleString("nl-BE", currencyStyle);
      document.getElementById("transaction_date").value=object.date;
      document.getElementById("transaction_bookDate").value=object.bookDate;
      document.getElementById("transaction_communication").value=object.communication;
      if (object.type == "PRIVA") {
        transaction.distribution = object.distribution;
        document.getElementById("transaction_properties_frame").style.display = "block";
        showTransactionDistribution();
      } else {
        document.getElementById("transaction_properties_frame").style.display = "none";
      };
      if (checkBookDate(object.bookDate)){document.getElementById("transaction_edit_button").disabled = false}
      else {document.getElementById("transaction_edit_button").disabled = true};
      costCenterGet(object.costCenter).then(function (cc){
        document.getElementById("transaction_costCenter").value = cc.name;
        refreshTransactionEvidence();
      
        var elems = document.querySelectorAll('select');
        M.FormSelect.init(elems);
        M.updateTextFields();
      });
    };    

    function showTransactionDistribution(){
      var htmlTable = document.getElementById("transaction_distribution_table");
      emptyHTMLSet( htmlTable);
      i=0;
      var total = 0;
      transaction.distribution.forEach(function(dis){
      
        propertyGet(dis.property).then(function(p){
          var objectsRow= document.createElement('tr');
          var cellContent = propertyLink(p);
          var cell = document.createElement('td');
          cell.appendChild(cellContent);
          objectsRow.appendChild(cell);

          total = total + dis.amount;
          var cellContent = document.createTextNode(dis.amount.toLocaleString("nl-BE", currencyStyle));
          cell = document.createElement('td');
          cell.appendChild(cellContent);
          objectsRow.appendChild(cell);

          htmlTable.appendChild(objectsRow);
                    
          i = i+1;
          if (i == transaction.distribution.length){
            var objectsRow= document.createElement('tr');
            var cellContent = document.createTextNode("Total");
            var cell = document.createElement('td');cell.style.fontWeight = "bold";
            cell.appendChild(cellContent);
            objectsRow.appendChild(cell);
            cellContent = document.createTextNode(total.toLocaleString("nl-BE", currencyStyle));
            cell = document.createElement('td');cell.style.fontWeight = "bold";
            cell.appendChild(cellContent);
            objectsRow.appendChild(cell);     
            htmlTable.appendChild(objectsRow);
          };
         }).catch(function(error) {
            M.toast({html:"System error loading property in distribution list: " + error});
         });
      });     
    };
    
    function resetSelectedTransaction() {
      selectedTransactionId = null;
      transaction = new TransactionObject();
      document.getElementById("transaction_type_add").value="";
      listCostCenters(document.getElementById("transaction_costCenter_add"), "");
      document.getElementById("transaction_account_add").value="";
      document.getElementById("transaction_name_add").value="";
      document.getElementById("transaction_amount_add").value="";
      document.getElementById("transaction_date_add").value="";
      document.getElementById("transaction_bookDate_add").value="";
      document.getElementById("transaction_communication_add").value="";
      document.getElementById("transaction_properties_add_frame").style.display = "none";
      document.getElementById("transaction_save_button").innerHTML = "Save and go to adding evidence";
      emptyHTMLSet(document.getElementById("transaction_distribution_table_add"));
      var elems = document.querySelectorAll('select');
      M.FormSelect.init(elems);
      M.updateTextFields();  
    };
    function editTransaction(id,object) {
      document.getElementById("transaction_type_add").value=object.type;
      listCostCenters(document.getElementById("transaction_costCenter_add"), object.costCenter);
      document.getElementById("transaction_account_add").value=object.account;
      document.getElementById("transaction_name_add").value=object.name;
      document.getElementById("transaction_amount_add").value=object.amount;
      document.getElementById("transaction_date_add").value=object.date;
      document.getElementById("transaction_bookDate_add").value=object.bookDate;
      document.getElementById("transaction_communication_add").value=object.communication;
      document.getElementById("transaction_save_button").innerHTML = "Save";
      enableSelectProperties();
      var elems = document.querySelectorAll('select');
      M.FormSelect.init(elems);
      M.updateTextFields();
    };

    function listProperties(el, selectedOption) {
      var option;
      emptyHTMLSet(el);
      if (!Boolean(selectedOption)) {
        option = document.createElement("option");
        option.setAttribute("value","");
        option.setAttribute("disabled",true);
        option.setAttribute("selected",true);
        option.innerHTML = "Select Property";
        el.appendChild(option);
      };
      refCoproperty.collection("Properties").get().then(function(querySnapshot) {
        querySnapshot.forEach(function(prFS) {
            option = document.createElement("option");
            option.setAttribute("value",prFS.id);
            if (prFS.id == selectedOption) {option.setAttribute("selected",true);};
            option.innerHTML = prFS.data().code;
            el.appendChild(option);
          });
        M.updateTextFields();
        var elems = document.querySelectorAll('select');        
	      M.FormSelect.init(elems);
      });
    };

    function removeTransactionDistribution(i){
      transaction.distribution.splice(i,1);
      refreshTransactionDistribution();
    };

    function addTransactionDistribution(){
      var valid = true;
      var propertyId = document.getElementById("transaction_properties_add").value;
      if (propertyId == "") {
        M.toast({html:"Please select property"});
        valid=false;
      };
      var amountString = document.getElementById("transaction_distribution_amount_add").value;
      if ((!amountString) || (!(document.getElementById("transaction_distribution_amount_add")).checkValidity())) {
        M.toast({html:"Please enter valid amount"});
        valid=false;
      };
      if (valid){
        transaction.distribution.push({
          property: propertyId,
          propertyCode: ((document.getElementById("transaction_properties_add")).item(document.getElementById("transaction_properties_add").selectedIndex)).innerHTML,
          amount: parseFloat(amountString),
        });
        refreshTransactionDistribution();
      };
    };
    
    function refreshTransactionDistribution(){
      var htmlTable = document.getElementById("transaction_distribution_table_add");
      emptyHTMLSet( htmlTable);
      i=0;
      distributedAmount = 0;
      
      while (i<transaction.distribution.length){
        var transactionData = transaction.distribution[i];
        var objectsRow= document.createElement('tr');
        var cellContent = document.createTextNode(transactionData.propertyCode);
        var cell = document.createElement('td');
        cell.appendChild(cellContent);
        objectsRow.appendChild(cell);

        distributedAmount = distributedAmount + transactionData.amount;
        var cellContent = document.createTextNode(transactionData.amount.toLocaleString("nl-BE", currencyStyle));
        cell = document.createElement('td');
        cell.appendChild(cellContent);
        objectsRow.appendChild(cell);

        cellContent = document.createElement('button');
        cellContent.setAttribute('class','btn-small waves-light red');
        cellContent.setAttribute('style','float: right;margin-left: 20px;margin-bottom: 3px');
        cellContent.setAttribute('onclick','removeTransactionDistribution('+JSON.stringify(i)+')');
        var cellButtonIcon = document.createElement('i');
        cellButtonIcon.setAttribute('class','material-icons right');
        cellButtonIcon.innerHTML="delete";           
        cellContent.appendChild(cellButtonIcon);
        cellContent.innerHTML = "Remove";
        cell.appendChild(cellContent);
        objectsRow.appendChild(cell);

        htmlTable.appendChild(objectsRow);
        i = i+1;
      };
      
      var objectsRow= document.createElement('tr');
      var cellContent = document.createTextNode("Total");
      var cell = document.createElement('td');cell.style.fontWeight = "bold";
      cell.appendChild(cellContent);
      objectsRow.appendChild(cell);
      cellContent = document.createTextNode(distributedAmount.toLocaleString("nl-BE", currencyStyle));
      cell = document.createElement('td');cell.style.fontWeight = "bold";
      cell.appendChild(cellContent);
      objectsRow.appendChild(cell);      
      htmlTable.appendChild(objectsRow);
    };
    
    function enableSelectProperties(){
      if (document.getElementById("transaction_type_add").value == "PRIVA") {
        document.getElementById("transaction_properties_add_frame").style.display = "block";
        document.getElementById("transaction_distribution_amount_add").value = "";
        listProperties(document.getElementById("transaction_properties_add"), "");
        if (!transaction.distribution) {transaction.distribution = [];};
        refreshTransactionDistribution();       
      } else {
        document.getElementById("transaction_properties_add_frame").style.display = "none";
      };
    };

      function emptyTransactionEvidenceFields(){
        document.getElementById("transactionEvidenceFile").value = "";
        document.getElementById("transactionEvidenceFileText").value = "";
        document.getElementById("transactionEvidence_type_edit").value = "";
      };
      

      function loadTransactionEvidence (objectFS){
        var object = objectFS.data();
        var objectsRow= document.createElement('tr');

        var cellContent = document.createElement("button");
        refCopropertyFiles.child("Transactions").child(objectFS.id).getDownloadURL().then(function(url) {
        cellContent.setAttribute('onclick','showReport('+JSON.stringify(url)+')');
        cellContent.setAttribute('style','border:none;background-color:Transparent');
        cellContent.innerHTML = "<font color='#0000FF'>" + object.fileName + "</font>";
        
        var cell = document.createElement('td');
        cell.appendChild(cellContent);
        objectsRow.appendChild(cell);
        
        cellContent = document.createTextNode(object.type);
        cell = document.createElement('td');
        cell.appendChild(cellContent);
        objectsRow.appendChild(cell);  
        if (currentUser.role == roleAdministrator) {
          cellContent = document.createElement('button');
          cellContent.setAttribute('class','modal-trigger btn-small waves-light red');
          cellContent.setAttribute("data-target", "transactionEvidenceRemove");
          cellContent.setAttribute('onclick','popupRemoveTransactionEvidence('+JSON.stringify(objectFS.id)+','+JSON.stringify(object.fileName)+')');
          var cellButtonIcon = document.createElement('i');
          cellButtonIcon.setAttribute('class','material-icons right');
          cellButtonIcon.innerHTML="delete";           
          cellContent.appendChild(cellButtonIcon);
          cellContent.innerHTML = "Remove";

          cell = document.createElement('td');
          cell.appendChild(cellContent);
          objectsRow.appendChild(cell);    
        };
        transactionEvidenceTable.appendChild (objectsRow);
        });
      };

      function refreshTransactionEvidence(){
        emptyHTMLSet(transactionEvidenceTable);
        refCoproperty.collection("Transactions").doc(selectedTransactionId).collection("Evidence").get().then(function(objectsFSArray){
            objectsFSArray.forEach(function(objectFS){
              loadTransactionEvidence(objectFS);
            })
          });
      };

      var transactionEvidenceFile;
      function validateTransactionEvidenceEntries() {
        var valid = true
        if (!(document.getElementById("transactionEvidence_type_edit").value)) {
          M.toast({html:"Please enter Type"});
          valid=false;
        };
      
        transactionEvidenceFile = document.getElementById('transactionEvidenceFile').files[0];
        let allowed_mime_types = ['application/pdf','image/jpeg', 'image/png'];
        let allowed_size_kb = 5000;
        if (transactionEvidenceFile) {
          if(allowed_mime_types.indexOf(transactionEvidenceFile.type) == -1) {
            M.toast({html:"Incorrect file type (only pdf, jpeg and png allowed)"});
            valid=false;
          };
          if(transactionEvidenceFile.size > allowed_size_kb*1024) {
            M.toast({html:"File exceeds max size 500KB"});
            valid=false;
          };
        } else {
            M.toast({html:"Please select PDF File"});
            valid=false;
        };
        return valid;
      };

      function getTransactionEvidenceEntries() {
        return {
          fileName: transactionEvidenceFile.name,
          type: document.getElementById("transactionEvidence_type_edit").value,
        };
      };
      
      function writeTransactionEvidence() {
        if (validateTransactionEvidenceEntries()) {  
          var entries = getTransactionEvidenceEntries();
          refCoproperty.collection("Transactions").doc(selectedTransactionId).collection("Evidence").add(entries).then(function(docref) {
            if (transactionEvidenceFile) {
              var fileRef = refCopropertyFiles.child("Transactions").child(docref.id);  
              fileRef.put(transactionEvidenceFile).then (function (){});
              refreshTransactionEvidence();
              refreshTransactions();
              M.Modal.getInstance(document.getElementById("transactionEvidenceAdd")).close();
            } else {
              M.toast({html:"System error writing file"});
            };
          }).catch(function(error) {
            M.toast({html:"System error writing document: " + error});
          });
        };
      };

      var transactionEvidence_to_remove;
      function popupRemoveTransactionEvidence(transactionEvidence,filename){
        document.getElementById("transactionEvidence_to_remove").innerHTML=filename;
        transactionEvidence_to_remove = transactionEvidence;
      }
      
      function removeTransactionEvidence(transactionEvidence){
        refCoproperty.collection("Transactions").doc(selectedTransactionId).collection("Evidence").doc(transactionEvidence).delete().then(function(){
          refreshTransactionEvidence();
          refreshTransactions();
          var fileRef = refCopropertyFiles.child("Transactions").child(transactionEvidence);
          fileRef.delete().then(function() {
          }).catch(function(error) {
            M.toast({html:"System error removing transaction evidence file:" + error});            
          });
          M.Modal.getInstance(document.getElementById("transactionEvidenceRemove")).close();
        }).catch(function(error) {
            M.toast({html:"System error removing transaction evidence:" + error});
        });
      };

   
    var transactionsLoadFile;
    function validateTransactionsLoadEntries(){
      var valid = true;
      transactionsLoadFile = document.getElementById('transactionLoadFile').files[0];
      let allowed_mime_types = ['application/vnd.ms-excel'];
      let allowed_size_kb = 100;
      if (transactionsLoadFile) {
        if(allowed_mime_types.indexOf(transactionsLoadFile.type) == -1) {
          valid=false;
          M.toast({html:"Incorrect file type (only csv allowed)"});
        };
        if(transactionsLoadFile.size > allowed_size_kb*1024) {
          valid=false;
          M.toast({html:"File exceeds max size 100KB"});
          
        };
      } else {
          valid=false;
          M.toast({html:"Please select CSV File"});       
      };
      return valid;
    };
    
    function emptyTransactionLoadFields(){
      if (transactionRules.length == 0) {refreshTransactionRules();};
      document.getElementById("transactionLoadFile").value = "";
      document.getElementById("transactionLoadFileText").value = "";
    };

    function argentaCsvToArray(str, delimiter = ";") {
    // slice from \n index + 1 to the end of the text
    // use split to create an array of each csv value row
    var rows = str.slice(str.indexOf("\n") + 1).split("\n");
    rows.pop();

    const arr = rows.map(function (row) {
      const values = row.split(delimiter);
      var resultRow = {};
      resultRow.type = "TBSET";
      resultRow.account = values[8];
      resultRow.name = values[9];
      resultRow.amount = values[5].replace(".","").replace(",",".");
      var trDate = values[7];
      resultRow.date = trDate.substring(6,10) + "-" + trDate.substring(3,5) + "-" + trDate.substring(0,2);
      resultRow.bookDate = resultRow.date;
      resultRow.communication = values[10];
      return resultRow;
    });

    // return the array
    //arr.pop();
    return arr;
    };

    function appendTransactionRow(object){
      function createMyCell(myText) {
        var cellContent = document.createTextNode(myText);
        var cell = document.createElement('td');
        cell.appendChild(cellContent);
        return cell;
      };
      
      var objectsRow = document.createElement('tr');
      objectsRow.appendChild(createMyCell(object.type));
      objectsRow.appendChild(createMyCell(object.name));
      objectsRow.appendChild(createMyCell(object.amount));
      objectsRow.appendChild(createMyCell(object.date));
      objectsRow.appendChild(createMyCell(object.account));
      objectsRow.appendChild(createMyCell(object.communication));
      
      transactionsLoadConfirmTable.appendChild (objectsRow);
    };
    
    function applyTransactionRule(el) {
      var i = 0;
      while (i < transactionRules.length) {
        if (transactionRules[i].account == el.account) {
          el.type = transactionRules[i].type;
          if ((transactionRules[i].type == "Owner Payment") && (transactionRules[i].owner)){
            el.owner = transactionRules[i].owner;
          };
          return el;
        };
        i += 1;
      };
      return el;

    };
    
    var transactionsBatchData;
    function loadTransactionsFile() {
      if (validateTransactionsLoadEntries()) {  
        M.Modal.getInstance(document.getElementById("transactionLoad")).close();
        M.Modal.getInstance(document.getElementById("transactionLoadConfirm")).open();
        const reader = new FileReader();

        reader.onload = function (e) {
          const text = e.target.result;
          transactionsBatchData = argentaCsvToArray(text);
          emptyHTMLSet(transactionsLoadConfirmTable);
          transactionsBatchData.map(function(el){
            appendTransactionRow(applyTransactionRule(el));
          });
        };
      
        reader.readAsText(transactionsLoadFile);
      };
    };

    
    function writeTransactionsFile(){

      var batch = firestore.batch();
      transactionsBatchData.map(function(el){
        var docRef = refCoproperty.collection("Transactions").doc();
        batch.set(docRef, el);
      });
      batch.commit().then(function() {
        refreshTransactions();
        M.Modal.getInstance(document.getElementById("transactionLoadConfirm")).close();
      }).catch(function(error) {
        M.toast({html:"System error loading transactions: " + error});
      });
    };

    </script>
    <!-- TransactionRules scripts start here-->
    <script>
      function loadTransactionRule(objectFS){
        var object = objectFS.data();
          var objectsRow= document.createElement('tr');
          
          var cellContent = document.createElement('button');
          cellContent.setAttribute("data-target", "transactionRuleEdit");
          cellContent.setAttribute('class','modal-trigger');
          cellContent.setAttribute('style','border:none;background-color:Transparent');
          cellContent.setAttribute('onclick','setSelectedTransactionRule('+JSON.stringify(objectFS.id)+','+JSON.stringify(object)+')');
          cellContent.innerHTML = "<font color='blue'>" + object.account + "</font>";
          var cell = document.createElement('td');
          cell.appendChild(cellContent);
          objectsRow.appendChild(cell);   

          if (object.communication) {cellContent = document.createTextNode(object.communication);}
          else {cellContent = document.createTextNode("");};
          cell = document.createElement('td');
          cell.appendChild(cellContent);
          objectsRow.appendChild(cell); 

          cellContent = document.createTextNode(TransTypeRead[object.type]);
          cell = document.createElement('td');
          cell.appendChild(cellContent);
          objectsRow.appendChild(cell);
          
          cellContent = document.createTextNode("");
          var ownerCell = document.createElement('td');
          ownerCell.setAttribute("style","white-space: nowrap");
          ownerCell.appendChild(cellContent);
          objectsRow.appendChild(cell);
          
          transactionRulesTable.appendChild (objectsRow);
          if (Boolean(object.owner)) {
            refCoproperty.collection("Members").doc(object.owner).get().then(function(ownerFS) {
              ownerCell.removeChild(ownerCell.firstChild);
              //ownerCell.appendChild(memberLink(ownerFS));
              var x = document.createTextNode("tttt");
              ownerCell.appendChild(x);
            }).catch(function(error) {
              console.log("Error getting owner:", error);
            });
          };

      };
      
      
      var transactionRules = [];
      function refreshTransactionRules(){
        emptyHTMLSet(transactionRulesTable);
        transactionRules = [];
        refCoproperty.collection("TransactionRules").get().then(function(objectsFSArray){
          objectsFSArray.forEach(function(objectFS){
            loadTransactionRule(objectFS);
            transactionRules.push(objectFS.data());
          });
        });
      };

      var transactionRulesLoaded = false;
      function loadTransactionRules(){
          hideMenu();
          document.getElementById("logo-container").innerHTML = "MyCondos: Transaction Rules";
          if (!transactionRulesLoaded) {
            refreshTransactionRules();
            transactionRulesLoaded = true;
          };
        };

      var selectedTransactionRuleId;
      var transactionRule;
      function resetSelectedTransactionRule(){
        var trR = 
          {
          type: "",
          costCenter:"",
          account: "",
          name: "",
          communication:"",
          owner:"",
          };
          setSelectedTransactionRule(null,trR)

      };

      function setSelectedTransactionRule(id,object) {
        selectedTransactionRuleId = id;
        document.getElementById("transactionRule_type").value=object.type;
        listCostCenters(document.getElementById("transactionRule_costCenter"),object.costCenter)
        document.getElementById("transactionRule_account").value=object.account;
        document.getElementById("transactionRule_name").value=object.name;
        document.getElementById("transactionRule_communication").value=object.communication;
        listMembers(document.getElementById("transactionRule_owner"), object.owner);
        if (id) {document.getElementById("transactionRuleDeleteButton").style = "float: right;margin-left: 20px;margin-bottom: 3px;display:block"}
        else {document.getElementById("transactionRuleDeleteButton").style = "float: right;margin-left: 20px;margin-bottom: 3px;display:none"};
        var elems = document.querySelectorAll('select');
        M.FormSelect.init(elems);
        M.updateTextFields();
      };

      function validateTransactionRule(){
        var valid = true;
        if (!document.getElementById("transactionRule_type").checkValidity()) {
          M.toast({html:"Please enter type"});
          valid=false;
        };
        if (!document.getElementById("transactionRule_costCenter").checkValidity()) {
          M.toast({html:"Please enter type"});
          valid=false;
        };
        if (!document.getElementById("transactionRule_account").checkValidity()) {
          M.toast({html:"Please enter valid account"});
          valid=false;
        };
        if (!document.getElementById("transactionRule_name").checkValidity()) {
          M.toast({html:"Please enter counter party"});
          valid=false;
        };
        if (!document.getElementById("transactionRule_communication").checkValidity()) {
          M.toast({html:"Please enter valid communication"});
          valid=false;
        };
        if ((document.getElementById("transactionRule_type").value == "Owner Payment") && (!document.getElementById("transactionRule_owner").value)) {
          M.toast({html:"Please select owner"});
          valid=false;
        };
        if ((document.getElementById("transactionRule_type").value != "Owner Payment") && (document.getElementById("transactionRule_owner").value)) {
          M.toast({html:"Owner only allowed for Owner Payment"});
          valid=false;
        };
        return valid;
      };
      
      function getTransactionRuleEntries(){
        return {
          type: document.getElementById("transactionRule_type").value,
          costCenter: document.getElementById("transactionRule_costCenter").value,
          account: document.getElementById("transactionRule_account").value,
          name: document.getElementById("transactionRule_name").value,
          communication:document.getElementById("transactionRule_communication").value,
          owner:document.getElementById("transactionRule_owner").value,
        };
      };
      
      function writeTransactionRule(){
        if (validateTransactionRule()) { 
          var entries =  getTransactionRuleEntries();
          if (selectedTransactionRuleId) {
            refCoproperty.collection("TransactionRules").doc(selectedTransactionRuleId).set(entries).then(function(docref) {
              refreshTransactionRules();
              M.Modal.getInstance(document.getElementById("transactionRuleEdit")).close();
            }).catch(function(error) {
              M.toast({html:"Error updating transaction rule: " + error});
            });
          } else {
            refCoproperty.collection("TransactionRules").add(entries).then(function(docref) {
              refreshTransactionRules();
              M.Modal.getInstance(document.getElementById("transactionRuleEdit")).close();
            }).catch(function(error) {
              M.toast({html:"Error adding transaction rule: " + error});
            });
          };
        };
      };

      function deleteTransactionRule(){
        refCoproperty.collection("TransactionRules").doc(selectedTransactionRuleId).delete().then(function(){
          refreshTransactionRules();
          M.Modal.getInstance(document.getElementById("transactionRuleEdit")).close();
        }).catch(function(error) {
            M.toast({html:"System error removing transaction rule:" + error});
        });
      };

    </script>
    <!--   Meter readings scripts start here -->
    <script>
      var meterReadingsTable = document.getElementById("meterReadingsTable");
      var meterReadingsLoaded = false;

      function loadMeterReading(property, meterFS){
        var objectsRow= document.createElement('tr');
        var cellContent;
        var cell;
        
        var meterData = meterFS.data();
        if (meterData.readings[0].date.localeCompare(lastReguDate) < 1) {
          /* newest reading is in closed period: fake empty record */
          meterData.readings.unshift({
            counter : meterData.readings[0].counter + 1,
            picture : false,
            reading : "",
            date: "",
          });
        };
        cellContent = document.createElement('button');
        var isOwner;
        if (property) {
          isOwner = (currentUser.id == property.owner);
          idHere = property.idFS;
          codeHere = property.code}
        else {
          isOwner = false;
          idHere =  currentCopropertyId;
          codeHere = "Common Parts";
        };

        if (currentUser.role == roleAdministrator || isOwner) {
          cellContent.setAttribute("data-target", "meterReadingWrite");
            cellContent.setAttribute('onclick','setSelectedMeterReading_edit('+JSON.stringify(idHere)+','+JSON.stringify(codeHere)+','+JSON.stringify(meterFS.id)+','+JSON.stringify(meterData)+')');
        } else {
          cellContent.setAttribute("data-target", "meterReadingRead");
          cellContent.setAttribute('onclick','setSelectedMeterReading_readonly('+JSON.stringify(idHere)+','+JSON.stringify(codeHere)+','+JSON.stringify(meterFS.id)+','+JSON.stringify(meterData)+')');
        };
        cellContent.setAttribute('class','modal-trigger');
        cellContent.setAttribute('style','border:none;background-color:Transparent');
        cellContent.innerHTML = "<font color='blue'>" + MeterType[meterData.type] + "</font>";
        cell = document.createElement('td');
        cell.appendChild(cellContent);
        objectsRow.appendChild(cell);  

        if (property) {cellContent = propertyLink(property);}
        else {
            /*cellContent = document.createElement();
            cellContent.innerHTML ="Common <br> Parts";*/
            cellContent = document.createTextNode("Common Parts");
          };
        cell = document.createElement('td');
        cell.appendChild(cellContent);
        objectsRow.appendChild(cell);
        
        if (meterData.readings[0].reading) {
           cellContent = document.createElement("i");
           cellContent.setAttribute("class","material-icons  green ");
           cellContent.innerHTML = "done";
        } else {
          cellContent = document.createElement("i");
           cellContent.setAttribute("class","material-icons  red ");
           cellContent.innerHTML = "clear";
        };
        cell = document.createElement('td');
        cell.setAttribute("align","center");
        cell.appendChild(cellContent);
        objectsRow.appendChild(cell);  

        if (meterData.readings[0].picture) {
           /*cellContent = document.createTextNode("&#10060;");*/
           cellContent = document.createElement("i");
           cellContent.setAttribute("class","material-icons  green ");
           cellContent.innerHTML = "done";
        } else {
          cellContent = document.createElement("i");
           cellContent.setAttribute("class","material-icons  red ");
           cellContent.innerHTML = "clear";
        };
        cell = document.createElement('td');
        cell.setAttribute("align","center");
        cell.appendChild(cellContent);
        objectsRow.appendChild(cell);  

        cellContent = document.createTextNode(meterData.readings[0].date);
        cell = document.createElement('td');
        cell.appendChild(cellContent);
        objectsRow.appendChild(cell);

        meterReadingsTable.appendChild (objectsRow);
      };
      
      function refreshMeterReadings(){
        emptyHTMLSet(meterReadingsTable);
        propertiesGet().then(function(ps){
          ps.forEach(function(p){
            refCoproperty.collection("Properties").doc(p.idFS).collection("Meters").orderBy("type").get().then(function(meterFSArray){
              meterFSArray.forEach(function(meterFS){
                if (meterFS.data().status.normalize() === "ACTIF".normalize()) {loadMeterReading(p,meterFS);};
              });
            });
          });  
          refCoproperty.collection("Meters").orderBy("type").get().then(function(meterFSArray){
            meterFSArray.forEach(function(meterFS){
              if (meterFS.data().status.normalize() === "ACTIF".normalize()) {loadMeterReading(null,meterFS);};
            });
          });
        });    
      };
      /*
      function refreshMeterReadings(){
        emptyHTMLSet(meterReadingsTable);
        refCoproperty.collection("Properties").orderBy("code").get().then(function(propertyFSArray){
          propertyFSArray.forEach(function(propertyFS){
            refCoproperty.collection("Properties").doc(propertyFS.id).collection("Meters").orderBy("type").get().then(function(meterFSArray){
              meterFSArray.forEach(function(meterFS){
                if (meterFS.data().status.normalize() === "ACTIF".normalize()) {loadMeterReading(propertyFS,meterFS);};
              });
            });
          });  
          refCoproperty.collection("Meters").orderBy("type").get().then(function(meterFSArray){
            meterFSArray.forEach(function(meterFS){
              if (meterFS.data().status.normalize() === "Active".normalize()) {loadMeterReading(null,meterFS);};
            });
          });
        });    
      };
      */
      function loadMeterReadings() {
        hideMenu();
        document.getElementById("logo-container").innerHTML = "MyCondos:Meter Readings";
        if (!meterReadingsLoaded) {
          refreshMeterReadings();
          meterReadingsLoaded = true;
        };
      };

      var selectedReadingId;
      var selectedReadingData;
      var selectedReadingPropertyId;
      var picturePresent;
      function setSelectedMeterReading_edit(propertyId, propertyCode,readingID, readingData){
        selectedReadingId = readingID;
        selectedReadingPropertyId = propertyId;
        selectedReadingData = readingData;
        document.getElementById("meterReading_property_edit").value = propertyCode;
        document.getElementById("meterReading_type_edit").value = readingData.type;
        document.getElementById("meterReading_id_edit").value = readingData.meter;
        document.getElementById("meterReading_lastReading_edit").value = readingData.readings[1].reading;
        document.getElementById("meterReading_reading_edit").value = readingData.readings[0].reading;
        document.getElementById("meterReading_date_edit").value = readingData.readings[0].date;
        emptyHTMLSet(document.getElementById("meterReading_picture"));
        emptyHTMLSet(document.getElementById("meterReading_picture_show_edit"));
        if (readingData.readings[0].picture) {
          refCopropertyFiles.child(selectedReadingPropertyId).child("Meters").child(selectedReadingId).child((readingData.readings[0].counter).toString()).getDownloadURL().then(function(url) {
            var imgEl = document.createElement("img");
            imgEl.setAttribute("width","400");
            imgEl.setAttribute("height","300");
            imgEl.setAttribute("src",url);
            document.getElementById("meterReading_picture_show_edit").appendChild(imgEl);
            document.getElementById("meterReading_picture_frame_edit").setAttribute("class","displayBlock");
            document.getElementById("meterReading_picture_form").setAttribute("class","displayHidden");
            picturePresent= true;
          });
        } else {
          document.getElementById("meterReading_picture_form").setAttribute("class","displayBlock");
          document.getElementById("meterReading_picture_frame_edit").setAttribute("class","displayHidden");
          document.getElementById("meterReading_picture_file").value = "";
          document.getElementById("meterReading_picture_text").value = "";
          picturePresent= false;
        };
        M.updateTextFields();
      };

      function setSelectedMeterReading_readonly(propertyId, propertyData,readingID, readingData){
        selectedReadingId = readingID;
        selectedReadingPropertyId = propertyId;
        document.getElementById("meterReading_property").value = propertyData.code;
        document.getElementById("meterReading_type").value = readingData.type;
        document.getElementById("meterReading_id").value = readingData.meter;
        document.getElementById("meterReading_lastReading").value = readingData.readings[1].reading;
        document.getElementById("meterReading_reading").value = readingData.readings[0].reading;
        document.getElementById("meterReading_date").value = readingData.readings[0].date;
        emptyHTMLSet(document.getElementById("meterReading_picture"));
        emptyHTMLSet(document.getElementById("meterReading_picture_show"));
        if (readingData.readings[0].picture) {
          refCopropertyFiles.child(selectedReadingPropertyId).child("Meters").child(selectedReadingId).child((readingData.readings[0].counter).toString()).getDownloadURL().then(function(url) {
            var imgEl = document.createElement("img");
            imgEl.setAttribute("width","400");
            imgEl.setAttribute("height","300");
            imgEl.setAttribute("src",url);
            document.getElementById("meterReading_picture_show").appendChild(imgEl);
            document.getElementById("meterReading_picture_frame").setAttribute("class","displayBlock");
            picturePresent= "Y";
          });
        } else {
          document.getElementById("meterReading_picture_frame").setAttribute("class","displayHidden");
          picturePresent= "";
        };
        M.updateTextFields();
      };

      function removePicture(){
        document.getElementById("meterReading_picture_form").setAttribute("class","displayBlock");
        document.getElementById("meterReading_picture_frame_edit").setAttribute("class","displayHidden");
        document.getElementById("meterReading_picture_file").value = "";
        document.getElementById("meterReading_picture_text").value = "";
        picturePresent = "";
        M.Modal.getInstance(document.getElementById("pictureRemove")).close();
      };
      
      function validateMeterReading(){
        var valid= true;
        if (!document.getElementById("meterReading_reading_edit").checkValidity()) {
          M.toast({html:"Please enter valid reading"});
          valid=false;
        };
        if (!document.getElementById("meterReading_date_edit").checkValidity()) {
          M.toast({html:"Please enter Reading Date"});
          valid=false;
        } else if (lastReguDate.localeCompare((document.getElementById("meterReading_date_edit").value)) != -1) {
          M.toast({html:"Reading date must be after last meters regulation date"});
          valid=false;
        };
        var readingPicture = document.getElementById('meterReading_picture_file').files[0];
        let allowed_mime_types = [ 'image/jpeg', 'image/png' ];
        let allowed_size_kb = 500;
        if (readingPicture) {
          if(allowed_mime_types.indexOf(readingPicture.type) == -1) {
            M.toast({html:"Incorrect file type (only jpeg or png allowed)"});
            valid=false;
          };
          if(readingPicture.size > allowed_size_kb*1024) {
            M.toast({html:"Picture exceeds max size 500KB"});
            valid=false;
          };
        }
        return valid;
      };

      function writeMeterReading(){
        var pictureFileText = document.getElementById("meterReading_picture_text").value;
        if (validateMeterReading()) {
          var thisReading = selectedReadingData.readings[0];
          thisReading.reading = document.getElementById("meterReading_reading_edit").value;
          thisReading.date = document.getElementById("meterReading_date_edit").value;
          var thisRefFS;
          if (selectedReadingData.coproperty){thisRefFS = refCoproperty}
          else {thisRefFS = refCoproperty.collection("Properties").doc(selectedReadingPropertyId)};
          if (pictureFileText) { 
            // A new picture has been attached
            thisReading.picture= true;
            thisRefFS.collection("Meters").doc(selectedReadingId).update({readings:selectedReadingData.readings}).then(function() {
              var pictureFile = document.getElementById('meterReading_picture_file').files[0];
              var fileRef = refCopropertyFiles.child(selectedReadingPropertyId).child("Meters").child(selectedReadingId).child((thisReading.counter).toString());  
              fileRef.put(pictureFile).then (function (){});
              refreshMeterReadings();
              M.Modal.getInstance(document.getElementById("meterReadingWrite")).close();
            }).catch(function(error) {
              M.toast({html:"Error occurred updating meter reading:" + error}); 
            });
          } else {
            // No new picture attached: either existing picture or no picture or pictuture was removed
            thisReading.picture= picturePresent;
            thisRefFS.collection("Meters").doc(selectedReadingId).update({readings:selectedReadingData.readings}).then(function(docref) {
              refreshMeterReadings();
              M.Modal.getInstance(document.getElementById("meterReadingWrite")).close();
            }).catch(function(error) {
              M.toast({html:"Error occurred updating meter reading:" + error}); 
            });
          }
        };
      };
    </script>
    <!--   Members scripts start here -->
    <script>
      function insertAdrressCoproperty(){
        refCoproperty.get().then(function(copropertyFS){
          var object = copropertyFS.data();
          document.getElementById("member_country_edit").value=object.country;
          document.getElementById("member_zip_edit").value=object.zip;
          document.getElementById("member_town_edit").value=object.town;
          document.getElementById("member_street_edit").value=object.street;
          document.getElementById("member_houseNumber_edit").value=object.houseNumber;
          /*M.updateTextFields();*/
        });
      };
      
      function memberLink(memberFS) {
        var memberData = memberFS.data();
        var elA = document.createElement('button');
        elA.setAttribute("data-target", "memberView");
        elA.setAttribute('class','modal-trigger');
        elA.setAttribute('style','border:none;background-color:Transparent');
        elA.setAttribute('onclick','setSelectedMember('+JSON.stringify(memberFS.id)+','+JSON.stringify(memberData)+',"")');
        elA.innerHTML = "<font color='#0000FF'>"+memberData.firstName+"   "+memberData.lastName+"</font>";
        return elA;
      };

      var membersTable = document.getElementById("membersTable");
      function loadMember (objectFS){
        var object = objectFS.data();
        var objectsRow= document.createElement('tr');
        var cellContent = memberLink(objectFS);
        var cell = document.createElement('td');
        cell.setAttribute("style","white-space: nowrap");
        cell.appendChild(cellContent);
        objectsRow.appendChild(cell);
        
        cellContent = document.createTextNode(object.email);
        cell = document.createElement('td');
        cell.appendChild(cellContent);
        objectsRow.appendChild(cell);  

        cellContent = document.createTextNode(object.phoneMobile);
        cell = document.createElement('td');
        cell.appendChild(cellContent);
        objectsRow.appendChild(cell);  

        membersTable.appendChild (objectsRow);
      };
      
      function refreshMembers() {
        emptyHTMLSet(membersTable);
        refCoproperty.collection("Members").orderBy("firstName").get().then(function(objectsFSArray){
          objectsFSArray.forEach(function(objectFS){
            loadMember(objectFS);
          });  
        });    
      };

      var membersLoaded = false;
      function loadMembers(){
        hideMenu();
        document.getElementById("logo-container").innerHTML = "MyCondos: Members";
        if (!membersLoaded) {
          refreshMembers();
          membersLoaded = true;
        };
      };

      function addMember(member){
        refCoproperty.collection("Members").add(member)
          .then(function(docref) {
            refreshMembers();
            M.Modal.getInstance(document.getElementById("memberWrite")).close();
          }).catch(function(error) {
            M.toast({html:"Error occurred adding this member:" + error}); 
          });
      };

      function updateMember(member){
        refCoproperty.collection("Members").doc(selectedMemberId).update(member)
          .then(function(docref) {
            refreshMembers();
            setSelectedMember(selectedMemberId,getMemberEntries(),"");
            M.Modal.getInstance(document.getElementById("memberWrite")).close();
          }).catch(function(error) {
            M.toast({html:"Error occurred updating this member:" + error}); 
          });
      };

      
      function writeMember() {
        if (validateMemberEntries()) {  
          var entries = getMemberEntries();
          if (mode === "add"){
            if (entries.email) {
              refCoproperty.collection("Members").where("email", "==", entries.email).get()
                .then(function(existingList) {
                  if (existingList.docs.length > 0) {
                    M.toast({html:"Error: member with this email already exists"}); 
                  } else {addMember(entries);};
                }) .catch (function(error) {
                  M.toast({html:"Error occurred checking email uniqueness:" + error}); 
                });
            } else {
                    addMember(entries);
            };
          } else {
            if ((entries.email) && (! (entries.email.normalize() === selectedMemberObject.email.normalize()))) {
              refCoproperty.collection("Members").where("email", "==", entries.email).get()
                .then(function(existingList) {
                  if (existingList.docs.length > 0) {
                    M.toast({html:"Error: member with this email already exists"}); 
                  } else {
                      updateMember(entries);
                    };
                }) .catch (function(error) {
                  M.toast({html:"Error occurred checking email uniqueness:" + error}); 
                });
            } else {
                    updateMember(entries);
            };
          };
        };
      };        

        function getMemberEntries() {
          return {
                firstName: document.getElementById("member_firstName_edit").value,
                lastName: document.getElementById("member_lastName_edit").value,
                email: document.getElementById("member_email_edit").value,
                phoneHome: document.getElementById("member_phoneHome_edit").value,
                phoneMobile: document.getElementById("member_phoneMobile_edit").value,
                country: document.getElementById("member_country_edit").value,
                zip: document.getElementById("member_zip_edit").value,
                town: document.getElementById("member_town_edit").value,
                street: document.getElementById("member_street_edit").value,
                houseNumber: document.getElementById("member_houseNumber_edit").value,
                bus: document.getElementById("member_bus_edit").value
          };
        };
        
        function propertyJump (propertyId, propertyObject){
          
          M.Modal.getInstance(document.getElementById("memberView")).close();
          setSelectedProperty(propertyId,propertyObject,"");
        };

        
        function propertyLinkFromMemberView(property) {
          var elA = document.createElement('a');
          elA.setAttribute("data-target", "propertyView");
          elA.setAttribute('class','btn-flat modal-trigger');
          elA.setAttribute('onclick','propertyJump('+JSON.stringify(property.id)+','+JSON.stringify(property.data())+')');
          elA.innerHTML = "<font color='blue'>"+property.data().code+"</font>"+ "  ";
          return elA;
        };

        
        
        var mode;
        var selectedMemberId;
        var selectedMemberObject;
        function setSelectedMember(id,object,modeArg) {
          selectedMemberId=id;
          selectedMemberObject=object;
          mode="edit";
          document.getElementById("member_firstName"+modeArg).value=object.firstName;
          document.getElementById("member_lastName"+modeArg).value=object.lastName;
          document.getElementById("member_email"+modeArg).value=object.email;
          document.getElementById("member_phoneHome"+modeArg).value=object.phoneHome;
          document.getElementById("member_phoneMobile"+modeArg).value=object.phoneMobile;
          document.getElementById("member_country"+modeArg).value=object.country;
          document.getElementById("member_zip"+modeArg).value=object.zip;
          document.getElementById("member_town"+modeArg).value=object.town;
          document.getElementById("member_street"+modeArg).value=object.street;
          document.getElementById("member_houseNumber"+modeArg).value=object.houseNumber;
          document.getElementById("member_bus"+modeArg).value=object.bus;
          if (!modeArg) {
            var ownerOfEl = document.getElementById("member_ownerOf");
            emptyHTMLSet(ownerOfEl);
            refCoproperty.collection("Properties").where("owner", "==", id).get().then (function (querySnapshot){
              querySnapshot.forEach (function (property) {
                ownerOfEl.appendChild(propertyLinkFromMemberView(property));
              });
            });
            var occupantOfEl = document.getElementById("member_occupantOf");
            emptyHTMLSet(occupantOfEl);
            refCoproperty.collection("Properties").get().then (function (querySnapshotProperties){
              querySnapshotProperties.forEach (function (property) {
                property.ref.collection("Occupants").where("occupant", "==", id).get().then (function (querySnapshotOccupants){
                  if (querySnapshotOccupants.docs.length > 0) {
                    occupantOfEl.appendChild(propertyLinkFromMemberView(property));
                  };
                });
              });
            });
          };
          M.updateTextFields();
        };

        function resetSelectedMember() {
          selectedMemberId=null;
          selectedMemberObject=null;
          mode="add";
          document.getElementById("member_firstName_edit").value="";
          document.getElementById("member_lastName_edit").value="";
          document.getElementById("member_email_edit").value="";
          document.getElementById("member_phoneHome_edit").value="";
          document.getElementById("member_phoneMobile_edit").value="";
          document.getElementById("member_country_edit").value="";
          document.getElementById("member_zip_edit").value="";
          document.getElementById("member_town_edit").value="";
          document.getElementById("member_street_edit").value="";
          document.getElementById("member_houseNumber_edit").value="";
          document.getElementById("member_bus_edit").value="";
          M.updateTextFields();
        };

        function validateMemberEntries() {
              var valid= true;
              if (!document.getElementById("member_firstName_edit").checkValidity()) {
                M.toast({html:"Please enter First Name"});
                valid=false;
              };
              if (!document.getElementById("member_lastName_edit").checkValidity()) {
                M.toast({html:"Please enter Last Name"});
                valid=false;
              };
              if (!document.getElementById("member_email_edit").checkValidity()) {
                M.toast({html:"Please enter valid Email"});
                valid=false;
              };
              if (!document.getElementById("member_phoneHome_edit").checkValidity()) {
                M.toast({html:"Please enter valid Phone Home"});
                valid=false;
              };
              if (!document.getElementById("member_phoneMobile_edit").checkValidity()) {
                M.toast({html:"Please enter valid Mobile"});
                valid=false;
              };
              if (!document.getElementById("member_zip_edit").checkValidity()) {
                M.toast({html:"Please enter valid Zip"});
                valid=false;
              };
              if (!document.getElementById("member_bus_edit").checkValidity()) {
                M.toast({html:"Please enter valid Bus"});
                valid=false;
              };
              return valid;
        };
    </script>
    <!--   Properties scripts start here -->
    <script>
      var propertiesLoaded = false;
      var properties = null;
      async function propertiesGet(){
        if (properties) {return properties;}
        else {
          var querySnapshot = await refCoproperty.collection("Properties").orderBy("code").get();
          properties = [];
          querySnapshot.forEach(function(objectFS) {
            var thisObject = objectFS.data();
            thisObject.idFS = objectFS.id;
            properties.push(thisObject);
          });
          return properties;
        };
      }; 
      async function propertyGet(idFS){
        function checkId(p){return p.idFS == idFS};
        var ps = await propertiesGet();
        return ps.find(checkId);
      };
      
      var propertiesTable = document.getElementById("propertiesTable");

      function loadProperty (object){
        var objectsRow= document.createElement('tr');
        var cellContent = propertyLink(object);
        var cell = document.createElement('td');
        cell.appendChild(cellContent);
        objectsRow.appendChild(cell);
        
        totalQuotas = totalQuotas + parseInt(object.quota);
        cellContent = document.createTextNode(object.quota);
        cell = document.createElement('td');
        cell.appendChild(cellContent);
        objectsRow.appendChild(cell);  
        
        cellContent = document.createTextNode(PropType[object.type]);
        cell = document.createElement('td');
        cell.appendChild(cellContent);
        objectsRow.appendChild(cell); 
        
        cellContent = document.createTextNode("");
        var ownerCell = document.createElement('td');
        ownerCell.setAttribute("style","white-space: nowrap");
        ownerCell.appendChild(cellContent);
        objectsRow.appendChild(ownerCell); 

        propertiesTable.appendChild (objectsRow);

        if (Boolean(object.owner)) {
          refCoproperty.collection("Members").doc(object.owner).get().then(function(ownerFS) {
            ownerCell.removeChild(ownerCell.firstChild);
            ownerCell.appendChild(memberLink(ownerFS));
          }).catch(function(error) {
            console.log("Error getting document:", error);
          });
        }; 
      };

      function refreshProperties() {
        emptyHTMLSet(propertiesTable);
        propertiesGet().then(function(ps){
          ps.forEach(function(p){loadProperty(p);});
        });
      };

      var propertiesLoaded = false;
      function loadProperties(){
          hideMenu();
          document.getElementById("logo-container").innerHTML = "MyCondos: Properties";
        if (!propertiesLoaded) {
          refreshProperties();
          propertiesLoaded = true;
        };
      };

      function propertyLink(property) {
        var elA = document.createElement('button');
        elA.setAttribute("data-target", "propertyView");
        elA.setAttribute('class','modal-trigger');
        elA.setAttribute('style','border:none;background-color:Transparent');
        elA.setAttribute('onclick','setSelectedProperty('+JSON.stringify(property.idFS)+','+JSON.stringify(property)+',"")');
        elA.innerHTML = "<font color='#0000FF'>"+property.code+"</font>";
        return elA;
      };

      function addProperty(){
       if (validateAddPropertyEntries()) {  
        var entries = getAddPropertyEntries();
        refCoproperty.collection("Properties").where("code", "==", entries.code).get().then(function(existingList) {
            if (existingList.docs.length > 0) {
              M.toast({html:"Error: property with this code already exists"}); 
            } else {
              refCoproperty.collection("Properties").add(entries).then(function(pFS) {
                  refreshProperties();
                  setSelectedProperty(pFS.id, entries);
                  M.Modal.getInstance(document.getElementById("propertyAdd")).close();
                  M.Modal.getInstance(document.getElementById("propertyView")).open();
                }).catch(function(error) {
                  M.toast({html:"Error occurred adding this property:" + error}); 
                });
            };
          }).catch (function(error) {
            M.toast({html:"Error occurred checking code uniqueness:" + error}); 
          });
       };
      };

      function updateProperty(property){
        refCoproperty.collection("Properties").doc(selectedPropertyId).update(property)
          .then(function(docref) {
            refreshProperties();
            selectedPropertyObject.code=property.code;
            selectedPropertyObject.quota=property.quota;
            selectedPropertyObject.type=property.type;
            selectedPropertyObject.cellar=property.cellar;
            document.getElementById("property_code").value=property.code;
            document.getElementById("property_quota").value=property.quota;
            document.getElementById("property_type").value=PropType[property.type];
            document.getElementById("property_cellar").value=property.cellar;
            M.Modal.getInstance(document.getElementById("propertyWrite")).close();
          }).catch(function(error) {
            M.toast({html:"Error occurred updating this member:" + error}); 
          });
      };

      function writeProperty() {
        if (validateEditPropertyEntries()) {  
          var entries = getEditPropertyEntries();
          if (! (entries.code.normalize() === selectedPropertyObject.code.normalize())) {
            refCoproperty.collection("Properties").where("code", "==", entries.code).get()
              .then(function(existingList) {
                if (existingList.docs.length > 0) {
                  M.toast({html:"Error: property with this code already exists"}); 
                } else {
                    updateProperty(entries);
                  };
              }) .catch (function(error) {
                M.toast({html:"Error occurred checking code uniqueness:" + error}); 
              });
          } else {
                  updateProperty(entries);
          };
        };
      };

      function enableOccupantAdd() {
        document.getElementById("buttonOccupantAdd").setAttribute("class","btn-small waves-light");
      };

      function disableOccupantAdd() {
        document.getElementById("buttonOccupantAdd").setAttribute("class","btn-small waves-light disabled");
      }

      var selectedPropertyId;
      var selectedPropertyObject;
      var selectedPropertyOccupants;
      var selectedMeterId;
      var selectedMeterData;
      var occupantsTable = document.getElementById("property_occupants");
      var metersTable = document.getElementById("property_meters");
      var handlingCopropertyMeter = false;
        
      function displayOccupant(propertyId,occupant){
        refCoproperty.collection("Members").doc(occupant.data().occupant).get().then(function(member) {
          var objectsRow= document.createElement('tr');
          var cell = document.createElement('td');
          var cellContent = memberLink(member);
          cell.appendChild(cellContent);
          objectsRow.appendChild(cell); 
          if (currentUser.role == roleAdministrator || currentUser.id == selectedPropertyObject.owner) {
            cell = document.createElement('td');
            cellContent = document.createElement('a'); 
            cellContent.setAttribute('style',"float: right");
            cellContent.setAttribute('class','waves-light btn-small red');
            cellContent.setAttribute('onclick','removeOccupant('+JSON.stringify(propertyId)+',' +JSON.stringify(occupant.id)+')');
            objectsRow.setAttribute("id", occupant.id)
            cellButtonIcon = document.createElement('i');
            cellButtonIcon.setAttribute('class','material-icons right');
            cellButtonIcon.innerHTML="delete";           
            cellContent.appendChild(cell);
            cellContent.innerHTML = "Remove Occupant";
            cell.appendChild(cellContent);
            objectsRow.appendChild(cell); 
          };
          occupantsTable.appendChild (objectsRow);
        }).catch (function(error) {
          M.toast({html:"Error occurred during displaying occupant:" + error}); 
        });
      };

      
      function editMeter(meter, meterData){
        selectedMeterId = meter;
        selectedMeterData = meterData;
        handlingCopropertyMeter = false;
        document.getElementById("meter_type").value=meterData.type;
        document.getElementById("meter_id").value=meterData.meter;
        document.getElementById("meter_status").value=meterData.status;
        if (meterData.readings.length == 0) {
          document.getElementById("meter_firstReading").value = "";
          document.getElementById("meter_firstReadingPanel").setAttribute("class", "input-field col s12 m12 displayBlock");
        } else if (meterData.readings.length == 1) {
          document.getElementById("meter_firstReading").value = meterData.readings[0].reading;
          document.getElementById("meter_firstReadingPanel").setAttribute("class", "input-field col s12 m12 displayBlock");
        } else if (meterData.readings.length == 2) {
          document.getElementById("meter_firstReading").value = meterData.readings[1].reading;
          document.getElementById("meter_firstReadingPanel").setAttribute("class", "input-field col s12 m12 displayBlock");
        } else {
          document.getElementById("meter_firstReadingPanel").setAttribute("class", "input-field col s12 m12 displayBlock");
        };
        var elems = document.querySelectorAll('select');
        M.FormSelect.init(elems);
        M.updateTextFields();
      };

      function validateMeterEntries(){
        var valid= true;
        if (!document.getElementById("meter_type").checkValidity()) {
          M.toast({html:"Please enter Type"});
          valid=false;
        };
        if (!document.getElementById("meter_id").checkValidity()) {
          M.toast({html:"Please enter valid Meter ID"});
          valid=false;
        };
        if (!document.getElementById("meter_status").checkValidity()) {
          M.toast({html:"Please enter Status"});
          valid=false;
        };
        if (document.getElementById("meter_firstReadingPanel").getAttribute("class") == "displayBlock") {
          if (!document.getElementById("meter_firstReading").checkValidity()) {
            M.toast({html:"Please enter first reading"});
            valid=false;
          };
        };
        return valid;
      };
      
      function writeMeter(){
        if (validateMeterEntries()) {
          if (selectedMeterId) {
            var entries = {
              type: document.getElementById("meter_type").value,
              meter: document.getElementById("meter_id").value,
              status: document.getElementById("meter_status").value,
            };
            if (selectedMeterData.readings.length == 1) {
              selectedMeterData.readings[0].reading = document.getElementById("meter_firstReading").value;
              entries.readings = selectedMeterData.readings;
            } else if (selectedMeterData.readings.length == 2) {
              selectedMeterData.readings[1].reading = document.getElementById("meter_firstReading").value;
              entries.readings = selectedMeterData.readings;
            };
            if (Boolean(selectedMeterData.coproperty)) {
              refCoproperty.collection("Meters").doc(selectedMeterId).update(entries).then(function(docrefmeter) {
                meterReadingsLoaded = false;
                refreshSettings();
                M.Modal.getInstance(document.getElementById("meterWrite")).close();
              }).catch(function(error) {
                M.toast({html:"Error occurred editing meter:" + error}); 
              });
            } else {
              refCoproperty.collection("Properties").doc(selectedPropertyId).collection("Meters").doc(selectedMeterId).update(entries).then(function(docrefmeter) {
                displayMeters(selectedPropertyId);
                meterReadingsLoaded = false;
                M.Modal.getInstance(document.getElementById("meterWrite")).close();
              }).catch(function(error) {
                M.toast({html:"Error occurred editing meter:" + error}); 
              });
            };
          } else {
            var entries = {
              type: document.getElementById("meter_type").value,
              meter: document.getElementById("meter_id").value,
              status: document.getElementById("meter_status").value,
              readings: [{
                date: currentCoproperty.initialStartDate,
                picture: false,
                reading: document.getElementById("meter_firstReading").value,
                counter: 0
              }]
            };
            if (handlingCopropertyMeter) {
              entries.coproperty = true;
              refCoproperty.collection("Meters").add(entries).then(function(docrefmeter) {
                meterReadingsLoaded = false;
                refreshSettings();
                handlingCopropertyMeter = false;
                M.Modal.getInstance(document.getElementById("meterWrite")).close();
              }).catch(function(error) {
                M.toast({html:"Error occurred adding meter:" + error}); 
              });
            }
            else {
              refCoproperty.collection("Properties").doc(selectedPropertyId).collection("Meters").add(entries).then(function(docrefmeter) {
                displayMeters(selectedPropertyId);
                meterReadingsLoaded = false;
                M.Modal.getInstance(document.getElementById("meterWrite")).close();
              }).catch(function(error) {
                M.toast({html:"Error occurred adding meter:" + error}); 
              });
            };
          };
        };
      };

      function addMeter(property){
        selectedMeterId = "";
        document.getElementById("meter_type").value="";
        document.getElementById("meter_id").value="";
        document.getElementById("meter_status").value="ACTIF";
        document.getElementById("meter_firstReading").value="";
        document.getElementById("meter_firstReadingPanel").setAttribute("class", "input-field col s12 m12 displayBlock");
        var elems = document.querySelectorAll('select');
        M.FormSelect.init(elems);
        M.updateTextFields();
      };

      
      function displayMeter(meterFS){
        var meterData = meterFS.data();
        var objectsRow= document.createElement('tr');
        var cell = document.createElement('td');
        var cellContent = document.createTextNode(MeterType[meterData.type]);
        cell.appendChild(cellContent);
        objectsRow.appendChild(cell); 

        cell = document.createElement('td');
        cellContent = document.createTextNode(meterData.meter);
        cell.appendChild(cellContent);
        objectsRow.appendChild(cell);

        cell = document.createElement('td');
        cellContent = document.createTextNode(MeterStatus[meterData.status]);
        cell.appendChild(cellContent);
        objectsRow.appendChild(cell);

        if (currentUser.role == roleAdministrator) {
          cell = document.createElement('td');
          cellContent = document.createElement('button'); 
          cellContent.setAttribute('class','waves-light btn-small modal-trigger');
          cellContent.setAttribute("data-target", "meterWrite");
          cellContent.setAttribute('onclick','editMeter('+JSON.stringify(meterFS.id)+',' +JSON.stringify(meterData)+')');
          cellContent.innerHTML = "Edit";
          cell.appendChild(cellContent);
          objectsRow.appendChild(cell); 
        };
        if (Boolean(meterData.coproperty)) {copropertyMetersTable.appendChild (objectsRow);}
        else {metersTable.appendChild (objectsRow);};
      };
      
      
      function addOccupant() {
        var selectedOccupant = document.getElementById("property_occupant_add").value;
        var collRef = refCoproperty.collection("Properties").doc(selectedPropertyId).collection("Occupants");
        collRef.where("occupant", "==", selectedOccupant).get()
        .then(function(existingList) {
          if (existingList.docs.length > 0) {
            M.toast({html:"Error: This member is already occupant"}); 
          } else {
              collRef.add({occupant:selectedOccupant}).then(function(docRef){
                docRef.get().then(function(newOccupant) {
                  displayOccupant(selectedPropertyId,newOccupant);
                  document.getElementById("property_occupant_add").value = "";
                  disableOccupantAdd();
                  var elems = document.querySelectorAll('select');
                  M.FormSelect.init(elems);
                });
              });
            };
        }) .catch (function(error) {
          M.toast({html:"Error occurred checking code uniqueness:" + error}); 
        });
      };
      
      function removeOccupant(property,occupant){
        refCoproperty.collection("Properties").doc(property).collection("Occupants").doc(occupant).delete().then(function(){
          document.getElementById(occupant).remove();
        }).catch(function(error) {
            M.toast({html:"Error removing occupant:" + error});
        });
      };

      function listMembers(el, selectedOption) {
        var option;
        emptyHTMLSet(el);
        if (!Boolean(selectedOption)) {
          option = document.createElement("option");
          option.setAttribute("value","");
          option.setAttribute("disabled",true);
          option.setAttribute("selected",true);
          option.innerHTML = "Select Member";
          el.appendChild(option);
        };
        refCoproperty.collection("Members").get().then(function(querySnapshot) {
          querySnapshot.forEach(function(member) {
              option = document.createElement("option");
              option.setAttribute("value",member.id);
              if (member.id == selectedOption) {option.setAttribute("selected",true);};
              option.innerHTML = member.data().firstName + " " + member.data().lastName;
              el.appendChild(option);
            });
          var elems = document.querySelectorAll('select');
          M.FormSelect.init(elems);
        });
        
      };
      
      function displayOccupants(property) {
        emptyHTMLSet(occupantsTable);
        refCoproperty.collection("Properties").doc(property).collection("Occupants").get().then( function (querySnapshot) {
          if (Boolean(querySnapshot)) {
            querySnapshot.forEach(function(occupant) {
              displayOccupant(property,occupant);
            });
          };
        });
        listMembers(document.getElementById("property_occupant_add"),"");   
      };

      
      function displayMeters(property) {
        emptyHTMLSet(metersTable);
        refCoproperty.collection("Properties").doc(property).collection("Meters").get().then( function (querySnapshot) {
          if (Boolean(querySnapshot)) {
            querySnapshot.forEach(function(meterFS) {displayMeter(meterFS);});
          };
        });  
      };

      function displayMember(el,memberId){
        // displays the member into a yet defined HTML hyperlink element
        refCoproperty.collection("Members").doc(memberId).get().then(function(member) {
              el.setAttribute('onclick','setSelectedMember('+JSON.stringify(member.id)+','+JSON.stringify(member.data())+',"")');
              el.innerHTML = "<u><font color='blue'>"+member.data().firstName + " " + member.data().lastName+"</font></u>";
              el.setAttribute("style","white-space: nowrap");
        });
      };

      function createMemberLink(memberId){
        // creates the member HTML hyperlink element
        var el = document.createElement('a');
        el.setAttribute("data-target", "memberView");
        el.setAttribute('class','btn-flat modal-trigger');
        displayMember(el,memberId);
        return el;
      };
      
      function setSelectedProperty(id,object) {
        selectedPropertyId=id;
        selectedPropertyObject=object;
        if (currentUser.role == roleAdministrator || currentUser.id == selectedPropertyObject.owner){
          document.getElementById("Properties_OccupantsAdd").setAttribute("class","displayBlock");
          document.getElementById("buttonOccupantAdd").setAttribute("class","btn-small waves-light disabled");
        } else {
          document.getElementById("Properties_OccupantsAdd").setAttribute("class","displayHidden");
        };
        document.getElementById("property_code").value=object.code;
        document.getElementById("property_quota").value=object.quota;
        document.getElementById("property_type").value=PropType[object.type];
        document.getElementById("property_cellar").value=object.cellar;
        var ownerEl = document.getElementById("property_owner");
        refCoproperty.collection("Members").doc(object.owner).get().then(function(member) {
              ownerEl.setAttribute('onclick','setSelectedMember('+JSON.stringify(member.id)+','+JSON.stringify(member.data())+',"")');
              ownerEl.innerHTML = "<font color='#0000FF'>"+member.data().firstName + " " + member.data().lastName+"</font>";
        });
        refCoproperty.collection("Properties").doc(id).collection("PreviousOwners").get().then(function(existingList) {
          if (existingList.docs.length > 0) {
            document.getElementById("previousOwnersButton").setAttribute("class","displayBlock");
          } else {
            document.getElementById("previousOwnersButton").setAttribute("class","displayHidden");
          };
        
        displayOccupants(id); 
        displayMeters(id);
        var elems = document.querySelectorAll('select');
        M.FormSelect.init(elems);
        M.updateTextFields();
        });
      };

      function resetSelectedProperty() {
        selectedPropertyId=null;
        selectedPropertyObject=null;
        document.getElementById("property_code_add").value="";
        document.getElementById("property_quota_add").value="";
        document.getElementById("property_type_add").value="";
        document.getElementById("property_cellar_add").value="";
        document.getElementById("property_owner_add").value="";
        listMembers(document.getElementById("property_owner_add"),"");
        M.updateTextFields();
        M.FormSelect.init(document.querySelectorAll('select'));
      };

      function validateAddPropertyEntries() {
        var valid= true;
        if (!document.getElementById("property_code_add").checkValidity()) {
          M.toast({html:"Please enter Code"});
          valid=false;
        };
        if (!document.getElementById("property_quota_add").checkValidity()) {
          M.toast({html:"Please enter valid Quota"});
          valid=false;
        };
        if (!document.getElementById("property_type_add").checkValidity()) {
          M.toast({html:"Please enter valid Type"});
          valid=false;
        };
        if (!document.getElementById("property_owner_add").checkValidity()) {
          M.toast({html:"Please select Owner"});
          valid=false;
        };
        return valid;
      };

      function validateEditPropertyEntries() {
        var valid= true;
        if (!document.getElementById("property_code_edit").checkValidity()) {
          M.toast({html:"Please enter Code"});
          valid=false;
        };
        if (!document.getElementById("property_quota_edit").checkValidity()) {
          M.toast({html:"Please enter valid Quota"});
          valid=false;
        };
        if (!document.getElementById("property_type_edit").checkValidity()) {
          M.toast({html:"Please enter valid Type"});
          valid=false;
        };
        return valid;
      };

      function getAddPropertyEntries() {
        return {
              code: document.getElementById("property_code_add").value,
              quota: document.getElementById("property_quota_add").value,
              type: document.getElementById("property_type_add").value,
              cellar: document.getElementById("property_cellar_add").value,
              owner: document.getElementById("property_owner_add").value,
            };
      };

      function getEditPropertyEntries() {
        return {
              code: document.getElementById("property_code_edit").value,
              quota: document.getElementById("property_quota_edit").value,
              type: document.getElementById("property_type_edit").value,
              cellar: document.getElementById("property_cellar_edit").value,
            };
      };

      function setEditPropertyEntries() {
        document.getElementById("property_code_edit").value=selectedPropertyObject.code;
        document.getElementById("property_quota_edit").value=selectedPropertyObject.quota;
        document.getElementById("property_type_edit").value=selectedPropertyObject.type;
        document.getElementById("property_cellar_edit").value=selectedPropertyObject.cellar;
        M.updateTextFields();
        M.FormSelect.init(document.querySelectorAll('select')); 
      };

      function newOwner() {
        document.getElementById("property_transferDate").value="";
        document.getElementById("property_newOwner").value="";
        listMembers(document.getElementById("property_newOwner"),"");
        M.updateTextFields();
        M.FormSelect.init(document.querySelectorAll('select'));
      };

      function validateNewOwnerEntries() {
        var valid= true;
        if (!document.getElementById("property_transferDate").checkValidity()) {
          M.toast({html:"Please enter Code"});
          valid=false;
        };
        if (!document.getElementById("property_newOwner").checkValidity()) {
          M.toast({html:"Please enter valid Quota"});
          valid=false;
        };
        return valid;
      };

      function getNewOwnerEntries(){
        return {
              date: document.getElementById("property_transferDate").value,
              owner: document.getElementById("property_newOwner").value,
            };
      };


      var previousOwnerId;
      function setPreviousOwner(poId, poObject) {
        previousOwnerId = poId;
        listMembers(document.getElementById("property_previousOwner"), poObject.owner); 
        document.getElementById("property_transferDatePrevious").value = poObject.date;
        M.updateTextFields();
        M.FormSelect.init(document.querySelectorAll('select'));
      };

      function writeNewOwner() {
        if (validateNewOwnerEntries()) {  
          var entries = getNewOwnerEntries();
          if (entries.owner == selectedPropertyObject.owner) {
            M.toast({html:"Error: new and existing owner must be different"});
          } else {
            refCoproperty.collection("Properties").doc(selectedPropertyId).update({owner:(entries.owner)})
              .then(function(docrefProperty) {
                var po = {
                  owner: selectedPropertyObject.owner,
                  date: entries.date,
                };
                refCoproperty.collection("Properties").doc(selectedPropertyId).collection("PreviousOwners").add(po).then(function(docrefPreviousOwner) {
                  refreshProperties();
                  displayMember(document.getElementById("property_owner"),entries.owner);
                  document.getElementById("previousOwnersButton").setAttribute("class","displayBlock");
                  M.Modal.getInstance(document.getElementById("newOwner")).close();
                }).catch(function(error) {
                  M.toast({html:"Error occurred updating current owner:" + error}); 
                });
              }).catch(function(error) {
                M.toast({html:"Error occurred updating previous owners:" + error}); 
              });
          };
        };
      };

      var propertyPreviousOwnersTable = document.getElementById("propertyPreviousOwnersTable");

      function loadPreviousOwner(objectFS){
        var object = objectFS.data();
        var objectsRow= document.createElement('tr');
        var cellContent = createMemberLink(object.owner);
        var cell = document.createElement('td');
        cell.appendChild(cellContent);
        objectsRow.appendChild(cell);
        
        cellContent = document.createTextNode(object.date);
        cell = document.createElement('td');
        cell.appendChild(cellContent);
        objectsRow.appendChild(cell);  
        
        cellContent = document.createElement('button');
        cellContent.setAttribute("data-target", "previousOwner");
        cellContent.setAttribute('class','btn-small waves-light modal-trigger');
        cellContent.setAttribute('onclick','setPreviousOwner('+JSON.stringify(objectFS.id)+','+JSON.stringify(object)+')');
        cellContent.innerHTML = "Edit";

        cell = document.createElement('td');
        cell.appendChild(cellContent);
        objectsRow.appendChild(cell);    
        
        propertyPreviousOwnersTable.appendChild (objectsRow);
      };
      
      function showPreviousOwnersTable(){
        emptyHTMLSet(propertyPreviousOwnersTable);
        refCoproperty.collection("Properties").doc(selectedPropertyId).collection("PreviousOwners").orderBy("date").get().then(function(objectsFSArray){
          objectsFSArray.forEach(function(objectFS){
            loadPreviousOwner(objectFS);
          });
        });
      };

      function validatePreviousOwnerEntries(){
        var valid= true;
        if (!document.getElementById("property_previousOwner").checkValidity()) {
          M.toast({html:"Please enter Owner"});
          valid=false;
        };
        if (!document.getElementById("property_transferDatePrevious").checkValidity()) {
          M.toast({html:"Please enter Transfer Date"});
          valid=false;
        };
        return valid;
      };
      
      function getPreviousOwnerEntries() {
        return {
              owner: document.getElementById("property_previousOwner").value, 
              date: document.getElementById("property_transferDatePrevious").value,
              };
      };
      
      function writePreviousOwner(){
        
        if (validatePreviousOwnerEntries()) {
          var entries = getPreviousOwnerEntries();
          
          refCoproperty.collection("Properties").doc(selectedPropertyId).collection("PreviousOwners").doc(previousOwnerId).set(entries).then(function(docrefPreviousOwner) {
            showPreviousOwnersTable();
            M.Modal.getInstance(document.getElementById("previousOwner")).close();
          }).catch(function(error) {
            M.toast({html:"Error occurred updating previous owner:" + error}); 
          });
        };
      };
    </script>
    <!--   Settings scripts start here -->
    <script>
      var copropertyMetersLoaded = false;
      var copropertyMetersTable = document.getElementById("coproperty_meters");
      
      function refreshCopropertyMeters() {
        emptyHTMLSet(copropertyMetersTable);
        refCoproperty.collection("Meters").get().then( function (querySnapshot) {
          if (Boolean(querySnapshot)) {
            querySnapshot.forEach(function(meterFS) {displayMeter(meterFS);});
          };
        });  

      };
      var costCentersLoaded = false;
      var costCenters = null;
      async function costCentersGet(){
        if (costCenters) {return costCenters;}
        else {
          var querySnapshot = await refCoproperty.collection("CostCenters").get();
          costCenters = [];
          querySnapshot.forEach(function(objectFS) {
            var thisObject = objectFS.data();
            thisObject.idFS = objectFS.id;
            costCenters.push(thisObject);
          });
          return costCenters;
        };
      };   

      async function costCenterGet(id){
        function checkId(cc){return cc.idFS == id};
        if (id == "PRIVA") {return {name: "private"}}
        else {
          var ccs = await costCentersGet();
          return ccs.find(checkId);
        };
      };

      function listCostCenters(el, selectedOption) {
        var option;
        emptyHTMLSet(el);
        if (!Boolean(selectedOption)) {
          option = document.createElement("option");
          option.setAttribute("value","");
          option.setAttribute("disabled",true);
          option.setAttribute("selected",true);
          option.innerHTML = "Select Cost Center";
          el.appendChild(option);
        };
        costCentersGet().then(function(querySnapshot) {
          querySnapshot.forEach(function(cc) {
              option = document.createElement("option");
              option.setAttribute("value",cc.idFS);
              if (cc.idFS == selectedOption) {option.setAttribute("selected",true);};
              option.innerHTML = cc.name;
              el.appendChild(option);
            });
          option = document.createElement("option");
          option.setAttribute("value","PRIVA");
          option.innerHTML = "private";
          el.appendChild(option);
          var elems = document.querySelectorAll('select');
          M.FormSelect.init(elems);
        });       
      };     
      
      async function costCenterAdd(ccName){
        var cc = {
          name: ccName,
          distribution: {},
        };
        refCoproperty.collection("CostCenters").add(cc).then(function(newCC) {
          costCenters=null;
          refreshCostCenters();
        });
      };

      async function costCenterNameEdit(id, newName){
        refCoproperty.collection("CostCenters").doc(id).update({"name": newName}).then(function(newCC) {  
        });
      };

      async function costCenterQuotaEdit(ccId, pId, newQuota){
        var update = {};
        update["distribution."+pId] = newQuota;
        refCoproperty.collection("CostCenters").doc(ccId).update(update).then(function() {  
        });
      };

      function costCenterAddPrepare(){
        if (document.getElementById("costCenter_name_add").checkValidity()) {
          costCenterAdd(document.getElementById("costCenter_name_add").value).then(function(cc) {
            costCenters=null;
            refreshCostCenters();
            M.Modal.getInstance(document.getElementById("costCenterAdd")).close();
          })
        }  else {
          M.toast({html:"Please enter new name"});
        };
      };

      
      var selectedCostCenterId = null;
      function costCenterSelect(id, name){
        selectedCostCenterId = id;
        document.getElementById("costCenter_name_edit").value = name ;
        M.updateTextFields();
      };
      var selectedCCPropertyId = null;
      function costCenterQuotaSelect(ccId, pId, quota){
        selectedCostCenterId = ccId;
        selectedCCPropertyId = pId;
        if (quota == null) {quota = 0};
        document.getElementById("costCenter_quota_edit").value = quota ;
        M.updateTextFields();
      };

      function costCenterNameEditPrepare(){
        if (document.getElementById("costCenter_name_edit").checkValidity()) {
          costCenterNameEdit(selectedCostCenterId, document.getElementById("costCenter_name_edit").value).then(function() {
            selectedCostCenterId = null;
            costCenters = null;
            refreshCostCenters();
            M.Modal.getInstance(document.getElementById("costCenterNameEdit")).close();
          })
        } else {
          M.toast({html:"Please enter new name"});
        };
      }; 

      function costCenterQuotaEditPrepare(){
        if (document.getElementById("costCenter_quota_edit").checkValidity()) {
          costCenterQuotaEdit(selectedCostCenterId, selectedCCPropertyId, Number(document.getElementById("costCenter_quota_edit").value)).then(function() {
            selectedCostCenterId = null; selectedCCPropertyId = null;
            costCenters = null;
            refreshCostCenters();
            M.Modal.getInstance(document.getElementById("costCenterQuotaEdit")).close();
          })
        } else {
          M.toast({html:"Please enter valid quota"});
        };
      };

      
      function refreshCostCenters() {
        var ccHeadEl = document.getElementById("costCenters_tableHead");
        emptyHTMLSet(ccHeadEl);
        var headerCol = document.createElement("th");
        headerCol.innerHTML = "Property";
        ccHeadEl.appendChild(headerCol);
        costCentersGet().then(function (ccs){
            var totals = [];
            ccs.forEach(function(cc){
            headerCol = document.createElement("th");
            headerCol.setAttribute("style","text-align: right");
            headerCol.innerHTML = cc.name;
            ccHeadEl.appendChild(headerCol);
            totals[cc.name]=0;
            if (currentUser.role == roleAdministrator) {
              headerCol = document.createElement("th");
              var cellContent = document.createElement('button');
              cellContent.setAttribute("style", "float:left");
              cellContent.setAttribute("data-target", "costCenterNameEdit");
              cellContent.setAttribute('class','btn-small waves-light modal-trigger');
              cellContent.setAttribute('onclick','costCenterSelect('+JSON.stringify(cc.idFS)+','+JSON.stringify(cc.name)+')');
              cellContent.innerHTML = "Edit";
              headerCol.appendChild(cellContent);
              ccHeadEl.appendChild(headerCol);
            };
          });
          var ccBodyEl = document.getElementById("costCenters_tableBody");
          emptyHTMLSet(ccBodyEl);
          propertiesGet().then(function(ps){
            ps.forEach(function(p){
              var row = document.createElement("tr");
              var cell = document.createElement("td");
              var cellContent = propertyLink(p);
              cell.appendChild(cellContent);
              row.appendChild(cell);

              ccs.forEach(function(cc){
                cell = document.createElement("td");
                cell.setAttribute("style","text-align: right");
                var quota = cc.distribution[p.idFS];
                if (quota) {
                  cell.innerHTML = quota;
                  totals[cc.name] += quota;
                };
                row.appendChild(cell);
                if (currentUser.role == roleAdministrator) {
                  cell = document.createElement("th");
                  cellContent = document.createElement('button');
                  cellContent.setAttribute("style", "float:left");
                  cellContent.setAttribute("data-target", "costCenterQuotaEdit");
                  cellContent.setAttribute('class','btn-small waves-light modal-trigger');
                  if (!quota) {quota = 0};
                  cellContent.setAttribute('onclick','costCenterQuotaSelect('+JSON.stringify(cc.idFS)+','+JSON.stringify(p.idFS)+','+JSON.stringify(quota)+')');
                  cellContent.innerHTML = "Edit";
                  cell.appendChild(cellContent);
                  row.appendChild(cell);
                };
              });

              ccBodyEl.appendChild(row);
            });
            var totalsRow = document.createElement("tr");
            var cell = document.createElement("td");
            cell.innerHTML = "<b>Total quotas</b>";
            totalsRow.appendChild(cell);
            ccs.forEach(function(cc){
              var cell = document.createElement("td");
              cell.setAttribute("style","text-align: right");
              cell.innerHTML = totals[cc.name];
              totalsRow.appendChild(cell);
              if (currentUser.role == roleAdministrator) {
                  cell = document.createElement("th");
                  cellContent = document.createTextNode("");
                  cell.appendChild(cellContent);
                  totalsRow.appendChild(cell);
              };
            });
            ccBodyEl.appendChild(totalsRow);
          });
        });
      };
    
     
      function loadSettings() {
        hideMenu();
        document.getElementById("logo-container").innerHTML = "MyCondos: Settings";
        if (!copropertyMetersLoaded) {
          refreshCopropertyMeters();
          copropertyMetersLoaded = true;
        };
        if (!costCentersLoaded) {
          refreshCostCenters();
          costCentersLoaded = true;
        };
      };

      function addCopropertyMeter(){
        addMeter();
        handlingCopropertyMeter = true;
      }
      </script>
      <!-- Charges report ----------------------------------------------------->
      <script>
      
      function reportTransaction(trData){
        trData.type = TransTypeRead[trData.type];
        if (!trData.communication) { trData.communication= " ";} 
        else {trData.communication = trData.communication.substr(0,62);};
        trData.name=trData.name.substr(0,25);
        return trData.amount;
      };

      function convertToCurrency (aTable, listOfFields) {
        aTable.forEach(function(aRow){
          listOfFields.forEach(function(anAmountField){
            aRow[anAmountField] = aRow[anAmountField].toLocaleString("nl-BE",currencyStyle);
          });        
        });
        return aTable;
      };

      var headerCommon = [
        {id:"type",name:"type",prompt:"type",width: 35,align: "center",padding: 0},
        {id:"name",name:"name",prompt:"counter party",width: 50,align: "center",padding: 0},
        {id:"date",name:"date",prompt:"date",width: 35,align: "center",padding: 0},
        {id:"communication",name:"communication",prompt:"communication",width: 87,align: "center",padding: 0},
        {id:"amount",name:"amount",prompt:"amount",width: 38,align: "right",padding: 0}
      ];
      var headerPrivate = [
        {id:"name",name:"name",prompt:"counter party",width: 50,align: "center",padding: 0},
        {id:"date",name:"date",prompt:"date",width: 35,align: "center",padding: 0},
        {id:"communication",name:"communication",prompt:"communication",width: 87,align: "center",padding: 0},
        {id:"assignments",name:"assignments",prompt:"assigned to",width: 145,align: "center",padding: 0},
        {id:"amount",name:"amount",prompt:"amount",width: 38,align: "right",padding: 0}
      ];
      var headerWH = [
        {id:"name",name:"name",prompt:"counter party",width: 50,align: "center",padding: 0},
        {id:"date",name:"date",prompt:"date",width: 35,align: "center",padding: 0},
        {id:"communication",name:"communication",prompt:"communication",width: 122,align: "center",padding: 0},
        {id:"amount",name:"amount",prompt:"amount",width: 38,align: "right",padding: 0}
      ];
      
      var headerConsumption = [
        {id:"owner",name:"owner",prompt:"owner",width: 38,align: "center",padding: 0},
        {id:"property",name:"property",prompt:"property",width: 20,align: "center",padding: 0},
        {id:"meter",name:"meter",prompt:"meter",width: 30,align: "center",padding: 0},
        {id:"type",name:"type",prompt:"type",width: 18,align: "center",padding: 0},
        {id:"last_reading",name:"last_reading",prompt:"last reading",width: 28,align: "center",padding: 0},
        {id:"reading",name:"reading",prompt:"new reading",width: 28,align: "center",padding: 0},
        {id:"difference",name:"difference",prompt:"difference",width: 23,align: "center",padding: 0},
        {id:"water",name:"water",prompt:"water consumed",width: 30,align: "center",padding: 0},
        {id:"water_payed",name:"water_payed",prompt:"water payed",width: 30,align: "center",padding: 0},
        {id:"water_regu",name:"water_regu",prompt:"water regularisation",width: 27,align: "center",padding: 0},
        {id:"heating",name:"heating",prompt:"heating consumed",width: 30,align: "center",padding: 0},
        {id:"heating_payed",name:"heating_payed",prompt:"heating  payed",width: 30,align: "center",padding: 0},
        {id:"heating_regu",name:"heating_regu",prompt:"heating regularisation",width: 27,align: "center",padding: 0},
      ];
      var emptyConsumptionLine = {owner:"", property:"", meter:"", type:"", last_reading:"", reading:"", difference:"", water:"", water_payed:"", water_regu:"", heating:"", heating_payed:"", heating_regu:""};
     var headerChargesMetersIncluded = [
        {id:"owner",name:"owner",prompt:"owner",width: 60,align: "center",padding: 0},
        {id:"common",name:"common",prompt:"common charges",width: 40,align: "center",padding: 0},
        {id:"private",name:"private",prompt:"private charges",width: 40,align: "center",padding: 0},
        {id:"water_pro",name:"water_pro",prompt:"provision water",width: 40,align: "center",padding: 0},
        {id:"heating_pro",name:"heating_pro",prompt:"provision heating",width: 40,align: "center",padding: 0},
        {id:"water_regu",name:"water_regu",prompt:"regularisation water",width: 40,align: "center",padding: 0},
        {id:"heating_regu",name:"heating_regu",prompt:"regularisation heating",width: 40,align: "center",padding: 0},
        {id:"Total",name:"Total",prompt:"Total",width: 55,align: "right",padding: 0}
      ];
      var headerChargesMetersExcluded = [
        {id:"owner",name:"owner",prompt:"owner",width: 60,align: "center",padding: 0},
        {id:"property",name:"property",prompt:"property",width: 20,align: "center",padding: 0},
        {id:"private",name:"private",prompt:"private charges",width: 35,align: "right",padding: 0},
        {id:"Total",name:"Total",prompt:"Total",width: 35,align: "right",padding: 0}
      ];
      
      var ccsInReport;
      
      /*var propertiesInReport;*/
      async function generateChargesReport(closeDateTransactions, metersIncluded){  
        ccsInReport = await costCentersGet(); 
        /* propertiesInReport = await propertiesGet(); */
        var commonCharges = {}; 
        var totalCharges = [];
        var i = 0;
        ccsInReport.forEach(function(cc) {
          var ccId = cc.idFS;
          function checkId(ccHere){return ccHere.idFS == ccId};
          commonCharges[ccId] ={};
          commonCharges[ccId].total = 0;
          commonCharges[ccId].transactions = [];
          if (!metersIncluded){
            headerChargesMetersExcluded.splice(2+i, 0, {id:ccId,name:ccId,prompt:ccsInReport.find(checkId).name,width: 40,align: "center",padding: 0});
          };
          i += 1;
        });
        var privateCharges = [];
        var privateTotal = 0;
       
        refCoproperty.collection("Transactions").where("bookDate", ">", lastCloseDate).where("bookDate", "<=", closeDateTransactions).orderBy("bookDate").get().then(function(transactionsFS){
          transactionsFS.forEach(function(transactionFS){
            var trData = transactionFS.data();
            if (trData.type == "PRIVA") {
              privateTotal += reportTransaction(trData);
              var distributionStringHere = " ";
              
              trData.distribution.forEach(function (ds){
                distributionStringHere += ds.propertyCode + ": " + ds.amount.toLocaleString("nl-BE",currencyStyle) + " | ";
              });
              
              trData.assignments = distributionStringHere;
              trData.distribution = distributionStringHere;
              privateCharges.push(trData);
            } else {
              commonCharges[trData.costCenter].total += reportTransaction(trData);
              commonCharges[trData.costCenter].transactions.push(trData);
            };
          });

          Object.keys(commonCharges).forEach(function(cc){
            commonCharges[cc].transactions.push({type:"Total",name:" ",date:" ",communication:" ",amount:commonCharges[cc].total});
            convertToCurrency(commonCharges[cc].transactions, ["amount"]);
          });
          /*privateCharges.push({name: "Total", date: " ", communication: " ", assignments: " ", amount: privateTotal});*/
          convertToCurrency(privateCharges, ["amount"]);
          writePDF (closeDateTransactions,false,commonCharges,privateCharges, [{owner:" ",property:" ",private:" ",Total: " ",itxxrPNtUWkH2omdiqNe:" ", qfdhC9zaS9W9iGZ6EnqJ: " ",uRenBj8T1f6UkTu5CiLP: " " }]);
        });
      
      };
      
          
         
          /*
          refCoproperty.collection("Transactions").where("type", "==", "Water").where("bookDate", ">", lastReguDate).where("bookDate", "<=", closeDateTransactions).orderBy("bookDate").get().then(function(transactionsFS){
            transactionsFS.forEach(function(transactionFS){
              var trData = transactionFS.data();
              buildingWater += reportTransaction(trData);
              dataWater.push(trData);
            });      
          dataWater.push({type:"Total",name:" ",date:" ",communication:" ",amount:buildingWater.toLocaleString("nl-BE",currencyStyle)});

          refCoproperty.collection("Transactions").where("type", "==", "Heating").where("bookDate", ">", lastReguDate).where("bookDate", "<=", closeDateTransactions).orderBy("bookDate").get().then(function(transactionsFS){
            transactionsFS.forEach(function(transactionFS){
              var trData = transactionFS.data();
              buildingHeating += reportTransaction(trData);
              dataHeating.push(trData);
            });      
          dataHeating.push({type:"Total",name:" ",date:" ",communication:" ",amount:buildingHeating.toLocaleString("nl-BE",currencyStyle)});
                          
          refCoproperty.collection("Members").get().then(function(membersFS) { 
            var idMemberMap = [];
            membersFS.forEach(function(memberFS){
              idMemberMap[memberFS.id] = (memberFS.data().lastName + " " + memberFS.data().firstName).substr(0,25);
            });
            var iteratorProp = 0;
            var stop = false;
            refCoproperty.collection("Properties").orderBy("owner").get().then(function(propertiesFS){  
              propertiesFS.forEach(function(prFS){
                var prData = prFS.data();
                var ownerIdV = prData.owner;
                var ownerName = idMemberMap[ownerIdV];
                dataQuota.push({ownerId:ownerIdV, owner:ownerName, propertyId:prFS.id, property:prData.code, quota:prData.quota, period:"100%", quota_period: prData.quota, common:0, water_pro: 0, heating_pro: 0, waterCons: false, heatingCons: false, private: 0, total: 0}); 
                var prQuota = parseInt(prData.quota);
                totalQuota = totalQuota + prQuota; 
                if (!dataCharges[ownerIdV]) {
                  dataCharges[ownerIdV] = {ownerId:ownerIdV, owner:ownerName, common:0, private:0, water_pro:0, heating_pro:0, water_regu:0, heating_regu:0, Total:0};
                };
                var iteratorMeter = 0;
                refCoproperty.collection("Properties").doc(prFS.id).collection("Meters").get().then(function(metersFS){   
                  iteratorProp = iteratorProp + 1;                                    
                    metersFS.forEach(function(meterFS){
                      iteratorMeter = iteratorMeter +1;
                      var meterData = meterFS.data();
                      var lastReading = "";
                      var newReading = "";
                      var differenceV = 0;
                      var readingDate = meterData.readings[0].date;
                      if (metersIncluded && ((!checkBookDate(readingDate))|| (readingDate.localeCompare(closeDateTransactions)>0))) {
                        M.toast({html:"following meter reading is missing or out of period: " + meterData.meter});
                        stop = true;
                      } else {
                        lastReading = meterData.readings[1].reading;
                        newReading = meterData.readings[0].reading;
                        differenceV = parseFloat(newReading) - parseFloat(lastReading);
                        if (meterData.type == "Cold Water") {
                          totalColdWaterDifference = totalColdWaterDifference + differenceV;
                          if (!(dataQuota[iteratorProp-1].waterCons)) {totalQuotaWater += prQuota};
                          dataQuota[iteratorProp-1].waterCons = true;
                        } else if (meterData.type == "Heating") {
                          totalHeatingDifference += differenceV;
                          if (!(dataQuota[iteratorProp-1].heatingCons)) {totalQuotaHeating += prQuota};
                          dataQuota[iteratorProp-1].heatingCons = true;
                        } else if (meterData.type == "Hot Water"){
                          totalHotWaterDifference += differenceV;
                          
                        };                    
                        dataConsumption.push({ownerId:ownerIdV, quota: prQuota, owner:ownerName.substr(0,15), property:prData.code, meter:meterData.meter, type:meterData.type, last_reading:lastReading, reading:newReading, difference:differenceV, water:0, water_payed:" ", water_regu:" ", heating:0, heating_payed:" ", heating_regu:" "});                       
                      };
                    
                      if (!stop)  {
                        if ((iteratorMeter == metersFS.docs.length) && (iteratorProp == propertiesFS.docs.length)) {                         
                          var totalledConsumption = dataConsumption;
                          if (metersIncluded) {
                            totalledConsumption = calcTotalConsumption (totalQuota, totalQuotaWater, totalQuotaHeating, coldWaterDifferenceCommon, totalHotWaterDifference, totalHeatingDifference, buildingWater, buildingHeating, dataCommon, dataConsumption, dataCharges);
                          };
                          calcAndGenerate(closeDateTransactions, metersIncluded,totalQuota, totalQuotaWater,totalQuotaHeating,buildingCommon, buildingWater, buildingWaterPeriod, buildingHeating, buildingHeatingPeriod, buildingPrivate, dataWaterPeriod, dataWater, dataHeatingPeriod, dataHeating, dataCommon, dataPrivate, totalledConsumption, dataQuota, dataCharges);                         
                        };
                      };
                    });
            
                });
                
                                
              });
              
            }).catch(function(error) {
              M.toast({html:"Error during properties upload:" + error});
            });
          });
          });
          });
        });
        }).catch(function(error) {
            M.toast({html:"Error during expenses upload:" + error});
        });
      };  

      function calcAndGenerate(closeDateTransactions, metersIncluded,totalQuota, totalQuotaWater,totalQuotaHeating, buildingCommon, buildingWater, buildingWaterPeriod, buildingHeating, buildingHeatingPeriod, buildingPrivate, dataWaterPeriod, dataWater, dataHeatingPeriod, dataHeating, dataCommon, dataPrivate, totalledConsumptionData, dataQuota, dataCharges){
        var totalledPrivateData = calcPrivate(dataQuota, dataPrivate, dataCharges);
        var totalledQuotaData = makeSubtotals(dataQuota,totalQuota, totalQuotaWater,totalQuotaHeating, buildingCommon, buildingWaterPeriod, buildingHeatingPeriod, dataCharges);
        dataCommon.push({type:"Total",name:" ",date:" ",communication:" ",amount:buildingCommon.toLocaleString("nl-BE",currencyStyle)});
        var totalledPrivateData = calcPrivate(totalledQuotaData, dataPrivate, dataCharges);
        var dataChargesCurrency = putChargesCurrency(Object.values(dataCharges), metersIncluded);
        writePDF(closeDateTransactions, metersIncluded, dataWaterPeriod, dataWater, dataHeatingPeriod, dataHeating,  dataCommon, totalledPrivateData, totalledConsumptionData, putQuotaCurreny(totalledQuotaData), dataChargesCurrency);
      };
      
      function putQuotaCurreny(dataQuota){
        dataQuota.forEach(function(arrayEl) {
          if (arrayEl.owner) {
            arrayEl.total = (arrayEl.common+arrayEl.water_pro+arrayEl.heating_pro+arrayEl.private).toLocaleString("nl-BE",currencyStyle);
            arrayEl.common = arrayEl.common.toLocaleString("nl-BE",currencyStyle);
            if (arrayEl.water_pro){arrayEl.water_pro = arrayEl.water_pro.toLocaleString("nl-BE",currencyStyle);}
            else {arrayEl.water_pro =" "};
            if (arrayEl.heating_pro){arrayEl.heating_pro = arrayEl.heating_pro.toLocaleString("nl-BE",currencyStyle);}
            else {arrayEl.heating_pro =" "};
            if (arrayEl.private){arrayEl.private = arrayEl.private.toLocaleString("nl-BE",currencyStyle);}
            else {arrayEl.private =" "};
          };
        });
        return dataQuota;
      }
      
      function putChargesCurrency(dataChargesP, metersIncluded){
        var tCommon = 0;
        var tWater_pro = 0;
        var tHeating_pro = 0;
        var tWater_regu = 0;
        var tHeating_regu = 0;
        var tPrivate = 0;
        dataChargesP.forEach(function(arrayEl) {
          var totalRow;
          if (metersIncluded){totalRow = arrayEl.common + arrayEl.private + arrayEl.water_pro + arrayEl.heating_pro + arrayEl.water_regu + arrayEl.heating_regu;}
          else {totalRow = arrayEl.common + arrayEl.private + arrayEl.water_pro + arrayEl.heating_pro;};
          arrayEl.Total = totalRow.toLocaleString("nl-BE",currencyStyle);
          tCommon += arrayEl.common;
          arrayEl.common = arrayEl.common.toLocaleString("nl-BE",currencyStyle);
          tWater_pro += arrayEl.water_pro;
          arrayEl.water_pro = arrayEl.water_pro.toLocaleString("nl-BE",currencyStyle);
          tHeating_pro += arrayEl.heating_pro;
          arrayEl.heating_pro = arrayEl.heating_pro.toLocaleString("nl-BE",currencyStyle);
          tPrivate += arrayEl.private;
          arrayEl.private = arrayEl.private.toLocaleString("nl-BE",currencyStyle); 
          if (metersIncluded) {
            tWater_regu += arrayEl.water_regu;
            arrayEl.water_regu = arrayEl.water_regu.toLocaleString("nl-BE",currencyStyle);
            tHeating_regu += arrayEl.heating_regu;
            arrayEl.heating_regu = arrayEl.heating_regu.toLocaleString("nl-BE",currencyStyle);
          } else {
            arrayEl.water_regu = " ";
            arrayEl.heating_regu = " ";
          }
        });
        if (metersIncluded) {
          dataChargesP.push({ownerId:"", owner:"Total", common:tCommon.toLocaleString("nl-BE",currencyStyle), private:tPrivate.toLocaleString("nl-BE",currencyStyle), water_pro:tWater_pro.toLocaleString("nl-BE",currencyStyle), heating_pro:tHeating_pro.toLocaleString("nl-BE",currencyStyle), water_regu:tWater_regu.toLocaleString("nl-BE",currencyStyle), heating_regu:tHeating_regu.toLocaleString("nl-BE",currencyStyle), Total:(tCommon+tPrivate+tWater_pro+tHeating_pro+tWater_regu+tHeating_regu).toLocaleString("nl-BE",currencyStyle)});
        } else {
          dataChargesP.push({ownerId:"", owner:"Total", common:tCommon.toLocaleString("nl-BE",currencyStyle), private:tPrivate.toLocaleString("nl-BE",currencyStyle), water_pro:tWater_pro.toLocaleString("nl-BE",currencyStyle), heating_pro:tHeating_pro.toLocaleString("nl-BE",currencyStyle), Total:(tCommon+tPrivate).toLocaleString("nl-BE",currencyStyle)});
        };
        return dataChargesP;
      };
      
      function putConsumptionCurreny(dataConsumption){
        dataConsumption.forEach(function(arrayEl) {
          if (arrayEl.type == "Cold Water") {arrayEl.type = "CW"};
          if (arrayEl.type == "Hot Water") {arrayEl.type = "HW"};
          if (arrayEl.type == "Heating") {arrayEl.type = "HE"};
          if ((arrayEl.difference)&& (arrayEl.difference != " ")){arrayEl.difference = arrayEl.difference.toString();};         
          if ((arrayEl.water)&& (arrayEl.water != " ")){arrayEl.water = arrayEl.water.toLocaleString("nl-BE",currencyStyle);}
          else if (arrayEl.owner){arrayEl.water = " "};
          if ((arrayEl.water_payed)&& (arrayEl.water_payed != " ")){arrayEl.water_payed = arrayEl.water_payed.toLocaleString("nl-BE",currencyStyle);};
          if ((arrayEl.water_regu)&& (arrayEl.water_regu != " ")){arrayEl.water_regu = arrayEl.water_regu.toLocaleString("nl-BE",currencyStyle);};
          if ((arrayEl.heating)&& (arrayEl.heating != " ")){arrayEl.heating = arrayEl.heating.toLocaleString("nl-BE",currencyStyle);}
          else if (arrayEl.owner){arrayEl.heating = " "};;
          if ((arrayEl.heating_payed)&& (arrayEl.heating_payed != " ")){arrayEl.heating_payed = arrayEl.heating_payed.toLocaleString("nl-BE",currencyStyle);};
          if ((arrayEl.heating_regu)&& (arrayEl.heating_regu != " ")){arrayEl.heating_regu = arrayEl.heating_regu.toLocaleString("nl-BE",currencyStyle);};          
        });
        return dataConsumption;
      };
      
      function calcPrivate(dataQuota, dataPrivate, dataCharges){
        var result = [];
        var total = 0;
        var thisPropertyId;
        function findQR (quotaRow) {
          return quotaRow.propertyId == thisPropertyId;
        }
        dataPrivate.forEach(function (dp) {
          var distributionString = "";
          dp.distribution.forEach(function (ds){
            thisPropertyId = ds.property;
            var thisQR = dataQuota.find(findQR);         
            distributionString += thisQR.property + ": " + ds.amount.toLocaleString("nl-BE",currencyStyle) + " | ";
            thisQR.private += ds.amount;
          });
          result.push({name: dp.name, date: dp.date, communication: dp.communication, distribution: distributionString, amount: dp.amount.toLocaleString("nl-BE",currencyStyle)});
          total += dp.amount;
        });
        result.push({name: "Total", date: " ", communication: " ", distribution: " ", amount: total.toLocaleString("nl-BE",currencyStyle)});
        return result;
      };
      
      function calcConsumptionAmounts (dataConsumption, coldWaterDifferenceCommon, totalHotWaterDifference, totalHeatingDifference, buildingWater, buildingHeating) {
        dataConsumption.forEach(function(arrayEl) {
          if (arrayEl.type != "Heating") {
            var amountWaterString = (buildingWater * arrayEl.difference / (coldWaterDifferenceCommon)).toFixed(2);
            arrayEl.water = Number(amountWaterString);
          };
          if (arrayEl.type != "Cold Water") {
            var amountHeatingString = (buildingHeating * arrayEl.difference / (totalHeatingDifference + totalHotWaterDifference)).toFixed(2);
            arrayEl.heating = Number(amountHeatingString);
          };
        });      
      };
      
      function calcTotalConsumption(totalQuota, totalQuotaWater, totalQuotaHeating, coldWaterDifferenceCommon, totalHotWaterDifference, totalHeatingDifference, buildingWater, buildingHeating, dataCommon, dataConsumption, dataCharges){
        calcConsumptionAmounts (dataConsumption, coldWaterDifferenceCommon, totalHotWaterDifference, totalHeatingDifference, buildingWater, buildingHeating);
        var reguProperties = calcConsumptionRegusProperties (totalQuota, totalQuotaWater, totalQuotaHeating, dataConsumption, buildingWater, buildingHeating);
        var reguOwners = calcConsumptionRegusOwners(buildingWater, reguProperties, dataCommon, dataCharges);
        return putConsumptionCurreny(reguOwners);        
      };

      function calcConsumptionRegusProperties (totalQuota, totalQuotaWater, totalQuotaHeating, dataConsumption, buildingWater, buildingHeating) {
        var i=0;
        var count = 0;
        var totalWaterCons = 0;
        var totalHeatingCons = 0;
        const arraylength = dataConsumption.length;
        var result = [];
        while (i < arraylength) {
          count = count+1;
          totalWaterCons = totalWaterCons + dataConsumption[i].water;
          totalHeatingCons = totalHeatingCons + dataConsumption[i].heating;
          if (((count == 1) && ((i + 1) != arraylength) && (dataConsumption[i].property != dataConsumption[i+1].property)) || ((count == 1) && ((i + 1) == arraylength))){
            dataConsumption[i].water_payed = Number((buildingWater * dataConsumption[i].quota / totalQuotaWater).toFixed(2));
            dataConsumption[i].water_regu = dataConsumption[i].water - dataConsumption[i].water_payed;
            dataConsumption[i].heating_payed = Number((buildingHeating * dataConsumption[i].quota / totalQuotaHeating).toFixed(2));
            dataConsumption[i].heating_regu = dataConsumption[i].heating - dataConsumption[i].heating_payed;
            result.push(dataConsumption[i]);
            totalWaterCons = 0;
            totalHeatingCons = 0;
            count = 0;
          } else if (((i + 1) != arraylength) && (dataConsumption[i].property == dataConsumption[i+1].property)){
            result.push(dataConsumption[i]);
          } else {
            result.push(dataConsumption[i]);
            var waterPayed = Number((buildingWater * dataConsumption[i].quota / totalQuotaWater).toFixed(2));
            var heatingPayed = Number((buildingHeating * dataConsumption[i].quota / totalQuotaHeating).toFixed(2));
            var waterRegu = totalWaterCons - waterPayed;
            var heatingRegu = totalHeatingCons - heatingPayed;
            result.push({ownerId:dataConsumption[i].ownerId, owner:dataConsumption[i].owner, property:dataConsumption[i].property, meter:"Subtotal", type:"", last_reading:"", reading:"", difference:"", water:totalWaterCons, water_payed:waterPayed, water_regu: waterRegu, heating:totalHeatingCons, heating_payed:heatingPayed, heating_regu: heatingRegu});
            count = 0;
            totalWaterCons = 0;
            totalHeatingCons = 0;
          };
          i = i + 1;
        };
        return result;
      };

      function calcConsumptionRegusOwners (buildingWater, dataConsumption, dataCommon, dataCharges) {
        
        var i=0;
        var count = 0;
        var totalWaterCons = 0;
        var totalHeatingCons = 0;
        var totalWaterPayed = 0;
        var totalHeatingPayed = 0;
        var totalWaterRegu = 0;
        var totalHeatingRegu = 0;
        var waterOwners = 0;
        
        const arraylength = dataConsumption.length;
        var result = [];

        function sumIt(consLine){
            totalWaterCons = totalWaterCons + consLine.water;
            totalHeatingCons = totalHeatingCons + consLine.heating;
            totalWaterPayed = totalWaterPayed + consLine.water_payed;
            totalHeatingPayed = totalHeatingPayed + consLine.heating_payed;
            totalWaterRegu = totalWaterRegu + consLine.water_regu;
            totalHeatingRegu = totalHeatingRegu + consLine.heating_regu;

        };

        while (i < arraylength) {
          result.push(dataConsumption[i]);
          if ((dataConsumption[i].water_regu) && (dataConsumption[i].water_regu !== " ")){
            count = count+1;
            if (((count == 1) && ((i + 1) != arraylength) && (dataConsumption[i].ownerId != dataConsumption[i+1].ownerId)) || ((count == 1) && ((i + 1) == arraylength))){
              waterOwners += dataConsumption[i].water;
              result.push(emptyConsumptionLine);
              dataCharges[dataConsumption[i].ownerId].water_regu = dataConsumption[i].water_regu;
              dataCharges[dataConsumption[i].ownerId].heating_regu = dataConsumption[i].heating_regu;
              count = 0;             
            } else if (((i + 1) != arraylength) && (dataConsumption[i].ownerId == dataConsumption[i+1].ownerId)){
              sumIt(dataConsumption[i]);
          } else {
              sumIt(dataConsumption[i]);
              waterOwners += totalWaterCons;
              result.push({ownerId:dataConsumption[i].ownerId, owner:dataConsumption[i].owner, property:"Total", meter:"", type:"", last_reading:"", reading:"", difference:"", water:totalWaterCons, water_payed:totalWaterPayed, water_regu: totalWaterRegu, heating:totalHeatingCons, heating_payed:totalHeatingPayed, heating_regu: totalHeatingRegu});
              result.push(emptyConsumptionLine);
              dataCharges[dataConsumption[i].ownerId].water_regu = totalWaterRegu;
              dataCharges[dataConsumption[i].ownerId].heating_regu = totalHeatingRegu;
              count = 0;
              totalWaterCons = 0;
              totalHeatingCons = 0;
              totalWaterPayed = 0;
              totalHeatingPayed = 0;
              totalWaterRegu = 0;
              totalHeatingRegu = 0;
            };
          } ;
          i = i + 1;
        };
        var waterCommonParts = buildingWater-waterOwners;
        buildingCommon += waterCommonParts;                           
        dataCommon.push({type:"Water Common", name:" ",date:" ", communication:"water common parts = " + buildingWater.toLocaleString("nl-BE",currencyStyle)+ " - " + waterOwners.toLocaleString("nl-BE",currencyStyle), amount:waterCommonParts.toLocaleString("nl-BE",currencyStyle)});
        return result;
      };


      function makeSubtotals (dataQuota,totalQuota, totalQuotaWater,totalQuotaHeating, buildingCommon, buildingWaterPeriod, buildingHeatingPeriod, dataCharges) {
        var result = [];
        var totalCommon = 0;
        var totalWater = 0;
        var totalHeating = 0;
        var totalPrivate = 0;
        var currentOwnerId = "";
        var count =0;
        var subtotalCommon = 0;
        var subtotalWater = 0;
        var subtotalHeating = 0;
        var subtotalPrivate = 0;
        var amount = 0;
        var amountWater = 0;
        var amountHeating = 0;
        
        function writeData(arrayEl){
          var quota = parseInt(arrayEl.quota);
          var amountString = (buildingCommon * quota / totalQuota).toFixed(2);
          amount = Number(amountString);
          arrayEl.common = amount;
          subtotalCommon += amount;
          subtotalPrivate += Number(arrayEl.private);
          if (arrayEl.waterCons){
            amountString = (buildingWaterPeriod * quota / totalQuotaWater).toFixed(2);
            amountWater = Number(amountString);
            arrayEl.water_pro = amountWater;
            subtotalWater += amountWater;
          };
          if (arrayEl.heatingCons){
            amountString = (buildingHeatingPeriod * quota / totalQuotaHeating).toFixed(2);
            amountHeating = Number(amountString);
            arrayEl.heating_pro = amountHeating;
            subtotalHeating += amountHeating;
          };
          result.push(arrayEl);
          var thisOwnerId = arrayEl.ownerId;         
          dataCharges[thisOwnerId].common = subtotalCommon;
          dataCharges[thisOwnerId].private = subtotalPrivate;
          dataCharges[thisOwnerId].water_pro = subtotalWater;
          dataCharges[thisOwnerId].heating_pro = subtotalHeating;
          
        };
        dataQuota.forEach(function(arrayEl) {
          if ((!currentOwnerId) || (arrayEl.ownerId == currentOwnerId)) {
            count = count + 1;
            writeData(arrayEl);
          } else {
            if (count > 1) {
              result.push({ownerId:currentOwnerId, owner:"Total", property:"", quota:"", period:"", quota_period: "", common:subtotalCommon,water_pro:subtotalWater,heating_pro:subtotalHeating, private: subtotalPrivate, total:0});
            };
            result.push({ownerId:" ", owner:"", property:"", quota:"", period:"", quota_period: "", common:"", water_pro:"", heating_pro:"", private: "", total:""});
            count = 0;
            subtotalCommon = 0; subtotalWater = 0; subtotalHeating = 0; subtotalPrivate = 0;
            writeData(arrayEl);
          };
          currentOwnerId = arrayEl.ownerId;
          totalCommon += amount;   
          totalWater += amountWater;
          totalHeating += amountHeating;
          totalPrivate += arrayEl.private;
        });
        if (count > 1) {
              result.push({ownerId:currentOwnerId, owner:"Total", property:"", quota:"", period:"", quota_period: "", common:subtotalCommon,water_pro:subtotalWater,tHeating_pro:subtotalHeating, private: subtotalPrivate,total:0});
            };
            result.push({ownerId:" ", owner:"", property:"", quota:"", period:"", quota_period: "", common:"", water_pro:"", heating_pro:"", private: "", total:""});
            result.push({ownerId:" ", owner:"Total building", property:" ", quota:" ", period:" ", quota_period: totalQuota.toString(), common:totalCommon,water_pro:totalWater,heating_pro:totalHeating, private: totalPrivate,total:0});
        return result;
      };*/
      
      function writePDF (closeDateTransactions, metersIncludedHere, commonCharges ,privateCharges, totalCharges){
        const rowsLandscape =15;
        const rowsLandscapePrivate =11;
        const rowsPortrait =17;
        var numPages;
        if (metersIncludedHere) {
           numPages = 1 + Math.ceil(dataWaterPeriod.length/rowsPortrait) + Math.ceil(dataWater.length/rowsPortrait) + Math.ceil(dataHeatingPeriod.length/rowsPortrait) + Math.ceil(dataHeating.length/rowsPortrait) + Math.ceil(dataConsumption.length/rowsLandscape) + Math.ceil(dataCommon.length/rowsPortrait) + Math.ceil(dataQuota.length/rowsLandscape) + Math.ceil(dataPrivate.length/rowsLandscapePrivate) + Math.ceil(tableCharges.length/rowsLandscape);
        } else {
          numPages = 6;
           /*numPages = 1 + Math.ceil(dataCommon.length/rowsPortrait) + Math.ceil(dataQuota.length/rowsLandscape) + Math.ceil(dataPrivate.length/rowsPortrait) + Math.ceil(tableCharges.length/rowsPortrait);
           */
        };
        window.jsPDF = window.jspdf.jsPDF;
        var currentPage = 1;
        
        var startDateHere = new Date(lastCloseDate);
        startDateHere.setDate(startDateHere.getDate() + 1);
        var startDateString = startDateHere.toISOString().substr(0,10);
        const footerText = "Charges Report " + currentCoproperty.name + " " + startDateString + " to " + closeDateTransactions;
        
        function printFooterPortrait () {
          doc.line(15, 280, 200, 280);
          doc.setFontSize(10);
          doc.setTextColor("green");doc.text("MyCondos " ,15, 285);doc.setTextColor("black");
          doc.text(footerText,35, 285);
          doc.text("Page " + currentPage + "/" + numPages, 185, 285);
          currentPage = currentPage + 1;
        };
        function printFooterLandscape () {
          doc.line(10, 190, 280, 190);
          doc.setFontSize(10);
          doc.setTextColor("green");doc.text("MyCondos" ,10, 195);doc.setTextColor("black");
          doc.text(footerText,32, 195);
          doc.text("Page " + currentPage + "/" + numPages, 265, 195);
          currentPage = currentPage + 1;
        };
        function printTablePortrait(title, table, header) {
          for (i = 0; i < Math.ceil(table.length/rowsPortrait); i= i + 1) {
            doc.addPage("a4", "portrait");
            doc.setFontSize(16);
            doc.text(title, 15, 15);
            doc.table(15, 20, table.slice(i*rowsPortrait, (i+1)*rowsPortrait), header,{fontSize:10});
            printFooterPortrait ();
          };
        };
        function printTableLandscape(title, table, header, fontSizeP) {
          for (i = 0; i < Math.ceil(table.length/rowsLandscape); i= i + 1) {
            doc.addPage("a4", "landscape");
            doc.setFontSize(16);
            doc.text(title, 15, 15);
            doc.table(10, 20, table.slice(i*rowsLandscape, (i+1)*rowsLandscape), header,{fontSize:fontSizeP});
            printFooterLandscape ();
          };
        };
        
        var doc = new jsPDF({ putOnlyUsedFonts: true, orientation: "portrait" });
        doc.setTextColor("green"); doc.setFontSize(32);
        doc.text("MyCondos", 60, 20);
        doc.setTextColor("black"); doc.setFontSize(24); 
        doc.text("Report of Charges", 40, 40);
        doc.setFontSize(16);
        doc.text("Condomynium:", 15, 55);
        doc.setFontSize(14);
        doc.text("Name:", 30, 65);doc.text(currentCoproperty.name, 90, 65);
        doc.text("Address:", 30, 75);doc.text(currentCoproperty.street + " " + currentCoproperty.houseNumber + ", "+ currentCoproperty.zip + " " + currentCoproperty.town, 90, 75);
        doc.text("Administrator:", 30, 85);doc.text("Marc Van Limberghen", 90, 85);
        doc.setFontSize(16);
        doc.text("Period:", 15, 105);
        doc.setFontSize(14);
        doc.text(startDateString + " to " + closeDateTransactions, 90, 105);
        if (metersIncludedHere){
          doc.text("including regularisation meter readings", 90, 115);
        } else {
          doc.text("without regularisation meter readings", 90, 115);
        };
        doc.setFontSize(16);
        doc.text("List of tables:", 15, 135);
        doc.setFontSize(14);
        doc.text("Common charges per cost center", 30, 145);
        doc.text("Private expenses", 30, 155);
        doc.text("Total charges", 30, 165);
        /*
        doc.text("Water:", 30, 155);doc.text("total building this period", 90, 155);
        doc.text("Heating:", 30, 165);doc.text("total building this period", 90, 165);
        
        doc.text("Common charges:", 30, 175);doc.text("quota per owner", 90, 175);
        doc.text("Private expenses:", 30, 185);doc.text("expenses per owner", 90, 185);
        if (metersIncludedHere){
          doc.text("Water:", 30, 195);doc.text("total building since last regularisation", 90, 195);
          doc.text("Heating:", 30, 205);doc.text("total building since last regularisation", 90, 205);
          doc.text("Water and Heating:", 30, 215);doc.text("regularisation per owner and property", 90, 215);
          doc.text("Total Charges:", 30, 230);doc.text("total charges per owner", 90, 230);
        } else {
          doc.text("Total Charges:", 30, 200);doc.text("total charges per owner", 90, 200);
        };
        */
        printFooterPortrait();
        Object.keys(commonCharges).forEach(function(cc){
          function checkId(ccHere){return ccHere.idFS == cc};
          printTablePortrait("Common charges for cost center " + ccsInReport.find(checkId).name, commonCharges[cc].transactions, headerCommon);});
        printTableLandscape("Private expenses", privateCharges, headerPrivate, 10);
        console.log("header ",headerChargesMetersExcluded);
        console.log("data ",totalCharges);
        printTableLandscape("Total charges", totalCharges, headerChargesMetersExcluded, 10);
        
        /*
        printTablePortrait("Water: total building this period", dataWaterPeriod, headerWH);
        printTablePortrait("Heating: total building this period", dataHeatingPeriod, headerWH);
        printTableLandscape("Private expenses", dataPrivate, headerPrivate,10);
        printTableLandscape("Charges and expenses per owner", dataQuota, headerQuota,10);
        
        if (metersIncludedHere){
          
          printTablePortrait("Water: total for building since last regularisation", dataWater, headerWH);
          printTablePortrait("Heating: total for building since last regularisation", dataHeating, headerWH);
          printTableLandscape("Water and Heating: regularisation per property and owner (CW = Cold Water, HW= Hot Water, HE = heating)", dataConsumption, headerConsumption,8);
          printTableLandscape("Total charges: total charges per owner", tableCharges, headerChargesMetersIncluded,10);
        } else {
          printTableLandscape("Total charges: total charges per owner", tableCharges, headerChargesMetersExcluded, 10);
        };
        */
        refCoproperty.collection("ChargesReports").add({startDate: startDateString, endDate: closeDateTransactions, metersIncluded: metersIncludedHere, confirmed: false }).then (function (chargesReportFS){
          var fileRef = refCopropertyFiles.child("ChargesReports").child(chargesReportFS.id);  
          fileRef.put(doc.output("blob")).then(function(snapshot) {
              refreshChargesReports();
              M.Modal.getInstance(document.getElementById("chargesReportAdd")).close();
          }).catch(function(error) {
                M.toast({html:"Error writing report file in store:" + error});
          });
          
        }).catch(function(error) {
            M.toast({html:"Error saving charges report:" + error});
        });
        
      };
      
    </script>
</body>

</html>