<!DOCTYPE html>
<html>

<head>
  <base target="_top">
  <title style:"color:#00796b bold">MyCondos</title>
  <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
  <link rel="icon"
    href="https://firebasestorage.googleapis.com/v0/b/slimmeeigendomdb.appspot.com/o/Building-32.png?alt=media&token=9754f9c3-9d56-42fc-bd61-839ce2354a95">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.98.0/css/materialize.min.css">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />


  <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
  <!--<script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.98.0/js/materialize.min.js"></script>-->

  <script src="https://www.gstatic.com/firebasejs/8.2.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com//firebasejs/8.2.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.2.0/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.2.0/firebase-storage.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.3.1/jspdf.umd.min.js"></script>

  <script>
    var firebaseConfig = {
        apiKey: "AIzaSyDVT644vSE0ue8KyDy-o9YwbYPX3m0ZmSc",
        authDomain: "slimmeeigendomdb.firebaseapp.com",
        projectId: "slimmeeigendomdb",
        storageBucket: "slimmeeigendomdb.appspot.com",
        messagingSenderId: "636221237434",
        appId: "1:636221237434:web:3db507acbf4a6a1e0d7a83",
        measurementId: "G-2JL08QYJJ3"
      };
      firebase.initializeApp(firebaseConfig);
      var firestore=firebase.firestore();
      var fileStorageRef =firebase.storage().ref();
  </script>
  <style>
    .content {
      max-width: 500px;
      margin: auto;
    }
  </style>

</head>

<body>
  <center>
    <div id="loginPanel" <h6 style="font-size:36px;color:#00796b">MyCondos</h6>
      <h6 style="font-size:12px;color:black">Stay connected to your properties</h6>
      <h6 style="font-size:20px;color:black">Please login </h6>
      <div style="width:500px">
        <form class="col s12" target="_top">
          <div class="input-field col s12">
            <input id="login_email" type="email" maxlength="50" class="validate" required aria-required="true">
            <label for="login_email">Email</label>
            <span class="helper-text" data-error="please enter valid email" ></span>
          </div>
          <div class="input-field col s12">
            <input id="login_password" type="password" class="validate" required aria-required="true">
            <label for="login_password">Password</label>
          </div>
        </form>
      </div>

      <button class="btn waves-effect waves-light" type="submit" onclick="login()">Log in<i class="material-icons right">perm_identity</i></button>
      <br>
      <button class="btn-flat" onclick="showPasswordReset()">
        <font color='blue'>Forgot password? </font>
      </button>
      <br>
      <button class="btn-flat" onclick="showPasswordSet()">
        <font color='blue'>First time user?</font>
      </button>
    </div>

    <div id="setPasswordPanel" class="displayHidden">
      <h6 style="font-size:36px;color:#00796b">MyCondos</h6>
      <h6 style="font-size:12px;color:black">Stay connected to your properties</h6>
      <h6 style="font-size:20px;color:black">Create password</h6>
      <div style="width:500px">
        <form class="col s12">
          <div class="input-field col s12">
            <input id="passwordSet_email" type="email" maxlength="50" class="validate" required aria-required="true">
            <label for="passwordSet_email">Email</label>
            <span class="helper-text" data-error="please enter valid email" ></span>
          </div>
        </form>
      </div>
      <h6 style="font-size:16px;color:black">An email will be sent to the above address</h6>
      <h6 style="font-size:16px;color:black">with a link to set your password.</h6>
      <br>
      <h6 style="font-size:16px;color:black">Note that your administrator should yet </h6>
      <h6 style="font-size:16px;color:black">have entered your email address.</h6>
      <br>
      <button class="btn waves-effect waves-light" type="submit" onclick="passwordSet()">Submit<i class="material-icons right">send</i></button>
      <br><br>
      <button class="btn-flat" onclick="backToLoginFromSetPW()">
        <font color='blue'>Back to Login</font>
      </button>
    </div>

    <div id="resetPasswordPanel" class="displayHidden">
      <h6 style="font-size:36px;color:#00796b">MyCondos</h6>
      <h6 style="font-size:12px;color:black">Stay connected to your properties</h6>
      <h6 style="font-size:20px;color:black">Reset password</h6>
      <div style="width:500px">
        <form class="col s12">
          <div class="input-field col s12">
            <input id="passwordReset_email" type="email" maxlength="50" class="validate" required aria-required="true">
            <label for="passwordReset_email">Email</label>
            <span class="helper-text" data-error="please enter valid email" ></span>
          </div>
        </form>
      </div>
      <h6 style="font-size:16px;color:black">An email will be sent to the above address</h6>
      <h6 style="font-size:16px;color:black">with a link to set your new password.</h6>
      <br>
      <button class="btn waves-effect waves-light" type="submit" onclick="passwordReset()">Submit<i class="material-icons right">send</i></button>
      <br><br>
      <button class="btn-flat" onclick="backToLoginFromResetPW()">
        <font color='blue'>Back to Login</font>
      </button>
    </div>
  </center>

  <div id="applicationPanel" class="displayHidden">
    <header>
      <nav id="header" class="nav-fixed teal lighten-1">
        <div class="nav-wrapper container center-align">
          <a href="javascript:void(0)" class="brand-logo right right-align" id="logo-container"
            style="font-size:24px">MyCondos: Home</a>
          <a href="#" data-target="slide-out" class="btn-collapsible sidenav-trigger left left-align"
            onclick="showMenu()"><i class="material-icons">menu</i></a>
        </div>
      </nav>
      <ul class="side-nav fixed tabs collapsible" id="slide-out">
        <li>
          <div class="userView">
            <div class="background">
              <img style="width:100%" src="https://img1.goodfon.com/wallpaper/big/6/d8/android-material-fon-linii.jpg">
            </div>
            <img width="150" height="100"" class="center" src="https://firebasestorage.googleapis.com/v0/b/slimmeeigendomdb.appspot.com/o/Azur_small.gif?alt=media&token=289506e5-49da-435a-877d-bd00757f3aac">
            <span class="white-text name" style="font-size:18px">Condomynium: Azur</span>
          </div>
        </li>
        <li id="homeTab" class="tab side text-teal"><a class=" active waves-effect" href="#Home" style="font-size:22px"
            onclick="loadHome()">Home</a>
        </li>
        <li class="tab side text-teal"><a class="waves-effect" href="#Reports" style="font-size:22px"
            onclick="loadReports()">Reports</a></li>
        <li class="tab side text-teal"><a class="waves-effect" href="#Transactions" style="font-size:22px"
            onclick="loadTransactions()">Transactions</a></li>
        <li class="tab side text-teal"><a class="waves-effect" href="#MeterReadings" style="font-size:22px"
            onclick="loadMeterReadings()">Meter Readings</a></li>
        <li class="tab side text-teal"><a class="waves-effect" href="#Members" style="font-size:22px"
            onclick="loadMembers()">Members</a></li>
        <li class="tab side text-teal"><a class="waves-effect" href="#Properties" style="font-size:22px"
            onclick="loadProperties()">Properties</a></li>
        <li id="tabSettings" style="display:none" class="tab side text-teal"><a class="waves-effect" href="#Settings" style="font-size:22px"
            onclick="loadSettings()">Settings</a></li>  
      </ul>

      <script>
        function showMenu(){
          var el = document.getElementById("slide-out");
          M.Sidenav.init(el);
          var instance = M.Sidenav.getInstance(el);
          instance.open();
        };
        function hideMenu(){
          var el = document.getElementById("slide-out");
          M.Sidenav.init(el);
          var instance = M.Sidenav.getInstance(el);
          instance.close();
        };
        var elemshier = document.querySelectorAll('.sidenav');
        var instanceshier = M.Sidenav.init(elemshier);

        var collapsibleElemhier = document.querySelector('.collapsible');
        var collapsibleInstancehier = M.Collapsible.init(collapsibleElemhier);
        
        const tabsContainer = document.querySelector(".tabs");
        M.Tabs.init(tabsContainer);
        var instance = M.Tabs.getInstance(document.getElementById("slide-out"));
        instance.select("#Home");
      </script>
    </header>
    <main>
      <div class="row">
        <div id="Home" class="col s12">
          <h6 style="font-size:20px "><b>Announcements</b></h6>
          <br>
          <ul class="collapsible">
            <li>
              <div class="collapsible-header"><i class="material-icons">account_balance</i>Assemblée Générale Update Apr
                2, 2020</div>
              <div class="collapsible-body"><span>Chère / Cher Copropriétaire,
            A défaut d'une Assemblée Générale au cours de laquelle nous pouvions vous tenir au courant de la
            situation générale de notre immeuble et des travaux en cours, nous vous proposons de trouver ici touts les
            infos sur notre immeuble.</span></div>
            </li>
            <li>
              <div class="collapsible-header"><i class="material-icons">build</i>Travaux Update Mar 29, 2020</div>
              <div class="collapsible-body">
                <span>Chère / Cher Copropriétaire,
            Le réamenagement du jardin démarrera le mois de Mai. Veuillez nous excuser pour des éventuels inconvénients ayant la vision de retrouver après un jardin bien plus joli.</span>
              </div>
            </li>
          </ul>
          <br>
          <h6 style="font-size:20px "><b>Condomynium</b></h6>
          <div class="row">
            <div class="col s12 m6">
              <table>
                <tr>
                  <td>Name</td>
                  <td id="Home_CopropertyName"></td>
                </tr>
                <tr>
                  <td>Address</td>
                  <td id="Home_CopropertyAddress"></td>
                </tr>
                <tr>
                  <td>Administrator</td>
                  <td>Marc Van Limberghen</td>
                </tr>
              </table>
            </div>
            <div class="col s12 m6">
              <img width="300" height="175"" class="center" src="https://firebasestorage.googleapis.com/v0/b/slimmeeigendomdb.appspot.com/o/Azur_small.gif?alt=media&token=289506e5-49da-435a-877d-bd00757f3aac">
            </div>
          </div>
        </div>
        <!------------------------------------------------------------------------------------------------------>
        <div id="Reports" class="col s12">
          <div id="reportRemove" class="modal">
            <div class="modal-content">
              <h5> You are about to permanently remove the report</h5>
              <p id="report_to_remove"> </p>
            </div>
            <div class="modal-footer">
              <button style="float: right;margin-left: 20px" class="btn-small waves-light" type="submit" onclick="removeReport(report_to_remove)">Confirm<i class="material-icons right">send</i></button>
              <a style="float: right"
                class="modal-close waves-light btn-small"><i class="material-icons right">cancel</i>
                Cancel</a>
            </div>
          </div>
          <div id="reportAdd" class="modal">
            <div class="modal-content">
              <a style="float: right"
                class="modal-close waves-light btn-small"><i class="material-icons right">cancel</i>
                Cancel</a>
              <h5> New Report</h5>
              <div class="row">
                <form>
                  <div class="input-field" id="report_file_edit">
                  </div>
                  <div class="file-field input-field col s12 m6">
                    <div class="btn-small">
                      <span>PDF Document<b><font color='red'>*</font></b><i class="material-icons right">attach_file</i></span>
                      <input type="file" id="reportFile">
                    </div>
                    <div class="file-path-wrapper">
                      <input class="file-path validate" type="text" id="reportFileText">
                    </div>
                  </div>
                </form>
                <form>
                  <div class="input-field col s12 m6">
                    <input id="report_type_edit" type="text" required required="true" maxlength="50">
                    <label for="report_type_edit">Type<b><font color='red'>*</font></b></label>
                    <span class="helper-text" data-error="maximum 50 characters" ></span>
                  </div>
                </form>
              </div>
            </div>
            <div class="modal-footer">
              <button style="float: right;margin-left: 20px" class="btn-small waves-light" type="submit" onclick="writeReport()">Submit<i class="material-icons right">send</i></button>
              <a style="float: right"
                class="modal-close waves-light btn-small"><i class="material-icons right">cancel</i>
                Cancel</a>
            </div>
          </div>
          <div id="chargesReportAdd" class="modal">
            <div class="modal-content">
              <a style="float: right"
                class="modal-close waves-light btn-small"><i class="material-icons right">cancel</i>
                Cancel</a>
              <h5>Generate new charges report</h5>
              <div class="row">
                <form>
                  <div class="input-field col s12 m6">
                    <input id="chargesReport_closeDate" type="date" required required="true">
                    <label for="chargesReport_closeDate">Accountancy close date<b><font color='red'>*</font></b></label>
                  </div>
                  <div class="input-field col s12 m6">
                    <select id="chargesReport_metersIncluded" required aria-required="true">
                    <option value="" disabled selected>Indicate if meter readings should be included</option>
                    <option>Yes</option>
                    <option>No</option>
                    </select>
                    <label>Include Meter Readings<b><font color='red'>*</font></b></label>
                  </div>
                </form>
              </div>
            </div>
            <div class="modal-footer">
              <h6 style="float: right;margin-left: 20px">Generating the report might take a few minites. Please confirm
                the generated report after review</h6>
              <br><br>
              <button style="float: right;margin-left: 20px" class="btn-small waves-light" type="submit" onclick="prepareChargesReport()">Submit<i class="material-icons right">send</i></button>
              <a style="float: right"
                class="modal-close waves-light btn-small"><i class="material-icons right">cancel</i>
                Cancel</a>
            </div>
          </div>
          <h6 style="font-size:20px "><b>Charges reports generated by the application</b></h6>
          <table class="striped">
            <thead>
              <tr>
                <th>Period</th>
                <th>Meter readings included?</th>
              </tr>
            </thead>
            <tbody id="chargesReportsTable">
            </tbody>

          </table>
          <br>
          <div id="Reports_Generate" class="displayHidden">
            <button id="ChargesReport_Generate" style="float: right" data-target="chargesReportAdd" class="btn-small waves-light modal-trigger" onclick="emptyFieldsChargesReportAdd()"><i class="material-icons right">add</i>Generate New Charges Report</button>
          </div>
          <br><br>
          <h6 style="font-size:20px "><b>Reports uploaded by users</b></h6>
          <table class="striped">
            <thead>
              <tr>
                <th> File name </th>
                <th> Document Type</th>
                <th> Upload Date </th>
              </tr>
            </thead>
            <tbody id="reportsTable">
            </tbody>
          </table>
          <br>
          <div id="Reports_Add" class="displayHidden">
            <button style="float: right" data-target="reportAdd" class="btn-small waves-light modal-trigger" onclick="emptyReportFields()"><i class="material-icons right">add</i>New Report</button>
          </div>
        </div>
        <!------------------------------------------------------------------------------------------------------>
        <div id="Transactions" class="col s12">
          <table class="striped">
            <thead>
              <tr>
                <th>Click to<br>0pen Transaction</th>
                <th>
                  <p style="writing-mode: vertical-rl">Evidence?</p>
                </th>
                <th>Counterparty</th>
                <th>
                  <p style="text-align: right">Amount</p>
                </th>
                <th>
                  <p style="text-align: right">Date</p>
                </th>
              </tr>
            </thead>
            <tbody id="transactionsTable">
            </tbody>
          </table>
          <div class="displayHidden" <h6> <b>Total amount is </b><b id="totalAmount"></b></h6>
          </div>
          <div id="Transactions_Add" class="displayHidden">
            <button style="float: right" data-target="transactionAdd" class="btn-small waves-light modal-trigger" onclick="resetSelectedTransaction()"><i class="material-icons right">add</i>New transaction</button>
          </div>
          <div id="transactionAdd" class="modal">
            <div class="modal-content">
              <a style="float: right"
                class="modal-close waves-light btn-small"><i class="material-icons right">cancel</i>
                Cancel</a>
              <h5>New Transaction</h5>
              <form>
                <div class="input-field col s12 m4">
                  <select id="transaction_type_add" required required="true">
                            <option value="" disabled selected>Select the type</option>
                            <option>Repair</option>
                            <option>Maintenance</option>
                            <option>Installation</option>
                            <option>Insurance</option>
                            <option>Water</option>
                            <option>Electricity</option>
                            <option>Heating</option>
                            <option>Services</option>
                            <option>Equipment</option>
                            <option>Other</option>
                          </select>
                  <label>Type<b><font color='red'>*</font></b></label>
                </div>
                <div class="input-field col s12 m8">
                  <input id="transaction_name_add" type="text" class="validate" maxlength="50" required required="true">
                  <label for="transaction_name_add">Counterparty<b><font color='red'>*</font></b></label>
                  <span class="helper-text" data-error="Maximum 50 characters"></span>
                </div>
                <div class="input-field col s12 m4">
                  <input id="transaction_amount_add" type="number" class="validate" min="0" max="999999" step="0.01" required required="true">
                  <label for="transaction_amount_add">Amount<b><font color='red'>*</font></b></label>
                  <span class="helper-text" data-error="Positive amount of max 999999 with max 2 decimals. Example: 1234.56">Amount with max 2 decimals. Example: 1234.56</span>
                </div>
                <div class="input-field col s12 m4">
                  <input id="transaction_date_add" type="text" class="datepicker validate"  required required="true" onchange="copyToBookDate()">
                  <label for="transaction_date_add">Transaction Date<b><font color='red'>*</font></b></label>
                  <span class="helper-text" data-error="Required field"></span>
                </div>
                <div class="input-field col s12 m4">
                  <input id="transaction_bookDate_add" type="text" class="datepicker validate"  required required="true">
                  <label for="transaction_bookDate_add">Accountancy Date<b><font color='red'>*</font></b></label>
                  <span class="helper-text" data-error="Required field">By default copied from Transaction Date</span>
                </div>
                <div class="input-field col s12 m4">
                  <input id="transaction_account_add" type="text" maxlength="19" class="validate"
                    pattern="^BE\d{14}$|^BE\d{2}\s\d{4}\s\d{4}\s\d{4}$">
                  <label for="transaction_account_add">Account</label>
                  <span class="helper-text" data-error="BE followed by 14 digits, blancs for printing format allowed. Example: BE40 9799 2578 3625">BE followed by max 14 digits, blancs allowed. Example: BE40 9799 2578 3625</span>
                </div>
                <div class="input-field col s12 m8">
                  <input id="transaction_communication_add" type="text" class="validate" maxlength="80" >
                  <label for="transaction_communication_add">Communication</label>
                  <span class="helper-text" data-error="Maximum 80 characters"></span>
                </div>
              </form>
              <button style="float: right;margin-left: 20px;margin-bottom: 3px" class="btn-small waves-light" type="submit" onclick="addTransaction()">Save and go to adding evidence<i class="material-icons right">send</i></button>
              <a style="float: right;margin-bottom: 3px"
                class="modal-close waves-light btn-small"><i class="material-icons right">cancel</i>
                Cancel</a>
            </div>
          </div>

          <div id="transactionView" class="modal">
            <div class="modal-content">
              <a style="float: right"
                class="modal-close waves-light btn-small"><i class="material-icons right">cancel</i>
                Close</a>
              <h5> View Transaction</h5>
              <div class="w3-panel w3-border" style="box-shadow: 5px 10px 8px #888888">
                <form class="col s12">
                  <div class="input-field col s12 m4">
                    <input id="transaction_type" type="text" readonly>
                    <label for="transaction_type">type</label>
                  </div>
                  <div class="input-field col s12 m8">
                    <input id="transaction_name" type="text" readonly>
                    <label for="transaction_name">Counterparty</label>
                  </div>
                  <div class="input-field col s12 m4">
                    <input id="transaction_amount" type="text" readonly>
                    <label for="transaction_amount">Amount</label>
                  </div>
                  <div class="input-field col s12 m4">
                    <input id="transaction_date" type="text" readonly>
                    <label for="transaction_date">Transaction Date</label>
                  </div>
                  <div class="input-field col s12 m4">
                    <input id="transaction_bookDate" type="text" readonly>
                    <label for="transaction_bookDate">Accountancy Date</label>
                  </div>
                  <div class="input-field col s12 m4">
                    <input id="transaction_account" type="text" readonly>
                    <label for="transaction_account">Account</label>
                  </div>
                  <div class="input-field col s12 m8">
                    <input id="transaction_communication" type="text" readonly>
                    <label for="transaction_communication">Communication</label>
                  </div>
                </form>
                <div id="Transactions_Edit" class="displayHidden">
                  <button style="float: right;margin-bottom: 3px" data-target="transactionWrite" class="btn-small waves-light modal-trigger" onclick="editTransaction(selectedTransactionId, selectedTransactionObject)">Edit<i class="material-icons right">edit</i></button>
                </div>
              </div>
              <div class="w3-panel w3-border" style="box-shadow: 5px 10px 8px #888888">
                <h6 style="font-size:20px ">Transaction Evidence</h6>
                <table class="striped">
                  <thead>
                    <tr>
                      <th> File name</th>
                      <th> Document Type</th>
                    </tr>
                  </thead>
                  <tbody id="transactionEvidenceTable">
                  </tbody>
                </table>
                <br>
                <div id="Transactions_EvidenceAdd" class="displayHidden">
                  <button style="float: right;margin-bottom: 3px" data-target="transactionEvidenceAdd" class="btn-small waves-light modal-trigger" onclick="emptyTransactionEvidenceFields()"><i class="material-icons right">add</i>New Evidence</button>
                </div>
              </div>
              <a style="float: right;margin-bottom: 3px"
                class="modal-close waves-light btn-small"><i class="material-icons right">cancel</i>
                Close</a>
            </div>
          </div>

          <div id="transactionWrite" class="modal">
            <div class="modal-content">
              <a style="float: right"
                class="modal-close waves-light btn-small"><i class="material-icons right">cancel</i>
                Cancel</a>
              <h5>Edit Transaction</h5>
              <div class="row">
                <form class="col s12">
                  <div class="input-field col s12 m4">
                    <select id="transaction_type_edit" required required="true">
                           <option value="" disabled selected>Select the type</option>
                            <option>Repair</option>
                            <option>Maintenance</option>
                            <option>Installation</option>
                            <option>Insurance</option>
                            <option>Water</option>
                            <option>Electricity</option>
                            <option>Heating</option>
                            <option>Services</option>
                            <option>Equipment</option>
                            <option>Other</option>
                          </select>
                    <label>Type<b><font color='red'>*</font></b></label>
                  </div>
                  <div class="input-field col s12 m8">
                    <input id="transaction_name_edit" type="text" class="validate" maxlength="50" required required="true">
                    <label for="transaction_name_edit">Counterparty<b><font color='red'>*</font></b></label>
                    <span class="helper-text" data-error="maximum 50 characters" ></span>
                  </div>
                  <div class="input-field col s12 m4">
                    <input id="transaction_amount_edit" type="number" class="validate" min="0" max="999999" step="0.01" required required="true">
                    <label for="transaction_amount_edit">Amount<b><font color='red'>*</font></b></label>
                    <span class="helper-text" data-error="Positive amount of max 999999 with max 2 decimals. Example: 1234.56">Amount with max 2 decimals. Example: 1234.56</span>
                  </div>
                  <div class="input-field col s12 m4">
                    <input id="transaction_date_edit" type="text" class="datepicker validate"  required required="true">
                    <label for="transaction_date_edit">Transaction Date<b><font color='red'>*</font></b></label>
                    <span class="helper-text" data-error="required field" ></span>
                  </div>
                  <div class="input-field col s12 m4">
                    <input id="transaction_bookDate_edit" type="text" class="datepicker validate"  required required="true">
                    <label for="transaction_bookDate_edit">Accountancy Date<b><font color='red'>*</font></b></label>
                    <span class="helper-text" data-error="required field" ></span>
                  </div>
                  <div class="input-field col s12 m4">
                    <input id="transaction_account_edit" type="text" maxlength="19" class="validate"
                    pattern="^BE\d{14}$|^BE\d{2}\s\d{4}\s\d{4}\s\d{4}$">
                    <label for="transaction_account_edit">Account</label>
                    <span class="helper-text" data-error="BE followed by 14 digits, blancs for printing format allowed. Example: BE40 9799 2578 3625">BE followed by max 14 digits, blancs allowed. Example: BE40 9799 2578 3625</span>
                  </div>
                  <div class="input-field col s12 m8">
                    <input id="transaction_communication_edit" type="text" class="validate" maxlength="80" >
                    <label for="transaction_communication_edit">Communication</label>
                    <span class="helper-text" data-error="maximum 80 characters" ></span>
                  </div>
                </form>
              </div>
              <button style="float: right;margin-left: 20px;margin-bottom: 3px" class="btn-small waves-light" type="submit" onclick="updateTransaction()">Submit<i class="material-icons right">send</i></button>
              <a style="float: right;margin-bottom: 3px"
                class="modal-close waves-light btn-small"><i class="material-icons right">cancel</i>
                Cancel</a>
            </div>
          </div>

          <div id="transactionEvidenceRemove" class="modal">
            <div class="modal-content">
              <h5> You are about to permanently remove the evidence</h5>
              <p id="transactionEvidence_to_remove"> </p>
            </div>
            <div class="modal-footer">
              <button style="float: right;margin-left: 20px" class="btn-small waves-light" type="submit" onclick="removeTransactionEvidence(transactionEvidence_to_remove)">Confirm<i class="material-icons right">send</i></button>
              <a style="float: right"
                class="modal-close waves-light btn-small"><i class="material-icons right">cancel</i>
                Cancel</a>
            </div>
          </div>
          <div id="transactionEvidenceAdd" class="modal">
            <div class="modal-content">
              <a style="float: right"
                class="modal-close waves-light btn-small"><i class="material-icons right">cancel</i>
                Cancel</a>
              <h5> New Transaction Evidence</h5>
              <div class="row">
                <form>
                  <div class="input-field" id="transactionEvidence_file_edit">
                  </div>
                  <div class="file-field input-field col s12 m6">
                    <div class="btn-small">
                      <span>PDF Document<b><font color='red'>*</font></b><i class="material-icons right">attach_file</i></span>
                      <input type="file" id="transactionEvidenceFile">
                    </div>
                    <div class="file-path-wrapper">
                      <input class="file-path validate" type="text" id="transactionEvidenceFileText">
                    </div>
                  </div>
                </form>
                <form>
                  <div class="input-field col s12 m6">
                    <input id="transactionEvidence_type_edit" type="text" required required="true" maxlength="50">
                    <label for="transactionEvidence_type_edit">Type<b><font color='red'>*</font></b></label>
                    <span class="helper-text" data-error="maximum 50 characters" ></span>
                  </div>
                </form>
              </div>
            </div>
            <div class="modal-footer">
              <button style="float: right;margin-left: 20px" class="btn-small waves-light" type="submit" onclick="writeTransactionEvidence()">Submit<i class="material-icons right">send</i></button>
              <a style="float: right"
                class="modal-close waves-light btn-small"><i class="material-icons right">cancel</i>
                Cancel</a>
            </div>
          </div>

        </div>
        <!------------------------------------------------------------------------------------------------------>
        <div id="MeterReadings" class="col s12">
          <table class="striped">
            <thead>
              <tr>
                <th align=center>
                  <p style="writing-mode: vertical-rl">Property</p>
                </th>
                <th align=center>
                  <div class="writing-mode: vertical-rl">Click To<br>Open Reading</div>
                </th>
                <th align=center>
                  <p style="writing-mode: vertical-rl">Reading?</p>
                </th>
                <th align=center>
                  <p style="writing-mode: vertical-rl">Picture?</p>
                </th>
                <th align=center>Date</th>
              </tr>
            </thead>
            <tbody id="meterReadingsTable">
            </tbody>
          </table>

          <div id="pictureRemove" class="modal">
            <div class="modal-content">
              <h5> You are about to remove the meter reading picture</h5>
            </div>
            <div class="modal-footer">
              <button style="float: right;margin-left: 20px" class="btn-small waves-light" type="submit" onclick="removePicture()">Confirm<i class="material-icons right">send</i></button>
              <a style="float: right"
                class="modal-close waves-light btn-small"><i class="material-icons right">cancel</i>
                Cancel</a>
            </div>
          </div>

          <div id="meterReadingWrite" class="modal">
            <div class="modal-content">
              <a style="float: right"
                class="modal-close waves-light btn-small"><i class="material-icons right">cancel</i> Close</a>
              <h5>Meter info</h5>
              <form>
                <div class="input-field col s12 m6">
                  <input id="meterReading_property_edit" type="text" readonly>
                  <label for="meterReading_property_edit">Property</label>
                </div>
                <div class="input-field col s12 m6">
                  <input id="meterReading_type_edit" type="text" readonly>
                  <label for="meterReading_type_edit">Type</label>
                </div>
                <div class="input-field col s12 m6">
                  <input id="meterReading_id_edit" type="text" readonly>
                  <label for="meterReading_id_edit">ID Meter</label>
                </div>
                <div class="input-field col s12 m6">
                  <input id="meterReading_lastReading_edit" type="text" readonly>
                  <label for="meterReading_lastReading_edit">Last Reading</label>
                </div>
              </form>
              <h6><b>Please enter Meter Reading here below:</b></h6>
              <div class="row">
                <form>
                  <div class="input-field col s12 m6">
                    <div class="input-field">
                      <input id="meterReading_reading_edit" type="number" class="validate" max="9999999999" required required="true">
                      <label for="meterReading_reading_edit">Reading<b><font color='red'>*</font></b></label>
                      <span class="helper-text" data-error="Include decimals but ignore separator if present. Max 10 digits. Example: 06614639">Include decimals but ignore separator if present. Example: 06614639</span>
                    </div>
                    <br>
                    <div class="input-field ">
                      <input id="meterReading_date_edit" type="text" class="datepicker validate" required required="true">
                      <label for="meterReading_date_edit">Reading Date<b><font color='red'>*</font></b></label>
                      <span class="helper-text" data-error="required field" ></span>
                    </div>
                  </div>
                </form>
                <div class="col s12 m6">
                  <div id="meterReading_picture_frame_edit">
                    <div id="meterReading_picture_show_edit" class="col s12 m6">
                    </div>
                    <button style="float:right;margin-left: 20px;margin-top: 3px" class="btn-small waves-light red modal-trigger" data-target="pictureRemove" type="submit" >Remove Picture<i class="material-icons right">delete</i></button>
                  </div>
                  <form id="meterReading_picture_form" class="displayHidden">
                    <div class="input-field " id="meterReading_picture">
                    </div>
                    <div class="file-field input-field col s12 m6">
                      <div class="btn-small">
                        <span>Picture<i class="material-icons right">attach_file</i></span>
                        <input type="file" id="meterReading_picture_file">
                      </div>
                      <div class="file-path-wrapper">
                        <input class="file-path validate" type="text" id="meterReading_picture_text">
                      </div>
                    </div>
                  </form>
                </div>
              </div>


              <button style="float: right;margin-left: 20px;margin-bottom: 3px" class="btn-small waves-light" type="submit" onclick="writeMeterReading()">Submit<i class="material-icons right">send</i></button>
              <a style="float: right;margin-bottom: 3px"
                class="modal-close waves-light btn-small"><i class="material-icons right">cancel</i> Cancel</a>
            </div>
          </div>

          <div id="meterReadingRead" class="modal">
            <div class="modal-content">
              <a style="float: right"
                class="modal-close waves-light btn-small"><i class="material-icons right">cancel</i> Close</a>
              <h5>Meter info</h5>
              <form>
                <div class="input-field col s12 m6">
                  <input id="meterReading_property" type="text" readonly>
                  <label for="meterReading_property">Property</label>
                </div>
                <div class="input-field col s12 m6">
                  <input id="meterReading_type" type="text" readonly>
                  <label for="meterReading_type">Type</label>
                </div>
                <div class="input-field col s12 m6">
                  <input id="meterReading_id" type="text" readonly>
                  <label for="meterReading_id">ID Meter</label>
                </div>
                <div class="input-field col s12 m6">
                  <input id="meterReading_lastReading" type="text" readonly>
                  <label for="meterReading_lastReading">Last Reading</label>
                </div>
              </form>
              <div class="row">
                <form>
                  <div class="input-field col s12 m6">
                    <div class="input-field">
                      <input id="meterReading_reading" type="text" readonly>
                      <label for="meterReading_reading">Reading</label>
                    </div>
                    <div class="input-field ">
                      <input id="meterReading_date" type="text" readonly>
                      <label for="meterReading_date">Reading Date</label>
                    </div>
                  </div>
                </form>
                <div class="col s12 m6">
                  <div id="meterReading_picture_frame">
                    <div id="meterReading_picture_show" class="col s12 m6">
                    </div>
                  </div>
                </div>
              </div>
              <a style="float: right;margin-bottom: 3px"
                class="modal-close waves-light btn-small"><i class="material-icons right">cancel</i>Close</a>
            </div>
          </div>

        </div>
        <!------------------------------------------------------------------------------------------------------>
        <div id="Members" class="col s12">
          <table class="striped">
            <thead>
              <tr>
                <th style="white-space: nowrap"> First and Last Name </th>
                <th> Email </th>
                <th> Mobile </th>
              </tr>
            </thead>
            <tbody id="membersTable">
            </tbody>
          </table>
          <br>
          <div id="Members_Add" class="displayHidden">
            <button style="float: right" data-target="memberWrite" class="btn-small waves-light modal-trigger" onclick="resetSelectedMember()"><i class="material-icons right">add</i>New Member</button>
          </div>
        </div>
        <!--- shared views ------------------------------------------------------------------------------------>
        <div id="memberView" class="modal">
          <a style="float: right;margin-top: 3px;margin-right: 5px"
            class="modal-close waves-light btn-small"><i class="material-icons right">cancel</i>Close</a>
          <div class="modal-content">
            <h5> View member</h5>
            <div class="w3-panel w3-border" style="box-shadow: 5px 10px 8px #888888">
              <form class="col s12">
                <div class="input-field col s12 m4">
                  <i class="material-icons prefix">account_circle</i>
                  <input id="member_firstName" type="text" readonly>
                  <label for="member_firstName" >First Name</label>
                </div>
                <div class="input-field col s12 m8">
                  <i class="material-icons prefix">account_circle</i>
                  <input id="member_lastName" type="text" readonly>
                  <label for="member_lastName" >Last Name</label>
                </div>
                <div class="input-field col s12">
                  <input id="member_email" type="email" readonly>
                  <label for="member_email" >Email</label>
                </div>
                <div class="input-field col s12 m6">
                  <i class="material-icons prefix">phone</i>
                  <input id="member_phoneHome" type="tel" readonly>
                  <label for="member_phoneHome">Telephone Home</label>
                </div>
                <div class="input-field col s12 m6">
                  <i class="material-icons prefix">phone</i>
                  <input id="member_phoneMobile" type="tel" readonly>
                  <label for="member_phoneMobile">Mobile</label>
                </div>
                <p> </p>
                <div class="input-field col s12 m4">
                  <input  id="member_country" type="text" readonly >
                  <label for="member_country" >Country</label>
                </div>
                <div class="input-field col s12 m6">
                  <input  id="member_town" type="text" readonly >
                  <label for="member_town">Town</label>
                </div>
                <div class="input-field col s12 m2">
                  <input  id="member_zip" type="number" readonly>
                  <label for="member_zip" >Zip</label>
                </div>
                <div class="input-field col s12 m4">
                  <input  id="member_street" type="text" readonly >
                  <label for="member_street">Street</label>
                </div>
                <div class="input-field col s6 m2">
                  <input  id="member_houseNumber" type="text" readonly >
                  <label for="member_houseNumber">Number</label>
                </div>
                <div class="input-field col s6 m2">
                  <input  id="member_bus" type="number" readonly >
                  <label for="member_bus">Bus</label>
                </div>
                <div id="Members_Edit" class="displayHidden">
                  <button style="float: right;margin-bottom: 3px" data-target="memberWrite" class="btn-small waves-light modal-trigger" onclick="setSelectedMember(selectedMemberId, selectedMemberObject,editMode)">Edit<i class="material-icons right">edit</i></button>
                </div>
              </form>
            </div>
            <div class="w3-panel w3-border" style="box-shadow: 5px 10px 8px #888888">
              <div class="col s12 m4">
                <h6>Owner of:</h6>
                <p id="member_ownerOf"> </p>
              </div>
              <div class="col s12 m4">
                <h6>Occupant of:</h6>
                <p id="member_occupantOf"> </p>
              </div>
            </div>
          </div>
          <a style="float:right;margin-bottom: 3px;margin-right: 5px"
            class="modal-close waves-light btn-small"><i class="material-icons right">cancel</i>Close</a>
        </div>

        <div id="memberWrite" class="modal">
          <div class="modal-content">
            <a style="float: right" class="modal-close waves-light btn-small"><i class="material-icons right">cancel</i>
              Cancel</a>
            <h5> Enter member data</h5>
            <form class="col s12">
              <div class="input-field col s12 m4">
                <i class="material-icons prefix">account_circle</i>
                <input id="member_firstName_edit" type="text" class="validate" maxlength="50" required aria-required="true">
                <label for="member_firstName_edit" >First Name<b><font color='red'>*</font></b></label>
                <span class="helper-text" data-error="maximum 50 characters" ></span>
              </div>
              <div class="input-field col s12 m8">
                <i class="material-icons prefix">account_circle</i>
                <input id="member_lastName_edit" type="text" class="validate" maxlength="50" required aria-required="true">
                <label for="member_lastName_edit" >Last Name <b><font color='red'>*</font></b></label>
                <span class="helper-text" data-error="maximum 50 characters" ></span>
              </div>
              <div class="input-field col s12">
                <input id="member_email_edit" type="email" class="validate" maxlength="70" >
                <label for="member_email_edit" >Email</label>
                <span class="helper-text" data-error="email must contain @" ></span>
              </div>
              <div class="input-field col s12 m6">
                <i class="material-icons prefix">phone</i>
                <input id="member_phoneHome_edit" type="tel" pattern="([+]?[0-9]|[ ])*" maxlength="30" class="validate">
                <label for="member_phoneHome_edit">Telephone Home</label>
                <span class="helper-text" data-error="Only +, digits or spaces, max 30. Example: +32 2 456 789" >Only digits or spaces. Example: +32 2 456 789</span>
              </div>
              <div class="input-field col s12 m6">
                <i class="material-icons prefix">phone</i>
                <input id="member_phoneMobile_edit" type="tel" pattern="([+]?[0-9]|[ ])*" maxlength="30" class="validate">
                <label for="member_phoneMobile_edit">Mobile</label>
                <span class="helper-text" data-error="Only digits or spaces, max 30. Example: +32 476 123 456" >Only digits or spaces. Example: +32 476 123 456</span>
              </div>
              <div class="col s12 m12">
                <button style="float: left" class="btn-small waves-light" type="button" onclick="insertAdrressCoproperty()">Copy adress condomynium<i class="material-icons right">content_copy</i></button>
              </div>
              <div class="input-field col s12 m4">
                <input  id="member_country_edit" type="text" class="validate" maxlength="50" >
                <label for="member_country_edit" >Country</label>
                <span class="helper-text" data-error="Max 50 characters"></span>
              </div>
              <div class="input-field col s6 m6">
                <input  id="member_town_edit" type="text" class="validate" maxlength="50" >
                <label for="member_town_edit">Town</label>
                <span class="helper-text" data-error="Max 50 characters"></span>
              </div><div class="input-field col s6 m2">
                <input  id="member_zip_edit" type="text" class="validate" min="0" maxlength="10">
                <label for="member_zip_edit" >Zip</label>
                <span class="helper-text" data-error="Max 10 characters. For Belgium 4 digits. Example Belgium: 1730">"Example Belgium: 1730"</span>
              </div>
              
              <div class="input-field col s12 m4">
                <input  id="member_street_edit" type="text" class="validate" maxlength="50" >
                <label for="member_street_edit">Street</label>
                <span class="helper-text" data-error="Max 50 characters"></span>
              </div>
              <div class="input-field col s6 m2">
                <input  id="member_houseNumber_edit" type="text" class="validate" maxlength="10" >
                <label for="member_houseNumber_edit">Number</label>
                <span class="helper-text" data-error="Max 10 characters. Example 26A">Max 10 characters. Example 26A</span>
              </div>
              <div class="input-field col s6 m2">
                <input  id="member_bus_edit" type="text" class="validate" maxlength="3" >
                <label for="member_bus_edit">Bus</label>
                <span class="helper-text" data-error="Max 3 characters. Example 12" >Max 3 characters. Example 12</span>
              </div>
            </form>
            <button style="float: right;margin-left: 20px;margin-bottom: 3px" class="btn-small waves-light" type="submit" onclick="writeMember()">Submit<i class="material-icons right">send</i></button>
            <a style="float: right;margin-bottom: 3px"
              class="modal-close waves-light btn-small"><i class="material-icons right">cancel</i>
              Cancel</a>
          </div>

        </div>

        <div id="propertyView" class="modal">
          <a style="float: right;margin-top: 3px;margin-right: 5px"
            class="modal-close waves-light btn-small"><i class="material-icons right">cancel</i>Close</a>
          <div class="modal-content">
            <h5> View property</h5>
            <div class="w3-panel w3-border" style="box-shadow: 5px 10px 8px #888888">
              <form class="col s12">
                <div class="input-field col s6 m6">
                  <input id="property_code" type="text" readonly>
                  <label for="property_code">Code</label>
                </div>
                <div class="input-field col s6 m6">
                  <input id="property_quota" type="number" readonly>
                  <label for="property_quota">Quota</label>
                </div>
                <div class="input-field col s6 m6">
                  <input id="property_type" type="text" readonly>
                  <label for="property_type">Type</label>
                </div>
                <div class="input-field col s6 m6">
                  <input id="property_cellar" type="text" readonly>
                  <label for="property_cellar">Cellar(s)</label>
                </div>
                <div id="Properties_Edit" class="displayHidden">
                  <button style="float: right;margin-bottom: 3px" data-target="propertyWrite" class="btn-small waves-light modal-trigger" onclick="setEditPropertyEntries()">Edit<i class="material-icons right">edit</i></button>
                </div>
              </form>
            </div>
            <div class="w3-panel w3-border" style="box-shadow: 5px 10px 8px #888888">
              <div>
                <h7>Owner: </h7>
                <button id="property_owner" data-target="memberView" class="modal-trigger" style="border:none;background-color:Transparent"></button>

                <div class="displayHidden" id="previousOwnersButton">
                  <button style="float:right;margin-left: 20px;margin-bottom: 3px" data-target="previousOwners" class="btn-small waves-light modal-trigger" onclick="showPreviousOwnersTable()">Previous Owners</button>
                </div>
                <div id="Properties_OwnersAdd" class="displayHidden">
                  <button style="float:right;margin-bottom: 3px" data-target="newOwner" class="btn-small waves-light modal-trigger" onclick="newOwner()">New Owner<i class="material-icons right">add</i></button>
                </div>
              </div>
            </div>
            <div class="w3-panel w3-border" style="box-shadow: 5px 10px 8px #888888">
              <div>
                <h7>Meters</h7>
                <table class="striped">
                  <thead>
                    <th>Type</th>
                    <th>Meter ID</th>
                    <th>Status</th>
                  </thead>
                  <tbody id="property_meters">
                  </tbody>
                </table>
              </div>
              <div id="Properties_MetersAdd" class="displayHidden">
                <button style="float: right;margin-bottom: 3px" class="btn-small waves-light modal-trigger" data-target="meterWrite" onclick="addMeter()">Add Meter<i class="material-icons right">add</i></button>
              </div>
            </div>
            
            <div class="w3-panel w3-border" style="box-shadow: 5px 10px 8px #888888">
              <div>
                <h7>Occupants</h7>
                <table class="striped">
                  <tbody id="property_occupants">
                  </tbody>
                </table>
              </div>
              <div id="Properties_OccupantsAdd" class="displayHidden">
                <div class="input-field col s12 m4">
                  <select id="property_occupant_add" onchange="enableOccupantAdd()">
                  </select>
                </div>
                <div class="input-field col s12 m4">
                  <button id="buttonOccupantAdd" class="btn-small waves-light disabled" onclick="addOccupant()">Add as Occupant<i class="material-icons right">add</i></button>
                </div>
              </div>
            </div>

          </div>

          <a style="float:right;margin-bottom: 3px"
            class="modal-close waves-light btn-small"><i class="material-icons right">cancel</i>Close</a>

        </div>

        <div id="meterWrite" class="modal">
            <div class="modal-content">
              <a style="float: right"
                class="modal-close waves-light btn-small"><i class="material-icons right">cancel</i> Close</a>
              <h5> Enter meter</h5>
              <form class="col s12">
                <div class="input-field col s12 m4">
                  <select id="meter_type" required aria-required="true">
                    <option value="" disabled selected>Select the type</option>
                    <option>Cold Water</option>
                    <option>Hot Water</option>
                    <option>Heating</option>
                  </select>
                  <label for="meter_type">Type<b><font color='red'>*</font></b></label>
                </div>
                <div class="input-field col s12 m4">
                  <input id="meter_id" type="text" maxlength="10" class="validate" required aria-required="true" pattern="([A-Z]|[0-9]){4,10}">
                  <label for="meter_id">ID meter<b><font color='red'>*</font></b></label>
                  <span class="helper-text" data-error="4 to 10 digts or capital letters. Example 99DB517508">4 to 10 digts or capital letters. Example 99DB517508</span>
                </div>
                <div class="input-field col s12 m4">
                  <select id="meter_status" required aria-required="true">
                    <option selected>Active</option>
                    <option>Removed</option>
                  </select>
                  <label for="meter_status">Status<b><font color='red'>*</font></b></label>
                </div>
                  <div id="meter_firstReadingPanel" class="input-field col s12 m4" >
                    <input id="meter_firstReading" type="number" class="validate" max="9999999999" required required="true">
                    <label for="meter_firstReading">Reading<b><font color='red'>*</font></b></label>
                    <span class="helper-text" data-error="Include decimals but ignore separator if present. Max 10 digits. Example: 06614639">Include decimals but ignore separator if present. Example: 06614639</span>
                  </div>
                
              </form>
              <button style="float: right;margin-left: 20px;margin-bottom: 3px" class="btn-small waves-light" type="submit" onclick="writeMeter()">Submit<i class="material-icons right">send</i></button>
              <a style="float: right;margin-bottom: 3px"
                class="modal-close waves-light btn-small"><i class="material-icons right">cancel</i> Cancel</a>
            </div>
        </div>
        <!------------------------------------------------------------------------------------------>
        <div id="Properties" class="col s12">
          <table class="striped">
            <thead>
              <tr>
                <th>Code</th>
                <th>Quota</th>
                <th>Type</th>
                <th>Owner</th>
              </tr>
            </thead>
            <tbody id="propertiesTable">
            </tbody>
          </table>
          <h6><b id="totalQuotas"></b></h6>
          <div id="Properties_Add" class="displayHidden">
            <button style="float: right" data-target="propertyAdd" class="btn-small waves-light modal-trigger" onclick="resetSelectedProperty()"><i class="material-icons right">add</i>New Property</button>
          </div>

          
          <div id="previousOwners" class="modal">
            <div class="modal-content">
              <a style="float: right"
                class="modal-close waves-light btn-small"><i class="material-icons right">cancel</i> Close</a>
              <h5> Previous Owners:</h5>
              <table class="striped">
                <thead>
                  <tr>
                    <th> Member </th>
                    <th> Transfer Date </th>
                  </tr>
                </thead>
                <tbody id="propertyPreviousOwnersTable">
                </tbody>
              </table>
              <a style="float: right"
                class="modal-close waves-light btn-small"><i class="material-icons right">cancel</i> Close</a>
            </div>
          </div>

          <div id="propertyAdd" class="modal">
            <div class="modal-content">
              <a style="float: right"
                class="modal-close waves-light btn-small"><i class="material-icons right">cancel</i> Cancel</a>
              <h5> New Property</h5>
              <form class="col s12">
                <div class="input-field col s6 m6">
                  <input id="property_code_add" type="text" pattern="([A-Z]|[0-9]){1,4}" class="validate" required aria-required="true">
                  <label for="property_code_add">Code<b><font color='red'>*</font></b></label>
                  <span class="helper-text" data-error="Max 4 capitals or numbers. Example: A1">Max 4 capitals or numbers. Example: A1</span>
                </div>
                <div class="input-field col s6 m6">
                  <input id="property_quota_add" type="number" class="validate" min="0" max="999" required aria-required="true">
                  <label for="property_quota_add">Quota<b><font color='red'>*</font></b></label>
                  <span class="helper-text" data-error="A number of max 3 digits. Example: 22">A number of max 3 digits. Example: 22</span>
                </div>
                <div class="row">
                  <div class="input-field col s6 m6">
                    <select id="property_type_add" required aria-required="true">
                    <option value="" disabled selected>Select the type</option>
                    <option>Garage</option>
                    <option>Apartment</option>
                  </select>
                    <label for="property_type_add">Type<b><font color='red'>*</font></b></label>
                  </div>
                  <div class="input-field col s12 m6">
                    <select id="property_owner_add" required aria-required="true">
                      <option value="" disabled selected>Select the owner</option>
                    </select>
                    <label for="property_owner_add">Owner<b><font color='red'>*</font></b></label>
                  </div>
                </div>
                <div class="input-field col s6 m6">
                  <input id="property_cellar_add" type="text" maxlength="10" class="validate">
                  <label for="property_cellar_add">Cellar(s)</label>
                  <span class="helper-text" data-error="A string of max 10 digits: Example: C1, C2">A string of max 10 digits: Example: C1,C2</span>
                </div>
              </form>
              <button style="float: right;margin-left: 20px;margin-bottom: 3px" class="btn-small waves-light" type="submit" onclick="addProperty()">Save and complete by adding meters<i class="material-icons right">send</i></button>
              <a style="float: right;margin-bottom: 3px"
                class="modal-close waves-light btn-small"><i class="material-icons right">cancel</i> Cancel</a>
            </div>
          </div>

          <div id="newOwner" class="modal">
            <div class="modal-content">
              <a style="float: right"
                class="modal-close waves-light btn-small"><i class="material-icons right">cancel</i> Cancel</a>
              <h5> Transfer property to new owner</h5>
              <form class="col s12">
                <div class="input-field col s12 m6">
                  <select id="property_newOwner" required aria-required="true">
                      <option value="" disabled selected>Select the new owner</option>
                    </select>
                  <label for="property_newOwner">New Owner<b><font color='red'>*</font></b></label>
                </div>
                <div class="input-field col s12 m6">
                  <input id="property_transferDate" type="text" class="datepicker validate" required required="true">
                  <label for="property_transferDate">Transfer Date<b><font color='red'>*</font></b></label>
                  <span class="helper-text" data-error="required field" ></span>
                </div>
              </form>
              <button style="float: right;margin-left: 20px;margin-bottom: 3px" class="btn-small waves-light" type="submit" onclick="writeNewOwner()">Submit<i class="material-icons right">send</i></button>
              <a style="float: right;margin-bottom: 3px"
                class="modal-close waves-light btn-small"><i class="material-icons right">cancel</i> Cancel</a>
            </div>
          </div>

          <div id="previousOwner" class="modal">
            <div class="modal-content">
              <a style="float: right"
                class="modal-close waves-light btn-small"><i class="material-icons right">cancel</i> Cancel</a>
              <h5> Previous Owner</h5>
              <form class="col s12">
                <div class="input-field col s12 m6">
                  <select id="property_previousOwner" required aria-required="true">
                      <option value="" disabled selected>Correct the previous owner</option>
                    </select>
                  <label for="property_previousOwner">Previous Owner<b><font color='red'>*</font></b></label>
                </div>
                <div class="input-field col s12 m6">
                  <input id="property_transferDatePrevious" type="text" class="datepicker validate" required required="true">
                  <label for="property_transferDatePrevious">Transfer Date<b><font color='red'>*</font></b></label>
                  <span class="helper-text" data-error="required field" ></span>
                </div>
              </form>
              <button style="float: right;margin-left: 20px" class="btn-small waves-light" type="submit" onclick="writePreviousOwner()">Submit<i class="material-icons right">send</i></button>
              <a style="float: right"
                class="modal-close waves-light btn-small"><i class="material-icons right">cancel</i> Cancel</a>
            </div>
          </div>

          <div id="propertyWrite" class="modal">
            <div class="modal-content">
              <a style="float: right"
                class="modal-close waves-light btn-small"><i class="material-icons right">cancel</i> Cancel</a>
              <h5> Edit property data</h5>
              <form class="col s12">
                <div class="input-field col s6 m6">
                  <input id="property_code_edit" type="text" pattern="([A-Z]|[0-9]){1,4}" class="validate" required aria-required="true">
                  <label for="property_code_edit">Code<b><font color='red'>*</font></b></label>
                  <span class="helper-text" data-error="Max 4 capitals or numbers. Example: A1">Max 4 capitals or numbers. Example: A1</span>
                </div>
                <div class="input-field col s6 m6">
                  <input id="property_quota_edit" type="number" class="validate" min="0" max="999" required aria-required="true">
                  <label for="property_quota_edit">Quota<b><font color='red'>*</font></b></label>
                  <span class="helper-text" data-error="A number of max 3 digits. Example: 22">A number of max 3 digits. Example: 22</span>
                </div>
                <div class="row">
                  <div class="input-field col s6 m6">
                    <select id="property_type_edit" required aria-required="true">
                    <option value="" disabled selected>Select the type</option>
                    <option>Garage</option>
                    <option>Apartment</option>
                  </select>
                    <label for="property_type_edit">Type<b><font color='red'>*</font></b></label>
                  </div>
                  <div class="input-field col s6 m6">
                    <input id="property_cellar_edit" type="text" maxlength="10" class="validate">
                    <label for="property_cellar_edit">Cellar(s)</label>
                    <span class="helper-text" data-error="A string of max 10 digits: Example: C1, C2">A string of max 10 digits: Example: C1,C2</span>
                  </div>
                </div>
              </form>
              <button style="float: right;margin-left: 20px;margin-bottom: 3px" class="btn-small waves-light" type="submit" onclick="writeProperty()">Submit<i class="material-icons right">send</i></button>
              <a style="float: right;margin-bottom: 3px"
                class="modal-close waves-light btn-small"><i class="material-icons right">cancel</i> Cancel</a>
            </div>
          </div>
        </div>
        <div id="Settings" class="col s12">
          <h5>Meters common parts</h5>
            <table class="striped">
              <thead>
                <th>Type</th>
                <th>Meter ID</th>
                <th>Status</th>
              </thead>
              <tbody id="coproperty_meters">
              </tbody>
            </table>
            <br>
            <button style="float: right;margin-bottom: 3px" class="btn-small waves-light modal-trigger" data-target="meterWrite" onclick="addCopropertyMeter()">Add Meter<i class="material-icons right">add</i></button>
        </div>
      </div>
    </main>
    <script>
      var currencyStyle = {
        style: "currency",
        currency: "EUR"
      };
      var currentUserProperties;
      var currentUser = {
        email: "",
        role: "",
        id:"",
        owns: function(propertyId){
          var x = [];
          if (!currentUserProperties) {
            currentUserProperties = [];
            refCoproperty.collection("Properties").where("owner","==",this.id).get().then(function(propertiesFS){
              propertiesFS.forEach(function (propertyFS){
                console.log("properties is " + currentUserProperties);
                currentUserProperties.push(propertyFS.id);
                console.log("properties is " + currentUserProperties);
              });
              console.log("properties is " + currentUserProperties);
              console.log("propertyid is is " + propertyId);
              return currentUserProperties.includes(propertyId);
            });
          } else {
          return currentUserProperties.includes(propertyId);
          };
        }
      };
      var roleAdministrator = 1;

      function showPasswordSet() {
      document.getElementById("loginPanel").setAttribute("class","displayHidden");
      document.getElementById("setPasswordPanel").setAttribute("class","displayBlock");
      };

      function showPasswordReset() {
      document.getElementById("loginPanel").setAttribute("class","displayHidden");
      document.getElementById("resetPasswordPanel").setAttribute("class","displayBlock");
      };

    function validateLoginEntries() {
      var valid= true;
      if (!document.getElementById("login_email").checkValidity()) {
        M.toast({html:"Please enter your email"});
        valid=false;
      };
      if (!document.getElementById("login_password").checkValidity()) {
        M.toast({html:"Please enter your password"});
        valid=false;
      };
      return valid;
    };

    function openApplication() {
      refCoproperty.collection("ChargesReports").orderBy("endDate", "desc").limit(1).get().then (function(chargesReportsFS){
        refCoproperty.get().then(function(copropertyFS){
          currentCoproperty = copropertyFS.data();
          if  (chargesReportsFS.docs.length > 0) {lastCloseDate= chargesReportsFS.docs[0].endDate;}
          else {lastCloseDate = currentCoproperty.initialStartDate;};
        
          emptyHTMLSet(document.getElementById("Home_CopropertyName"));
          var textN = document.createTextNode(currentCoproperty.name);
          document.getElementById("Home_CopropertyName").appendChild(textN);
          textN = document.createTextNode(currentCoproperty.street + " " + currentCoproperty.houseNumber + ", "+ currentCoproperty.zip + " " + currentCoproperty.town);
          document.getElementById("Home_CopropertyAddress").appendChild(textN);
          homeLoaded = true;
          document.getElementById("loginPanel").setAttribute("class","displayHidden");
          document.getElementById("applicationPanel").setAttribute("class","displayBlock");
        });
      });
    };
    
    function login(){
      if (validateLoginEntries()) {
        var email = document.getElementById("login_email").value.toLowerCase();
        var password = document.getElementById("login_password").value;

        var docUserRef = firestore.collection("Users").doc(email);
        docUserRef.get().then(function(user){
          if (user.exists)  {
            firebase.auth().setPersistence(firebase.auth.Auth.Persistence.SESSION)
              .then(function() {
                  firebase.auth().signInWithEmailAndPassword(email, password)
                    .then(function(user){
                      
                      refCoproperty.collection("Members").where("email", "==" ,email).get().then(function(membersFS){ currentUser.email = email;
                        currentUser.id = membersFS.docs[0].id;
                        if (membersFS.docs[0].data().role) {
                          currentUser.role = roleAdministrator;
                          document.getElementById("Reports_Generate").setAttribute("class","displayBlock");
                          document.getElementById("Reports_Add").setAttribute("class","displayBlock");
                          document.getElementById("Transactions_Add").setAttribute("class","displayBlock");
                          document.getElementById("Transactions_Edit").setAttribute("class","displayBlock");
                          document.getElementById("Transactions_EvidenceAdd").setAttribute("class","displayBlock");
                          document.getElementById("Members_Add").setAttribute("class","displayBlock");
                          document.getElementById("Members_Edit").setAttribute("class","displayBlock");
                          document.getElementById("Properties_Add").setAttribute("class","displayBlock");
                          document.getElementById("Properties_Edit").setAttribute("class","displayBlock");
                          document.getElementById("Properties_MetersAdd").setAttribute("class","displayBlock");
                          document.getElementById("Properties_OwnersAdd").setAttribute("class","displayBlock");
                          document.getElementById("tabSettings").style.display = "block";
                        };
                        openApplication();
                      }).catch(function(error) {
                        M.toast({html:"You are not registered as an active user: Please contact your administrator"});
                      }); 
                    })
                    .catch(function(error) {
                      M.toast({html:"Invalid email or password"});
                    });
              })
              .catch (function(error) {
                M.toast({html:error.message + "...authentication server not accessible"});
              });  
          }
          else {
            M.toast({html:"Unknown email: Please contact your administartor"});
          };
        });
      };
    };

    function backToLoginFromSetPW() {
      document.getElementById("setPasswordPanel").setAttribute("class","displayHidden");
      document.getElementById("loginPanel").setAttribute("class","displayBlock"); 
    };
    function backToLoginFromResetPW() {
      document.getElementById("resetPasswordPanel").setAttribute("class","displayHidden");
      document.getElementById("loginPanel").setAttribute("class","displayBlock"); 
    };
    
    function validatePasswordSetEntries() {
        var valid= true;
        if (!document.getElementById("passwordSet_email").checkValidity()) {
          M.toast({html:"Please enter your email"});
          valid=false;
        };
        return valid;
    };

      
    function passwordSet(){
      if (validatePasswordSetEntries()) {
        var email = document.getElementById("passwordSet_email").value;
        var docUserRef = firestore.collection("Users").doc(email);
        docUserRef.get().then(function(user){
          if (user.exists)  {
            firebase.auth().sendPasswordResetEmail(email).then(function() {
                M.toast({html:"Please follow instructions sent by mail"});
                setTimeout(function(){backToLoginFromSetPW();}, 6000);
            }).catch(function(error) {
              M.toast({html:"Error sending mail to set password set" + error});
            });
          } else {M.toast({html:"Unknown email: Please contact your administrator"});
          };
        }).catch(function(error) {
            M.toast({html:"Unknown email: Please contact your administrator"});
        });
      };
    };
    
    function validatePasswordResetEntries() {
        var valid= true;
        if (!document.getElementById("passwordReset_email").checkValidity()) {
          M.toast({html:"Please enter your email"});
          valid=false;
        };
        return valid;
    };
    
    
    function passwordReset(){
      if (validatePasswordResetEntries()) {
        var email = document.getElementById("passwordReset_email").value;
        var docUserRef = firestore.collection("Users").doc(email);
        docUserRef.get().then(function(user){
          if (user.exists)  {
            firebase.auth().sendPasswordResetEmail(email).then(function() {
                M.toast({html:"Please follow instructions sent by mail"});
                setTimeout(function(){backToLoginFromResetPW();}, 6000);
            }).catch(function(error) {
              M.toast({html:"Error sending password reset mail" + error});
            });
          } else {M.toast({html:"Unknown email: Please contact your administrator"});
          };
        }).catch(function(error) {
            M.toast({html:"Unknown email: Please contact your administrator"});
        });
      };
    };
    </script>
    <!--   Application scripts starts here -->
    <script>
      
    const options = {
        duration: 300,
        onShow: null,
        swipeable: false,
        responsiveThreshold: Infinity
    };
    var elems = document.querySelectorAll('select');
    var instances = M.FormSelect.init(elems); 

    const tabsContainer = document.querySelector(".tabs");
    M.Tabs.init(tabsContainer,options);
    elems = document.querySelectorAll('.datepicker');
    instances = M.Datepicker.init(elems, {maxDate: new Date(),format: 'yyyy-mm-dd'});

    
    elems = document.querySelectorAll('.modal');
    instances = M.Modal.init(elems, {dismissible:false,preventScrolling:false});

    var refCoproperty = firestore.doc("CoProperties/OrncEBHp37pJYisfxf79");
    var refCopropertyFiles = fileStorageRef.child("OrncEBHp37pJYisfxf79");
    var editMode = "_edit";
        
    function emptyHTMLSet(set) {
      while(set.hasChildNodes()){
        set.removeChild(set.firstChild);
      };
    };

    elems = document.querySelectorAll('.sidenav');
    instances = M.Sidenav.init(elems);
    /*
    var collapsibleElem = document.querySelector('.collapsible');
    var collapsibleInstance = M.Collapsible.init(collapsibleElem);
    */
    var elems = document.querySelectorAll('.collapsible');
    var instances = M.Collapsible.init(elems);
    
    </script>
    <!--   Home scripts start here -->
    <script>
      var lastCloseDate;
      var lastReguDate;
      var currentCoproperty;
      var currentCopropertyId;
      function refreshHome(){
      refCoproperty.get().then(function(copropertyFS){
        currentCopropertyId = copropertyFS.id;
        currentCoproperty = copropertyFS.data();
        
        emptyHTMLSet(document.getElementById("Home_CopropertyName"));
        var textN = document.createTextNode(currentCoproperty.name);
        document.getElementById("Home_CopropertyName").appendChild(textN);
        textN = document.createTextNode(currentCoproperty.street + " " + currentCoproperty.houseNumber + ", "+ currentCoproperty.zip + " " + currentCoproperty.town);
        document.getElementById("Home_CopropertyAddress").appendChild(textN);
        });
      };
      
      var homeLoaded = false;
      function loadHome() {
        hideMenu();
        document.getElementById("logo-container").innerHTML = "MyCondos: Home";
        if (!homeLoaded) {
          refreshHome();
          homeLoaded = true;
        };
      };
    
      function checkBookDate (bookDate){
        /* applied both for transactions and for meter readings */
        if (bookDate.localeCompare(lastCloseDate) < 1) { return false} 
        else { return true};
      };

    </script>
    <!--   Reports scripts start here -->
    <script>
      function emptyReportFields(){
        document.getElementById("reportFile").value = "";
        document.getElementById("reportFileText").value = "";
        document.getElementById("report_type_edit").value = "";
      };
      
      function showReport(url) {
          window.open(url,"_blank");
      };

      function loadReport (objectFS){
        var object = objectFS.data();
        var objectsRow= document.createElement('tr');
        
        var cellContent = document.createElement("button");
        cellContent.setAttribute('style','border:none;background-color:Transparent');
        cellContent.setAttribute('class','modal-trigger');
        cellContent.setAttribute('data-target','fileShow');
        refCopropertyFiles.child("Reports").child(objectFS.id).getDownloadURL().then(function(url) {
          
        cellContent.setAttribute('onclick','showReport('+JSON.stringify(url)+')');
        cellContent.innerHTML = "<font color='#0000FF'>" + object.fileName + "</font>";
        var cell = document.createElement('td');
        cell.appendChild(cellContent);
        objectsRow.appendChild(cell);
        
        cellContent = document.createTextNode(object.type);
        cell = document.createElement('td');
        cell.appendChild(cellContent);
        objectsRow.appendChild(cell);  
        
        cellContent = document.createTextNode(object.date);
        cell = document.createElement('td');
        cell.appendChild(cellContent);
        objectsRow.appendChild(cell); 
        if (currentUser.role == roleAdministrator) {
          cellContent = document.createElement('button');
          cellContent.setAttribute('class','modal-trigger btn-small waves-light red');
          cellContent.setAttribute("data-target", "reportRemove");
          cellContent.setAttribute('onclick','popupRemoveReport('+JSON.stringify(objectFS.id)+','+JSON.stringify(object.fileName)+')');
          var cellButtonIcon = document.createElement('i');
          cellButtonIcon.setAttribute('class','material-icons right');
          cellButtonIcon.innerHTML="delete";           
          cellContent.appendChild(cellButtonIcon);
          cellContent.innerHTML = "Remove";

          cell = document.createElement('td');
          cell.appendChild(cellContent);
          objectsRow.appendChild(cell);    
        };
        reportsTable.appendChild (objectsRow);
        });
      };

      function refreshReports(){
        emptyHTMLSet(reportsTable);
        refCoproperty.collection("Reports").orderBy("date","desc").get().then(function(objectsFSArray){
            objectsFSArray.forEach(function(objectFS){
              loadReport(objectFS);
            })
          });
      };

      var reportsLoaded = false;
      function loadReports() {
      hideMenu();
      document.getElementById("logo-container").innerHTML = "MyCondos: Reports";
      loadChargesReports();
      if (!reportsLoaded) {
            refreshReports();
            reportsLoaded = true;
          };
      };

      var reportFile;
      function validateReportEntries() {
        var valid = true
        if (!(document.getElementById("report_type_edit").value)) {
          M.toast({html:"Please enter Type"});
          valid=false;
        };
      
        reportFile = document.getElementById('reportFile').files[0];
        let allowed_mime_types = ['application/pdf'];
        let allowed_size_kb = 5000;
        if (reportFile) {
          if(allowed_mime_types.indexOf(reportFile.type) == -1) {
            M.toast({html:"Incorrect file type (only pdf allowed)"});
            valid=false;
          };
          if(reportFile.size > allowed_size_kb*1024) {
            M.toast({html:"File exceeds max size 500KB"});
            valid=false;
          };
        } else {
            M.toast({html:"Please select PDF File"});
            valid=false;
        };
        return valid;
      };

      function getReportEntries() {
        var d = new Date();
        return {
          fileName: reportFile.name,
          type: document.getElementById("report_type_edit").value,
          date: d.toDateString()
        };
      };


      function writeReport() {
        if (validateReportEntries()) {  
          var entries = getReportEntries();
          refCoproperty.collection("Reports").add(entries).then(function(docref) {
            if (reportFile) {
              var fileRef = refCopropertyFiles.child("Reports").child(docref.id);  
              fileRef.put(reportFile).then (function (){});
              M.Modal.getInstance(document.getElementById("reportAdd")).close();
              refreshReports();
            } else {
              M.toast({html:"System error writing file"});
            };
          }).catch(function(error) {
            M.toast({html:"System error writing document: " + error});
          });
        };
      };

      var report_to_remove;
      function popupRemoveReport(report,filename){
        document.getElementById("report_to_remove").innerHTML=filename;
        report_to_remove = report;
      }
      
      function removeReport(report){
        refCoproperty.collection("Reports").doc(report).delete().then(function(){
          refreshReports();
          var fileRef = refCopropertyFiles.child("Reports").child(report);
          fileRef.delete().then(function() {
          }).catch(function(error) {
            M.toast({html:"System error removing report file:" + error});
            console.log(error);
          });
          M.Modal.getInstance(document.getElementById("reportRemove")).close();
        }).catch(function(error) {
            M.toast({html:"System error removing report:" + error});
        });
      };

    function emptyFieldsChargesReportAdd() {
      document.getElementById("chargesReport_closeDate").value = "";
      document.getElementById("chargesReport_metersIncluded").value = "";
      var elems = document.querySelectorAll('select');
      M.FormSelect.init(elems);
      M.updateTextFields();
    };
    
    function validateChargesReportAdd() {
        var valid = true
        if (!document.getElementById("chargesReport_closeDate").checkValidity()) {
          M.toast({html:"Please enter accountancy close date"});
          valid=false;
        } else {
          checkDate = checkBookDate(document.getElementById("chargesReport_closeDate").value);
          if (!checkBookDate(document.getElementById("chargesReport_closeDate").value)) {
            M.toast({html:"Accountancy close date must be later than last close date being " + lastCloseDate});
            valid=false;
          };
        };
        return valid;
      };

      function prepareChargesReport() {
      if (validateChargesReportAdd()) {
        var metersIn = (document.getElementById("chargesReport_metersIncluded").value == "Yes");
        generateChargesReport(document.getElementById("chargesReport_closeDate").value, metersIn);
      };
    };

    function loadChargesReport (objectFS){
        var object = objectFS.data();
        if ((!object.confirmed) && (currentUser.role !== roleAdministrator)) {return};
        var objectsRow= document.createElement('tr');
        
        var cellContent = document.createElement("button");
        cellContent.setAttribute('style','border:none;background-color:Transparent');
        cellContent.setAttribute('class','modal-trigger');
        cellContent.setAttribute('data-target','fileShow');
        refCopropertyFiles.child("ChargesReports").child(objectFS.id).getDownloadURL().then(function(url) {
          
        cellContent.setAttribute('onclick','showReport('+JSON.stringify(url)+')');
        cellContent.innerHTML = "<font color='#0000FF'>" + object.startDate + " to " +object.endDate + "</font>";
        var cell = document.createElement('td');
        cell.appendChild(cellContent);
        objectsRow.appendChild(cell);
        
        if (object.metersIncluded) {cellContent = document.createTextNode("Yes");}
        else {cellContent = document.createTextNode("No");};
        cell = document.createElement('td');
        cell.appendChild(cellContent);
        objectsRow.appendChild(cell);  
        
        if (!object.confirmed) {
          cellContent = document.createElement('button');
          cellContent.setAttribute('class','btn-small waves-light');
          cellContent.setAttribute('onclick','popupChargesReportConfirmed('+JSON.stringify(objectFS.id)+')');
          var cellButtonIcon = document.createElement('i');
          cellButtonIcon.setAttribute('class','material-icons right');
          cellButtonIcon.innerHTML="verified_user";           
          cellContent.appendChild(cellButtonIcon);
          cellContent.innerHTML = "Confirm";

          cell = document.createElement('td');
          cell.appendChild(cellContent);
          objectsRow.appendChild(cell);  

          cellContent = document.createElement('button');
          cellContent.setAttribute('class','btn-small waves-light red');
          cellContent.setAttribute('onclick','popupChargesReportRemoved('+JSON.stringify(objectFS.id)+')');
          var cellButtonIcon = document.createElement('i');
          cellButtonIcon.setAttribute('class','material-icons right');
          cellButtonIcon.innerHTML="delete";           
          cellContent.appendChild(cellButtonIcon);
          cellContent.innerHTML = "Remove";

          cell = document.createElement('td');
          cell.appendChild(cellContent);
          objectsRow.appendChild(cell);   

          document.getElementById("ChargesReport_Generate").setAttribute("class", "btn-small waves-light modal-trigger disabled"); 
        };
        chargesReportsTable.appendChild (objectsRow);
        });
      };

      function refreshChargesReports(){
        emptyHTMLSet(chargesReportsTable);
        refCoproperty.collection("ChargesReports").orderBy("endDate","desc").get().then(function(chargesReportsFS){
            if  (chargesReportsFS.docs.length > 0) {
              lastCloseDate= chargesReportsFS.docs[0].endDate;
              var i = 0;
              while ((i < chargesReportsFS.docs.length) && (!chargesReportsFS.docs[i].data().metersIncluded)) {i = i+1};
              if (i < chargesReportsFS.docs.length) {lastReguDate = chargesReportsFS.docs[i].data().endDate}
              else {lastReguDate = currentCoproperty.initialStartDate};
            }
            else {
              lastCloseDate = currentCoproperty.initialStartDate;
              lastReguDate = currentCoproperty.initialStartDate;
            };
            chargesReportsFS.forEach(function(objectFS){
              loadChargesReport(objectFS);
            });
            meterReadingsLoaded = false;
          });
      };

      var chargesReportsLoaded = false;
      function loadChargesReports() {
      if (!chargesReportsLoaded) {
            refreshChargesReports();
            chargesReportsLoaded = true;
          };
      };

      function popupChargesReportConfirmed(chargesReportId) {
        refCoproperty.collection("ChargesReports").doc(chargesReportId).update({confirmed:true}).then(function(){
          refreshChargesReports();
          document.getElementById("ChargesReport_Generate").setAttribute("class", "btn-small waves-light modal-trigger");
          M.toast({html:"Charges report now visible to owners"});
        }).catch(function(error) {
          console.error("Error confirming charges report: ", error);
        });
      };

      function popupChargesReportRemoved(chargesReportId) {
        refCoproperty.collection("ChargesReports").doc(chargesReportId).delete().then(function(){
          refCopropertyFiles.child("ChargesReports").child(chargesReportId).delete().then({});
          refreshChargesReports();
          document.getElementById("ChargesReport_Generate").setAttribute("class", "btn-small waves-light modal-trigger");
          M.toast({html:"Charges report removed: correct your data and generate a new charges report anytime"});
        }).catch(function(error) {
          console.error("Error removing charges report: ", error);
        });
      };

    </script>
    <!--   Transaction scripts start here -->
    <script>
      var totalAmount=0;
      var transactionsTable = document.getElementById("transactionsTable");
      function loadTransaction (objectFS){
          var object = objectFS.data();
          var objectsRow= document.createElement('tr');
          
          var cellContent = document.createElement('button');
          cellContent.setAttribute("data-target", "transactionView");
          cellContent.setAttribute('class','btn-small waves-light modal-trigger');
          cellContent.setAttribute('onclick','setSelectedTransaction('+JSON.stringify(objectFS.id)+','+JSON.stringify(object)+')');
          var cellButtonIcon = document.createElement('i');
          cellButtonIcon.setAttribute('class','material-icons right');
          cellButtonIcon.innerHTML="add";           
          cellContent.appendChild(cellButtonIcon);
          cellContent.innerHTML = object.type;
          var cell = document.createElement('td');
          cell.appendChild(cellContent);
          objectsRow.appendChild(cell);   
          
          refCoproperty.collection("Transactions").doc(objectFS.id).collection("Evidence").get().then(function(objectsFSArray){
            if (objectsFSArray.docs.length > 0) {
              cellContent = document.createElement("i");
              cellContent.setAttribute("class","material-icons  green ");
              cellContent.innerHTML = "done";
            } else {
              cellContent = document.createElement("i");
              cellContent.setAttribute("class","material-icons  red ");
              cellContent.innerHTML = "clear";
            };
          
          cell = document.createElement('td');
          cell.appendChild(cellContent);
          objectsRow.appendChild(cell);
          
          cellContent = document.createTextNode(object.name);
          cell = document.createElement('td');
          cell.appendChild(cellContent);
          objectsRow.appendChild(cell); 

          var amount = Number(object.amount);
          /* totalAmount = totalAmount + amount;*/
          cellContent = document.createTextNode(amount.toLocaleString("nl-BE", currencyStyle));
          cell = document.createElement('td');
          cell.setAttribute("style", "text-align: right"); 
          cell.appendChild(cellContent);
          objectsRow.appendChild(cell);  
          
          cellContent = document.createTextNode(object.date);
          cell = document.createElement('td');
          cell.setAttribute("style", "text-align: right"); 
          cell.appendChild(cellContent);
          objectsRow.appendChild(cell); 

          
          transactionsTable.appendChild (objectsRow);
          });
        };
          
        function refreshTransactions(){
          emptyHTMLSet(transactionsTable);
          /*totalAmount = 0;*/
          refCoproperty.collection("Transactions").orderBy("date","desc").get().then(function(objectsFSArray){
              objectsFSArray.forEach(function(objectFS){
                loadTransaction(objectFS);
              });
              /* document.getElementById("totalAmount").innerHTML = totalAmount.toLocaleString("nl-BE", currencyStyle);*/
            });
        };

        var transactionsLoaded = false;
        function loadTransactions(){
          hideMenu();
          document.getElementById("logo-container").innerHTML = "MyCondos: Transactions";
          if (!transactionsLoaded) {
            refreshTransactions();
            transactionsLoaded = true;
          };
        };

      function updateTransaction() {
        if (validateTransactionEdit()) { 
            var entries =  getTransactionEntriesEdit();
            refCoproperty.collection("Transactions").doc(selectedTransactionId).set(entries)
          .then(function(docref) {
              refreshTransactions();
              setSelectedTransaction(selectedTransactionId,entries)
              M.Modal.getInstance(document.getElementById("transactionWrite")).close();
          }).catch(function(error) {
            console.error("Error updating transaction: ", error);
          });
        };
      };

      function addTransaction() {
        if (validateTransactionAdd()) {  
            var entries = getTransactionEntriesAdd();
            refCoproperty.collection("Transactions").add(entries).then(function(docref) {
              refreshTransactions();
              setSelectedTransaction(docref.id,entries);
              M.Modal.getInstance(document.getElementById("transactionAdd")).close();
              M.Modal.getInstance(document.getElementById("transactionView")).open();
          }).catch(function(error) {
            console.error("Error adding transaction: ", error);
          });
        };
      };

    function copyToBookDate(){
      if (!document.getElementById("transaction_bookDate_add").checkValidity()) {
        document.getElementById("transaction_bookDate_add").value = document.getElementById("transaction_date_add").value;
        M.updateTextFields();
      };
    };
    
    function validateTransactionAdd() {
      var valid = true
      if (!document.getElementById("transaction_type_add").checkValidity()) {
        M.toast({html:"Please enter type"});
        valid=false;
      };
      if (!document.getElementById("transaction_account_add").checkValidity()) {
        M.toast({html:"Please enter valid account"});
        valid=false;
      };
      if (!document.getElementById("transaction_name_add").checkValidity()) {
        M.toast({html:"Please enter counter party"});
        valid=false;
      };
      if (!document.getElementById("transaction_amount_add").checkValidity()) {
        M.toast({html:"Please enter amount"});
        valid=false;
      };
      if (!document.getElementById("transaction_date_add").checkValidity()) {
        M.toast({html:"Please enter transaction date"});
        valid=false;
      };
      if (!document.getElementById("transaction_bookDate_add").checkValidity()) {
        M.toast({html:"Please enter accountancy date"});
        valid=false;
      }else if (!checkBookDate(document.getElementById("transaction_bookDate_add").value)) {
          M.toast({html:"Accountancy date must be after last close data accountancy"});
          valid=false;
      };
      if (!document.getElementById("transaction_communication_add").checkValidity()) {
        M.toast({html:"Please enter valid communication"});
        valid=false;
      };
      return valid;
    };

    function validateTransactionEdit() {
      var valid = true
      if (!document.getElementById("transaction_type_edit").checkValidity()) {
        M.toast({html:"Please enter type"});
        valid=false;
      };
      if (!document.getElementById("transaction_account_edit").checkValidity()) {
        M.toast({html:"Please enter valid account"});
        valid=false;
      };
      if (!document.getElementById("transaction_name_edit").checkValidity()) {
        M.toast({html:"Please enter supplier name"});
        valid=false;
      };
      if (!document.getElementById("transaction_amount_edit").checkValidity()) {
        M.toast({html:"Please enter amount"});
        valid=false;
      };
      if (!document.getElementById("transaction_date_edit").checkValidity()) {
        M.toast({html:"Please enter transaction date"});
        valid=false;
      };
      if (!document.getElementById("transaction_bookDate_edit").checkValidity()) {
        M.toast({html:"Please enter accountancy date"});
        valid=false;
      }else if (!checkBookDate(document.getElementById("transaction_bookDate_edit").value)) {
          M.toast({html:"Accountancy date must be after last close data accountancy"});
          valid=false;
      };
      if (!document.getElementById("transaction_communication_edit").checkValidity()) {
        M.toast({html:"Please enter valid communication"});
        valid=false;
      };
      return valid;
    };

    function getTransactionEntriesAdd() {
      return {
        type: document.getElementById("transaction_type_add").value,
        account: document.getElementById("transaction_account_add").value,
        name: document.getElementById("transaction_name_add").value,
        amount: document.getElementById("transaction_amount_add").value,
        date: document.getElementById("transaction_date_add").value,
        bookDate: document.getElementById("transaction_bookDate_add").value,
        communication:document.getElementById("transaction_communication_add").value,
      };
    };

    function getTransactionEntriesEdit() {
      return {
        type: document.getElementById("transaction_type_edit").value,
        account: document.getElementById("transaction_account_edit").value,
        name: document.getElementById("transaction_name_edit").value,
        amount: document.getElementById("transaction_amount_edit").value,
        date: document.getElementById("transaction_date_edit").value,
        bookDate: document.getElementById("transaction_bookDate_edit").value,
        communication:document.getElementById("transaction_communication_edit").value,
      };
    };

    var selectedTransactionId;
    var selectedTransactionObject;
    function setSelectedTransaction(id,object) {
      selectedTransactionId = id;
      selectedTransactionObject = object;
      document.getElementById("transaction_type").value=object.type;
      document.getElementById("transaction_account").value=object.account;
      document.getElementById("transaction_name").value=object.name;
      document.getElementById("transaction_amount").value=Number(object.amount).toLocaleString("nl-BE", currencyStyle);
      document.getElementById("transaction_date").value=object.date;
      document.getElementById("transaction_bookDate").value=object.bookDate;
      document.getElementById("transaction_communication").value=object.communication;
      refreshTransactionEvidence()
      var elems = document.querySelectorAll('select');
      M.FormSelect.init(elems);
      M.updateTextFields();
    };

    function editTransaction(id,object) {
      document.getElementById("transaction_type_edit").value=object.type;
      document.getElementById("transaction_account_edit").value=object.account;
      document.getElementById("transaction_name_edit").value=object.name;
      document.getElementById("transaction_amount_edit").value=object.amount;
      document.getElementById("transaction_date_edit").value=object.date;
      document.getElementById("transaction_bookDate_edit").value=object.bookDate;
      document.getElementById("transaction_communication_edit").value=object.communication;
      var elems = document.querySelectorAll('select');
      M.FormSelect.init(elems);
      M.updateTextFields();
    };

    function resetSelectedTransaction() {
      selectedTransactionId = null;
      selectedTransactionObject = null;
      document.getElementById("transaction_type_add").value="";
      document.getElementById("transaction_account_add").value="";
      document.getElementById("transaction_name_add").value="";
      document.getElementById("transaction_amount_add").value="";
      document.getElementById("transaction_date_add").value="";
      document.getElementById("transaction_bookDate_add").value="";
      document.getElementById("transaction_communication_add").value="";
      var elems = document.querySelectorAll('select');
      M.FormSelect.init(elems);
      M.updateTextFields();
      elems = document.querySelectorAll('.modal');
      instances = M.Modal.init(elems, {dismissible:false});
    };

      function emptyTransactionEvidenceFields(){
        document.getElementById("transactionEvidenceFile").value = "";
        document.getElementById("transactionEvidenceFileText").value = "";
        document.getElementById("transactionEvidence_type_edit").value = "";
      };
      

      function loadTransactionEvidence (objectFS){
        var object = objectFS.data();
        var objectsRow= document.createElement('tr');

        var cellContent = document.createElement("button");
        refCopropertyFiles.child("Transactions").child(objectFS.id).getDownloadURL().then(function(url) {
        cellContent.setAttribute('onclick','showReport('+JSON.stringify(url)+')');
        cellContent.setAttribute('style','border:none;background-color:Transparent');
        cellContent.innerHTML = "<font color='#0000FF'>" + object.fileName + "</font>";
        
        var cell = document.createElement('td');
        cell.appendChild(cellContent);
        objectsRow.appendChild(cell);
        
        cellContent = document.createTextNode(object.type);
        cell = document.createElement('td');
        cell.appendChild(cellContent);
        objectsRow.appendChild(cell);  
        if (currentUser.role == roleAdministrator) {
          cellContent = document.createElement('button');
          cellContent.setAttribute('class','modal-trigger btn-small waves-light red');
          cellContent.setAttribute("data-target", "transactionEvidenceRemove");
          cellContent.setAttribute('onclick','popupRemoveTransactionEvidence('+JSON.stringify(objectFS.id)+','+JSON.stringify(object.fileName)+')');
          var cellButtonIcon = document.createElement('i');
          cellButtonIcon.setAttribute('class','material-icons right');
          cellButtonIcon.innerHTML="delete";           
          cellContent.appendChild(cellButtonIcon);
          cellContent.innerHTML = "Remove";

          cell = document.createElement('td');
          cell.appendChild(cellContent);
          objectsRow.appendChild(cell);    
        };
        transactionEvidenceTable.appendChild (objectsRow);
        });
      };

      function refreshTransactionEvidence(){
        emptyHTMLSet(transactionEvidenceTable);
        refCoproperty.collection("Transactions").doc(selectedTransactionId).collection("Evidence").get().then(function(objectsFSArray){
            objectsFSArray.forEach(function(objectFS){
              loadTransactionEvidence(objectFS);
            })
          });
      };

      var transactionEvidenceFile;
      function validateTransactionEvidenceEntries() {
        var valid = true
        if (!(document.getElementById("transactionEvidence_type_edit").value)) {
          M.toast({html:"Please enter Type"});
          valid=false;
        };
      
        transactionEvidenceFile = document.getElementById('transactionEvidenceFile').files[0];
        let allowed_mime_types = ['application/pdf','image/jpeg', 'image/png'];
        let allowed_size_kb = 5000;
        if (transactionEvidenceFile) {
          if(allowed_mime_types.indexOf(transactionEvidenceFile.type) == -1) {
            M.toast({html:"Incorrect file type (only pdf, jpeg and png allowed)"});
            valid=false;
          };
          if(transactionEvidenceFile.size > allowed_size_kb*1024) {
            M.toast({html:"File exceeds max size 500KB"});
            valid=false;
          };
        } else {
            M.toast({html:"Please select PDF File"});
            valid=false;
        };
        return valid;
      };

      function getTransactionEvidenceEntries() {
        return {
          fileName: transactionEvidenceFile.name,
          type: document.getElementById("transactionEvidence_type_edit").value,
        };
      };

      function writeTransactionEvidence() {
        if (validateTransactionEvidenceEntries()) {  
          var entries = getTransactionEvidenceEntries();
          refCoproperty.collection("Transactions").doc(selectedTransactionId).collection("Evidence").add(entries).then(function(docref) {
            if (transactionEvidenceFile) {
              var fileRef = refCopropertyFiles.child("Transactions").child(docref.id);  
              fileRef.put(transactionEvidenceFile).then (function (){});
              refreshTransactionEvidence();
              refreshTransactions();
              M.Modal.getInstance(document.getElementById("transactionEvidenceAdd")).close();
            } else {
              M.toast({html:"System error writing file"});
            };
          }).catch(function(error) {
            M.toast({html:"System error writing document: " + error});
          });
        };
      };

      var transactionEvidence_to_remove;
      function popupRemoveTransactionEvidence(transactionEvidence,filename){
        document.getElementById("transactionEvidence_to_remove").innerHTML=filename;
        transactionEvidence_to_remove = transactionEvidence;
      }
      
      function removeTransactionEvidence(transactionEvidence){
        refCoproperty.collection("Transactions").doc(selectedTransactionId).collection("Evidence").doc(transactionEvidence).delete().then(function(){
          refreshTransactionEvidence();
          refreshTransactions();
          var fileRef = refCopropertyFiles.child("Transactions").child(transactionEvidence);
          fileRef.delete().then(function() {
          }).catch(function(error) {
            M.toast({html:"System error removing transaction evidence file:" + error});
            console.log(error);
          });
          M.Modal.getInstance(document.getElementById("transactionEvidenceRemove")).close();
        }).catch(function(error) {
            M.toast({html:"System error removing transaction evidence:" + error});
        });
      };

    </script>
    <!--   Meter readings scripts start here -->
    <script>
      var meterReadingsTable = document.getElementById("meterReadingsTable");
      var meterReadingsLoaded = false;

      function loadMeterReading(propertyFS, meterFS){
        var objectsRow= document.createElement('tr');
        var cellContent;
        if (propertyFS) {cellContent = propertyLink(propertyFS);}
        else {cellContent = document.createTextNode("Common Parts");};
        var cell = document.createElement('td');
        cell.appendChild(cellContent);
        objectsRow.appendChild(cell);
        
        var meterData = meterFS.data();
        if (meterData.readings[0].date.localeCompare(lastCloseDate) < 1) {
          /* newest reading is in closed period: fake empty record */
          meterData.readings.unshift({
            counter : meterData.readings[0].counter + 1,
            picture : false,
            reading : "",
            date: "",
          });
        };
        var cellContent = document.createElement('button');
        var isOwner;
        if (propertyFS) {
          isOwner = (currentUser.id == propertyFS.data().owner);
          idHere = propertyFS.id;
          codeHere = propertyFS.data().code}
        else {
          isOwner = false;
          idHere =  currentCopropertyId;
          codeHere = "Common Parts";
        };

        if (currentUser.role == roleAdministrator || isOwner) {
          cellContent.setAttribute("data-target", "meterReadingWrite");
            cellContent.setAttribute('onclick','setSelectedMeterReading_edit('+JSON.stringify(idHere)+','+JSON.stringify(codeHere)+','+JSON.stringify(meterFS.id)+','+JSON.stringify(meterData)+')');
        } else {
          cellContent.setAttribute("data-target", "meterReadingRead");
          cellContent.setAttribute('onclick','setSelectedMeterReading_readonly('+JSON.stringify(idHere)+','+JSON.stringify(codeHere)+','+JSON.stringify(meterFS.id)+','+JSON.stringify(meterData)+')');
        };
        cellContent.setAttribute('class','btn-small waves-light modal-trigger');
        cellContent.innerHTML = meterData.type;
        cell = document.createElement('td');
        cell.appendChild(cellContent);
        objectsRow.appendChild(cell);  

        if (meterData.readings[0].reading) {
           cellContent = document.createElement("i");
           cellContent.setAttribute("class","material-icons  green ");
           cellContent.innerHTML = "done";
        } else {
          cellContent = document.createElement("i");
           cellContent.setAttribute("class","material-icons  red ");
           cellContent.innerHTML = "clear";
        };
        cell = document.createElement('td');
        cell.setAttribute("align","center");
        cell.appendChild(cellContent);
        objectsRow.appendChild(cell);  

        if (meterData.readings[0].picture) {
           /*cellContent = document.createTextNode("&#10060;");*/
           cellContent = document.createElement("i");
           cellContent.setAttribute("class","material-icons  green ");
           cellContent.innerHTML = "done";
        } else {
          cellContent = document.createElement("i");
           cellContent.setAttribute("class","material-icons  red ");
           cellContent.innerHTML = "clear";
        };
        cell = document.createElement('td');
        cell.setAttribute("align","center");
        cell.appendChild(cellContent);
        objectsRow.appendChild(cell);  

        cellContent = document.createTextNode(meterData.readings[0].date);
        cell = document.createElement('td');
        cell.appendChild(cellContent);
        objectsRow.appendChild(cell);

        meterReadingsTable.appendChild (objectsRow);
      };
      
      function refreshMeterReadings(){
        emptyHTMLSet(meterReadingsTable);
        refCoproperty.collection("Properties").orderBy("code").get().then(function(propertyFSArray){
          propertyFSArray.forEach(function(propertyFS){
            refCoproperty.collection("Properties").doc(propertyFS.id).collection("Meters").orderBy("type").get().then(function(meterFSArray){
              meterFSArray.forEach(function(meterFS){
                if (meterFS.data().status.normalize() === "Active".normalize()) {loadMeterReading(propertyFS,meterFS);};
              });
            });
          });  
          refCoproperty.collection("Meters").orderBy("type").get().then(function(meterFSArray){
            meterFSArray.forEach(function(meterFS){
              if (meterFS.data().status.normalize() === "Active".normalize()) {loadMeterReading(null,meterFS);};
            });
          });
        });    
      };
      
      function loadMeterReadings() {
        hideMenu();
        document.getElementById("logo-container").innerHTML = "MyCondos:Meter Readings";
        if (!meterReadingsLoaded) {
          refreshMeterReadings();
          meterReadingsLoaded = true;
        };
      };

      var selectedReadingId;
      var selectedReadingData;
      var selectedReadingPropertyId;
      var picturePresent;
      function setSelectedMeterReading_edit(propertyId, propertyCode,readingID, readingData){
        selectedReadingId = readingID;
        selectedReadingPropertyId = propertyId;
        selectedReadingData = readingData;
        document.getElementById("meterReading_property_edit").value = propertyCode;
        document.getElementById("meterReading_type_edit").value = readingData.type;
        document.getElementById("meterReading_id_edit").value = readingData.meter;
        document.getElementById("meterReading_lastReading_edit").value = readingData.readings[1].reading;
        document.getElementById("meterReading_reading_edit").value = readingData.readings[0].reading;
        document.getElementById("meterReading_date_edit").value = readingData.readings[0].date;
        emptyHTMLSet(document.getElementById("meterReading_picture"));
        emptyHTMLSet(document.getElementById("meterReading_picture_show_edit"));
        if (readingData.readings[0].picture) {
          refCopropertyFiles.child(selectedReadingPropertyId).child("Meters").child(selectedReadingId).child((readingData.readings[0].counter).toString()).getDownloadURL().then(function(url) {
            var imgEl = document.createElement("img");
            imgEl.setAttribute("width","400");
            imgEl.setAttribute("height","300");
            imgEl.setAttribute("src",url);
            document.getElementById("meterReading_picture_show_edit").appendChild(imgEl);
            document.getElementById("meterReading_picture_frame_edit").setAttribute("class","displayBlock");
            document.getElementById("meterReading_picture_form").setAttribute("class","displayHidden");
            picturePresent= true;
          });
        } else {
          document.getElementById("meterReading_picture_form").setAttribute("class","displayBlock");
          document.getElementById("meterReading_picture_frame_edit").setAttribute("class","displayHidden");
          document.getElementById("meterReading_picture_file").value = "";
          document.getElementById("meterReading_picture_text").value = "";
          picturePresent= false;
        };
        M.updateTextFields();
      };

      function setSelectedMeterReading_readonly(propertyId, propertyData,readingID, readingData){
        selectedReadingId = readingID;
        selectedReadingPropertyId = propertyId;
        document.getElementById("meterReading_property").value = propertyData.code;
        document.getElementById("meterReading_type").value = readingData.type;
        document.getElementById("meterReading_id").value = readingData.meter;
        document.getElementById("meterReading_lastReading").value = readingData.readings[1].reading;
        document.getElementById("meterReading_reading").value = readingData.readings[0].reading;
        document.getElementById("meterReading_date").value = readingData.readings[0].date;
        emptyHTMLSet(document.getElementById("meterReading_picture"));
        emptyHTMLSet(document.getElementById("meterReading_picture_show"));
        if (readingData.readings[0].picture) {
          refCopropertyFiles.child(selectedReadingPropertyId).child("Meters").child(selectedReadingId).child((readingData.readings[0].counter).toString()).getDownloadURL().then(function(url) {
            var imgEl = document.createElement("img");
            imgEl.setAttribute("width","400");
            imgEl.setAttribute("height","300");
            imgEl.setAttribute("src",url);
            document.getElementById("meterReading_picture_show").appendChild(imgEl);
            document.getElementById("meterReading_picture_frame").setAttribute("class","displayBlock");
            picturePresent= "Y";
          });
        } else {
          document.getElementById("meterReading_picture_frame").setAttribute("class","displayHidden");
          picturePresent= "";
        };
        M.updateTextFields();
      };

      function removePicture(){
        document.getElementById("meterReading_picture_form").setAttribute("class","displayBlock");
        document.getElementById("meterReading_picture_frame_edit").setAttribute("class","displayHidden");
        document.getElementById("meterReading_picture_file").value = "";
        document.getElementById("meterReading_picture_text").value = "";
        picturePresent = "";
        M.Modal.getInstance(document.getElementById("pictureRemove")).close();
      };
      
      function validateMeterReading(){
        var valid= true;
        if (!document.getElementById("meterReading_reading_edit").checkValidity()) {
          M.toast({html:"Please enter valid reading"});
          valid=false;
        };
        if (!document.getElementById("meterReading_date_edit").checkValidity()) {
          M.toast({html:"Please enter Reading Date"});
          valid=false;
        } else if (!checkBookDate(document.getElementById("meterReading_date_edit").value)) {
          M.toast({html:"Reading date must be after last close data accountancy"});
          valid=false;
        };
        var readingPicture = document.getElementById('meterReading_picture_file').files[0];
        let allowed_mime_types = [ 'image/jpeg', 'image/png' ];
        let allowed_size_kb = 500;
        if (readingPicture) {
          if(allowed_mime_types.indexOf(readingPicture.type) == -1) {
            M.toast({html:"Incorrect file type (only jpeg or png allowed)"});
            valid=false;
          };
          if(readingPicture.size > allowed_size_kb*1024) {
            M.toast({html:"Picture exceeds max size 500KB"});
            valid=false;
          };
        }
        return valid;
      };

      function writeMeterReading(){
        var pictureFileText = document.getElementById("meterReading_picture_text").value;
        if (validateMeterReading()) {
          var thisReading = selectedReadingData.readings[0];
          thisReading.reading = document.getElementById("meterReading_reading_edit").value;
          thisReading.date = document.getElementById("meterReading_date_edit").value;
          var thisRefFS;
          if (selectedReadingData.coproperty){thisRefFS = refCoproperty}
          else {thisRefFS = refCoproperty.collection("Properties").doc(selectedReadingPropertyId)};
          if (pictureFileText) { 
            // A new picture has been attached
            thisReading.picture= true;
            thisRefFS.collection("Meters").doc(selectedReadingId).update({readings:selectedReadingData.readings}).then(function() {
              var pictureFile = document.getElementById('meterReading_picture_file').files[0];
              var fileRef = refCopropertyFiles.child(selectedReadingPropertyId).child("Meters").child(selectedReadingId).child((thisReading.counter).toString());  
              fileRef.put(pictureFile).then (function (){});
              refreshMeterReadings();
              M.Modal.getInstance(document.getElementById("meterReadingWrite")).close();
            }).catch(function(error) {
              M.toast({html:"Error occurred updating meter reading:" + error}); 
            });
          } else {
            // No new picture attached: either existing picture or no picture or pictuture was removed
            thisReading.picture= picturePresent;
            thisRefFS.collection("Meters").doc(selectedReadingId).update({readings:selectedReadingData.readings}).then(function(docref) {
              refreshMeterReadings();
              M.Modal.getInstance(document.getElementById("meterReadingWrite")).close();
            }).catch(function(error) {
              M.toast({html:"Error occurred updating meter reading:" + error}); 
            });
          }
        };
      };
    </script>
    <!--   Members scripts start here -->
    <script>
      function insertAdrressCoproperty(){
        refCoproperty.get().then(function(copropertyFS){
          var object = copropertyFS.data();
          document.getElementById("member_country_edit").value=object.country;
          document.getElementById("member_zip_edit").value=object.zip;
          document.getElementById("member_town_edit").value=object.town;
          document.getElementById("member_street_edit").value=object.street;
          document.getElementById("member_houseNumber_edit").value=object.houseNumber;
          /*M.updateTextFields();*/
        });
      };
      
      function memberName(memberId){
        var x;
        refCoproperty.collection("Members").doc(memberId).get().then(function(memberFS){
          x = memberFS.data().lastName+" "+memberFS.data().firstName;
          return x;
        });
      };
      
      function memberLink(memberFS) {
        var memberData = memberFS.data();
        var elA = document.createElement('button');
        elA.setAttribute("data-target", "memberView");
        elA.setAttribute('class','modal-trigger');
        elA.setAttribute('style','border:none;background-color:Transparent');
        elA.setAttribute('onclick','setSelectedMember('+JSON.stringify(memberFS.id)+','+JSON.stringify(memberData)+',"")');
        elA.innerHTML = "<font color='#0000FF'>"+memberData.firstName+"   "+memberData.lastName+"</font>";
        return elA;
      };

      var membersTable = document.getElementById("membersTable");
      function loadMember (objectFS){
        var object = objectFS.data();
        var objectsRow= document.createElement('tr');
        var cellContent = memberLink(objectFS);
        var cell = document.createElement('td');
        cell.setAttribute("style","white-space: nowrap");
        cell.appendChild(cellContent);
        objectsRow.appendChild(cell);
        
        cellContent = document.createTextNode(object.email);
        cell = document.createElement('td');
        cell.appendChild(cellContent);
        objectsRow.appendChild(cell);  

        cellContent = document.createTextNode(object.phoneMobile);
        cell = document.createElement('td');
        cell.appendChild(cellContent);
        objectsRow.appendChild(cell);  

        membersTable.appendChild (objectsRow);
      };
      
      function refreshMembers() {
        emptyHTMLSet(membersTable);
        refCoproperty.collection("Members").orderBy("firstName").get().then(function(objectsFSArray){
          objectsFSArray.forEach(function(objectFS){
            loadMember(objectFS);
          });  
        });    
      };

      var membersLoaded = false;
      function loadMembers(){
        hideMenu();
        document.getElementById("logo-container").innerHTML = "MyCondos: Members";
        if (!membersLoaded) {
          refreshMembers();
          membersLoaded = true;
        };
      };

      function addMember(member){
        refCoproperty.collection("Members").add(member)
          .then(function(docref) {
            refreshMembers();
            M.Modal.getInstance(document.getElementById("memberWrite")).close();
          }).catch(function(error) {
            M.toast({html:"Error occurred adding this member:" + error}); 
          });
      };

      function updateMember(member){
        refCoproperty.collection("Members").doc(selectedMemberId).update(member)
          .then(function(docref) {
            refreshMembers();
            setSelectedMember(selectedMemberId,getMemberEntries(),"");
            M.Modal.getInstance(document.getElementById("memberWrite")).close();
          }).catch(function(error) {
            M.toast({html:"Error occurred updating this member:" + error}); 
          });
      };

      function writeMember() {
        if (validateMemberEntries()) {  
          var entries = getMemberEntries();
          if (mode === "add"){
            if (entries.email) {
              refCoproperty.collection("Members").where("email", "==", entries.email).get()
                .then(function(existingList) {
                  if (existingList.docs.length > 0) {
                    M.toast({html:"Error: member with this email already exists"}); 
                  } else {
                      addMember(entries);
                    };
                }) .catch (function(error) {
                  M.toast({html:"Error occurred checking email uniqueness:" + error}); 
                });
            } else {
                    addMember(entries);
            };
          } else {
            if ((entries.email) && (! (entries.email.normalize() === selectedMemberObject.email.normalize()))) {
              refCoproperty.collection("Members").where("email", "==", entries.email).get()
                .then(function(existingList) {
                  if (existingList.docs.length > 0) {
                    M.toast({html:"Error: member with this email already exists"}); 
                  } else {
                      updateMember(entries);
                    };
                }) .catch (function(error) {
                  M.toast({html:"Error occurred checking email uniqueness:" + error}); 
                });
            } else {
                    updateMember(entries);
            };
          };
        };
      };        

        function getMemberEntries() {
          return {
                firstName: document.getElementById("member_firstName_edit").value,
                lastName: document.getElementById("member_lastName_edit").value,
                email: document.getElementById("member_email_edit").value,
                phoneHome: document.getElementById("member_phoneHome_edit").value,
                phoneMobile: document.getElementById("member_phoneMobile_edit").value,
                country: document.getElementById("member_country_edit").value,
                zip: document.getElementById("member_zip_edit").value,
                town: document.getElementById("member_town_edit").value,
                street: document.getElementById("member_street_edit").value,
                houseNumber: document.getElementById("member_houseNumber_edit").value,
                bus: document.getElementById("member_bus_edit").value
          };
        };
        
        function propertyJump (propertyId, propertyObject){
          
          M.Modal.getInstance(document.getElementById("memberView")).close();
          setSelectedProperty(propertyId,propertyObject,"");
        };

        
        function propertyLinkFromMemberView(property) {
          var elA = document.createElement('a');
          elA.setAttribute("data-target", "propertyView");
          elA.setAttribute('class','btn-flat modal-trigger');
          elA.setAttribute('onclick','propertyJump('+JSON.stringify(property.id)+','+JSON.stringify(property.data())+')');
          elA.innerHTML = "<font color='blue'>"+property.data().code+"</font>"+ "  ";
          return elA;
        };

        
        
        var mode;
        var selectedMemberId;
        var selectedMemberObject;
        function setSelectedMember(id,object,modeArg) {
          selectedMemberId=id;
          selectedMemberObject=object;
          mode="edit";
          document.getElementById("member_firstName"+modeArg).value=object.firstName;
          document.getElementById("member_lastName"+modeArg).value=object.lastName;
          document.getElementById("member_email"+modeArg).value=object.email;
          document.getElementById("member_phoneHome"+modeArg).value=object.phoneHome;
          document.getElementById("member_phoneMobile"+modeArg).value=object.phoneMobile;
          document.getElementById("member_country"+modeArg).value=object.country;
          document.getElementById("member_zip"+modeArg).value=object.zip;
          document.getElementById("member_town"+modeArg).value=object.town;
          document.getElementById("member_street"+modeArg).value=object.street;
          document.getElementById("member_houseNumber"+modeArg).value=object.houseNumber;
          document.getElementById("member_bus"+modeArg).value=object.bus;
          if (!modeArg) {
            var ownerOfEl = document.getElementById("member_ownerOf");
            emptyHTMLSet(ownerOfEl);
            refCoproperty.collection("Properties").where("owner", "==", id).get().then (function (querySnapshot){
              querySnapshot.forEach (function (property) {
                ownerOfEl.appendChild(propertyLinkFromMemberView(property));
              });
            });
            var occupantOfEl = document.getElementById("member_occupantOf");
            emptyHTMLSet(occupantOfEl);
            refCoproperty.collection("Properties").get().then (function (querySnapshotProperties){
              querySnapshotProperties.forEach (function (property) {
                property.ref.collection("Occupants").where("occupant", "==", id).get().then (function (querySnapshotOccupants){
                  if (querySnapshotOccupants.docs.length > 0) {
                    occupantOfEl.appendChild(propertyLinkFromMemberView(property));
                  };
                });
              });
            });
          };
          M.updateTextFields();
        };

        function resetSelectedMember() {
          selectedMemberId=null;
          selectedMemberObject=null;
          mode="add";
          document.getElementById("member_firstName_edit").value="";
          document.getElementById("member_lastName_edit").value="";
          document.getElementById("member_email_edit").value="";
          document.getElementById("member_phoneHome_edit").value="";
          document.getElementById("member_phoneMobile_edit").value="";
          document.getElementById("member_country_edit").value="";
          document.getElementById("member_zip_edit").value="";
          document.getElementById("member_town_edit").value="";
          document.getElementById("member_street_edit").value="";
          document.getElementById("member_houseNumber_edit").value="";
          document.getElementById("member_bus_edit").value="";
          M.updateTextFields();
        };

        function validateMemberEntries() {
              var valid= true;
              if (!document.getElementById("member_firstName_edit").checkValidity()) {
                M.toast({html:"Please enter First Name"});
                valid=false;
              };
              if (!document.getElementById("member_lastName_edit").checkValidity()) {
                M.toast({html:"Please enter Last Name"});
                valid=false;
              };
              if (!document.getElementById("member_email_edit").checkValidity()) {
                M.toast({html:"Please enter valid Email"});
                valid=false;
              };
              if (!document.getElementById("member_phoneHome_edit").checkValidity()) {
                M.toast({html:"Please enter valid Phone Home"});
                valid=false;
              };
              if (!document.getElementById("member_phoneMobile_edit").checkValidity()) {
                M.toast({html:"Please enter valid Mobile"});
                valid=false;
              };
              if (!document.getElementById("member_zip_edit").checkValidity()) {
                M.toast({html:"Please enter valid Zip"});
                valid=false;
              };
              if (!document.getElementById("member_bus_edit").checkValidity()) {
                M.toast({html:"Please enter valid Bus"});
                valid=false;
              };
              return valid;
        };
    </script>
    <!--   Properties scripts start here -->
    <script>
      function propertyLink(propertyFS) {
        var elA = document.createElement('button');
        elA.setAttribute("data-target", "propertyView");
        elA.setAttribute('class','modal-trigger');
        elA.setAttribute('style','border:none;background-color:Transparent');
        elA.setAttribute('onclick','setSelectedProperty('+JSON.stringify(propertyFS.id)+','+JSON.stringify(propertyFS.data())+',"")');
        elA.innerHTML = "<font color='#0000FF'>"+propertyFS.data().code+"</font>";
        return elA;
      };

      function makePropertyLink(propertyId) {
        refCoproperty.collection("Properties").doc(propertyId).get().then(function(objectFS){
          return propertyLink(objectFS);
        }).catch(function(error) {
          console.log("Error getting document:", error);
            return document.createTextNode("error");
            
          });
      };


      var totalQuotas = 0;
      var propertiesTable = document.getElementById("propertiesTable");

      function loadProperty (objectFS){
        var object = objectFS.data();
        var objectsRow= document.createElement('tr');
        var cellContent = propertyLink(objectFS);
        var cell = document.createElement('td');
        cell.appendChild(cellContent);
        objectsRow.appendChild(cell);
        
        totalQuotas = totalQuotas + parseInt(object.quota);
        cellContent = document.createTextNode(object.quota);
        cell = document.createElement('td');
        cell.appendChild(cellContent);
        objectsRow.appendChild(cell);  
        
        cellContent = document.createTextNode(object.type);
        cell = document.createElement('td');
        cell.appendChild(cellContent);
        objectsRow.appendChild(cell); 
        
        cellContent = document.createTextNode("");
        var ownerCell = document.createElement('td');
        ownerCell.setAttribute("style","white-space: nowrap");
        ownerCell.appendChild(cellContent);
        objectsRow.appendChild(ownerCell); 

        propertiesTable.appendChild (objectsRow);

        if (Boolean(object.owner)) {
          refCoproperty.collection("Members").doc(object.owner).get().then(function(ownerFS) {
            ownerCell.removeChild(ownerCell.firstChild);
            ownerCell.appendChild(memberLink(ownerFS));
          }).catch(function(error) {
            console.log("Error getting document:", error);
          });
        }; 
      };

      function refreshProperties() {
        emptyHTMLSet(propertiesTable);
        totalQuotas = 0;
        refCoproperty.collection("Properties").orderBy("code").get().then(function(objectsFSArray){
          objectsFSArray.forEach(function(objectFS){
            loadProperty(objectFS);
          });
          document.getElementById("totalQuotas").innerHTML = "Total Quotas = " + totalQuotas;  
        });    
      };

      var propertiesLoaded = false;
      function loadProperties(){
          hideMenu();
          document.getElementById("logo-container").innerHTML = "MyCondos: Properties";
        if (!propertiesLoaded) {
          refreshProperties();
          propertiesLoaded = true;
        };
      };

      function addProperty(){
       if (validateAddPropertyEntries()) {  
        var entries = getAddPropertyEntries();
        refCoproperty.collection("Properties").where("code", "==", entries.code).get().then(function(existingList) {
            if (existingList.docs.length > 0) {
              M.toast({html:"Error: property with this code already exists"}); 
            } else {
              refCoproperty.collection("Properties").add(entries).then(function(pFS) {
                  console.log("voor refreshProperties");
                  refreshProperties();
                  console.log("voor setSelectedProperty" + pFS.id + " met entries " + entries);
                  setSelectedProperty(pFS.id, entries);
                  console.log("voor close modal");
                  M.Modal.getInstance(document.getElementById("propertyAdd")).close();
                  console.log("voor open modal");
                  M.Modal.getInstance(document.getElementById("propertyView")).open();
                }).catch(function(error) {
                  M.toast({html:"Error occurred adding this property:" + error}); 
                });
            };
          }).catch (function(error) {
            M.toast({html:"Error occurred checking code uniqueness:" + error}); 
          });
       };
      };

      function updateProperty(property){
        refCoproperty.collection("Properties").doc(selectedPropertyId).update(property)
          .then(function(docref) {
            refreshProperties();
            selectedPropertyObject.code=property.code;
            selectedPropertyObject.quota=property.quota;
            selectedPropertyObject.type=property.type;
            selectedPropertyObject.cellar=property.cellar;
            document.getElementById("property_code").value=property.code;
            document.getElementById("property_quota").value=property.quota;
            document.getElementById("property_type").value=property.type;
            document.getElementById("property_cellar").value=property.cellar;
            M.Modal.getInstance(document.getElementById("propertyWrite")).close();
          }).catch(function(error) {
            M.toast({html:"Error occurred updating this member:" + error}); 
          });
      };

      function writeProperty() {
        if (validateEditPropertyEntries()) {  
          var entries = getEditPropertyEntries();
          if (! (entries.code.normalize() === selectedPropertyObject.code.normalize())) {
            refCoproperty.collection("Properties").where("code", "==", entries.code).get()
              .then(function(existingList) {
                if (existingList.docs.length > 0) {
                  M.toast({html:"Error: property with this code already exists"}); 
                } else {
                    updateProperty(entries);
                  };
              }) .catch (function(error) {
                M.toast({html:"Error occurred checking code uniqueness:" + error}); 
              });
          } else {
                  updateProperty(entries);
          };
        };
      };

      function enableOccupantAdd() {
        document.getElementById("buttonOccupantAdd").setAttribute("class","btn-small waves-light");
      };

      function disableOccupantAdd() {
        document.getElementById("buttonOccupantAdd").setAttribute("class","btn-small waves-light disabled");
      }

      var selectedPropertyId;
      var selectedPropertyObject;
      var selectedPropertyOccupants;
      var selectedMeterId;
      var selectedMeterData;
      var occupantsTable = document.getElementById("property_occupants");
      var metersTable = document.getElementById("property_meters");
      var handlingCopropertyMeter = false;
        
      function displayOccupant(propertyId,occupant){
        refCoproperty.collection("Members").doc(occupant.data().occupant).get().then(function(member) {
          var objectsRow= document.createElement('tr');
          var cell = document.createElement('td');
          var cellContent = memberLink(member);
          cell.appendChild(cellContent);
          objectsRow.appendChild(cell); 
          if (currentUser.role == roleAdministrator || currentUser.id == selectedPropertyObject.owner) {
            cell = document.createElement('td');
            cellContent = document.createElement('a'); 
            cellContent.setAttribute('style',"float: right");
            cellContent.setAttribute('class','waves-light btn-small red');
            cellContent.setAttribute('onclick','removeOccupant('+JSON.stringify(propertyId)+',' +JSON.stringify(occupant.id)+')');
            objectsRow.setAttribute("id", occupant.id)
            cellButtonIcon = document.createElement('i');
            cellButtonIcon.setAttribute('class','material-icons right');
            cellButtonIcon.innerHTML="delete";           
            cellContent.appendChild(cell);
            cellContent.innerHTML = "Remove Occupant";
            cell.appendChild(cellContent);
            objectsRow.appendChild(cell); 
          };
          occupantsTable.appendChild (objectsRow);
        }).catch (function(error) {
          M.toast({html:"Error occurred during displaying occupant:" + error}); 
        });
      };

      
      function editMeter(meter, meterData){
        selectedMeterId = meter;
        selectedMeterData = meterData;
        handlingCopropertyMeter = false;
        document.getElementById("meter_type").value=meterData.type;
        document.getElementById("meter_id").value=meterData.meter;
        document.getElementById("meter_status").value=meterData.status;
        if (meterData.readings.length == 0) {
          document.getElementById("meter_firstReading").value = "";
          document.getElementById("meter_firstReadingPanel").setAttribute("class", "input-field col s12 m12 displayBlock");
        } else if (meterData.readings.length == 1) {
          document.getElementById("meter_firstReading").value = meterData.readings[0].reading;
          document.getElementById("meter_firstReadingPanel").setAttribute("class", "input-field col s12 m12 displayBlock");
        } else if (meterData.readings.length == 2) {
          document.getElementById("meter_firstReading").value = meterData.readings[1].reading;
          document.getElementById("meter_firstReadingPanel").setAttribute("class", "input-field col s12 m12 displayBlock");
        } else {
          document.getElementById("meter_firstReadingPanel").setAttribute("class", "input-field col s12 m12 displayBlock");
        };
        var elems = document.querySelectorAll('select');
        M.FormSelect.init(elems);
        M.updateTextFields();
      };

      function validateMeterEntries(){
        var valid= true;
        if (!document.getElementById("meter_type").checkValidity()) {
          M.toast({html:"Please enter Type"});
          valid=false;
        };
        if (!document.getElementById("meter_id").checkValidity()) {
          M.toast({html:"Please enter valid Meter ID"});
          valid=false;
        };
        if (!document.getElementById("meter_status").checkValidity()) {
          M.toast({html:"Please enter Status"});
          valid=false;
        };
        if (document.getElementById("meter_firstReadingPanel").getAttribute("class") == "displayBlock") {
          if (!document.getElementById("meter_firstReading").checkValidity()) {
            M.toast({html:"Please enter first reading"});
            valid=false;
          };
        };
        return valid;
      };
      
      function writeMeter(){
        if (validateMeterEntries()) {
          if (selectedMeterId) {
            var entries = {
              type: document.getElementById("meter_type").value,
              meter: document.getElementById("meter_id").value,
              status: document.getElementById("meter_status").value,
            };
            if (selectedMeterData.readings.length == 1) {
              selectedMeterData.readings[0].reading = document.getElementById("meter_firstReading").value;
              entries.readings = selectedMeterData.readings;
            } else if (selectedMeterData.readings.length == 2) {
              selectedMeterData.readings[1].reading = document.getElementById("meter_firstReading").value;
              entries.readings = selectedMeterData.readings;
            };
            if (Boolean(selectedMeterData.coproperty)) {
              refCoproperty.collection("Meters").doc(selectedMeterId).update(entries).then(function(docrefmeter) {
                meterReadingsLoaded = false;
                refreshSettings();
                M.Modal.getInstance(document.getElementById("meterWrite")).close();
              }).catch(function(error) {
                M.toast({html:"Error occurred editing meter:" + error}); 
              });
            } else {
              refCoproperty.collection("Properties").doc(selectedPropertyId).collection("Meters").doc(selectedMeterId).update(entries).then(function(docrefmeter) {
                displayMeters(selectedPropertyId);
                meterReadingsLoaded = false;
                M.Modal.getInstance(document.getElementById("meterWrite")).close();
              }).catch(function(error) {
                M.toast({html:"Error occurred editing meter:" + error}); 
              });
            };
          } else {
            var entries = {
              type: document.getElementById("meter_type").value,
              meter: document.getElementById("meter_id").value,
              status: document.getElementById("meter_status").value,
              readings: [{
                date: currentCoproperty.initialStartDate,
                picture: false,
                reading: document.getElementById("meter_firstReading").value,
                counter: 0
              }]
            };
            if (handlingCopropertyMeter) {
              entries.coproperty = true;
              refCoproperty.collection("Meters").add(entries).then(function(docrefmeter) {
                meterReadingsLoaded = false;
                refreshSettings();
                handlingCopropertyMeter = false;
                M.Modal.getInstance(document.getElementById("meterWrite")).close();
              }).catch(function(error) {
                M.toast({html:"Error occurred adding meter:" + error}); 
              });
            }
            else {
              refCoproperty.collection("Properties").doc(selectedPropertyId).collection("Meters").add(entries).then(function(docrefmeter) {
                displayMeters(selectedPropertyId);
                meterReadingsLoaded = false;
                M.Modal.getInstance(document.getElementById("meterWrite")).close();
              }).catch(function(error) {
                M.toast({html:"Error occurred adding meter:" + error}); 
              });
            };
          };
        };
      };

      function addMeter(property){
        selectedMeterId = "";
        document.getElementById("meter_type").value="";
        document.getElementById("meter_id").value="";
        document.getElementById("meter_status").value="Active";
        document.getElementById("meter_firstReading").value="";
        document.getElementById("meter_firstReadingPanel").setAttribute("class", "input-field col s12 m12 displayBlock");
        var elems = document.querySelectorAll('select');
        M.FormSelect.init(elems);
        M.updateTextFields();
      };

      
      function displayMeter(meterFS){
        var meterData = meterFS.data();
        var objectsRow= document.createElement('tr');
        var cell = document.createElement('td');
        var cellContent = document.createTextNode(meterData.type);
        cell.appendChild(cellContent);
        objectsRow.appendChild(cell); 

        cell = document.createElement('td');
        cellContent = document.createTextNode(meterData.meter);
        cell.appendChild(cellContent);
        objectsRow.appendChild(cell);

        cell = document.createElement('td');
        cellContent = document.createTextNode(meterData.status);
        cell.appendChild(cellContent);
        objectsRow.appendChild(cell);

        if (currentUser.role == roleAdministrator) {
          cell = document.createElement('td');
          cellContent = document.createElement('button'); 
          cellContent.setAttribute('class','waves-light btn-small modal-trigger');
          cellContent.setAttribute("data-target", "meterWrite");
          cellContent.setAttribute('onclick','editMeter('+JSON.stringify(meterFS.id)+',' +JSON.stringify(meterData)+')');
          cellContent.innerHTML = "Edit";
          cell.appendChild(cellContent);
          objectsRow.appendChild(cell); 
        };
        if (Boolean(meterData.coproperty)) {copropertyMetersTable.appendChild (objectsRow);}
        else {metersTable.appendChild (objectsRow);};
      };
      
      
      function addOccupant() {
        var selectedOccupant = document.getElementById("property_occupant_add").value;
        var collRef = refCoproperty.collection("Properties").doc(selectedPropertyId).collection("Occupants");
        collRef.where("occupant", "==", selectedOccupant).get()
        .then(function(existingList) {
          if (existingList.docs.length > 0) {
            M.toast({html:"Error: This member is already occupant"}); 
          } else {
              collRef.add({occupant:selectedOccupant}).then(function(docRef){
                docRef.get().then(function(newOccupant) {
                  displayOccupant(selectedPropertyId,newOccupant);
                  document.getElementById("property_occupant_add").value = "";
                  disableOccupantAdd();
                  var elems = document.querySelectorAll('select');
                  M.FormSelect.init(elems);
                });
              });
            };
        }) .catch (function(error) {
          M.toast({html:"Error occurred checking code uniqueness:" + error}); 
        });
      };
      
      function removeOccupant(property,occupant){
        refCoproperty.collection("Properties").doc(property).collection("Occupants").doc(occupant).delete().then(function(){
          document.getElementById(occupant).remove();
        }).catch(function(error) {
            M.toast({html:"Error removing occupant:" + error});
        });
      };

      function listMembers(el, selectedOption) {
        var option;
        emptyHTMLSet(el);
        if (!Boolean(selectedOption)) {
          option = document.createElement("option");
          option.setAttribute("value","");
          option.setAttribute("disabled",true);
          option.setAttribute("selected",true);
          option.innerHTML = "Select Member";
          el.appendChild(option);
        };
        refCoproperty.collection("Members").get().then(function(querySnapshot) {
          querySnapshot.forEach(function(member) {
              option = document.createElement("option");
              option.setAttribute("value",member.id);
              if (member.id == selectedOption) {option.setAttribute("selected",true);};
              option.innerHTML = member.data().firstName + " " + member.data().lastName;
              el.appendChild(option);
            });
          var elems = document.querySelectorAll('select');
          M.FormSelect.init(elems);
        });
        
      };
      
      function displayOccupants(property) {
        emptyHTMLSet(occupantsTable);
        refCoproperty.collection("Properties").doc(property).collection("Occupants").get().then( function (querySnapshot) {
          if (Boolean(querySnapshot)) {
            querySnapshot.forEach(function(occupant) {
              displayOccupant(property,occupant);
            });
          };
        });
        listMembers(document.getElementById("property_occupant_add"),"");   
      };

      
      function displayMeters(property) {
        emptyHTMLSet(metersTable);
        refCoproperty.collection("Properties").doc(property).collection("Meters").get().then( function (querySnapshot) {
          if (Boolean(querySnapshot)) {
            querySnapshot.forEach(function(meterFS) {displayMeter(meterFS);});
          };
        });  
      };

      function displayMember(el,memberId){
        // displays the member into a yet defined HTML hyperlink element
        refCoproperty.collection("Members").doc(memberId).get().then(function(member) {
              el.setAttribute('onclick','setSelectedMember('+JSON.stringify(member.id)+','+JSON.stringify(member.data())+',"")');
              el.innerHTML = "<u><font color='blue'>"+member.data().firstName + " " + member.data().lastName+"</font></u>";
              el.setAttribute("style","white-space: nowrap");
        });
      };

      function createMemberLink(memberId){
        // creates the member HTML hyperlink element
        var el = document.createElement('a');
        el.setAttribute("data-target", "memberView");
        el.setAttribute('class','btn-flat modal-trigger');
        displayMember(el,memberId);
        return el;
      };
      
      function setSelectedProperty(id,object) {
        selectedPropertyId=id;
        selectedPropertyObject=object;
        if (currentUser.role == roleAdministrator || currentUser.id == selectedPropertyObject.owner){
          document.getElementById("Properties_OccupantsAdd").setAttribute("class","displayBlock");
          document.getElementById("buttonOccupantAdd").setAttribute("class","btn-small waves-light disabled");
        } else {
          document.getElementById("Properties_OccupantsAdd").setAttribute("class","displayHidden");
        };
        document.getElementById("property_code").value=object.code;
        document.getElementById("property_quota").value=object.quota;
        document.getElementById("property_type").value=object.type;
        document.getElementById("property_cellar").value=object.cellar;
        var ownerEl = document.getElementById("property_owner");
        refCoproperty.collection("Members").doc(object.owner).get().then(function(member) {
              ownerEl.setAttribute('onclick','setSelectedMember('+JSON.stringify(member.id)+','+JSON.stringify(member.data())+',"")');
              ownerEl.innerHTML = "<font color='#0000FF'>"+member.data().firstName + " " + member.data().lastName+"</font>";
        });
        refCoproperty.collection("Properties").doc(id).collection("PreviousOwners").get().then(function(existingList) {
          if (existingList.docs.length > 0) {
            document.getElementById("previousOwnersButton").setAttribute("class","displayBlock");
          } else {
            document.getElementById("previousOwnersButton").setAttribute("class","displayHidden");
          };
        
        displayOccupants(id); 
        displayMeters(id);
        var elems = document.querySelectorAll('select');
        M.FormSelect.init(elems);
        M.updateTextFields();
        });
      };

      function resetSelectedProperty() {
        selectedPropertyId=null;
        selectedPropertyObject=null;
        document.getElementById("property_code_add").value="";
        document.getElementById("property_quota_add").value="";
        document.getElementById("property_type_add").value="";
        document.getElementById("property_cellar_add").value="";
        document.getElementById("property_owner_add").value="";
        listMembers(document.getElementById("property_owner_add"),"");
        M.updateTextFields();
        M.FormSelect.init(document.querySelectorAll('select'));
      };

      function validateAddPropertyEntries() {
        var valid= true;
        if (!document.getElementById("property_code_add").checkValidity()) {
          M.toast({html:"Please enter Code"});
          valid=false;
        };
        if (!document.getElementById("property_quota_add").checkValidity()) {
          M.toast({html:"Please enter valid Quota"});
          valid=false;
        };
        if (!document.getElementById("property_type_add").checkValidity()) {
          M.toast({html:"Please enter valid Type"});
          valid=false;
        };
        if (!document.getElementById("property_owner_add").checkValidity()) {
          M.toast({html:"Please select Owner"});
          valid=false;
        };
        return valid;
      };

      function validateEditPropertyEntries() {
        var valid= true;
        if (!document.getElementById("property_code_edit").checkValidity()) {
          M.toast({html:"Please enter Code"});
          valid=false;
        };
        if (!document.getElementById("property_quota_edit").checkValidity()) {
          M.toast({html:"Please enter valid Quota"});
          valid=false;
        };
        if (!document.getElementById("property_type_edit").checkValidity()) {
          M.toast({html:"Please enter valid Type"});
          valid=false;
        };
        return valid;
      };

      function getAddPropertyEntries() {
        return {
              code: document.getElementById("property_code_add").value,
              quota: document.getElementById("property_quota_add").value,
              type: document.getElementById("property_type_add").value,
              cellar: document.getElementById("property_cellar_add").value,
              owner: document.getElementById("property_owner_add").value,
            };
      };

      function getEditPropertyEntries() {
        return {
              code: document.getElementById("property_code_edit").value,
              quota: document.getElementById("property_quota_edit").value,
              type: document.getElementById("property_type_edit").value,
              cellar: document.getElementById("property_cellar_edit").value,
            };
      };

      function setEditPropertyEntries() {
        document.getElementById("property_code_edit").value=selectedPropertyObject.code;
        document.getElementById("property_quota_edit").value=selectedPropertyObject.quota;
        document.getElementById("property_type_edit").value=selectedPropertyObject.type;
        document.getElementById("property_cellar_edit").value=selectedPropertyObject.cellar;
        M.updateTextFields();
        M.FormSelect.init(document.querySelectorAll('select')); 
      };

      function newOwner() {
        document.getElementById("property_transferDate").value="";
        document.getElementById("property_newOwner").value="";
        listMembers(document.getElementById("property_newOwner"),"");
        M.updateTextFields();
        M.FormSelect.init(document.querySelectorAll('select'));
      };

      function validateNewOwnerEntries() {
        var valid= true;
        if (!document.getElementById("property_transferDate").checkValidity()) {
          M.toast({html:"Please enter Code"});
          valid=false;
        };
        if (!document.getElementById("property_newOwner").checkValidity()) {
          M.toast({html:"Please enter valid Quota"});
          valid=false;
        };
        return valid;
      };

      function getNewOwnerEntries(){
        return {
              date: document.getElementById("property_transferDate").value,
              owner: document.getElementById("property_newOwner").value,
            };
      };


      var previousOwnerId;
      function setPreviousOwner(poId, poObject) {
        previousOwnerId = poId;
        listMembers(document.getElementById("property_previousOwner"), poObject.owner); 
        document.getElementById("property_transferDatePrevious").value = poObject.date;
        M.updateTextFields();
        M.FormSelect.init(document.querySelectorAll('select'));
      };

      function writeNewOwner() {
        if (validateNewOwnerEntries()) {  
          var entries = getNewOwnerEntries();
          if (entries.owner == selectedPropertyObject.owner) {
            M.toast({html:"Error: new and existing owner must be different"});
          } else {
            refCoproperty.collection("Properties").doc(selectedPropertyId).update({owner:(entries.owner)})
              .then(function(docrefProperty) {
                var po = {
                  owner: selectedPropertyObject.owner,
                  date: entries.date,
                };
                refCoproperty.collection("Properties").doc(selectedPropertyId).collection("PreviousOwners").add(po).then(function(docrefPreviousOwner) {
                  refreshProperties();
                  displayMember(document.getElementById("property_owner"),entries.owner);
                  document.getElementById("previousOwnersButton").setAttribute("class","displayBlock");
                  M.Modal.getInstance(document.getElementById("newOwner")).close();
                }).catch(function(error) {
                  M.toast({html:"Error occurred updating current owner:" + error}); 
                });
              }).catch(function(error) {
                M.toast({html:"Error occurred updating previous owners:" + error}); 
              });
          };
        };
      };

      var propertyPreviousOwnersTable = document.getElementById("propertyPreviousOwnersTable");

      function loadPreviousOwner(objectFS){
        var object = objectFS.data();
        var objectsRow= document.createElement('tr');
        var cellContent = createMemberLink(object.owner);
        var cell = document.createElement('td');
        cell.appendChild(cellContent);
        objectsRow.appendChild(cell);
        
        cellContent = document.createTextNode(object.date);
        cell = document.createElement('td');
        cell.appendChild(cellContent);
        objectsRow.appendChild(cell);  
        
        cellContent = document.createElement('button');
        cellContent.setAttribute("data-target", "previousOwner");
        cellContent.setAttribute('class','btn-small waves-light modal-trigger');
        cellContent.setAttribute('onclick','setPreviousOwner('+JSON.stringify(objectFS.id)+','+JSON.stringify(object)+')');
        cellContent.innerHTML = "Edit";

        cell = document.createElement('td');
        cell.appendChild(cellContent);
        objectsRow.appendChild(cell);    
        
        propertyPreviousOwnersTable.appendChild (objectsRow);
      };
      
      function showPreviousOwnersTable(){
        emptyHTMLSet(propertyPreviousOwnersTable);
        refCoproperty.collection("Properties").doc(selectedPropertyId).collection("PreviousOwners").orderBy("date").get().then(function(objectsFSArray){
          objectsFSArray.forEach(function(objectFS){
            loadPreviousOwner(objectFS);
          });
        });
      };

      function validatePreviousOwnerEntries(){
        var valid= true;
        if (!document.getElementById("property_previousOwner").checkValidity()) {
          M.toast({html:"Please enter Owner"});
          valid=false;
        };
        if (!document.getElementById("property_transferDatePrevious").checkValidity()) {
          M.toast({html:"Please enter Transfer Date"});
          valid=false;
        };
        return valid;
      };
      
      function getPreviousOwnerEntries() {
        return {
              owner: document.getElementById("property_previousOwner").value, 
              date: document.getElementById("property_transferDatePrevious").value,
              };
      };
      
      function writePreviousOwner(){
        
        if (validatePreviousOwnerEntries()) {
          var entries = getPreviousOwnerEntries();
          
          refCoproperty.collection("Properties").doc(selectedPropertyId).collection("PreviousOwners").doc(previousOwnerId).set(entries).then(function(docrefPreviousOwner) {
            showPreviousOwnersTable();
            M.Modal.getInstance(document.getElementById("previousOwner")).close();
          }).catch(function(error) {
            M.toast({html:"Error occurred updating previous owner:" + error}); 
          });
        };
      };
    </script>
    <!--   Settings scripts start here -->
    <script>
      var settingsLoaded = false;
      var copropertyMetersTable = document.getElementById("coproperty_meters");
      
      function refreshSettings() {
        emptyHTMLSet(copropertyMetersTable);
        refCoproperty.collection("Meters").get().then( function (querySnapshot) {
          if (Boolean(querySnapshot)) {
            querySnapshot.forEach(function(meterFS) {displayMeter(meterFS);});
          };
        });  

      };
      
      function loadSettings() {
        hideMenu();
        document.getElementById("logo-container").innerHTML = "MyCondos: Settings";
        if (!settingsLoaded) {
          refreshSettings();
          settingsLoaded = true;
        };
      };

      function addCopropertyMeter(){
        addMeter();
        handlingCopropertyMeter = true;
      }
      var waterCommonParts;

      function reportTransaction(trData){
        if (!trData.communication) { trData.communication=" ";
        } else {trData.communication=trData.communication.substr(0,54);};
        trData.name=trData.name.substr(0,25);
        var amount = Number(trData.amount);
        trData.amount = amount.toLocaleString("nl-BE",currencyStyle);            
        return amount;
      };

      var headerCommon = [
        {id:"type",name:"type",prompt:"type",width: 30,align: "center",padding: 0},
        {id:"name",name:"name",prompt:"name",width: 60,align: "center",padding: 0},
        {id:"communication",name:"communication",prompt:"communication",width: 117,align: "center",padding: 0},
        {id:"amount",name:"amount",prompt:"amount",width: 38,align: "right",padding: 0}
      ];
      var headerConsumption = [
        {id:"owner",name:"owner",prompt:"owner",width: 35,align: "center",padding: 0},
        {id:"property",name:"property",prompt:"property",width: 20,align: "center",padding: 0},
        {id:"meter",name:"meter",prompt:"meter",width: 30,align: "center",padding: 0},
        {id:"type",name:"type",prompt:"type",width: 28,align: "center",padding: 0},
        {id:"last_reading",name:"last_reading",prompt:"last reading",width: 28,align: "center",padding: 0},
        {id:"reading",name:"reading",prompt:"new reading",width: 28,align: "center",padding: 0},
        {id:"difference",name:"difference",prompt:"difference",width: 23,align: "center",padding: 0},
        {id:"water",name:"water",prompt:"water consumed",width: 30,align: "center",padding: 0},
        {id:"water_payed",name:"water_payed",prompt:"water payed",width: 30,align: "center",padding: 0},
        {id:"water_regu",name:"water_regu",prompt:"water regularisation",width: 24,align: "center",padding: 0},
        {id:"heating",name:"heating",prompt:"heating consumed",width: 30,align: "center",padding: 0},
        {id:"heating_payed",name:"heating_payed",prompt:"heating  payed",width: 30,align: "center",padding: 0},
        {id:"heating_regu",name:"heating_regu",prompt:"heating regularisation",width: 24,align: "center",padding: 0},
      ];
      var emptyConsumptionLine = {owner:"", property:"", meter:"", type:"", last_reading:"", reading:"", difference:"", water:"", water_payed:"", water_regu:"", heating:"", heating_payed:"", heating_regu:""};
      var headerQuota =[
        {id:"owner",name:"owner",prompt:"owner",width: 70,align: "center",padding: 0},
        {id:"property",name:"property",prompt:"property",width: 30,align: "center",padding: 0},
        {id:"quota",name:"quota",prompt:"quota",width: 25,align: "center",padding: 0},
        {id:"period",name:"period",prompt:"period",width: 30,align: "center",padding: 0},
        {id:"quota_period",name:"quota_period",prompt:"quota period",width: 30,align: "center",padding: 0},
        {id:"amount",name:"amount",prompt:"amount",width: 40,align: "right",padding: 0}
      ];
      var headerChargesMetersIncluded = [
        {id:"owner",name:"owner",prompt:"owner",width: 80,align: "center",padding: 0},
        {id:"common",name:"common",prompt:"common charges",width: 50,align: "right",padding: 0},
        {id:"private",name:"private",prompt:"private charges",width: 50,align: "right",padding: 0},
        {id:"water",name:"water",prompt:"regularisation water",width: 55,align: "right",padding: 0},
        {id:"heating",name:"heating",prompt:"regularisation heating",width: 55,align: "right",padding: 0},
        {id:"Total",name:"Total",prompt:"Total",width: 46,align: "right",padding: 0}
      ];
      var headerChargesMetersExcluded = [
        {id:"owner",name:"owner",prompt:"owner",width: 80,align: "center",padding: 0},
        {id:"common",name:"common",prompt:"common charges",width: 50,align: "right",padding: 0},
        {id:"private",name:"private",prompt:"private charges",width: 50,align: "right",padding: 0},
        {id:"Total",name:"Total",prompt:"Total",width: 50,align: "right",padding: 0}
      ];

      function generateChargesReport(closeDateTransactions, metersIncluded){
        var onlyOnce = true;
        var buildingWater = 0;
        var buildingHeating = 0;
        var buildingCommon = 0;
        
        var totalColdWaterDifference = 0
        var totalHeatingDifference = 0; 
        var totalHotWaterDifference = 0; 
        var totalQuota = 0;
       
        var dataCommon = [];
        var dataWater = [];
        var dataHeating = [];
        var dataConsumption = [];
        var dataQuota = [];
        var dataCharges = [];
        
        refCoproperty.collection("Transactions").where("bookDate", ">", lastCloseDate).where("bookDate", "<=", closeDateTransactions).orderBy("bookDate").get().then(function(transactionsFS){
          transactionsFS.forEach(function(transactionFS){
            var trData = transactionFS.data();
            buildingCommon = buildingCommon + reportTransaction(trData);
            dataCommon.push(trData);
          });
          refCoproperty.collection("Transactions").where("type", "==", "Water").where("bookDate", ">", lastReguDate).where("bookDate", "<=", closeDateTransactions).orderBy("bookDate").get().then(function(transactionsFS){
            transactionsFS.forEach(function(transactionFS){
              var trData = transactionFS.data();
              buildingWater = buildingWater + reportTransaction(trData);
              dataWater.push(trData);
            });      
          dataWater.push({type:"Total",name:" ",communication:" ",amount:buildingWater.toLocaleString("nl-BE",currencyStyle)});

          refCoproperty.collection("Transactions").where("type", "==", "Heating").where("bookDate", ">", lastReguDate).where("bookDate", "<=", closeDateTransactions).orderBy("bookDate").get().then(function(transactionsFS){
            transactionsFS.forEach(function(transactionFS){
              var trData = transactionFS.data();
              buildingHeating = buildingHeating + reportTransaction(trData);
              dataHeating.push(trData);
            });      
          dataHeating.push({type:"Total",name:" ",communication:" ",amount:buildingHeating.toLocaleString("nl-BE",currencyStyle)});
          
          refCoproperty.collection("Members").get().then(function(membersFS) { 
            var idMemberMap = [];
            membersFS.forEach(function(memberFS){
              idMemberMap[memberFS.id] = (memberFS.data().lastName + " " + memberFS.data().firstName).substr(0,25);
            });
            console.log("voor properties lezen");
            var iteratorProp = 0;
            var stop = false;
            refCoproperty.collection("Properties").orderBy("owner").get().then(function(propertiesFS){  
              propertiesFS.forEach(function(prFS){
                console.log("iteratorProp is nu ", iteratorProp);
                var prData = prFS.data();
                var ownerIdV = prData.owner;
                var ownerName = idMemberMap[ownerIdV];
                dataQuota.push({ownerId:ownerIdV, owner:ownerName, property:prData.code, quota:prData.quota, period:"100%", quota_period: prData.quota, amount:" "}); 
                var prQuota = parseInt(prData.quota);
                totalQuota = totalQuota + prQuota; 
                if (!dataCharges[ownerIdV]) {
                  dataCharges[ownerIdV] = {ownerId:ownerIdV, owner:ownerName, common:" ", private:" ", water:" ", heating:" ", Total:" "};
                };
                var iteratorMeter = 0;
                refCoproperty.collection("Properties").doc(prFS.id).collection("Meters").get().then(function(metersFS){   
                  iteratorProp = iteratorProp + 1;                                    
                    metersFS.forEach(function(meterFS){
                      iteratorMeter = iteratorMeter +1;
                      var meterData = meterFS.data();
                      var lastReading = "";
                      var newReading = "";
                      var differenceV = 0;
                      var readingDate = meterData.readings[0].date;
                      if ((!checkBookDate(readingDate))|| (readingDate.localeCompare(closeDateTransactions)>0)) {
                        M.toast({html:"following meter reading is missing or out of period: " + meterData.meter});
                        stop = true;
                      } else {
                        lastReading = meterData.readings[1].reading;
                        newReading = meterData.readings[0].reading;
                        differenceV = parseFloat(newReading) - parseFloat(lastReading);
                        if (meterData.type == "Cold Water") {
                          totalColdWaterDifference = totalColdWaterDifference + differenceV;
                        } else if (meterData.type == "Heating") {
                          totalHeatingDifference = totalHeatingDifference + differenceV;
                        } else if (meterData.type == "Hot Water"){
                          totalHotWaterDifference = totalHotWaterDifference + differenceV;
                        };                    
                        dataConsumption.push({ownerId:ownerIdV, quota: prQuota, owner:ownerName.substr(0,15), property:prData.code, meter:meterData.meter, type:meterData.type, last_reading:lastReading, reading:newReading, difference:differenceV.toString(), water:" ", water_payed:" ", water_regu:" ", heating:" ", heating_payed:" ", heating_regu:" "});
                        console.log("lengte dataConsumption één per één ", dataConsumption.length); 
                      };
                    
                      if (!stop)  {
                        console.log("iteratorMeter is ", iteratorMeter);
                          console.log("metersFS.docs.length is ", metersFS.docs.length);
                          console.log("iteratorProp is ", iteratorProp);
                          console.log("propertiesFS.docs.length is ", propertiesFS.docs.length);
                          
                        if ((iteratorMeter == metersFS.docs.length) && (iteratorProp == propertiesFS.docs.length)) {
                          
                          /* ook testen op ingave coproperty meters ??*/   
                                              
                          var totalledConsumption = dataConsumption;
                          if (metersIncluded) {
                            totalledConsumption = calcTotalConsumption (totalQuota, totalColdWaterDifference, totalHotWaterDifference, totalHeatingDifference, buildingWater, buildingHeating, dataConsumption, dataCharges);
                          };
                          console.log("lengte van totalledConsumption is ", totalledConsumption.length);
                          calcAndGenerate(closeDateTransactions, metersIncluded,totalQuota,buildingCommon, dataWater, dataHeating, dataCommon,totalledConsumption, dataQuota, dataCharges);                         
                        };
                      };
                    });
            
                });
                
                                
              });
              
            }).catch(function(error) {
              M.toast({html:"Error during properties upload:" + error});
            });
          });
          });
          });
        }).catch(function(error) {
            M.toast({html:"Error during expenses upload:" + error});
        });
      };  

      function calcAndGenerate(closeDateTransactions, metersIncluded,totalQuota,buildingCommon, dataWater, dataHeating, dataCommon,totalledConsumptionData, dataQuota, dataCharges){
              var totalledQuotaData = makeSubtotals(dataQuota,totalQuota, buildingCommon, dataCharges);                          
              dataCommon.push({type:"Total",name:" ",communication:" ",amount:buildingCommon.toLocaleString("nl-BE",currencyStyle)});
              var dataChargesCurrency = putChargesCurrency(Object.values(dataCharges), metersIncluded);
              writePDF(closeDateTransactions, metersIncluded, dataWater, dataHeating,  dataCommon, totalledConsumptionData, totalledQuotaData, dataChargesCurrency);
      };
      
      function putChargesCurrency(dataChargesP, metersIncluded){
        dataChargesP.forEach(function(arrayEl) {
          if (metersIncluded) {
            arrayEl.Total = (arrayEl.common + arrayEl.water + arrayEl.heating).toLocaleString("nl-BE",currencyStyle);
            arrayEl.common = arrayEl.common.toLocaleString("nl-BE",currencyStyle);
            arrayEl.water = arrayEl.water.toLocaleString("nl-BE",currencyStyle);
            arrayEl.heating = arrayEl.heating.toLocaleString("nl-BE",currencyStyle);
          } else {
            arrayEl.Total = (arrayEl.common).toLocaleString("nl-BE",currencyStyle);
            arrayEl.common = arrayEl.common.toLocaleString("nl-BE",currencyStyle);
            arrayEl.water = " ";
            arrayEl.heating = " ";
          }
        });
        return dataChargesP;
      };
      
      function putConsumptionCurreny(dataConsumption){
        dataConsumption.forEach(function(arrayEl) {
          if ((arrayEl.water)&& (arrayEl.water != " ")){arrayEl.water = arrayEl.water.toLocaleString("nl-BE",currencyStyle);};
          if ((arrayEl.water_payed)&& (arrayEl.water_payed != " ")){arrayEl.water_payed = arrayEl.water_payed.toLocaleString("nl-BE",currencyStyle);};
          if ((arrayEl.water_regu)&& (arrayEl.water_regu != " ")){arrayEl.water_regu = arrayEl.water_regu.toLocaleString("nl-BE",currencyStyle);};
          if ((arrayEl.heating)&& (arrayEl.heating != " ")){arrayEl.heating = arrayEl.heating.toLocaleString("nl-BE",currencyStyle);};
          if ((arrayEl.heating_payed)&& (arrayEl.heating_payed != " ")){arrayEl.heating_payed = arrayEl.heating_payed.toLocaleString("nl-BE",currencyStyle);};
          if ((arrayEl.heating_regu)&& (arrayEl.heating_regu != " ")){arrayEl.heating_regu = arrayEl.heating_regu.toLocaleString("nl-BE",currencyStyle);};          
        });
        return dataConsumption;
      };
      
      function calcConsumptionAmounts (dataConsumption, totalColdWaterDifference, totalHotWaterDifference, totalHeatingDifference, buildingWater, buildingHeating) {
        dataConsumption.forEach(function(arrayEl) {
          if (arrayEl.type != "Heating") {
            var amountWaterString = (buildingWater * parseInt(arrayEl.difference) / (totalColdWaterDifference + totalHotWaterDifference)).toFixed(2);
            amountWater = Number(amountWaterString);
            arrayEl.water = amountWater;
          };
          if (arrayEl.type != "Cold Water") {
            var amountHeatingString = (buildingHeating * parseInt(arrayEl.difference) / (totalHeatingDifference + totalHotWaterDifference)).toFixed(2);
            amountHeating = Number(amountHeatingString); 
            arrayEl.heating = amountHeating;
          };
        });
        
      };
      
      function calcTotalConsumption(totalQuota, totalColdWaterDifference, totalHotWaterDifference, totalHeatingDifference, buildingWater, buildingHeating, dataConsumption, dataCharges){
        calcConsumptionAmounts (dataConsumption, totalColdWaterDifference, totalHotWaterDifference, totalHeatingDifference, buildingWater, buildingHeating);
        console.log("lengte van dataConsumption is ", dataConsumption.length);
        var reguProperties = calcConsumptionRegusProperties (totalQuota, dataConsumption, buildingWater, buildingHeating);
        console.log("lengte van reguProperties is ", reguProperties.length);
        var reguOwners = calcConsumptionRegusOwners(reguProperties);
        console.log("lengte van reguOwners is ", reguOwners.length);
        return reguOwners;
      };

      function calcConsumptionRegusProperties (totalQuota, dataConsumption, buildingWater, buildingHeating) {
        /* per property */
        var i=0;
        var count = 0;
        var totalWaterCons = 0;
        var totalHeatingCons = 0;
        const arraylength = dataConsumption.length;
        var result = [];
        while (i < arraylength) {
          count = count+1;
          totalWaterCons = totalWaterCons + dataConsumption[i].water;
          totalHeatingCons = totalHeatingCons + dataConsumption[i].heating;
          if (((count == 1) && ((i + 1) != arraylength) && (dataConsumption[i].property != dataConsumption[i+1].property)) || ((count == 1) && ((i + 1) == arraylength))){
            /* solitary regularisation line */
            dataConsumption[i].water_payed = Number((buildingWater * dataConsumption[i].quota / totalQuota).toFixed(2));
            dataConsumption[i].water_regu = dataConsumption[i].water - dataConsumption[i].water_payed;
            dataConsumption[i].heating_payed = Number((buildingHeating * dataConsumption[i].quota / totalQuota).toFixed(2));
            dataConsumption[i].heating_regu = dataConsumption[i].heating - dataConsumption[i].heating_payed;
            result.push(dataConsumption[i]);
            totalWaterCons = 0;
            totalHeatingCons = 0;
            count = 0;
          } else if ((count > 1) && ((i + 1) != arraylength) && (dataConsumption[i].property != dataConsumption[i+1].property)){
            /* intermediary regularisation line */
            result.push(dataConsumption[i]);
         } else {
            /* last regularisation line newReading new totalling line */
            result.push(dataConsumption[i]);
            var waterPayed = Number((buildingWater * dataConsumption[i].quota / totalQuota).toFixed(2));
            var heatingPayed = Number((buildingHeating * dataConsumption[i].quota / totalQuota).toFixed(2));
            var waterRegu = totalWaterCons - waterPayed;
            var heatingRegu = totalHeatingCons - heatingPayed;
            result.push({ownerId:dataConsumption[i].ownerId, owner:dataConsumption[i].owner, property:dataConsumption[i].owner, meter:"Subtotal", type:"", last_reading:"", reading:"", difference:"", water:totalWaterCons, water_payed:waterPayed, water_regu: waterRegu, heating:totalHeatingCons, heating_payed:heatingPayed, heating_regu: heatingRegu});
            count = 0;
            totalWaterCons = 0;
            totalHeatingCons = 0;
          };
          i = i + 1;
        };
        return result;
      };

      function calcConsumptionRegusOwners (dataConsumption) {
        /* per property */
        var i=0;
        var count = 0;
        var totalWaterCons = 0;
        var totalHeatingCons = 0;
        var totalWaterPayed = 0;
        var totalHeatingPayed = 0;
        var totalWaterRegu = 0;
        var totalHeatingRegu = 0;
        const arraylength = dataConsumption.length;
        var result = [];

        function sumIt(consLine){
            totalWaterCons = totalWaterCons + consLine.water;
            totalHeatingCons = totalHeatingCons + consLine.heating;
            totalWaterPayed = totalWaterPayed + consLine.water_payed;
            totalHeatingPayed = totalHeatingPayed + consLine.heating_payed;
            totalWaterRegu = totalWaterRegu + consLine.water_regu;
            totalHeatingRegu = totalHeatingRegu + consLine.heating_regu;

        };

        while (i < arraylength) {
          result.push(dataConsumption[i]);
          if (dataConsumption[i].water_regu){
            count = count+1;
            if (((count == 1) && ((i + 1) != arraylength) && (dataConsumption[i].ownerId != dataConsumption[i+1].ownerId)) || ((count == 1) && ((i + 1) == arraylength))){
              /* solitary regularisation line */
              result.push(emptyConsumptionLine);             
            } else if ((count > 1) && ((i + 1) != arraylength) && (dataConsumption[i].ownerId != dataConsumption[i+1].ownerId)){
              /* intermediary regularisation line */
              sumIt(dataConsumption[i]);
          } else {
              /* last regularisation line needed new totalling line */
              sumIt(dataConsumption[i]);
              result.push({ownerId:dataConsumption[i].ownerId, owner:dataConsumption[i].owner, property:"Total", meter:"", type:"", last_reading:"", reading:"", difference:"", water:totalWaterCons, water_payed:totalWaterPayed, water_regu: totalWaterRegu, heating:totalHeatingCons, heating_payed:totalHeatingPayed, heating_regu: totalHeatingRegu});
              result.push(emptyConsumptionLine);
              count = 0;
              totalWaterCons = 0;
              totalHeatingCons = 0;
              totalWaterPayed = 0;
              totalHeatingPayed = 0;
              totalWaterRegu = 0;
              totalHeatingRegu = 0;
            };
          } else {
            result.push(dataConsumption[i]);
          };
          i = i + 1;
        };
        return result;
      };


      function makeSubtotals (dataQuota,totalQuota, buildingCommon, dataCharges) {
        var result = [];
        var totalCommon = 0;
        var currentOwnerId = "";
        var count =0;
        var subtotalAmount = 0;
        var amount = 0;;
        function writeData(arrayEl){
          var amountString = (buildingCommon * parseInt(arrayEl.quota) / totalQuota).toFixed(2);
          amount = Number(amountString);
          arrayEl.amount = amount.toLocaleString("nl-BE",currencyStyle);
          result.push(arrayEl);
          subtotalAmount = subtotalAmount + amount;
          dataCharges[arrayEl.ownerId].common = subtotalAmount;
        };
        dataQuota.forEach(function(arrayEl) {
          if ((!currentOwnerId) || (arrayEl.ownerId == currentOwnerId)) {
            count = count + 1;
            writeData(arrayEl);
          } else {
            if (count > 1) {
              result.push({ownerId:currentOwnerId, owner:"Total", property:"", quota:"", period:"", quota_period: "", amount:subtotalAmount.toLocaleString("nl-BE",currencyStyle)});
            };
            result.push({ownerId:" ", owner:"", property:"", quota:"", period:"", quota_period: "", amount:""});
            count = 0;
            subtotalAmount = 0;
            writeData(arrayEl);
          };
          currentOwnerId = arrayEl.ownerId;
          totalCommon = totalCommon + amount;   
        });
        if (count > 1) {
              result.push({ownerId:currentOwnerId, owner:"Total", property:"", quota:"", period:"", quota_period: "", amount:subtotalAmount.toLocaleString("nl-BE",currencyStyle)});
            };
        result.push({ownerId:" ", owner:"", property:"", quota:"", period:"", quota_period: "", amount:""});
        result.push({ownerId:" ", owner:"Total building", property:" ", quota:totalQuota.toString(), period:" ", quota_period: " ", amount:totalCommon.toLocaleString("nl-BE",currencyStyle)});
        return result;
      };
      
           
      function writePDF (closeDateTransactions, metersIncludedHere, dataWater, dataHeating, dataCommon, dataConsumption,  dataQuota, tableCharges){
        const rowsLandscape =15;
        const rowsPortrait =24;
        var numPages;
        if (metersIncludedHere) {
           numPages = 1 + Math.ceil(dataWater.length/rowsPortrait) + Math.ceil(dataHeating.length/rowsPortrait) + Math.ceil(dataConsumption.length/rowsLandscape) + Math.ceil(dataCommon.length/rowsPortrait) + Math.ceil(dataQuota.length/rowsPortrait) + Math.ceil(tableCharges.length/rowsLandscape);
        } else {
           numPages = 1 + Math.ceil(dataCommon.length/rowsPortrait) + Math.ceil(dataQuota.length/rowsPortrait) + Math.ceil(tableCharges.length/rowsLandscape);
        };
        window.jsPDF = window.jspdf.jsPDF;
        var currentPage = 1;
        
        var startDateHere = new Date(lastCloseDate);
        startDateHere.setDate(startDateHere.getDate() + 1);
        var startDateString = startDateHere.toISOString().substr(0,10);
        const footerText = "Charges Report " + currentCoproperty.name + " " + startDateString + " to " + closeDateTransactions;
        
        function printFooterPortrait () {
          doc.line(15, 280, 200, 280);
          doc.setFontSize(10);
          doc.setTextColor("green");doc.text("MyCondos" ,15, 285);doc.setTextColor("black");
          doc.text(footerText,32, 285);
          doc.text("Page " + currentPage + "/" + numPages, 185, 285);
          currentPage = currentPage + 1;
        };
        function printFooterLandscape () {
          doc.line(10, 190, 280, 190);
          doc.setFontSize(10);
          doc.setTextColor("green");doc.text("MyCondos" ,10, 195);doc.setTextColor("black");
          doc.text(footerText,32, 195);
          doc.text("Page " + currentPage + "/" + numPages, 265, 195);
          currentPage = currentPage + 1;
        };
        function printTablePortrait(title, table, header) {
          for (i = 0; i < Math.ceil(table.length/rowsPortrait); i= i + 1) {
            doc.addPage("a4", "portrait");
            doc.setFontSize(16);
            doc.text(title, 15, 15);
            doc.table(15, 20, table.slice(i*rowsPortrait, (i+1)*rowsPortrait), header,{fontSize:10});
            printFooterPortrait ();
          };
        };
        function printTableLandscape(title, table, header, fontSize) {
          for (i = 0; i < Math.ceil(table.length/rowsLandscape); i= i + 1) {
            doc.addPage("a4", "landscape");
            doc.setFontSize(16);
            doc.text(title, 15, 15);
            doc.table(10, 20, table.slice(i*rowsLandscape, (i+1)*rowsLandscape), header,{fontSize:fontSize});
            printFooterLandscape ();
          };
        };
        var doc = new jsPDF({ putOnlyUsedFonts: true, orientation: "portrait" });
        doc.setTextColor("green"); doc.setFontSize(32);
        doc.text("MyCondos", 60, 20);
        doc.setTextColor("black"); doc.setFontSize(24); 
        doc.text("Report of Charges", 40, 40);
        doc.setFontSize(16);
        doc.text("Condomynium:", 15, 55);
        doc.setFontSize(14);
        doc.text("Name:", 30, 65);doc.text(currentCoproperty.name, 90, 65);
        doc.text("Address:", 30, 75);doc.text(currentCoproperty.street + " " + currentCoproperty.houseNumber + ", "+ currentCoproperty.zip + " " + currentCoproperty.town, 90, 75);
        doc.text("Administrator:", 30, 85);doc.text("Marc Van Limberghen", 90, 85);
        doc.setFontSize(16);
        doc.text("Period:", 15, 105);
        doc.setFontSize(14);
        doc.text(startDateString + " to " + closeDateTransactions, 90, 105);
        if (metersIncludedHere){
          doc.text("including regularisation meter readings", 90, 115);
        } else {
          doc.text("without regularisation meter readings", 90, 115);
        };
        doc.setFontSize(16);
        doc.text("List of tables:", 15, 135);
        doc.setFontSize(14);
        doc.text("Common charges:", 30, 145);doc.text("total for building", 90, 145);
        doc.text("Common charges:", 30, 155);doc.text("quota per owner", 90, 155);
        doc.text("Private expenses:", 30, 165);doc.text("expenses per owner", 90, 165);
        if (metersIncludedHere){
          doc.text("Water:", 30, 175);doc.text("total for building since last regularisation", 90, 175);
          doc.text("Heating:", 30, 185);doc.text("total for building since last regularisation", 90, 185);
          doc.text("Water and Heating:", 30, 195);doc.text("regularisation per owner and property", 90, 195);
          doc.text("Total Charges:", 30, 215);doc.text("total charges per owner", 90, 215);
        } else {
          doc.text("Total Charges:", 30, 185);doc.text("total charges per owner", 90, 185);
        };
        
        printFooterPortrait();
        printTablePortrait("Common charges: total for building", dataCommon, headerCommon);
        printTablePortrait("Common charges: quota per owner", dataQuota, headerQuota);
        if (metersIncludedHere){
          printTablePortrait("Water: total for building since last regularisation", dataWater, headerCommon);
          printTablePortrait("Heating: total for building since last regularisation", dataHeating, headerCommon);
          printTableLandscape("Water and Heating: regularisation per owner and property", dataConsumption, headerConsumption,8);
          printTableLandscape("Total charges: total charges per owner", tableCharges, headerChargesMetersIncluded,12);
        } else {
          printTableLandscape("Total charges: total charges per owner", tableCharges, headerChargesMetersExcluded, 12);
        };
        
        refCoproperty.collection("ChargesReports").add({startDate: startDateString, endDate: closeDateTransactions, metersIncluded: metersIncludedHere, confirmed: false }).then (function (chargesReportFS){
          var fileRef = refCopropertyFiles.child("ChargesReports").child(chargesReportFS.id);  
          fileRef.put(doc.output("blob")).then(function(snapshot) {
              refreshChargesReports();
              M.Modal.getInstance(document.getElementById("chargesReportAdd")).close();
          }).catch(function(error) {
                M.toast({html:"Error writing report file in store:" + error});
          });
          
        }).catch(function(error) {
            M.toast({html:"Error saving charges report:" + error});
        });
      };
        
    </script>
</body>

</html>