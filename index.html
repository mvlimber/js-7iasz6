<!DOCTYPE html>

<html>

<head>
  <base target="_top"> 
  <title style:"color:#00796b" bold>MyDigitalCondo</title>
  <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
  <link rel="icon"
    href="https://firebasestorage.googleapis.com/v0/b/slimmeeigendomdb.appspot.com/o/Building-32.png?alt=media&token=9754f9c3-9d56-42fc-bd61-839ce2354a95">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.98.0/css/materialize.min.css">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />


  <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
  <!--<script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.98.0/js/materialize.min.js"></script>-->
  <script src="https://github.com/Dogfalo/materialize/blob/v1-dev/js/select.js"></script>

  <script src="https://www.gstatic.com/firebasejs/8.2.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com//firebasejs/8.2.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.2.0/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.2.0/firebase-storage.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.3.1/jspdf.umd.min.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
   <script>
    var firebaseConfig = {
      apiKey: "AIzaSyCwEi76F7zmWI21awzo7EDuNC69ddSGj0Y",
  authDomain: "mycondos-e9d66.firebaseapp.com",
  projectId: "mycondos-e9d66",
  storageBucket: "mycondos-e9d66.appspot.com",
  messagingSenderId: "839572460226",
  appId: "1:839572460226:web:403a8302b282274ee2e15b",
  measurementId: "G-EEDXR3K5X5"
      };
      var thisCoproperty = "W11PMCiHMS74mBgAcm5q";
      firebase.initializeApp(firebaseConfig);
      var firestore=firebase.firestore();
      var fileStorageRef =firebase.storage().ref();
  </script>
   
  <style>
    .content {
      max-width: 500px;
      margin: auto;
    }
  </style>

</head>

<body>
  <center>
    <div id="loginPanel"> <h6 style="font-size:36px;color:#00796b">MyDigitalCondo</h6>
      <h6 style="font-size:12px;color:black">Stay connected to your properties</h6>
      <h6 style="font-size:20px;color:black">Please login </h6>
      <div style="width:500px">
        <form class="col s12" target="_top">
          <div class="input-field col s12">
            <input id="login_email" type="email" maxlength="50" class="validate" required aria-required="true">
            <label for="login_email">Email</label>
            <span class="helper-text" data-error="please enter valid email" ></span>
          </div>
          <div class="input-field col s12">
            <input id="login_password" type="password" class="validate" required aria-required="true">
            <label for="login_password">Password</label>
          </div>
        </form>
      </div>

      <button class="btn waves-effect waves-light" type="submit" onclick="login()">Log in<i class="material-icons right">perm_identity</i></button>
      <br>
      <button class="btn-flat" onclick="showPasswordReset()">
        <font color='blue'>Forgot password? </font>
      </button>
      <br>
      <button class="btn-flat" onclick="showPasswordSet()">
        <font color='blue'>First time user?</font>
      </button>
    </div>

    <div id="setPasswordPanel" class="displayHidden">
      <h6 style="font-size:36px;color:#00796b">MyDigitalCondo</h6>
      <h6 style="font-size:12px;color:black">Stay connected to your properties</h6>
      <h6 style="font-size:20px;color:black">Create password</h6>
      <div style="width:500px">
        <form class="col s12">
          <div class="input-field col s12">
            <input id="passwordSet_email" type="email" maxlength="50" class="validate" required aria-required="true">
            <label for="passwordSet_email">Email</label>
            <span class="helper-text" data-error="please enter valid email" ></span>
          </div>
        </form>
      </div>
      <h6 style="font-size:16px;color:black">An email will be sent to the above address</h6>
      <h6 style="font-size:16px;color:black">with a link to set your password.</h6>
      <br>
      <h6 style="font-size:16px;color:black">Note that your administrator should yet </h6>
      <h6 style="font-size:16px;color:black">have entered your email address.</h6>
      <br>
      <button class="btn waves-effect waves-light" type="submit" onclick="passwordSet()">Submit<i class="material-icons right">send</i></button>
      <br><br>
      <button class="btn-flat" onclick="backToLoginFromSetPW()">
        <font color='blue'>Back to Login</font>
      </button>
    </div>

    <div id="resetPasswordPanel" class="displayHidden">
      <h6 style="font-size:36px;color:#00796b">MyDigitalCondo</h6>
      <h6 style="font-size:12px;color:black">Stay connected to your properties</h6>
      <h6 style="font-size:20px;color:black">Reset password</h6>
      <div style="width:500px">
        <form class="col s12">
          <div class="input-field col s12">
            <input id="passwordReset_email" type="email" maxlength="50" class="validate" required aria-required="true">
            <label for="passwordReset_email">Email</label>
            <span class="helper-text" data-error="please enter valid email" ></span>
          </div>
        </form>
      </div>
      <h6 style="font-size:16px;color:black">An email will be sent to the above address</h6>
      <h6 style="font-size:16px;color:black">with a link to set your new password.</h6>
      <br>
      <button class="btn waves-effect waves-light" type="submit" onclick="passwordReset()">Submit<i class="material-icons right">send</i></button>
      <br><br>
      <button class="btn-flat" onclick="backToLoginFromResetPW()">
        <font color='blue'>Back to Login</font>
      </button>
    </div>
  </center>
  <div id="applicationPanel" class="displayHidden">
    <header>
      <nav id="header" class="nav-fixed teal lighten-1">
        <div class="nav-wrapper container center-align">
          <a href="javascript:void(0)" class="brand-logo right right-align" id="logo-container"
            style="font-size:24px">Home</a>
          <a href="#" data-target="slide-out" class="btn-collapsible sidenav-trigger left left-align"
            onclick="showMenu()"><i class="material-icons">menu</i></a>
        </div>
      </nav>
      <ul class="side-nav fixed tabs collapsible" id="slide-out">
        <li>
          <div class="userView">
            <div class="background">
              <img style="width:100%"  src="https://img1.goodfon.com/wallpaper/big/6/d8/android-material-fon-linii.jpg">
            </div>
            
            <span class="white-text name" style="font-size:18px"><img width="20" height="20" class="left" src="https://firebasestorage.googleapis.com/v0/b/slimmeeigendomdb.appspot.com/o/Building-32.png?alt=media&token=9754f9c3-9d56-42fc-bd61-839ce2354a95">MyDigitalCondo</span>
            <span class="white-text name" style="font-size:18px; float:bottom">Résidence Pélican</span>
          
          </div>
        </li>
        <li id="homeTab" class="tab side text-teal"><a class=" active waves-effect" href="#Home" style="font-size:22px"
            onclick="loadHome()">Home</a>
        </li>
        <li class="tab side text-teal"><a class="waves-effect" href="#Reports" style="font-size:22px"
            onclick="loadChargesReports()">Charges</a></li>
        <li class="tab side text-teal"><a class="waves-effect" href="#MeterReadings" style="font-size:22px"
          onclick="loadMeterReadings()">Meter Readings</a></li>
        <li class="tab side text-teal"><a class="waves-effect" href="#Transactions" style="font-size:22px"
            onclick="loadTransactions()">Transactions</a></li>
        <li id="tabTransactionRules" style="display:none" class="tab side text-teal"><a class="waves-effect" href="#TransactionRules" style="font-size:22px" onclick="loadTransactionRules()">Transaction Rules</a></li>
        <li class="tab side text-teal"><a class="waves-effect" href="#Documents" style="font-size:22px"
              onclick="loadDocuments()">Documents</a></li>
        <li class="tab side text-teal"><a class="waves-effect" href="#Properties" style="font-size:22px"
              onclick="loadProperties()">Properties</a></li>
        <li class="tab side text-teal"><a class="waves-effect" href="#Members" style="font-size:22px"
            onclick="loadMembers()">Members</a></li>
        <li id="tabSettings" class="tab side text-teal"><a class="waves-effect" href="#Settings"
            style="font-size:22px" onclick="loadSettings()">Settings</a></li>
      </ul>

      <script>
        function showMenu(){
          var el = document.getElementById("slide-out");
          M.Sidenav.init(el);
          var instance = M.Sidenav.getInstance(el);
          instance.open();
        };
        function hideMenu(){
          var el = document.getElementById("slide-out");
          M.Sidenav.init(el);
          var instance = M.Sidenav.getInstance(el);
          instance.close();
        };
        var elemshier = document.querySelectorAll('.sidenav');
        var instanceshier = M.Sidenav.init(elemshier);

        var collapsibleElemhier = document.querySelector('.collapsible');
        var collapsibleInstancehier = M.Collapsible.init(collapsibleElemhier);
        
        const tabsContainer = document.querySelector(".tabs");
        M.Tabs.init(tabsContainer);
        var instance = M.Tabs.getInstance(document.getElementById("slide-out"));
        instance.select("#Home");
      </script>
    </header>
    <main> 
      <div class="row">
        <div id="Home" class="col s12" display="flex">
          <div id="notificationRemove" class="modal normal">
            <div class="modal-content">
              <h6> You are about to permanently remove this announcement. Please Confirm.</h6>  
            </div>
            <div class="modal-footer">
              <button style="float: right;margin-left: 20px" class="btn-small waves-light" type="submit" onclick="removeNotification()">Confirm<i class="material-icons right">send</i></button>
              <a style="float: right"
                class="modal-close waves-light btn-small"><i class="material-icons right">cancel</i>
                Cancel</a>
            </div>
          </div>
          <div id="notificationEdit" class="modal normal">
            <div class="modal-content">
              <a style="float: right" class="modal-close waves-light btn-floating"><i class="material-icons right">cancel</i></a>
              <h5>Enter announcement title and text</h5>
              <div class="row">
                <form>
                  <div class="input-field col s12 m4">
                    <select id="notification_type" required required="true"></select>
                  </div>
                  <div class="input-field col s12 m4">
                    <input id="notification_title" type="text" required required="true" data-length="30" maxlength="30">
                    <label for="notification_title">Title<b><font color='red'>*</font></b></label>
                  </div>
                  <div class="input-field col s12 m12" heigth= "200">
                    <textarea  id="notification_text"  data-length="300" maxlength="300"></textarea>
                  </div>
                </form>
              </div>
            </div>
            <div class="modal-footer">
              <button id="notificationSubmitButton" style="float: right;margin-left: 20px" class="btn-small waves-light" type="submit" onclick="this.disabled=true; writeNotification()">Submit<i class="material-icons right">send</i></button>
              <a style="float: right"
                class="modal-close waves-light btn-small"><i class="material-icons right">cancel</i>
                Cancel</a>
            </div>
          </div>
          <h6 style="font-size:20px "><b>Announcements</b></h6>
          <ul class="collapsible" id="notificationsTable">
          </ul>
          <button style="float: right" data-target="notificationEdit" class="btn-small waves-light modal-trigger" onclick="emptyNotificationFields()"><i class="material-icons right">add</i>New Announcement</button>
          <br><br><br>
          <h6 style="font-size:20px "><b>Condomynium</b></h6>
          <div class="row">
            <div class="col s12 m6">
              <table>
                <tr>
                  <td>Name</td>
                  <td id="Home_CopropertyName"></td>
                </tr>
                <tr>
                  <td>Address</td>
                  <td id="Home_CopropertyAddress"></td>
                </tr>
                <tr>
                <td>Bank Account</td>
                <td id="Home_Account"></td>
              </tr>
                <tr>
                  <td>Syndicus</td>
                  <td id = "home_administrator"></td>
                </tr>
              </table>
            </div>
            <div class="col s12 m6 center">
              <img width="225" height="225" class="center" src="https://firebasestorage.googleapis.com/v0/b/slimmeeigendomdb.appspot.com/o/blokOK.png?alt=media&token=fc68c21e-bef9-4d1f-a403-b0ac4b36656c">
            </div>
          </div>
        </div>
        <div id="loading" class="modal alert centerAlert">
          <div class="center">
          <div class="preloader-wrapper big active" >
            <div class="spinner-layer spinner-blue-only">
              <div class="circle-clipper left">
                <div class="circle"></div>
              </div>
              <div class="gap-patch">
                <div class="circle"></div>
              </div>
              <div class="circle-clipper right">
                <div class="circle"></div>
              </div>
            </div>
          </div>
          </div>
        </div>
        <!------------------------------------------------------------------------------------------------------>
        <div id="Reports" class="col s12">
          <div id="chargesReportAdd" class="modal normal">
            <div class="modal-content">
            <a style="float: right" class="modal-close waves-light btn-floating"><i class="material-icons right">cancel</i></a>
              
              <h5>Generate new charges report</h5>
              <div class="row">
                <form>
                  <div class="input-field col s12 m6">
                    <input id="chargesReport_closeDate" type="date" required required="true">
                    <label for="chargesReport_closeDate">Accountancy close date<b><font color='red'>*</font></b></label>
                  </div>
                  <div class="input-field col s12 m6">
                    <select id="chargesReport_metersIncluded" required aria-required="true">
                      <option value="" disabled selected>Include Meter Readings?<b><font color='red'>*</font></b></option>
                      <option>Yes</option>
                      <option>No</option>
                    </select>
                   
                  </div>
                </form>
              </div>
            </div>
            <div class="modal-footer">
              <h6 style="float: right;margin-left: 20px">Please confirm
                the generated report after your review</h6>
              <br><br>
              <button id="chargesReportSubmitButton" style="float: right;margin-left: 20px" class="btn-small waves-light" type="submit" onclick="this.disabled=true; prepareChargesReport()">Submit<i class="material-icons right">send</i></button>
              <a style="float: right"
                class="modal-close waves-light btn-small"><i class="material-icons right">cancel</i>
                Cancel</a>
            </div>
          </div>
          <div id="chargesTable_frame">
          <table class="striped" >
            <thead>
              <tr>
                <th>
                  <div style="height: 130px;position: relative">
                    <div style="position: absolute;bottom: 10px;">Period</div>
                  </div>
                </th>
                <th >
                  <p style="writing-mode: vertical-rl;display:flex;">Consumption <br> Regularisation?</p>
                </th>
              </tr>
            </thead>
            <tbody id="chargesReportsTable">
            </tbody>
          </table>
          </div>
          <div id = "charges_absentPhrase" style="display:none">
          <h5>There are no Charges Reports yet</h5>
          </div>
          <br>
          <div id="Reports_Generate" class="displayHidden">
            <button id="ChargesReport_Generate" style="float: right" data-target="chargesReportAdd" class="btn-small waves-light modal-trigger" onclick="emptyFieldsChargesReportAdd()"><i class="material-icons right">add</i>Generate New Charges Report</button>
          </div>
        </div>
        <!------------------------------------------------------------------------------------------------------>
        <div id="documentFilter" class="modal normal">
          <div class="modal-content">
            <a style="float: right" class="modal-close waves-light btn-floating"><i class="material-icons right">cancel</i></a>
            <h5>Enter filter</h5>
            <div class="row">
              <form>
                <div class="input-field col s12 m4">
                  <input id="documentFilter_updateDate" type="date">
                  <label for="documentFilter_updateDate">Updated on or before</label>
                </div>
                <div class="input-field col s12 m4">
                  <select id="documentFilter_type"></select>
                </div>
                <div class="input-field col s12 m4">
                  <input id="documentFilter_counterparty" type="text" class="validate" maxlength="50" data-length="50" >
                  <label for="documentFilter_counterparty">Counterparty contains</label>
                </div>
              </form>
            </div>
          </div>
          <div class="modal-footer">
            <button style="float: right;margin-left: 20px" class="btn-small waves-light" type="submit" onclick="setDocumentFilter()">Submit<i class="material-icons right">send</i></button>
            <a style="float: right"
              class="modal-close waves-light btn-small"><i class="material-icons right">cancel</i>
              Cancel</a>
          </div>
        </div>
        <div id="Documents" class="col s12">
          
          <button style="margin-top:5px;margin-left:2px" data-target="documentFilter" class="btn-small waves-light modal-trigger" onclick="prepareSetDocumentFilter()"><i class="material-icons right">filter_list</i>Filter</button>
          <button id="documentNewButton" style="visibility: hidden; margin-top:5px; float: right" data-target="documentEdit" class="btn-small waves-light modal-trigger" onclick="resetDocument()"><i class="material-icons right">add</i>New document</button>
          <div id="documents_filterOff">Filter Off</div>
          <div id="documents_filterOn" style="display:none">Filter On</div>
          <div id="documentsTable_frame">
            <ul class="collapsible" id="documentsList">
            </ul>
            <center>
              <div id="documents_more">
                <button  style="margin-bottom: 3px; margin-top:10px" class="btn-small waves-light" type="submit" onclick="this.disabeld=true; nextBatchDocuments(lastVisibleDocument)">Load More<i class="material-icons right">arrow_downward</i></button>
              </div>
              <div id="documents_noMore" style="margin-top: 20px;margin-bottom: 3px" ><i class="material-icons" style="float:bottom;margin-top:10px">all_inclusive</i>    End of List    <i class="material-icons">all_inclusive</i></div>
            </center>
          </div>
          <div id = "documents_absentPhrase" style="display:none">
          <h5 >There are no Documents yet</h5>
          </div>
        <br>
        
        <div id="documentEdit" class="modal normal">
          <div class="modal-content">
            <a style="float: right" class="modal-close waves-light btn-floating"><i class="material-icons right">cancel</i></a>
            <h5>Upload document and enter its attributes</h5>
            <form>
              <div class="input-field" id="document_file">
              </div>
              <div class="file-field input-field col s12 m12">
                <div class="btn-small">
                  <span id="documentUploadButtonLabel">PDF Document<b><font color='red'>*</font></b><i class="material-icons right">attach_file</i></span>
                  <input type="file" id="documentFile">
                </div>
                <div class="file-path-wrapper">
                  <input class="file-path validate" type="text" id="documentFileText">
                  <span class="helper-text" data-error="only pfd, jpeg or png files" >pfd, jpeg or png file</span>
                </div>
              </div>
            </form>
            <form>
              
              <div class="input-field col s12 m4">
                <select id="document_type" required required="true" onchange="toggleDocument()"></select>
              </div>
              <div class="input-field col s12 m4" id="document_counterparty_field">
                <input id="document_counterparty" type="text" class="validate" maxlength="20" data-length="20" >
                <label for="document_counterparty">Counterparty<b><font color='red'>*</font></b></label>
              </div> 
              <div class="input-field col s12 m4" id="document_before_field">
                <input id="document_before" type="text" class="datepicker datepickerFuture validate" >
                <label for="document_before">Act before</label>
                <span class="helper-text">reminder date</span>
              </div>
              <!--
              <div class="input-field col s12 m4" id="document_link_field">
                <select id="document_link" ></select>
                <label>Link to</label>
              </div>-->
              <div class="input-field col s12 m4" id="document_freeType_field">
                <input id="document_freeType" type="text" class="validate" maxlength="8" data-length="8" >
                <label for="document_freeType">Free text type<b><font color='red'>*</font></b></label>
              </div>
              <div class="input-field col s12 m12">
                <textarea id="document_comment" maxlength="150" data-length="150"></textarea>
                <label for="document_text">Comment</label>
              </div>
          
            </form>
            
            <button id="documentSubmitButton" style="float: right;margin-left: 20px;margin-bottom: 3px" class="btn-small waves-light" type="submit" onclick="this.disabled=true; writeDocument()">Submit<i class="material-icons right">send</i></button>
            <a style="float: right;margin-left: 20px;margin-bottom: 3px"
              class="modal-close waves-light btn-small"><i class="material-icons right">cancel</i>
              Cancel</a>
          </div>
        </div>
        
        <div id="documentRemove" class="modal normal">
          <div class="modal-content">
            <h5> Please confirm you want to permanently remove this document</h5>
          </div>
          <div class="modal-footer">
            <button style="float: right;margin-left: 20px" class="modal-close btn-small waves-light" type="submit" onclick="removeDocument()">Confirm<i class="material-icons right">send</i></button>
            <a style="float: right"
              class="modal-close waves-light btn-small"><i class="material-icons right">cancel</i>
              Cancel</a>
          </div>
        </div> 
       </div>
        <!------------------------------------------------------------------------------------------------------>
        <div id="transactionView" class="modal full">
          <div class="modal-content">
            <a style="float: right" class="modal-close waves-light btn-floating"><i class="material-icons right">cancel</i></a>
            <h5> View Transaction</h5>
            <div class="w3-panel w3-border" style="box-shadow: 5px 10px 8px #888888">
              
                <div class="input-field col s12 m4">
                  <input id="transaction_type" type="text" readonly>
                  <label for="transaction_type">type</label>
                </div>
                <div class="input-field col s12 m4" id="transaction_costCenter_field">
                  <input id="transaction_costCenter" type="text" readonly>
                  <label for="transaction_type">cost center</label>
                </div>
                <div class="input-field col s12 m4" id="transaction_name_field">
                  <input id="transaction_name" type="text" readonly>
                  <label for="transaction_name">Counterparty</label>
                </div>
                <div class="input-field col s12 m4" id="transaction_owner_field">
                  <input id="transaction_owner" type="text" readonly>
                  <label for="transaction_owner">Owner</label>
                </div>
                <div class="input-field col s12 m4" id="transaction_account_field">
                  <input id="transaction_account" type="text" readonly>
                  <label for="transaction_account">Account</label>
                </div>
                <div class="input-field col s12 m8" id="transaction_communication_field" >
                  <input id="transaction_communication" type="text" readonly>
                  <label for="transaction_communication">Communication</label>
                </div>
                <div class="input-field col s12 m4">
                  <input id="transaction_amount" type="text" readonly>
                  <label for="transaction_amount">Amount</label>
                </div>
                <div class="input-field col s12 m4">
                  <input id="transaction_date" type="text" readonly>
                  <label for="transaction_date">Transaction Date</label>
                </div>
                <div class="input-field col s12 m4">
                  <input id="transaction_bookDate" type="text" readonly>
                  <label for="transaction_bookDate">Accountancy Date</label>
                </div>
                <div id="transaction_properties_frame" style="display:none" >
                  <table class="striped">
                    <caption><b>Private transaction: Amount distributed to following properties:</b></caption>
                    <thead>
                      <tr>
                        <th>Property</th>
                        <th>Amount</th>
                      </tr>
                    </thead>
                    <tbody id="transaction_distribution_table">
                    </tbody>
                  </table>
                </div>
              
              <div class="row col s10 m10">
                <p style="font-size:12px">Updated On: <span id="transaction_updatedOn"></span> </p>
                <p style="font-size:12px">Updated by: <span id="transaction_updatedBy"></span> </p>
            </div>
              <div id="Transactions_Edit" class="displayHidden">
              <button id="transaction_edit_button" style="float: right;margin-bottom: 3px" data-target="transactionAdd" class="btn-floating waves-light modal-trigger" onclick="editTransaction(selectedTransactionId, transaction)"><i class="material-icons right">edit</i></button>
              <button id="transaction_remove_button" style="float: right;margin-bottom: 3px;margin-right: 5px" class="btn-floating waves-light red" onclick="prepareRemoveTransaction()"><i class="material-icons right">delete</i></button>
              
              </div>
            </div>
            <div class="w3-panel w3-border" style="box-shadow: 5px 10px 8px #888888">
              <h6 style="font-size:20px ">Transaction Evidence Documents</h6>
              <table class="striped">
                <tbody id="transactionEvidenceTable">
                </tbody>
              </table>
              <br>
              <div id="Transactions_EvidenceAdd" class="displayHidden">
                <button style="float: right;margin-bottom: 3px" data-target="transactionNewDocument" class="btn-small waves-light modal-trigger" onclick="emptyTransactionEvidenceFields()"><i class="material-icons right">add</i>New</button>
              </div>
              <div id="Transactions_EvidenceLink" class="displayHidden">
                <button style="float: right;margin-bottom: 3px;margin-right: 5px" data-target="transactionNewEvidenceLink" class="btn-small waves-light modal-trigger" onclick="emptyTransactionEvidenceLinkFields()"><i class="material-icons right">link</i>Link </button>
            </div>
            </div>
            <a style="float: right" class="modal-close waves-light btn-floating"><i class="material-icons right">cancel</i></a>
          </div>
        </div> 
        <div id="transactionRemove" class="modal normal">
        <div class="modal-content">
          <h5> Please confirm you want to permanently remove this transaction</h5>
        </div>
        <div class="modal-footer">
          <button style="float: right;margin-left: 20px" class="modal-close btn-small waves-light" type="submit" onclick="removeTransaction()">Confirm<i class="material-icons right">send</i></button>
          <a style="float: right"
            class="modal-close waves-light btn-small"><i class="material-icons right">cancel</i>
            Cancel</a>
        </div>
        </div>
        
        <div id="transactionEvidenceRemove" class="modal normal">
        <div class="modal-content">
          <h5> You are about to remove the document from the list of evidences</h5>
          <p>
          <form>
          <label>
            <input type="checkbox" class="filled-in" id="transactionEvidenceFileDelete"/>
            <span><h6>Also permanently delete the document and file itself</h6></span>
          </label>
          </form>
          
            <button style="float: right;margin-left: 20px" class="btn-small waves-light" type="submit" onclick="removeTransactionEvidence(transactionEvidenceId_to_remove)">Confirm<i class="material-icons right">send</i></button>
            <a style="float: right"
              class="modal-close waves-light btn-small"><i class="material-icons right">cancel</i>
              Cancel</a>
        </div>
        </div>
        <div id="transactionNewDocument" class="modal normal">
          <div class="modal-content">
            <a style="float: right" class="modal-close waves-light btn-floating"><i class="material-icons right">cancel</i></a>
            <h5> New Transaction Evidence Document</h5>
            <div class="row">
              <form>
                <div class="input-field" id="transactionEvidence_file_edit">
                </div>
                <div class="file-field input-field col s12 m6">
                  <div class="btn-small">
                    <span>PDF Document<b><font color='red'>*</font></b><i class="material-icons right">attach_file</i></span>
                    <input type="file" id="transactionEvidenceFile">
                  </div>
                  <div class="file-path-wrapper">
                    <input class="file-path validate" type="text" id="transactionEvidenceFileText">
                  </div>
                </div>
              </form>
              <form>
                <div class="input-field col s12 m4">
                  <select id="transactionEvidence_type" required required="true" onchange="toggleTransactionEvidenceNew()"></select>
                  
                </div> 
                <div class="input-field col s12 m4" id="transactionEvidence_freeType_field">
                  <input id="transactionEvidence_freeType" type="text" class="validate" maxlength="20" data-length="20" >
                  <label for="transactionEvidence_freeType">Free text type<b><font color='red'>*</font></b></label>
                  <span class="helper-text" data-error="Maximum 20 characters"></span>
                </div>
              </form>
            </div>
          </div>
          <div class="modal-footer">
            <button id="transactionEvidenceDocumentSubmitButton" style="float: right;margin-left: 20px" class="btn-small waves-light" type="submit" onclick="this.disabled=true; writeTransactionEvidence()">Submit<i class="material-icons right">send</i></button>
            <a style="float: right"
              class="modal-close waves-light btn-small"><i class="material-icons right">cancel</i>
              Cancel</a>
          </div>
        </div>
        <div id="transactionNewEvidenceLink" class="modal normal">
          <div class="modal-content">
            <a style="float: right" class="modal-close waves-light btn-floating"><i class="material-icons right">cancel</i></a>
            <h5> Link to existing document</h5>
            <button style="margin-top:5px;margin-left:2px" data-target="documentFilter" class="btn-small waves-light modal-trigger" onclick="prepareSetDocumentFilter()"><i class="material-icons right">filter_list</i>Filter</button>
            <div id="documentsFromTrEvidence_filterOff">Filter Off</div>
            <div id="documentsFromTrEvidence_filterOn" style="display:none">Filter On</div>
          
            
              <form>
                <div class="input-field col s12 m12">
                  <select id="transactionLink_document" required required="true"></select>
                  
                </div> 
                
              </form>
            
          </div>
          <h6>Only documents not yet linked are listed here. "General Assembly" can't be linked either.</h6>
          <center>
            <div id="transactionEvidenceLink_more">
              <button  style="margin-bottom: 3px; margin-top:10px" class="btn-small waves-light" type="submit" onclick="this.disabeld=true; nextBatchDocuments(lastVisibleDocument)">Load More<i class="material-icons right">arrow_downward</i></button>
            </div>
          </center>
          <div class="modal-footer">
            <button id="transactionEvidenceLinkSubmitButton" style="float: right;margin-left: 20px" class="btn-small waves-light" type="submit" onclick="writeTransactionLink()">Submit<i class="material-icons right">send</i></button>
            <a style="float: right"
              class="modal-close waves-light btn-small"><i class="material-icons right">cancel</i>
              Cancel</a>
          </div>
        </div>
        <div id="Transactions" class="col s12">
          <div id="transactionFilter" class="modal normal">
            <div class="modal-content">
            <a style="float: right" class="modal-close waves-light btn-floating"><i class="material-icons right">cancel</i></a>
            <h5>Enter filter</h5>
            <div class="row">
              <form>
                <div class="input-field col s12 m4">
                  <input id="transactionFilter_bookDate" type="date">
                  <label for="transactionFilter_bookDate">Booking Date on or before</label>
                </div>
                <div class="input-field col s12 m4">
                  <select id="transactionFilter_type"></select>
                </div>
                <div class="input-field col s12 m4">
                  <select id="transactionFilter_costCenter"></select>
                </div> 
                <div class="input-field col s12 m4">
                  <select id="transactionFilter_owner"></select>
                </div>
                <div class="input-field col s12 m4">
                  <input id="transactionFilter_name" type="text" class="validate" maxlength="50" data-length="50" >
                  <label for="transactionFilter_name">Counterparty contains</label>
                </div>
              </form>
            </div>
            </div>
            <div class="modal-footer">
              <button style="float: right;margin-left: 20px" class="btn-small waves-light" type="submit" onclick="setTransactionFilter()">Submit<i class="material-icons right">send</i></button>
              <a style="float: right"
                class="modal-close waves-light btn-small"><i class="material-icons right">cancel</i>
                Cancel</a>
            </div>
          </div>
          <button style="margin-top:5px;margin-left:2px" data-target="transactionFilter" class="btn-small waves-light modal-trigger" onclick="prepareSetTransactionFilter()"><i class="material-icons right">filter_list</i>Filter</button>
          <button id="Transactions_Add" style="float: right;margin-right:5px;margin-top:5px; visibility:hidden" data-target="transactionAdd" class="btn-small waves-light modal-trigger" onclick="resetSelectedTransaction()"><i class="material-icons right">add</i>New transaction</button>
          <button id="Transactions_Upload" style="float: right;margin-right:5px;margin-top:5px; visibility:hidden" data-target="transactionLoad" class="btn-small waves-light modal-trigger" onclick="emptyTransactionLoadFields()"><i class="material-icons right">file_upload</i>Upload transactions</button>
          
          <div id="transactions_filterOff">Filter Off</div>
          <div id="transactions_filterOn" style="display:none">Filter On</div>
          <div id="transactionsTable_frame">
          <table class="striped" >
            <thead>
              <tr>
                <th align=center>Counterparty</th>
                
                <th align=center>Amount</th>
                <th align=center>Date</th>
                <th align=center>
                  <p style="writing-mode: vertical-rl">Classified?</p>
                </th>
                <th align=center>
                  <p style="writing-mode: vertical-rl">Evidence?</p>
                </th>
              </tr>
            </thead>
            <tbody id="transactionsTable">
            </tbody>
          </table>
          <center>
            <div id="transactions_more">
              <button  style="margin-bottom: 3px; margin-top:10px" class="btn-small waves-light" type="submit" onclick="this.disabeld=true; nextBatchTransactions()">Load More<i class="material-icons right">arrow_downward</i></button>
            </div>
            <div id="transactions_noMore" style="margin-top: 20px;margin-bottom: 3px" ><i class="material-icons" style="float:bottom;margin-top:10px">all_inclusive</i>    End of List    <i class="material-icons">all_inclusive</i></div>
          </center>
          </div>
          <div id="transactions_absentPhrase" style="display:none">
          <h5>There are no Transactions yet</h5>
          </div>
          <br>
          
          <div id="transactionAdd" class="modal full">
            <div class="modal-content" >
              <a style="float: right" class="modal-close waves-light btn-floating"><i class="material-icons right">cancel</i></a>
              
              <h5>Enter transaction data</h5>
              <form>
                <div class="input-field col s12 m4">
                  <select id="transaction_type_add" required required="true" onchange="toggleTransaction()"></select>
                  
                </div>
                <div class="input-field col s12 m4" id="transaction_costCenter_add_field">
                  <select id="transaction_costCenter_add"></select>
                  
                </div>
                <div class="input-field col s12 m4" id="transaction_name_add_field">
                  <input id="transaction_name_add" type="text" class="validate" maxlength="50" data-length="50" >
                  <label for="transaction_name_add">Counterparty<b><font color='red'>*</font></b></label>
                  <span class="helper-text" data-error="Maximum 50 characters"></span>
                </div>
                <div class="input-field col s12 m4" id="transaction_owner_add_field" >
                  <select id="transaction_owner_add" >
                    <option value="" disabled selected>Select Owner*</option>
                  </select>
                </div>
                <div class="input-field col s12 m4">
                  <input id="transaction_account_add" type="text" maxlength="19" class="validate" data-length="19" 
                    pattern="^BE\d{14}$|^BE\d{2}\s\d{4}\s\d{4}\s\d{4}$">
                  <label for="transaction_account_add">Account</label>
                  <span class="helper-text" data-error="BE followed by 14 digits, blancs for printing format allowed. Example: BE40 9799 2578 3625">BE followed by max 14 digits, blancs allowed. Example: BE40 9799 2578 3625</span>
                </div>
                <div class="input-field col s12 m12">
                  <input id="transaction_communication_add" type="text" class="validate" maxlength="80" data-length="80" >
                  <label for="transaction_communication_add">Communication</label>
                  <span class="helper-text" data-error="Maximum 80 characters"></span>
                </div>
                <div class="input-field col s12 m4">
                  <input id="transaction_amount_add" type="number" class="validate" min="-999999" max="999999" step="0.01" required required="true">
                  <label for="transaction_amount_add">Amount<b><font color='red'>*</font></b></label>
                  <span class="helper-text" data-error="Positive or negative amount below 1 Million. Example: -10234.56">Positive or negative amount. Example: -1234.56"</span>
                </div>
                <div class="row">
                <div class="input-field col s12 m3">
                  <input id="transaction_date_add" type="text" class="datepicker validate"  required required="true" onchange="copyToBookDate()">
                  <label for="transaction_date_add">Transaction Date<b><font color='red'>*</font></b></label>
                  <span class="helper-text" data-error="Required field"></span>
                </div>
                <div class="input-field col s12 m3">
                  <input id="transaction_bookDate_add" type="text" class="datepicker validate"  required required="true">
                  <label for="transaction_bookDate_add">Accountancy Date<b><font color='red'>*</font></b></label>
                  <span class="helper-text" data-error="Required field">By default copied from Transaction Date</span>
                </div>
                </div>
                <div id="transaction_properties_add_frame" style="display:none" class="w3-panel">
                  <h5>For private transactions: please assign amount to properties</h5>
                  <div class="input-field col s12 m4">
                    <select id="transaction_properties_add">
                    </select>
                  </div>
                  <div class="input-field col s12 m4">
                    <input id="transaction_distribution_amount_add" type="number" class="validate" min="-999999" max="999999" step="0.01" required required="true">
                    <label for="transaction_distribution_amount_add">Amount<b><font color='red'>*</font></b></label>
                    <span class="helper-text" data-error="Positive or negative amount below 1 Million. Example: -10234.56">Positive or negative amount. Example: -1234.56"</span>
                  </div>
                  <button style="float: left;margin-left: 20px;margin-bottom: 3px" class="btn-small waves-light" type="button" onclick="addTransactionDistribution()"><i class="material-icons right">add</i>Assign amount to property</button>
                  <br>
                  <table class="striped">
                    <thead>
                      <tr>
                        <th>Property</th>
                        <th>Amount</th>
                      </tr>
                    </thead>
                    <tbody id="transaction_distribution_table_add">
                    </tbody>
                  </table>
                </div>
              </form>
            
              <button id="transaction_save_button" style="float: right;margin-left: 20px;margin-bottom: 3px" class="btn-small waves-light" type="submit" onclick="this.disabeld=true; writeTransaction()">Save and go to adding evidence<i class="material-icons right">send</i></button>
              <a style="float: right;margin-left: 20px;margin-bottom: 3px"
                class="modal-close waves-light btn-small"><i class="material-icons right">cancel</i>
                Cancel</a>
            </div>
          </div>

          <div id="transactionLoad" class="modal normal">
            <div class="modal-content">
            <a style="float: right" class="modal-close waves-light btn-floating"><i class="material-icons right">cancel</i></a>
              
              <h5> Load file with transactions</h5>
              <div class="row">
                <form>
                  <div class="input-field" id="transactionLoad_file_edit">
                  </div>
                  <div class="file-field input-field col s12 m6">
                    <div class="btn-small">
                      <span>CSV File<b><font color='red'>*</font></b><i class="material-icons right">attach_file</i></span>
                      <input type="file" id="transactionLoadFile">
                    </div>
                    <div class="file-path-wrapper">
                      <input class="file-path validate" type="text" id="transactionLoadFileText">
                    </div>
                  </div>
                </form>
              </div>
            </div>
            <div class="modal-footer">
              <button style="float: right;margin-left: 20px" class="btn-small waves-light" type="submit" onclick="loadTransactionsFile()">Load<i class="material-icons right">send</i></button>
              <a style="float: right"
                class="modal-close waves-light btn-small"><i class="material-icons right">cancel</i>
                Cancel</a>
            </div>
          </div>

          <div id="transactionLoadConfirm" class="modal full">
            <div class="modal-content">
            <a style="float: right" class="modal-close waves-light btn-floating"><i class="material-icons right">cancel</i></a>
              
              <h5>Please review and confirm all these transactions to be uploaded</h5>
              <table class="striped">
                <thead>
                  <tr>
                    <th>Type</th>
                    <th>Counterparty</th>
                    <th>Amount</th>
                    <th>Date</th>
                    <th>Account</th>
                    <th>Communication</th>
                  </tr>
                </thead>
                <tbody id="transactionsLoadConfirmTable">
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
              <button style="float: right;margin-left: 20px" class="btn-small waves-light" type="submit" onclick="writeTransactionsFile()">Confirm<i class="material-icons right">send</i></button>
              <a style="float: right"
                class="modal-close waves-light btn-small"><i class="material-icons right">cancel</i>
                Cancel</a>
            </div>
          </div>

        </div>
        <!------------------------------------------------------------------------------------------------------>
        <div id="TransactionRules" class="col s12">
          <h6 style="font-size:20px "><b>Rules to auto-classify uploaded transactions</b></h6>
          <ul class="collapsible" id="transactionRulesList">
          </ul>
          <div id="transactionRules_absentPhrase" style="display:none">
          <h5>There are no Transaction Rules yet</h5>
          </div>
          <br>
          <button style="float: right" data-target="transactionRuleEdit" class="btn-small waves-light modal-trigger" onclick="resetTransactionRule()"><i class="material-icons right">add</i>New transaction rule</button>
          <div id="transactionRuleEdit" class="modal normal">
            <div class="modal-content">
            <a style="float: right" class="modal-close waves-light btn-floating"><i class="material-icons right">cancel</i></a>
              
              <h5>Enter transaction rule </h5>
              <form>
                <div class="w3-panel ">
                  <h6><b>IF:</b> rule fires when all if-values match</h6>
                  <div class="input-field col s12 m4">
                    <input id="transactionRule_account" type="text" maxlength="19" class="validate" data-length="19" 
                      pattern="^BE\d{14}$|^BE\d{2}\s\d{4}\s\d{4}\s\d{4}$" required required="true">
                    <label for="transactionRule_account"><b>IF</b> Account<b><font color='red'>*</font></b></label>
                    <span class="helper-text" data-error="BE followed by 14 digits, blancs for printing format allowed. Example: BE40 9799 2578 3625">BE followed by max 14 digits, blancs allowed. Example: BE40 9799 2578 3625</span>
                  </div>
                  <div class="input-field col s12 m4">
                    <input id="transactionRule_communication" type="text" class="validate" maxlength="20" data-length="20" >
                    <label for="transactionRule_communication"><b>IF</b> Communication contains</label>
                    
                  </div>
                  <div class="input-field col s12 m4">
                    <input id="transactionRule_name" type="text" class="validate" maxlength="50" data-length="50" >
                    <label for="transactionRule_name"><b>For info only</b> Counterparty</label>
                    <span class="helper-text" data-error="Maximum 50 characters"></span>
                  </div>
                </div>
                <div class="w3-panel ">
                  <h6><b>THEN:</b> below fields will be set with value given</h6> 
                  <div class="input-field col s12 m4">
                    <select id="transactionRule_type" required required="true" onchange="toggleTransactionRule()"></select>
                  </div>
                  <div class="input-field col s12 m4" id="transactionRule_costCenter_field">
                    <select id="transactionRule_costCenter"></select>
                  </div>
                  <div class="input-field col s12 m4" id="transactionRule_owner_field" >
                    <select id="transactionRule_owner" >
                      <option value="" disabled selected>Select Owner*</option>
                    </select>
                  </div>
                </div>
              </form>
              <button id="transactionRuleSubmitButton" style="float: right;margin-left: 20px;margin-bottom: 3px" class="btn-small waves-light" type="submit" onclick="this.disabled=true; writeTransactionRule()">Save<i class="material-icons right">send</i></button>
              <a style="float: right;margin-left: 20px;margin-bottom: 3px"
                class="modal-close waves-light btn-small"><i class="material-icons right">cancel</i>
                Cancel</a>
            </div>
          </div>
          <div id="transactionRuleRemove" class="modal normal">
            <div class="modal-content">
              <h5> Please confirm you want to permanently remove this transaction rule</h5>
            </div>
            <div class="modal-footer">
              <button style="float: right;margin-left: 20px" class="modal-close btn-small waves-light" type="submit" onclick="removeTransactionRule()">Confirm<i class="material-icons right">send</i></button>
              <a style="float: right"
                class="modal-close waves-light btn-small"><i class="material-icons right">cancel</i>
                Cancel</a>
            </div>
          </div>  
        </div>
        <!------------------------------------------------------------------------------------------------------>
        <div id="meterReadingExample" class="modal long">
          <div class="modal-content">
            <a style="float: right" class="modal-close waves-light btn-floating"><i class="material-icons right">cancel</i></a>
            <h6>example</h6>
            <img width="300" height="550" class="center" src="https://firebasestorage.googleapis.com/v0/b/mycondos-e9d66.appspot.com/o/271597589_997941057732402_7454652556295526841_n.jpg?alt=media&token=bc603384-0f40-43b8-a8d7-a21afde189dd">
            <a style="float: right" class="modal-close waves-light btn-floating"><i class="material-icons right">cancel</i></a>
          </div>
        </div>
        <div id="MeterReadings" class="col s12">
          <div id="meterReadingsTable_frame">
          <table class="striped">
            <thead>
              <tr>
                <th align=center>Type</th>
                <th align=center>
                  <p style="writing-mode: vertical-rl">Property</p>
                </th>
                <th align=center>
                  <p style="writing-mode: vertical-rl">Reading?</p>
                </th>
                <th align=center>
                  <p style="writing-mode: vertical-rl">Picture?</p>
                </th>
                <th align=center>Date</th>
              </tr>
            </thead>
            <tbody id="meterReadingsTable">
            </tbody>
          </table>
          </div>
          <div id="meterReadings_absentPhrase" style="display:none">
            <h5>There are no Meter Readings yet</h5>
          </div>
          <div id="pictureRemove" class="modal normal">
            <div class="modal-content">
              <h5> You are about to remove the meter reading picture</h5>
            </div>
            <div class="modal-footer">
              <button style="float: right;margin-left: 20px" class="btn-small waves-light" type="submit" onclick="removePicture()">Confirm<i class="material-icons right">send</i></button>
              <a style="float: right"
                class="modal-close waves-light btn-small"><i class="material-icons right">cancel</i>
                Cancel</a>
            </div>
          </div>
          
          <div id="meterReadingEdit" class="modal normal">
            <div class="modal-content">
              <a style="float: right" class="modal-close waves-light btn-floating"><i class="material-icons right">cancel</i></a>
              <h5>Enter meter reading and picture</h5>
                <form>
                  <div class="input-field col s12 m4">
                    <div class="input-field">
                      <input id="meterReading_reading_edit" type="number" class="validate" max="9999999999" required required="true">
                      <label for="meterReading_reading_edit">Reading<b><font color='red'>*</font></b></label>
                      <span id="meterReading_reading_helper_edit" class="helper-text" ></span>
                    </div>
                    <br>
                    <div class="input-field ">
                      <input id="meterReading_date_edit" type="date" required required="true">
                      <label for="meterReading_date_edit">Date<b><font color='red'>*</font></b></label>
                      <span class="helper-text" data-error="required field" ></span>
                    </div>
                  </div>
                </form>
                <div class="col s12 m6">
                  <div id="meterReading_picture_edit_frame">
                    <img id="meterReading_picture_edit_img" width="300" height="225" class="center" />
                    <button style="float:right;margin-left: 20px;margin-top: 3px;margin-bottom: 10px" class="btn-small waves-light red"  type="submit" onclick="removePicture()">Remove Picture<i class="material-icons right">delete</i></button>
                  </div>
                  <div id = "meterReading_picture_form">
                  <form >
                    <div class="input-field">
                    </div>
                    <div class="file-field input-field ">
                      <div class="btn-small">
                        <span>Add Picture<i class="material-icons right">attach_file</i></span>
                        <input type="file" id="meterReading_picture_edit_file">
                      </div>
                      <div class="file-path-wrapper" style="visibility:hidden">
                        <input class="file-path validate" type="text" id="meterReading_picture_edit_text" onChange="showPictureMeterReadingEdit()">
                        <span class="helper-text" data-error="only jpeg or png files" >jpeg or png file</span>
                      </div>
                    </div>
                  </form>
                  <span>Add an horizontal picture like in this </span>
                    <button data-target="meterReadingExample" class="modal-trigger" style="border:none;background-color:Transparent"><font color='blue'>example</font></button>
                  </div>
                </div>
                
              <button id="meterReadingSubmitButton" style="float: right;margin-left: 20px;margin-bottom: 3px;margin-top: 5px" class="btn-small waves-light" type="submit" onclick="this.disabled=true; writeMeterReading()">Submit<i class="material-icons right">send</i></button>
              <a style="float: right;margin-bottom: 3px;margin-top: 5px"
                class="modal-close waves-light btn-small"><i class="material-icons right">cancel</i> Cancel</a>
            </div>
          </div>
          
          <div id="meterReadingView" class="modal full">
            <div class="modal-content">
              <a style="float: right" class="modal-close waves-light btn-floating"><i class="material-icons right">cancel</i></a>
              <h5>View meter readings</h5>
              <div class="w3-panel w3-border" style="box-shadow: 5px 10px 8px #888888">
                <h6><b>New Meter Reading</b></h6>
                
                  <div class="input-field col s6 m3">
                    <input id="meterReading_reading" type="text" readonly>
                    <label for="meterReading_reading">Reading</label>
                  </div>
                  <div class="input-field col s6 m3">
                    <input id="meterReading_date" type="text" readonly>
                    <label for="meterReading_date">Date</label>
                  </div>
                
                <div id="meterReading_picture_frame" class="col s12 m6">
                  <img id="meterReading_picture_img" width="300" height="225" class="center" >
                </div>
                <div class="row col s10 m4">
                  <p style="font-size:12px">Updated by: <span id="meterReading_updatedBy"></span> </p>
                </div>
                <div id="meterReading_edit_button_frame">
                  <button id="meterReading_edit_button" style="float: right;float: bottom;margin-bottom: 3px" data-target="meterReadingEdit" class="btn-floating waves-light modal-trigger" onclick="prepareMeterReadingEdit()"><i class="material-icons right">edit</i></button>
                </div>
              </div>
              <div class="w3-panel w3-border" style="box-shadow: 5px 10px 8px #888888">
                <h6><b>Meter Info</b></h6>
                <div class="input-field col s4 m4">
                  <input id="meterReading_property" type="text" readonly>
                  <label for="meterReading_property">Property</label>
                </div>
                <div class="input-field col s4 m4">
                  <input id="meterReading_type" type="text" readonly>
                  <label for="meterReading_type">Type</label>
                </div>
                
                <div class="input-field col s4 m4">
                  <input id="meterReading_id" type="text" readonly>
                  <label for="meterReading_id">ID Meter</label>
                </div>
                <br>
                <h6><b>Past Readings</b></h6>
                  <table>
                  <thead>
                    <th>reading</th>
                    <th>date</th>
                    <th>updated by</th>
                  </thead>
                  <tbody id="meterReadingHistory">
                  </tbody>
                </table>
              </div>
              <a style="float: right" class="modal-close waves-light btn-floating"><i class="material-icons right">cancel</i></a>
            </div>
          </div>
        </div> 
        <!------------------------------------------------------------------------------------------------------>
        <div id="Members" class="col s12">
          <table class="striped">
            <thead>
              <tr>
                <th style="white-space: nowrap"> Name </th>
                <!--<th> Email </th>-->
                <th> Mobile </th>
              </tr>
            </thead>
            <tbody id="membersTable">
            </tbody>
          </table>
          <br>
          <div id="Members_Add" >
            <button style="float: right" data-target="memberWrite" class="btn-small waves-light modal-trigger" onclick="resetSelectedMember()"><i class="material-icons right">add</i>New Member</button>
          </div>
        </div>
        <!--- shared views ------------------------------------------------------------------------------------>
        <div id="memberView" class="modal full">
          <div class="modal-content">
            <a style="float: right" class="modal-close waves-light btn-floating"><i class="material-icons right">cancel</i></a>
            <h5> View member</h5>
            <div class="w3-panel w3-border" style="box-shadow: 5px 10px 8px #888888">
                <div class="input-field col s12 m4" id="member_firstName_frame">
                  <i class="material-icons prefix">account_circle</i>
                  <input id="member_firstName" type="text" readonly>
                  <label for="member_firstName" >First Name</label>
                </div>
                <div class="input-field col s12 m8" id="member_lastName_frame">
                  <i class="material-icons prefix">account_circle</i>
                  <input id="member_lastName" type="text" readonly>
                  <label for="member_lastName" >Last Name</label>
                </div>
                <div class="input-field col s12 m8" id ="member_companyName_frame" >
                  <i class="material-icons prefix">business</i>
                  <input id="member_companyName" type="text" readonly>
                  <label for="member_companyName">Company Name</label>
                </div>
                <div class="input-field col s12 m4" id ="member_registrationNumber_frame">
                  <i class="material-icons prefix">business</i>
                  <input id="member_registrationNumber" type="text" readonly>
                  <label for="member_registrationNumber">Registration Number</label>
                </div>
                <div class="input-field col s12">
                <i class="material-icons prefix">email</i>
                <input id="member_email" type="email" readonly>
                  <label for="member_email" >Email</label>
                </div>
                <div class="input-field col s12 m6">
                  <i class="material-icons prefix">phone</i>
                  <input id="member_phoneHome" type="tel" readonly>
                  <label for="member_phoneHome">Telephone Home</label>
                </div>
                <div class="input-field col s12 m6">
                  <i class="material-icons prefix">phone</i>
                  <input id="member_phoneMobile" type="tel" readonly>
                  <label for="member_phoneMobile">Mobile</label>
                </div>
                <p> </p>
                <div class="input-field col s12 m4">
                  <input  id="member_country" type="text" readonly >
                  <label for="member_country" >Country</label>
                </div>
                <div class="input-field col s8 m6">
                  <input  id="member_town" type="text" readonly >
                  <label for="member_town">Town</label>
                </div>
                <div class="input-field col s4 m2">
                  <input  id="member_zip" type="number" readonly>
                  <label for="member_zip" >Zip</label>
                </div>
                <div class="input-field col s12 m4">
                  <input  id="member_street" type="text" readonly >
                  <label for="member_street">Street</label>
                </div>
                <div class="input-field col s6 m2">
                  <input  id="member_houseNumber" type="text" readonly >
                  <label for="member_houseNumber">Number</label>
                </div>
                <div class="input-field col s6 m2">
                  <input  id="member_bus" type="number" readonly >
                  <label for="member_bus">Bus</label>
                </div>
              
                <div class="row col s10 m10">
                  <p style="font-size:12px">Updated On: <span id="member_updatedOn"></span> </p>
                  <p style="font-size:12px">Updated by: <span id="member_updatedBy"></span> </p>
                </div>
                <div id="Members_Edit">
                    <button style="float: right;margin-bottom: 3px" data-target="memberWrite" class="btn-floating waves-light modal-trigger" onclick="setSelectedMember(selectedMemberObject,editMode)"><i class="material-icons right">edit</i></button>
                 <!-- </div>-->
                </div>
              
            </div>
            <div class="w3-panel w3-border" style="box-shadow: 5px 10px 8px #888888">
              <div class="col s12 m4">
                <h6>Owner of:</h6>
                <p id="member_ownerOf"> </p>
              </div>
              <div class="col s12 m4">
                <h6>Occupant of:</h6>
                <p id="member_occupantOf"> </p>
              </div>
            </div>
          <a style="float: right" class="modal-close waves-light btn-floating"><i class="material-icons right">cancel</i></a>
          </div>
        </div>

        <div id="memberWrite" class="modal full">
          <div class="modal-content">
          <a style="float: right" class="modal-close waves-light btn-floating"><i class="material-icons right">cancel</i></a>
            <h5> Enter member data</h5>
            <form >
              <div class="row">
              <div class="input-field col s12 m4">
                  <select id="member_type_edit" required required="true" onchange="toggleMember_edit()"></select>
              </div>
              </div>
              <div class="input-field col s12 m4" id="member_firstName_edit_frame">
                <i class="material-icons prefix">account_circle</i>
                <input id="member_firstName_edit" type="text" class="validate" maxlength="50" data-length="50" >
                <label for="member_firstName_edit" >First Name<b><font color='red'>*</font></b></label>
              </div>
              <div class="input-field col s12 m8" id="member_lastName_edit_frame">
                <i class="material-icons prefix">account_circle</i>
                <input id="member_lastName_edit" type="text" class="validate" maxlength="50" data-length="50" >
                <label for="member_lastName_edit" >Last Name <b><font color='red'>*</font></b></label>
              </div>
              <div class="input-field col s12 m8" id="member_companyName_edit_frame">
                <i class="material-icons prefix">business</i>
                <input id="member_companyName_edit" type="text" class="validate" maxlength="50" data-length="50" >
                <label for="member_companyName_edit">Company Name<b><font color='red'>*</font></b></label>
              </div>
              <div class="input-field col s12 m4" id="member_registrationNumber_edit_frame">
                <i class="material-icons prefix">business</i>
                <input id="member_registrationNumber_edit" type="text" class="validate" maxlength="50" data-length="50" >
                <label for="member_registrationNumber_edit" >Registration Number<b><font color='red'>*</font></b></label>
              </div>
              <div class="row">
              <div class="input-field col s12">
                <i class="material-icons prefix">email</i>
                <input id="member_email_edit" type="email" class="validate" maxlength="70" data-length="70">
                <label for="member_email_edit" >Email</label>
                <span class="helper-text" data-error="email must contain @" ></span>
              </div>
              <div class="input-field col s12 m6">
                <i class="material-icons prefix">phone</i>
                <input id="member_phoneHome_edit" type="tel" pattern="([+]?[0-9]|[ ])*" maxlength="30" class="validate">
                <label for="member_phoneHome_edit">Telephone Home</label>
                <span class="helper-text" data-error="Digits or spaces, f.i. +32 2 456 789" >Digits or spaces, f.i. +32 2 456 789</span>
              </div>
              <div class="input-field col s12 m6">
                <i class="material-icons prefix">phone</i>
                <input id="member_phoneMobile_edit" type="tel" pattern="([+]?[0-9]|[ ])*" maxlength="30" class="validate">
                <label for="member_phoneMobile_edit">Mobile</label>
                <span class="helper-text" data-error="+ then digits or spaces,f.i.: +32 476 123 456" >+ then digits or spaces,f.i.: +32 476 123 456</span>
              </div>
              <div class="col s12 m12">
                <button style="float: left" class="btn-small waves-light" type="button" onclick="insertAdrressCoproperty()">Copy adress condomynium<i class="material-icons right">content_copy</i></button>
              </div>
              <div class="input-field col s12 m4">
                <input  id="member_country_edit" type="text" class="validate" maxlength="50" data-length="50" >
                <label for="member_country_edit" >Country</label>
              </div>
              <div class="input-field col s6 m6">
                <input  id="member_town_edit" type="text" class="validate" maxlength="50" data-length="50" >
                <label for="member_town_edit">Town</label>
              </div>
              <div class="input-field col s6 m2">
                <input  id="member_zip_edit" type="text" class="validate" min="0" maxlength="10" data-length="10" >
                <label for="member_zip_edit" >Zip</label>
                <span class="helper-text" data-error="Example: 1730">"Example: 1730"</span>
              </div>
              <div class="input-field col s12 m4">
                <input  id="member_street_edit" type="text" class="validate" maxlength="50" data-length="50" >
                <label for="member_street_edit">Street</label>
              </div>
              <div class="input-field col s6 m2">
                <input  id="member_houseNumber_edit" type="text" class="validate" maxlength="10" data-length="10" >
                <label for="member_houseNumber_edit">Number</label>
                <span class="helper-text" data-error="Example: 26A">Example: 26A</span>
              </div>
              <div class="input-field col s6 m2">
                <input  id="member_bus_edit" type="text" class="validate" maxlength="3" data-length="3" >
                <label for="member_bus_edit">Bus</label>
                <span class="helper-text" data-error="Example: 12" >Example: 12</span>
              </div>
              </div>
            </form>
            <button id="memberSubmitButton" style="float: right;margin-left: 20px;margin-bottom: 3px" class="btn-small waves-light" type="submit" onclick="this.disabled=true; writeMember()">Submit<i class="material-icons right">send</i></button>
            <a style="float: right;margin-bottom: 3px"
              class="modal-close waves-light btn-small"><i class="material-icons right">cancel</i>
              Cancel</a>
          </div>

        </div>

        <div id="propertyView" class="modal full">
          <div class="modal-content">
            <a style="float: right" class="modal-close waves-light btn-floating"><i class="material-icons right">cancel</i></a>
            <h5> View property</h5>
            <div class="w3-panel w3-border" style="box-shadow: 5px 10px 8px #888888">
              
                <div class="input-field col s2 m2">
                  <input id="property_code" type="text" readonly>
                  <label for="property_code">Code</label>
                </div>
                <div class="input-field col s4 m4">
                <input id="property_type" type="text" readonly>
                <label for="property_type">Type</label>
                </div>
                <div class="input-field col s4 m4">
                  <input id="property_cellar" type="text" readonly>
                  <label for="property_cellar">Cellar(s)</label>
                </div>
                <div class="col s12 m4">
                  <p style="font-size:16px">Owner: <span id="property_owner"></span> </p>
                </div>
                <div class="row col s10 m10">
                  <p style="font-size:12px">Updated On: <span id="property_updatedOn"></span> </p>
                  <p style="font-size:12px">Updated by: <span id="property_updatedBy"></span> </p>
                </div>
                <div id="Properties_Edit" class="displayHidden">
                  <button style="float: right;margin-bottom: 3px;margin-top: 30px" data-target="propertyWrite" class="btn-floating waves-light modal-trigger" onclick="setEditPropertyEntries()"><i class="material-icons right">edit</i></button>
                </div>
              
            </div>
            <!--
            <div class="w3-panel w3-border" style="box-shadow: 5px 10px 8px #888888" class="displayHidden">
              <div>
                <h7 style="margin-top: 10px">Owner: </h7>
                <button id="property_owner" data-target="memberView" class="modal-trigger" style="border:none;background-color:Transparent;margin-top: 10px"></button>

                <div class="displayHidden" id="previousOwnersButton">
                  <button style="float:right;margin-left: 20px;margin-bottom: 3px" data-target="previousOwners" class="btn-small waves-light modal-trigger" onclick="showPreviousOwnersTable()">Previous Owners</button>
                </div>
                  <button id="Properties_OwnersAdd_button" disabled style="float:right;margin-top: 5px;margin-bottom: 3px;visibility:hidden" data-target="newOwner" class="btn-small waves-light modal-trigger" onclick="newOwner()">New Owner<i class="material-icons right">add</i></button>
                
              </div>
            </div>-->
            <div class="w3-panel w3-border" style="box-shadow: 5px 10px 8px #888888">
              <div>
                <h7>Meters</h7>
                <table class="striped">
                  <thead>
                    
                    <th>Type</th>
                    <th>Meter ID</th>
                    <th>Status</th>
                  </thead>
                  <tbody id="property_meters">
                  </tbody>
                </table>
              </div>
              <div id="Properties_MetersAdd" class="displayHidden">
                <button style="float: right;margin-bottom: 3px" class="btn-small waves-light modal-trigger" data-target="meterWrite" onclick="addMeter()">Add Meter<i class="material-icons right">add</i></button>
              </div>
            </div>

            <div class="w3-panel w3-border" style="box-shadow: 5px 10px 8px #888888">
              <div>
                <h7>Occupants</h7>
                <table class="striped">
                  <tbody id="property_occupants">
                  </tbody>
                </table>
              </div>
              <div id="Properties_OccupantsAdd" class="displayHidden">
                <div class="input-field col s10 m4">
                  <select id="property_occupant_add" onchange="enableOccupantAdd()">
                  </select>
                </div>
                <div class="input-field col s2 m4">
                  <a id="buttonOccupantAdd" class="btn-floating waves-light disabled" onclick="addOccupant()"><i class="material-icons right">add</i></a>
                </div>
              </div>
            </div>
            
          </div>
          <div class="modal-footer">
          <a style="float: right" class="modal-close waves-light btn-floating"><i class="material-icons right">cancel</i></a>
          </div>
        </div>
        <div id="initialPictureRemove" class="modal normal">
        <div class="modal-content">
          <h5> You are about to remove the meter reading picture</h5>
        </div>
        <div class="modal-footer">
          <button style="float: right;margin-left: 20px" class="btn-small waves-light" type="submit" onclick="removeInitialPicture()">Confirm<i class="material-icons right">send</i></button>
          <a style="float: right"
            class="modal-close waves-light btn-small"><i class="material-icons right">cancel</i>
            Cancel</a>
        </div>
      </div>
        <div id="meterWrite" class="modal normal">
          <div class="modal-content">
            <a style="float: right" class="modal-close waves-light btn-floating"><i class="material-icons right">cancel</i></a>
            <h5>Enter meter id, format and initial reading</h5>
            <div class="row">
              <form>
                <div class="input-field col s6 m6">
                  <select id="meter_type" required aria-required="true"></select>
                </div>
                <div class="input-field col s6 m6">
                  <input id="meter_id" type="text" maxlength="10" data-length="10" class="validate" required aria-required="true" pattern="([A-Z]|[0-9]){4,10}">
                  <label for="meter_id">ID meter<b><font color='red'>*</font></b></label>
                  <span class="helper-text" data-error="Digits or capitals,f.i. 99DB5175">Digits or capitals,f.i. 99DB5175</span>
                </div>
                <div class="input-field col s6 m4">
                  <select id="meter_digits" required aria-required="true" onchange="toggleMeter()">
                    <option value="" disabled selected>Select*</option>
                    <option value="4">4</option>
                    <option value="5">5</option>
                    <option value="6">6</option>
                    <option value="7">7</option>
                    <option value="8">8</option>
                  </select>
                  <span class="helper-text" data-error="digits before the comma" >digits before comma</span>
                </div>
                <div class="input-field col s6 m4">
                  <select id="meter_decimals" required aria-required="true" onchange="toggleMeter()">
                    <option value="" disabled selected>Select*</option>
                    <option value="0">0</option>
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                  </select>
                  <span class="helper-text" data-error="digits after comma">digits after comma</span>
                </div>
                <div class="input-field col s6 m4">
                  <select id="meter_status" required aria-required="true"></select>
                  <span class="helper-text">active/removed</span>
                </div>
                <div class="input-field col s6 m4">
                  <input id="meter_initialReading_edit" type="number" class="validate" max="9999999999" required required="true">
                  <label for="meter_initialReading_edit">Initial Reading<b><font color='red'>*</font></b></label>
                  <span id="meter_initialReading_helper_edit" class="helper-text" ></span>
                </div>
              </form>
              <div id="meterInitialReading_picture_edit_frame" class="col s12 m12">
                <img id="meterInitialReading_picture_edit_img" width="300" height="225" class="center" />
                <button style="float:right;margin-left: 20px;margin-top: 3px;margin-bottom: 10px" class="btn-small waves-light red"  type="submit" onclick="removeInitialPicture()">Remove Picture<i class="material-icons right">delete</i></button>
              </div>
              <div id = "meterInitialReading_picture_form" class="col s12 m12">
              <form>
                <div class="input-field">
                </div>
                <div class="file-field input-field ">
                  <div id="meterinitialReading_picture_button" class="btn-small">
                    <span>Add Picture<i class="material-icons right">attach_file</i></span>
                    <input type="file" id="meterInitialReading_picture_edit_file" >
                  </div>
                  <div class="file-path-wrapper" style="visibility:hidden">
                    <input class="file-path validate" type="text" id="meterInitialReading_picture_edit_text" onChange="showPictureMeterInitialReadingEdit()">
                    <span class="helper-text" data-error="only jpeg or png files" >jpeg or png file</span>
                  </div>
                </div>
              </form>
              <span>Add an horizontal picture like in this </span>
              <button data-target="meterReadingExample" class="modal-trigger" style="border:none;background-color:Transparent"><font color='blue'>example</font></button>
              </div>
            </div>
          </div>
          <div class="modal-footer">
          <button id="meterSubmitButton" style="float: right;margin-left: 20px;margin-bottom: 3px" class="btn-small waves-light " type="submit" onclick="this.disabled=true; writeMeter()">Submit<i class="material-icons right">send</i></button>
           <a style="float: right;margin-bottom: 3px"
             class="modal-close waves-light btn-small"><i class="material-icons right">cancel</i> Cancel</a>
         </div>
        </div>
        <!------------------------------------------------------------------------------------------>
        <div id="Properties" class="col s12">
          
          <div id="propertiesTable_frame">
            <table class="striped">
              <thead>
                <tr>
                  <th>Code</th>
                  <th>Type</th>
                  <th>Owner</th>
                </tr>
              </thead>
              <tbody id="propertiesTable">
              </tbody>
            </table>
          </div>
          <div id="properties_absentPhrase" style="display:none">
            <h5>There are no properties yet</h5>
          </div>
          <br>
          <div id="Properties_Add" class="displayHidden">
            <button style="float: right" data-target="propertyAdd" class="btn-small waves-light modal-trigger" onclick="resetSelectedProperty()"><i class="material-icons right">add</i>New Property</button>
          </div>

          <div id="previousOwners" class="modal normal">
            <div class="modal-content">
              <a style="float: right"
                class="modal-close waves-light btn-small"><i class="material-icons right">cancel</i> Close</a>
              <h5> Previous Owners:</h5>
              <table class="striped">
                <thead>
                  <tr>
                    <th> Member </th>
                    <th> Transfer Date </th>
                  </tr>
                </thead>
                <tbody id="propertyPreviousOwnersTable">
                </tbody>
              </table>
              <a style="float: right"
                class="modal-close waves-light btn-small"><i class="material-icons right">cancel</i> Close</a>
            </div>
          </div>

          <div id="propertyAdd" class="modal normal">
            <div class="modal-content">
              <a style="float: right" class="modal-close waves-light btn-floating"><i class="material-icons right">cancel</i></a>
              <h5>New Property</h5>
              <div class="row">
              <form>
                <div class="input-field col s6 m6">
                  <select id="property_type_add" required aria-required="true"></select>
                </div>
                <div class="input-field col s6 m6">
                  <input id="property_code_add" type="text" pattern="([A-Z]|[0-9]){1,4}" maxlength="4" data-length="4" class="validate" required aria-required="true">
                  <label for="property_code_add">Code<b><font color='red'>*</font></b></label>
                  <span class="helper-text" data-error="Capitals or numbers,f.i. A1">Capitals or numbers,f.i. A1</span>
                </div>
                <div class="input-field col s12 m6">
                  <select id="property_owner_add" required aria-required="true">
                    <option value="" disabled selected>Select the owner</option>
                  </select>
                  <span class="helper-text" >Owner</span>
                </div>
                <div class="input-field col s12 m6">
                  <input id="property_cellar_add" type="text" maxlength="10" data-length="10" class="validate">
                  <label for="property_cellar_add">Cellar(s)</label>
                  <span class="helper-text" data-error="Example: C1, C2">Example: C1,C2</span>
                </div>
              </form>
              </div>
              <button id="propertyAddButton" style="float: right;margin-left: 20px;margin-bottom: 3px" class="btn-small waves-light" type="submit" onclick="this.disabled=true; addProperty()">Save and complete<i class="material-icons right">send</i></button>
              <a style="float: right;margin-bottom: 3px"
                class="modal-close waves-light btn-small"><i class="material-icons right">cancel</i> Cancel</a>
          </div>
          </div>

          <div id="newOwner" class="modal normal">
            <div class="modal-content">
              <a style="float: right"
                class="modal-close waves-light btn-small"><i class="material-icons right">cancel</i> Cancel</a>
              <h5> Transfer property to new owner</h5>
              <form class="col s12">
                <div class="input-field col s12 m6">
                  <select id="property_newOwner" required aria-required="true">
                      <option value="" disabled selected>Select the new owner</option>
                    </select>
                  <label for="property_newOwner">New Owner<b><font color='red'>*</font></b></label>
                </div>
                <div class="input-field col s12 m6">
                  <input id="property_transferDate" type="text" class="datepicker validate" required required="true">
                  <label for="property_transferDate">Transfer Date<b><font color='red'>*</font></b></label>
                  <span class="helper-text" data-error="required field" ></span>
                </div>
              </form>
              <button style="float: right;margin-left: 20px;margin-bottom: 3px" class="btn-small waves-light" type="submit" onclick="writeNewOwner()">Submit<i class="material-icons right">send</i></button>
              <a style="float: right;margin-bottom: 3px"
                class="modal-close waves-light btn-small"><i class="material-icons right">cancel</i> Cancel</a>
            </div>
          </div>

          <div id="previousOwner" class="modal normal">
            <div class="modal-content">
              <a style="float: right"
                class="modal-close waves-light btn-small"><i class="material-icons right">cancel</i> Cancel</a>
              <h5> Previous Owner</h5>
              <form class="col s12">
                <div class="input-field col s12 m6">
                  <select id="property_previousOwner" required aria-required="true">
                      <option value="" disabled selected>Correct the previous owner</option>
                    </select>
                  <label for="property_previousOwner">Previous Owner<b><font color='red'>*</font></b></label>
                </div>
                <div class="input-field col s12 m6">
                  <input id="property_transferDatePrevious" type="text" class="datepicker validate" required required="true">
                  <label for="property_transferDatePrevious">Transfer Date<b><font color='red'>*</font></b></label>
                  <span class="helper-text" data-error="required field" ></span>
                </div>
              </form>
              <button style="float: right;margin-left: 20px" class="btn-small waves-light" type="submit" onclick="writePreviousOwner()">Submit<i class="material-icons right">send</i></button>
              <a style="float: right"
                class="modal-close waves-light btn-small"><i class="material-icons right">cancel</i> Cancel</a>
            </div>
          </div>

          <div id="propertyWrite" class="modal normal">
            <div class="modal-content">
            <a style="float: right" class="modal-close waves-light btn-floating"><i class="material-icons right">cancel</i></a>
              
              <h5> Edit property data</h5>
              <form class="col s12">
                <div class="input-field col s6 m6">
                  <select id="property_type_edit" required aria-required="true"></select>
                </div>
                <div class="input-field col s6 m6">
                  <input id="property_code_edit" type="text" pattern="([A-Z]|[0-9]){1,4}" maxlength="4" data-length="4" class="validate" required aria-required="true">
                  <label for="property_code_edit">Code<b><font color='red'>*</font></b></label>
                  <span class="helper-text" data-error="Max 4 capitals or numbers. Example: A1">Capitals or numbers. Example: A1</span>
                </div>
                <div class="input-field col s12 m6">
                  <select id="property_owner_edit" required aria-required="true"></select>
                <span class="helper-text" >Owner</span>
                </div>
                <div class="input-field col s12 m6">
                  <input id="property_cellar_edit" type="text" maxlength="10" data-length="10" class="validate">
                  <label for="property_cellar_edit">Cellar(s)</label>
                  <span class="helper-text" data-error="A string of max 10 digits: Example: C1, C2">A string of max 10 digits: Example: C1,C2</span>
                </div>
              </form>
              <button id="propertyWriteButton" style="float: right;margin-left: 20px;margin-bottom: 3px" class="btn-small waves-light" type="submit" onclick="this.disabled=true; writeProperty()">Submit<i class="material-icons right">send</i></button>
              <a style="float: right;margin-bottom: 3px"
                class="modal-close waves-light btn-small"><i class="material-icons right">cancel</i> Cancel</a>
            </div>
          </div>
        </div>
        <!------------------------------------------------------------------------------------------>
        <div id="Settings" class="col s12">
          <h5>Meters Building</h5>
          <table class="striped">
            <thead>
              <th>Type</th>
              <th>Meter ID</th>
              <th>Status</th>
            </thead>
            <tbody id="coproperty_meters">
            </tbody>
          </table>
          <br>
          <button id="commonPartsNewMeterButton" style="visibility: hidden; float: right;margin-bottom: 3px" class="btn-small waves-light modal-trigger" data-target="meterWrite" onclick="addCopropertyMeter()">New Meter Building<i class="material-icons right">add</i></button>
          <br><br><h5>Cost Centers</h5>
          <table class="striped">
          <thead id="costCenters_tableHead">
          </thead>
          <tbody id="costCenters_tableBody">
          </tbody>
          </table>
          <div class="row col s10 m10">
            <p style="font-size:12px">Updated On: <span id="costCenters_updatedOn"></span> </p>
            <p style="font-size:12px">Updated by: <span id="costCenters_updatedBy"></span> </p>
          </div>
          <button id="costCentersNewButton" style="visibility: hidden; float: right;margin-bottom: 3px" class="btn-small waves-light modal-trigger" data-target="costCenterAdd" ">New Cost Center<i class="material-icons right">add</i></button>
          <br><br><br><br>
          <table><tr>
            <td><h5>Periodic Provisions</h5></td>
            <td id=provisionsCostCenterView></td>
            <td><p id="provisions"></p></td>
            <td><button id="provisionsEditButton" style="visibility: hidden; float: right;margin-bottom: 3px" class="btn-floating waves-light modal-trigger" data-target="provisionsEdit" onclick="provisionsEditPrepare()"><i class="material-icons right">edit</i></button></td>
          </tr></table>
          <table><tr>
          <td><h5>Ratio Common Heating</h5></td>
          <td><p id="heatingCommon"></p></td>
          <td><button id="heatingCommonEditButton" style="visibility: hidden; float: right;margin-bottom: 3px" class="btn-floating waves-light modal-trigger" data-target="heatingCommonEdit" onclick="heatingCommonEditPrepare()"><i class="material-icons right">edit</i></button></td>
        </tr></table>
          <div id="initialSaldos_frame">
            <table><tr>
              <td><h5>Initial Saldo Condomynium</h5></td>
              <td><p id="initialSaldo"></p></td>
              <td><button id="initialCopropertySaldoEditButton" style="visibility: hidden; float: right;margin-bottom: 3px" class="btn-floating waves-light modal-trigger" data-target="initialCopropertySaldoEdit" onclick="initialCopropertySaldoEditPrepare()"><i class="material-icons right">edit</i></button></td>
            </tr></table>
            <h5>Initial Saldos Owners</h5>
            <table class="striped">
              <thead>
                <th>Owner</th>
                <th>Initial Saldo</th>
              </thead>
              <tbody id="initialSaldos">
              </tbody>
            </table>
          </div>
          
          <div id="costCenterPrepareRemove" class="modal normal">
            <div class="modal-content">
              <a style="float: right" class="modal-close waves-light btn-floating"><i class="material-icons right">cancel</i></a>
              <h5> You are about to permanently remove the cost center <i id="costCenter_to_remove"></i> </h5>
              
              <button style="float: right;margin-left: 20px;margin-bottom: 3px" class="btn-small waves-light" type="submit" onclick="removeCostCenter()">Confirm<i class="material-icons right">send</i></button>
              <a style="float: right;margin-bottom: 3px"
                class="modal-close waves-light btn-small"><i class="material-icons right">cancel</i> Cancel</a>
            </div>
          </div>
          <div id="costCenterAdd" class="modal normal">
            <div class="modal-content">
              <a style="float: right"
                class="modal-close waves-light btn-floating"><i class="material-icons right">cancel</i></a>
              <h5> New Cost Center</h5>
              <form class="col s12">
                <div class="input-field col s6 m6">
                  <input id="costCenter_name_add" type="text" class="validate" required aria-required="true" data-length="20" maxlength="20">
                  <label for="costCenter_name_add">Name<b><font color='red'>*</font></b></label>
                  <span class="helper-text" data-error="Required field">Max 20 characters</span>
                </div>
              </form>
              <button id="costCenterAddSubmitButton" style="float: right;margin-left: 20px;margin-bottom: 3px" class="btn-small waves-light" type="submit" onclick="this.disabled=true; costCenterAddPrepare()">Save<i class="material-icons right">send</i></button>
              <a style="float: right;margin-bottom: 3px"
                class="modal-close waves-light btn-small"><i class="material-icons right">cancel</i> Cancel</a>
            </div>
          </div>
          <div id="costCenterNameEdit" class="modal normal">
              <div class="modal-content">
                <a style="float: right" class="modal-close waves-light btn-floating"><i class="material-icons right">cancel</i></a>
                <h5> Enter name cost center</h5>
                <form class="col s12">
                  <div class="input-field col s6 m6">
                    <input id="costCenter_name_edit" type="text" class="validate" required aria-required="true">
                    <label for="costCenter_name_edit">Name<b><font color='red'>*</font></b></label>
                    <span class="helper-text" data-error="Required field"></span>
                  </div>
                </form>
                <button style="float: right;margin-left: 20px;margin-bottom: 3px" class="btn-small waves-light" type="submit" onclick="costCenterNameEditPrepare()">Save<i class="material-icons right">send</i></button>
                <a style="float: right;margin-bottom: 3px"
                  class="modal-close waves-light btn-small"><i class="material-icons right">cancel</i> Cancel</a>
              </div>
          </div>
          <div id="costCenterQuotaEdit" class="modal normal">
            <div class="modal-content">
              <a style="float: right" class="modal-close waves-light btn-floating"><i class="material-icons right">cancel</i></a>
              <h5> Enter quota</h5>
              <form class="col s12">
                <div class="input-field col s6 m6">
                <input id="costCenter_quota_edit" type="number" class="validate" min="0" max="999" required aria-required="true">
                <label for="costCenter_quota_edit">Quota<b><font color='red'>*</font></b></label>
                <span class="helper-text" data-error="A number of max 3 digits. Example: 22">A number of max 3 digits. Example: 22</span>
                </div>
              </form>
              <button style="float: right;margin-left: 20px;margin-bottom: 3px" class="btn-small waves-light" type="submit" onclick="costCenterQuotaEditPrepare()">Save<i class="material-icons right">send</i></button>
              <a style="float: right;margin-bottom: 3px"
                class="modal-close waves-light btn-small"><i class="material-icons right">cancel</i> Cancel</a>
            </div>
          </div>
          <div id="initialSaldoEdit" class="modal normal">
            <div class="modal-content">
              <a style="float: right" class="modal-close waves-light btn-floating"><i class="material-icons right">cancel</i></a>
              <h5> Enter initial saldo</h5>
              <form class="col s12">
                <div class="input-field col s12 m4">
                  <input id="initialSaldo_amount" type="number" class="validate" min="-999999" max="999999" step="0.01" required required="true">
                  <label for="initialSaldo_amount">Amount<b><font color='red'>*</font></b></label>
                  <span class="helper-text" data-error="Positive or negative amount. Example: -10234.56">Positive or negative amount. Example: -1234.56"</span>
                </div>
              </form>
              <button style="float: right;margin-left: 20px;margin-bottom: 3px" class="btn-small waves-light" type="submit" onclick="initialSaldoWrite()">Save<i class="material-icons right">send</i></button>
              <a style="float: right;margin-bottom: 3px"
                class="modal-close waves-light btn-small"><i class="material-icons right">cancel</i> Cancel</a>
            </div>
          </div>
          <div id="provisionsEdit" class="modal normal">
          <div class="modal-content">
            <a style="float: right" class="modal-close waves-light btn-floating"><i class="material-icons right">cancel</i></a>
            <h5> Enter amount periodic funds raising, for entire condomynium</h5>
            <form class="col s12">
              <div class="input-field col s12 m4">
                <input id="provisions_edit" type="number" class="validate" min="-999999" max="999999" step="0.01" required required="true">
                <label for="provisions_edit">Amount<b><font color='red'>*</font></b></label>
                <span class="helper-text" data-error="Positive or negative amount. Example: 2500">Positive amount. Example: 2000. Negative amount yields funds reimbursement"</span>
              </div>
              <div class="input-field col s12 m4">
                <select id="provisions_costCenter_edit"></select>
              </div>
            </form>
            <button style="float: right;margin-left: 20px;margin-bottom: 3px" class="btn-small waves-light" type="submit" onclick="provisionsWrite()">Save<i class="material-icons right">send</i></button>
            <a style="float: right;margin-bottom: 3px"
              class="modal-close waves-light btn-small"><i class="material-icons right">cancel</i> Cancel</a>
          </div>
          </div>
          <div id="heatingCommonEdit" class="modal normal">
          <div class="modal-content">
            <a style="float: right" class="modal-close waves-light btn-floating"><i class="material-icons right">cancel</i></a>
            <h5>Enter percentage applied for common heating</h5>
            <form class="col s12 m8">
              <div class="input-field col s12 m4">
                <input id="heatingCommon_edit" type="number" class="validate" min="0" max="100" step="1" required required="true">
                <label for="heatingCommon_edit">percentage<b><font color='red'>*</font></b></label>
                <span class="helper-text" data-error="Example: 10. Represents 10%">Positive amount. Example: 10. Represents 10%"</span>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button style="float: right;margin-left: 20px;margin-bottom: 3px" class="btn-small waves-light" type="submit" onclick="heatingCommonWrite()">Save<i class="material-icons right">send</i></button>
            <a style="float: right;margin-bottom: 3px"
              class="modal-close waves-light btn-small"><i class="material-icons right">cancel</i> Cancel</a>
          </div>
          </div>
          <div id="initialCopropertySaldoEdit" class="modal normal">
            <div class="modal-content">
              <a style="float: right" class="modal-close waves-light btn-floating"><i class="material-icons right">cancel</i></a>
              <h5> Enter initial condomynium saldo</h5>
              <form class="col s12">
                <div class="input-field col s12 m4">
                  <input id="initialCopropertySaldo_amount" type="number" class="validate" min="-999999" max="999999" step="0.01" required required="true">
                  <label for="initialCopropertySaldo_amount">Amount<b><font color='red'>*</font></b></label>
                  <span class="helper-text" data-error="Positive or negative amount. Example: -10234.56">Positive or negative amount. Example: -1234.56"</span>
                </div>
              </form>
              <button style="float: right;margin-left: 20px;margin-bottom: 3px" class="btn-small waves-light" type="submit" onclick="initialCopropertySaldoWrite()">Save<i class="material-icons right">send</i></button>
              <a style="float: right;margin-bottom: 3px"
                class="modal-close waves-light btn-small"><i class="material-icons right">cancel</i> Cancel</a>
            </div>
          </div>
          <div class="row col s10 m10">
            <p style="font-size:12px">Updated On: <span id="coproperty_updatedOn"></span> </p>
            <p style="font-size:12px">Updated by: <span id="coproperty_updatedBy"></span> </p>
          </div> 
        </div>
      </div>
    </main>
    <script>
      var lastLoadTime;
      var version;
      var loadBatchLength = 30;
      async function loadAll(){
        var time = (new Date()).getTime();
        if ((time - lastLoadTime) > 90000) {
          lastLoadTime = time;
          var siRef = firestore.collection("System").doc("systeminfo");
          siRef.get().then(function(si){
            if (si.data().version > version) {location.reload();}
            else {emptyDataCash();};
          });
        } else {lastLoadTime = time};
      };
      
      var lastCloseDate;
      var lastReguDate;
      
      var currencyStyle = {
        style: "currency",
        currency: "EUR"
      };
      var currentUserProperties;
      var currentUser = {
        email: "",
        role: "",
        id:"",
        owns: function(propertyId){
          var x = [];
          if (!currentUserProperties) {
            currentUserProperties = [];
            refCoproperty.collection("Properties").where("owner","==",this.id).get().then(function(propertiesFS){
              propertiesFS.forEach(function (propertyFS){
                currentUserProperties.push(propertyFS.id);                
              });             
              return currentUserProperties.includes(propertyId);
            });
          } else {
          return currentUserProperties.includes(propertyId);
          };
        }
      };
      var roleAdministrator = 1;

      function showPasswordSet() {
      document.getElementById("loginPanel").setAttribute("class","displayHidden");
      document.getElementById("setPasswordPanel").setAttribute("class","displayBlock");
      };

      function showPasswordReset() {
      document.getElementById("loginPanel").setAttribute("class","displayHidden");
      document.getElementById("resetPasswordPanel").setAttribute("class","displayBlock");
      };

    function validateLoginEntries() {
      var valid= true;
      if (!document.getElementById("login_email").checkValidity()) {
        M.toast({html:"Please enter your email"});
        valid=false;
      };
      if (!document.getElementById("login_password").checkValidity()) {
        M.toast({html:"Please enter your password"});
        valid=false;
      };
      return valid;
    };

    function openApplication() {
      lastLoadTime = (new Date()).getTime();
      var siRef = firestore.collection("System").doc("systeminfo");
      siRef.get().then(function(si){
        version = si.data().version;
        loadHome();
        document.getElementById("loginPanel").setAttribute("class","displayHidden");
        document.getElementById("applicationPanel").setAttribute("class","displayBlock");
      }); 
    };
    
    function enableAdminFunctions(){
      document.getElementById("Reports_Generate").setAttribute("class","displayBlock");
      document.getElementById("Transactions_Add").style.visibility = "visible";
      document.getElementById("Transactions_Upload").style.visibility = "visible";
      document.getElementById("Transactions_Edit").setAttribute("class","displayBlock");
      document.getElementById("Transactions_EvidenceAdd").setAttribute("class","displayBlock");
      document.getElementById("Transactions_EvidenceLink").style.display = "block";
      document.getElementById("Properties_Add").setAttribute("class","displayBlock");
      document.getElementById("Properties_Edit").setAttribute("class","displayBlock");
      document.getElementById("Properties_MetersAdd").setAttribute("class","displayBlock");
      /*document.getElementById("Properties_OwnersAdd_button").style.visibility="visible";*/
      document.getElementById("tabTransactionRules").style.display = "block";
      document.getElementById("commonPartsNewMeterButton").style.visibility = "visible";
      document.getElementById("costCentersNewButton").style.visibility = "visible";
      document.getElementById("provisionsEditButton").style.visibility = "visible";
      document.getElementById("initialCopropertySaldoEditButton").style.visibility = "visible";
      document.getElementById("documentNewButton").style.visibility = "visible";
      document.getElementById("heatingCommonEditButton").style.visibility = "visible";
    };
    
    function login(){
      if (validateLoginEntries()) {
        var email = document.getElementById("login_email").value.toLowerCase();
        var password = document.getElementById("login_password").value;

        var docUserRef = firestore.collection("Users").doc(email);
        docUserRef.get().then(function(user){
          if (user.exists)  {
            firebase.auth().setPersistence(firebase.auth.Auth.Persistence.SESSION)
              .then(function() {
                  firebase.auth().signInWithEmailAndPassword(email, password)
                    .then(function(user){
                      if (email == "marc.van_limberghen@mail.be") {
                        currentUser.email = email;
                        currentUser.id = null;
                        currentUser.role = roleAdministrator;
                        enableAdminFunctions();
                        openApplication();
                      } else {
                        refCoproperty.collection("Members").where("email", "==" ,email).get().then(function(membersFS){ currentUser.email = email;
                        currentUser.id = membersFS.docs[0].id;
                        if (membersFS.docs[0].data().role) {
                          currentUser.role = roleAdministrator;
                          enableAdminFunctions();
                        };
                        openApplication();
                        }).catch(function(error) {
                          M.toast({html:"You are not registered as an active user: Please contact your administrator"});
                        }); 
                      };
                    })
                    .catch(function(error) {
                      M.toast({html:"Invalid email or password"});
                    });
              })
              .catch (function(error) {
                M.toast({html:error.message + "...authentication server not accessible"});
              });  
          }
          else {
            M.toast({html:"Unknown email: Please contact your administrator"});
          };
        });
      };
    };

    function backToLoginFromSetPW() {
      document.getElementById("setPasswordPanel").setAttribute("class","displayHidden");
      document.getElementById("loginPanel").setAttribute("class","displayBlock"); 
    };
    function backToLoginFromResetPW() {
      document.getElementById("resetPasswordPanel").setAttribute("class","displayHidden");
      document.getElementById("loginPanel").setAttribute("class","displayBlock"); 
    };
    
    function validatePasswordSetEntries() {
        var valid= true;
        if (!document.getElementById("passwordSet_email").checkValidity()) {
          M.toast({html:"Please enter your email"});
          valid=false;
        };
        return valid;
    };

      
    function passwordSet(){
      if (validatePasswordSetEntries()) {
        var email = document.getElementById("passwordSet_email").value;
        var docUserRef = firestore.collection("Users").doc(email);
        docUserRef.get().then(function(user){
          if (user.exists)  {
            firebase.auth().sendPasswordResetEmail(email).then(function() {
                M.toast({html:"Please follow instructions sent by mail"});
                setTimeout(function(){backToLoginFromSetPW();}, 6000);
            }).catch(function(error) {
              M.toast({html:"Error sending mail to set password set" + error});
            });
          } else {M.toast({html:"Unknown email: Please contact your administrator"});
          };
        }).catch(function(error) {
            M.toast({html:"Unknown email: Please contact your administrator"});
        });
      };
    };
    
    function validatePasswordResetEntries() {
        var valid= true;
        if (!document.getElementById("passwordReset_email").checkValidity()) {
          M.toast({html:"Please enter your email"});
          valid=false;
        };
        return valid;
    };
    
    
    function passwordReset(){
      if (validatePasswordResetEntries()) {
        var email = document.getElementById("passwordReset_email").value;
        var docUserRef = firestore.collection("Users").doc(email);
        docUserRef.get().then(function(user){
          if (user.exists)  {
            firebase.auth().sendPasswordResetEmail(email).then(function() {
                M.toast({html:"Please follow instructions sent by mail"});
                setTimeout(function(){backToLoginFromResetPW();}, 6000);
            }).catch(function(error) {
              M.toast({html:"Error sending password reset mail" + error});
            });
          } else {M.toast({html:"Unknown email: Please contact your administrator"});
          };
        }).catch(function(error) {
            M.toast({html:"Unknown email: Please contact your administrator"});
        });
      };
    };
    </script>
    <!--   Application scripts starts here -->
     <script>
      const options = {
        duration: 300,
        onShow: null,
        swipeable: false,
        responsiveThreshold: Infinity
    };

    var elems = document.querySelectorAll('input[data-length]');
    M.CharacterCounter.init(elems);
    
    elems = document.querySelectorAll('select');
    var instances = M.FormSelect.init(elems);
    if (navigator.vendor.toLowerCase().indexOf('apple') > -1){  
      var i;
      for (i = 0; i < elems.length; i++) {elems[i].setAttribute("class" , "browser-default");};
    };

    const tabsContainer = document.querySelector(".tabs");
    M.Tabs.init(tabsContainer,options);
    elems = document.querySelectorAll('.datepicker');
    instances = M.Datepicker.init(elems, {maxDate: new Date(),format: 'yyyy-mm-dd'});
    elems = document.querySelectorAll('.datepickerFuture');
    instances = M.Datepicker.init(elems, {minDate: new Date(),format: 'yyyy-mm-dd'});
    
    
    elems = document.querySelectorAll('.modal');
    instances = M.Modal.init(elems, {dismissible:false,preventScrolling:false});

    M.CharacterCounter.init(document.querySelectorAll('.has-character-counter'));

    var refCoproperty = firestore.collection("CoProperties").doc(thisCoproperty);
    var refCopropertyFiles = fileStorageRef.child(thisCoproperty);
    var editMode = "_edit";
        
    function emptyHTMLSet(set) {
      while(set.hasChildNodes()){
        set.removeChild(set.firstChild);
      };
    };

    elems = document.querySelectorAll('.sidenav');
    instances = M.Sidenav.init(elems);
    /*
    var collapsibleElem = document.querySelector('.collapsible');
    var collapsibleInstance = M.Collapsible.init(collapsibleElem);
    */
    var elems = document.querySelectorAll('.collapsible');
    var instances = M.Collapsible.init(elems);

    var PropType = {
      APART: 'apartment',
      GARAG: 'garage'
    };

    var TransTypeRead = {
      MAINT : 'repair maintenance',
      RENOV: 'installation renovation',
      INSUR: 'insurance building',
      SERVI: 'services',
      EQUIP: 'small equipment',
      ELECT: 'electricity',
      WATER: 'water',
      HEATI: 'heating',
      PRIVA: 'private',
      OWNER: 'owner payment',
      PROVI: 'payed with provision',
      TBSET: 'to be set'
    };

    var TransType = {
      MAINT : 'repair maintenance',
      RENOV: 'installation renovation',
      INSUR: 'insurance building',
      SERVI: 'services',
      EQUIP: 'small equipment',
      ELECT: 'electricity',
      WATER: 'water',
      HEATI: 'heating',
      PRIVA: 'private',
      OWNER: 'owner payment',
      PROVI: 'payed with provision'
    };
    function hasCostCenter(aTransType) {return ((aTransType != "") && (aTransType != "TBSET") && (aTransType != "PRIVA") && (aTransType != "OWNER") && (aTransType != "PROVI") )};
    function hasCounterparty(aTransType) {return ((aTransType != "") && (aTransType != "OWNER") )};

    var TransRuleType = {
      MAINT : 'Repair Maintenance',
      RENOV: 'Installation Renovation',
      INSUR: 'Insurance Building',
      SERVI: 'Services',
      EQUIP: 'Small Equipment',
      ELECT: 'Electricity',
      WATER: 'Water',
      HEATI: 'Heating',
      OWNER: 'Owner Payment',
      PROVI: 'Payed with Provision'
    };

    var MeterStatus = {
      ACTIF: 'Active',
      PASSI: 'Removed'
    };

    var MeterType = {
      COLWA: 'Cold Water',
      HOTWA: 'Hot Water',
      HEATI: 'Heating'
    };

    var ConsumptionTableType = {
      COLWA: 'CW',
      HOTWA: 'HW',
      HEATI: 'HE'
    };

    var HeaderIconType = {
      ADMIN: 'account_balance',
      MOVIN:  'local_shipping',
      WORKS: 'build',
      OTHER: 'info_outline'
    };

    var NotificationType = {
      ADMIN: 'Administration',
      MOVIN:  'Moving',
      WORKS: 'Works',
      OTHER: 'Other'
    };

    var ReportType = {
      GEASS: 'General Assembly',
      CHARR: 'Charges and consumption',
      CHARS: 'Charges',
      OTHER:  'Other'
    };

    var DocumentIcon = {
      GEASS: 'account_balance',
      INVOI: 'euro_symbol',
      QUOTE: 'content_paste',
      PAYRE: 'euro_symbol',
      PURRE: 'receipt',
      OTHER: 'import_contacts'
    };
    var DocumentType = {
      GEASS: 'General Assembly',
      INVOI: 'Invoice',
      QUOTE: 'Quote',
      PAYRE: 'Reminder',
      PURRE: 'Receipt',
      OTHER: 'Other'
    };

    var EvidenceType = {
      INVOI: 'Invoice',
      QUOTE: 'Quote',
      PAYRE: 'Payment Reminder',
      PURRE: 'Purchase Receipt',
      OTHER: 'Other'
    };

    var MemberType = {
      PERSO: 'Person',
      COMPA: 'Company'
    }

    function insertSelectOptions (elBeforeID, keyValuePairs, mandatory, defaultString, defaultKey) {
      // either defaulString or defaultKey should be nul
      var el = document.getElementById(elBeforeID);
      if (defaultString) {
        var defaultt = document.createElement("option");
        defaultt.setAttribute("value", "");
        if (mandatory){
          defaultt.setAttribute("disabled",true);
          defaultt.innerHTML = "Select " + defaultString + "<b><font color='red'>*</font></b>";}
        else {defaultt.innerHTML = "Select " + defaultString;};
        el.insertAdjacentElement('beforeend', defaultt);
      };
      Object.keys(keyValuePairs).forEach(function(key){
        var newEl = document.createElement("option");
        if (key == defaultKey) {newEl.setAttribute("selected", "");};
        newEl.setAttribute("value", key);
        newEl.innerHTML = keyValuePairs[key];
        el.insertAdjacentElement('beforeend', newEl);
      });
    };
    insertSelectOptions("property_type_add", PropType, true, "Type");
    insertSelectOptions("property_type_edit", PropType, true, "Type");
    insertSelectOptions("transaction_type_add", TransType, true, "Type");
    insertSelectOptions("transactionRule_type", TransRuleType, true, "Type");
    insertSelectOptions("transactionFilter_type", TransTypeRead, false, "Type");
    insertSelectOptions("meter_type", MeterType, true, "Type");
    insertSelectOptions("meter_status", MeterStatus, true, "", "ACTIF");
    insertSelectOptions("notification_type", NotificationType, true, "Type");
    insertSelectOptions("document_type", DocumentType, true, "Type");
    insertSelectOptions("documentFilter_type", DocumentType, false, "Type");
    insertSelectOptions("transactionEvidence_type", EvidenceType, true, "Type");
    insertSelectOptions("member_type_edit", MemberType, true, "", "PERSO");

    function initialiseForm() {
      var elems = document.querySelectorAll('select');
      M.FormSelect.init(elems);
      M.updateTextFields();
      elems = document.querySelectorAll('textarea');
      M.CharacterCounter.init(elems);
      elems = document.querySelectorAll('text');
      M.CharacterCounter.init(elems);
    };
    
    </script>
    <!--   Home scripts start here -->
    <script>
      var currentCoproperty;
      var currentCopropertyId;
      var chargesReports = null;
      var chargesReportsLoaded = false;
      function refreshHome(){
        refCoproperty.get().then(function(copropertyFS){
          currentCopropertyId = copropertyFS.id;
          currentCoproperty = copropertyFS.data();
          refreshCopropertyUpdateInfo();
          refreshCopropertyCostCentersUpdateInfo();
          emptyHTMLSet(document.getElementById("Home_CopropertyName"));
          var textN = document.createTextNode(currentCoproperty.name);
          document.getElementById("Home_CopropertyName").appendChild(textN);
          textN = document.createTextNode(currentCoproperty.street + " " + currentCoproperty.houseNumber + ", "+ currentCoproperty.zip + " " + currentCoproperty.town);
          emptyHTMLSet(document.getElementById("Home_CopropertyAddress"));
          document.getElementById("Home_CopropertyAddress").appendChild(textN);
          emptyHTMLSet(document.getElementById("Home_Account"));
          textN = document.createTextNode(currentCoproperty.account);
          document.getElementById("Home_Account").appendChild(textN);
          emptyHTMLSet(document.getElementById("home_administrator"));
          memberGet(currentCoproperty.administrator).then (function(a){
            document.getElementById("home_administrator").appendChild(memberLink(a));
            chargesReportsGet().then(function(cRs){
              readCloseAndReguDate(cRs);
            });
          });
        });
      };
      
      var homeLoaded = false;
      function loadHome() {
      loadAll().then(function(){
        hideMenu();
        document.getElementById("logo-container").innerHTML = "Home";
        if (!homeLoaded) {
          refreshNotifications();
          refreshHome();
          homeLoaded = true;
        };
      });
      };
    
      function checkBookDate (bookDate){
        if (bookDate.localeCompare(lastCloseDate) < 1) { return false} 
        else { return true};
      };

      var notifications = null;
      async function notificationsGet(){
        if (notifications) {return notifications;}
        else {
          var querySnapshot = await refCoproperty.collection("Notifications").orderBy("updatedOn").get();
          notifications = [];
          querySnapshot.forEach(function(objectFS) {
            var thisObject = objectFS.data();
            thisObject.idFS = objectFS.id;
            notifications.push(thisObject);
          });
          return notifications;
        };
      };

      var notificationsTable = document.getElementById("notificationsTable");
      function refreshNotifications() {
        emptyHTMLSet(notificationsTable);
        notifications = null;
        notificationsGet().then(function(objectsFSArray){
          objectsFSArray.forEach(function(thisObject){loadNotification(thisObject);});  
        }); 
          
      };

      function addLinebreaks (anyString) {return anyString.replaceAll("\n", "<br />\r\n");};

function loadNotification (n){
        var objectsRow= document.createElement('li');
        objectsRow.setAttribute("style","border-style:solid;border-color: darkgrey");
        var header = document.createElement('div');
        header.setAttribute("class","collapsible-header");
        var headerIcon = document.createElement('i');
        headerIcon.setAttribute("class","material-icons");
        headerIcon.innerHTML = HeaderIconType[n.type];
        header.appendChild(headerIcon);
        var title = document.createElement('span');
        title.innerHTML = n.title;
        header.appendChild (title);
        objectsRow.appendChild(header);
        var body= document.createElement('div');
        body.setAttribute("class","collapsible-body");
        var text = document.createElement('DIV');
        text.innerHTML = addLinebreaks(n.text) + "<br><b>Updated on: </b>" + n.updatedOn + "<br><b>Updated by: </b>";
        memberGet(n.editedBy).then (function(author){
          text.appendChild(memberLink(author));
          body.appendChild(text);
          var buttons = document.createElement('DIV');
        
          if ((currentUser.role == roleAdministrator) || (currentUser.id == n.editedBy)){
            var removeButton = document.createElement('button');
            removeButton.setAttribute('style','float: right;margin-bottom: 3px');
            removeButton.setAttribute('class','modal-trigger btn-floating waves-light red');
            removeButton.setAttribute("data-target", "notificationRemove");
            removeButton.setAttribute('onclick','popupRemoveNotification('+JSON.stringify(n)+')');
            var cellButtonIcon = document.createElement('i');
            cellButtonIcon.setAttribute('class','material-icons right');
            cellButtonIcon.innerHTML="delete";           
            removeButton.appendChild(cellButtonIcon);
            /*removeButton.innerHTML = "Remove";*/
            buttons.appendChild(removeButton);
            var editButton = document.createElement('button');
            editButton.setAttribute('style','float: right;margin-right: 5px;margin-bottom: 3px');
            editButton.setAttribute('class','modal-trigger btn-floating waves-light');
            editButton.setAttribute("data-target", "notificationEdit");
            editButton.setAttribute('onclick','selectNotification('+JSON.stringify(n)+')');
            cellButtonIcon = document.createElement('i');
            cellButtonIcon.setAttribute('class','material-icons right');
            cellButtonIcon.innerHTML="edit";           
            editButton.appendChild(cellButtonIcon);
            /*editButton.innerHTML = "Edit";*/
            buttons.appendChild(editButton);
            body.appendChild(buttons);
            var br = document.createElement('br');
            body.appendChild(br);
          };
          objectsRow.appendChild(body);
          notificationsTable.appendChild (objectsRow);
        })
      };
      
      
      
      function emptyNotificationFields(){
        selectNotification({idFS:null,type:"", title:"",text:""});
      };
      var notification;

      function popupRemoveNotification(n){notification=n;};
      function removeNotification(n) {
        refCoproperty.collection("Notifications").doc(notification.idFS).delete().then(function(){
          refreshNotifications();
          M.Modal.getInstance(document.getElementById("notificationRemove")).close();
        }).catch(function(error) {
            M.toast({html:"System error removing notification:" + error});
        });
      }

      function selectNotification(object){
        document.getElementById("notification_type").value=object.type;
        document.getElementById("notification_title").value=object.title;
        document.getElementById("notification_text").value=object.text;
        document.getElementById("notificationSubmitButton").disabled=false;
        notification = object;
        var elems = document.querySelectorAll('select');
        M.FormSelect.init(elems);
        M.updateTextFields();
        var elems = document.querySelectorAll('textarea');
        M.CharacterCounter.init(elems);
        var elems = document.querySelectorAll('text');
        M.CharacterCounter.init(elems);
        
        

      
      };

      function validateNotification(){
        var valid = true;
        if (!document.getElementById("notification_type").checkValidity()) {
          M.toast({html:"Please enter type"});
          valid=false;
        };
        if (!document.getElementById("notification_title").checkValidity()) {
          M.toast({html:"Please enter title"});
          valid=false;
        };
        if (!document.getElementById("notification_text").checkValidity()) {
          M.toast({html:"Please enter text"});
          valid=false;
        };
        if (!valid) {document.getElementById("notificationSubmitButton").disabled=false;};
        return valid;
      };

      function getNotificationEntries(){
        var d = new Date();
        return {
          type: document.getElementById("notification_type").value,
          title: document.getElementById("notification_title").value,
          text: document.getElementById("notification_text").value,
          updatedOn: d.toDateString(),
          editedBy: currentUser.id
        };
      };
      
      function writeNotification(){
        if (validateNotification()) {
          var entries =  getNotificationEntries(); 
          if (notification.idFS) {
            refCoproperty.collection("Notifications").doc(notification.idFS).set(entries).then(function(docref) {
              refreshNotifications();
              M.Modal.getInstance(document.getElementById("notificationEdit")).close();
            }).catch(function(error) {
              M.toast({html:"Error updating notification: " + error});
            });
          } else {
            refCoproperty.collection("Notifications").add(entries).then(function(docref) {
              refreshNotifications();
              M.Modal.getInstance(document.getElementById("notificationEdit")).close();
            }).catch(function(error) {
              M.toast({html:"Error adding notification: " + error});
            });
          };

        }
      };

    </script>
    <!--   Reports scripts start here -->
    <script>
    var transactionsLoaded = false;
    var lastCopropertySaldo;
    var lastOwnersSaldo;
  
    async function chargesReportsGet(){
      if (chargesReports) {return chargesReports}
      else {
        var querySnapshot = await refCoproperty.collection("ChargesReports").orderBy("endDate","desc").get();
        chargesReports = [];
        querySnapshot.forEach(function(objectFS) {
          var thisObject = objectFS.data();
          thisObject.idFS = objectFS.id;
          chargesReports.push(thisObject);
        });
        chargesReports.sort(function(a, b){
          if (b.endDate < a.endDate) {return -1;};
          if (b.endDate > a.endDate) {return 1;};
          return 0;
          });
        return chargesReports;
      };
    };

    function emptyFieldsChargesReportAdd() {
      document.getElementById("chargesReport_closeDate").value = "";
      document.getElementById("chargesReport_metersIncluded").value = "";
      document.getElementById("chargesReportSubmitButton").disabled=false;
      var elems = document.querySelectorAll('select');
      M.FormSelect.init(elems);
      M.updateTextFields();
    };
    
    function validateChargesReportAdd() {
        var valid = true
        if (!document.getElementById("chargesReport_closeDate").checkValidity()) {
          M.toast({html:"Please enter accountancy close date"});
          valid=false;
        } else {
          checkDate = checkBookDate(document.getElementById("chargesReport_closeDate").value);
          if (!checkBookDate(document.getElementById("chargesReport_closeDate").value)) {
            M.toast({html:"Accountancy close date must be later than last close date being " + lastCloseDate});
            valid=false;
          };
        };
        if (!valid) {
          document.getElementById("chargesReportSubmitButton").disabled=false;
        };
        return valid;
      };

      function prepareChargesReport() {
      if (validateChargesReportAdd()) {
        M.Modal.getInstance(document.getElementById("loading")).open();
        var metersIn = (document.getElementById("chargesReport_metersIncluded").value == "Yes");
        generateChargesReport(document.getElementById("chargesReport_closeDate").value, metersIn);
      };
    };

    var chargesReportsTable = document.getElementById("chargesReportsTable");
      
    function loadChargesReport (cR){
        if ((!cR.confirmed) && (currentUser.role != roleAdministrator)) {return};
        var objectsRow= document.createElement('tr');
        
        var cellDocLink = document.createElement("button");
        cellDocLink.setAttribute('style','border:none;background-color:Transparent');
        cellDocLink.setAttribute('class','modal-trigger');
        cellDocLink.setAttribute('data-target','fileShow');

        cellDocLink.innerHTML = "<font color='#0000FF'>" + cR.startDate + " - " +cR.endDate + "</font>";
        var cell = document.createElement('td');
        cell.appendChild(cellDocLink);
        objectsRow.appendChild(cell);
        
        if (cR.metersIncluded) {cellContent = document.createTextNode("Yes");}
        else {cellContent = document.createTextNode("No");};
        cell = document.createElement('td');
        cell.appendChild(cellContent);
        objectsRow.appendChild(cell);  
        var cellContent;
        if (!cR.confirmed) {
          cellContent = document.createElement('button');
          cellContent.setAttribute('class','btn-small waves-light');
          cellContent.setAttribute('onclick','popupChargesReportConfirmed('+JSON.stringify(cR.idFS)+')');
          var cellButtonIcon = document.createElement('i');
          cellButtonIcon.setAttribute('class','material-icons right');
          cellButtonIcon.innerHTML="verified_user";           
          cellContent.appendChild(cellButtonIcon);
          cellContent.innerHTML = "Confirm";

          cell = document.createElement('td');
          cell.appendChild(cellContent);
          objectsRow.appendChild(cell);  

          cellContent = document.createElement('button');
          cellContent.setAttribute('class','btn-small waves-light red');
          cellContent.setAttribute('onclick','popupChargesReportRemoved('+JSON.stringify(cR.idFS)+')');
          var cellButtonIcon = document.createElement('i');
          cellButtonIcon.setAttribute('class','material-icons right');
          cellButtonIcon.innerHTML="delete";           
          cellContent.appendChild(cellButtonIcon);
          cellContent.innerHTML = "Remove";

          cell = document.createElement('td');
          cell.appendChild(cellContent);
          objectsRow.appendChild(cell);   

          document.getElementById("ChargesReport_Generate").setAttribute("class", "btn-small waves-light modal-trigger disabled"); 
        };
        chargesReportsTable.appendChild(objectsRow);
        refCopropertyFiles.child("ChargesReports").child(cR.idFS).getDownloadURL().then(function(url) {
          cellDocLink.setAttribute('onclick','showFile('+JSON.stringify(url)+')');
        });
      };

      function readCloseAndReguDate (cRs) {
        if  (cRs.length > 0) {
              document.getElementById("initialSaldos_frame").style.display = "none";
              var lastReportData = cRs[0];
              lastCloseDate= lastReportData.endDate;
              lastCopropertySaldo = lastReportData.copropertySaldo;
              lastOwnersSaldo = lastReportData.ownersSaldo;
              var i = 0;
              while ((i < cRs.length) && (!cRs[i].metersIncluded)) {i = i+1};
              if (i < cRs.length) {lastReguDate = cRs[i].endDate}
              else {lastReguDate = currentCoproperty.initialStartDate};
            }
            else {
              lastCloseDate = currentCoproperty.initialStartDate;
              lastReguDate = currentCoproperty.initialStartDate;
              lastCopropertySaldo = currentCoproperty.initialSaldo;
              lastOwnersSaldo = currentCoproperty.initialSaldos;
              document.getElementById("initialSaldos_frame").style.display = "block";
            };
      };

      function refreshChargesReports(){
        emptyHTMLSet(chargesReportsTable);
        chargesReports = null;
        chargesReportsGet().then(function(cRs){
          if (cRs.length) {
            document.getElementById("chargesTable_frame").style.display = "block";
            document.getElementById("charges_absentPhrase").style.display = "none";
            readCloseAndReguDate (cRs);
            var i = 0;
            while (i<cRs.length){
              loadChargesReport(cRs[i]);
              i += 1;
            };
          } else {
            readCloseAndReguDate (cRs);
            document.getElementById("chargesTable_frame").style.display = "none";
            document.getElementById("charges_absentPhrase").style.display = "block";
          };
          meterReadingsLoaded = false;
          transactionsLoaded = false;
          });
      };

      var chargesReportsLoaded = false;
      function loadChargesReports() {
      loadAll().then(function(){
        hideMenu();
        document.getElementById("logo-container").innerHTML = "Charges";
        if (!chargesReportsLoaded) {
              refreshChargesReports();
              chargesReportsLoaded = true;
            };
      });
      };

      function popupChargesReportConfirmed(chargesReportId) {
        refCoproperty.collection("ChargesReports").doc(chargesReportId).update({confirmed:true}).then(function(){
          refreshChargesReports();
          document.getElementById("ChargesReport_Generate").setAttribute("class", "btn-small waves-light modal-trigger");
          M.toast({html:"Charges report now visible to owners"});
        }).catch(function(error) {
          M.toast({html:"Error confirming charges report: " + error});
        });
      };

      function popupChargesReportRemoved(chargesReportId) {
        refCoproperty.collection("ChargesReports").doc(chargesReportId).delete().then(function(){
          refCopropertyFiles.child("ChargesReports").child(chargesReportId).delete().then({});
          refreshChargesReports();
          document.getElementById("ChargesReport_Generate").setAttribute("class", "btn-small waves-light modal-trigger");
          M.toast({html:"Charges report removed: correct your data and generate a new charges report anytime"});
        }).catch(function(error) {
          M.toast({html:"Error removing charges report: " + error});
        });
      };

    </script>
    <!-- Documents scripts start here-->
    <script>
    function showFile(url) {
          window.open(url,"_blank");
    };
    
    var documents = null;
    var documentsLoaded = false;
    var paper;
    var documentFile;
    var lastVisibleDocument;
    var documentValueFilter = {};
    var documentSubStringFilter = {};
    var documentFilterOnUpdateDate="";
      

    async function documentsGet(){
      if (documents) {return documents;}
      else {
        var querySnapshot = await refCoproperty.collection("Documents").where("before","!=","").orderBy("before","asc").get();
        documents = [];
        querySnapshot.forEach(function(objectFS) {
          var thisObject = objectFS.data();
          thisObject.idFS = objectFS.id;
          documents.push(thisObject);
        });
        var documentsFirstBatch = await documentsGetNext();
        return {objects:documents, lastFSObject:documentsFirstBatch.lastFSObject};
      };
    };

    async function documentsGetNext(lVD){
      var refFS = refCoproperty.collection("Documents").where("before","==","").orderBy("updatedOn","desc");
      if (lVD){refFS = refFS.startAfter(lVD)};
      var lBL;
      if ((Object.keys(documentValueFilter).length + Object.keys(documentSubStringFilter).length) == 0) {lBL = loadBatchLength}
      else {lBL =loadBatchLength*5};
      refFS = refFS.limit(lBL);
      objectsFSArray = await refFS.get();
      /*querySnapshot = await refCoproperty.collection("Documents").where("before","==","").orderBy("updatedOn","desc").limit(loadBatchLength).get();*/
      var documentsExtra = [];
      objectsFSArray.forEach(function(objectFS) {
        var thisObject = objectFS.data();
        thisObject.idFS = objectFS.id;
        documentsExtra.push(thisObject);
      });
      documents = documents.concat(documentsExtra);
      var newLVD;
      if (objectsFSArray.docs.length) {newLVD = objectsFSArray.docs[objectsFSArray.docs.length-1]};
      return {objects:documentsExtra,lastFSObject:newLVD};
    };

    var documentsList = document.getElementById("documentsList");

    function prepareSetDocumentFilter(){
      if (documentFilterOnUpdateDate) {document.getElementById("documentFilter_updateDate").value=documentFilterOnUpdateDate;}
      else {document.getElementById("documentFilter_updateDate").value="";};
      if (documentValueFilter.type) {document.getElementById("documentFilter_type").value=documentValueFilter.type;}
      else {document.getElementById("documentFilter_type").value="";};
      if (documentSubStringFilter.counterparty){ 
        document.getElementById("documentFilter_counterparty").value=documentSubStringFilter.counterparty;
      } else {document.getElementById("documentFilter_counterparty").value="";};
      initialiseForm();
    };

    function setDocumentFilter(){
          documentValueFilter = {};
          documentSubStringFilter = {};
          documentFilterOnUpdateDate = "";
          var filterSet=false;
          var x = document.getElementById("documentFilter_updateDate").value;
          if (x) {
            documentFilterOnUpdateDate = x;
            filterSet=true;
          };
          x = document.getElementById("documentFilter_type").value;
          if (x) {
            documentValueFilter.type = x;
            filterSet=true;
          };
          x = document.getElementById("documentFilter_counterparty").value;
          if (x) {
            documentSubStringFilter.counterparty = x;
            filterSet=true;
          };
          if (filterSet) {
            document.getElementById("documents_filterOn").style.display="block";
            document.getElementById("documents_filterOff").style.display="none";
            document.getElementById("documentsFromTrEvidence_filterOn").style.display="block";
            document.getElementById("documentsFromTrEvidence_filterOff").style.display="none";}
          else {
            document.getElementById("documents_filterOn").style.display="none";
            document.getElementById("documents_filterOff").style.display="block";
            document.getElementById("documentsFromTrEvidence_filterOn").style.display="block";
            document.getElementById("documentsFromTrEvidence_filterOff").style.display="none";
          };
          refreshDocuments();
          M.Modal.getInstance(document.getElementById("documentFilter")).close();
        };

    function documentsEndOfBatch(objectsBatch){
      var lBL;
      if ((Object.keys(documentValueFilter).length + Object.keys(documentSubStringFilter).length) == 0) {lBL = loadBatchLength}
      else {lBL =loadBatchLength*5};
      if (objectsBatch.objects.length < lBL){
        document.getElementById("documents_more").style.display = "none";
        document.getElementById("transactionEvidenceLink_more").style.display = "none";
        document.getElementById("documents_noMore").style.display = "block";
      } else {
        document.getElementById("documents_more").style.display = "block";
        document.getElementById("transactionEvidenceLink_more").style.display = "block";
        document.getElementById("documents_noMore").style.display = "none";
      };
    };
    
    function nextBatchDocuments(lVD) {
      documentsGetNext(lVD).then(function(nextBatch){
        lastVisibleDocument = nextBatch.lastFSObject;
        if (nextBatch.objects.length){
          nextBatch.objects.forEach(function(object){loadDocument(object);});
          documentsEndOfBatch(nextBatch);
          initialiseForm();
        } else {
          document.getElementById("documents_more").style.display = "none";
          document.getElementById("transactionEvidenceLink_more").style.display = "none";
          document.getElementById("documents_noMore").style.display = "block";
        };
      })
    };

    function refreshDocuments(){
      emptyHTMLSet(documentsList);
      emptyHTMLSet(transactionEvidenceLinkOptionEl);
      documents = null;
      documentsGet().then(function(objectsBatch){
        lastVisibleDocument = objectsBatch.lastFSObject;
        if (objectsBatch.objects.length){
          document.getElementById("documentsList").style.display = "block";
          document.getElementById("documents_absentPhrase").style.display = "none";
          objectsBatch.objects.forEach(function(d){loadDocument(d);});
          documentsEndOfBatch(objectsBatch);
          initialiseForm();
        } else {
          document.getElementById("documents_more").style.display = "none";
          document.getElementById("documents_noMore").style.display = "none";
          document.getElementById("documentsList").style.display = "none";
          document.getElementById("documents_absentPhrase").style.display = "block";
        };
      });
    };

    function loadDocument(d){
      if (passFilter(documentValueFilter, documentSubStringFilter, d)) {
      addEvidenceLinkOption(d);  
      var objectsRow= document.createElement('li');
      objectsRow.setAttribute("style","border-style:solid;border-color: darkgrey");
      var header = document.createElement('div');
      var headerIcon = document.createElement('i');
      headerIcon.setAttribute("class","material-icons");
      headerIcon.innerHTML = DocumentIcon[d.type];
      header.appendChild(headerIcon);
      header.setAttribute("class","collapsible-header");
      var title = document.createElement('div');
      title.setAttribute("style","text-align:center");
      if (d.type == "GEASS") {title.innerHTML = "";}
      else {title.innerHTML = (d.counterparty).substr(0,20);};
      var titleLeft = document.createElement('span');
      /*titleLeft.setAttribute("style","float:left;font-family:'Lucida Console'; monospace");*/
      titleLeft.setAttribute("style","float:left;margin-rigth: 25%");
      if (d.type != "OTHER"){
        /*titleLeft.innerHTML = ((DocumentType[d.type]) + '&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;').substr(0,8);*/
        titleLeft.innerHTML = DocumentType[d.type];
      }
      else {titleLeft.innerHTML = d.freeType };
      title.appendChild(titleLeft);
      var titleRight = document.createElement('span');
      titleRight.setAttribute("style","float:right");
      var body= document.createElement('div');
      body.setAttribute("style","position: relative");
      
      var bodyText = document.createElement('div');
      bodyText.setAttribute("style","margin-top: 0px");
      var bodyRight = document.createElement('span');
      bodyRight.setAttribute("style","float:right");
      if ((d.type != "GEASS")&&(d.before)){
        titleRight.innerHTML = "<font color='red'>" + d.before+"</font>";
        bodyRight.innerHTML = "<font color='red'>" +"Act Before: " + d.before+ "</font>";
        bodyText.appendChild(bodyRight);
        bodyText.appendChild(document.createElement('br'));
        bodyRight = document.createElement('span');
        bodyRight.setAttribute("style","float:right");
        bodyRight.innerHTML = "updated:" +d.updatedOn;
        bodyText.appendChild(bodyRight);
        body.appendChild(bodyText);
        body.appendChild(document.createElement('br'));
      } else {titleRight.innerHTML = d.updatedOn};
      title.appendChild(titleRight);
      header.appendChild (title);
      objectsRow.appendChild(header);
      body.setAttribute("class","collapsible-body");
      if (d.comment){
        var commentDiv = document.createElement('div');
        commentDiv.setAttribute("style","margin-top: 0px; margin-bottom : 20px");
        var commentEl= document.createTextNode("comment: "+d.comment);
        commentDiv.appendChild(commentEl);
        body.appendChild(commentDiv);
      };
      if (currentUser.role == roleAdministrator) {
          
        var removeButton = document.createElement('button');
        removeButton.setAttribute('style','float: right;margin-bottom: 3px');
        removeButton.setAttribute('class','btn-floating waves-light red');
        removeButton.setAttribute('onclick','prepareRemoveDocument('+JSON.stringify(d)+')');
        var cellButtonIcon = document.createElement('i');
        cellButtonIcon.setAttribute('class','material-icons right');
        cellButtonIcon.innerHTML="delete";           
        removeButton.appendChild(cellButtonIcon);
        body.appendChild(removeButton);
          
        var editButton = document.createElement('button');
        editButton.setAttribute('style','float: right;margin-right: 5px');
        editButton.setAttribute('class','modal-trigger btn-floating waves-light');
        editButton.setAttribute("data-target", "documentEdit");
        editButton.setAttribute('onclick','selectDocument('+JSON.stringify(d)+')');
        cellButtonIcon = document.createElement('i');
        cellButtonIcon.setAttribute('class','material-icons right');
        cellButtonIcon.innerHTML="edit";           
        editButton.appendChild(cellButtonIcon);
        body.appendChild(editButton);
      };
      var getFileButton = document.createElement("button");
      getFileButton.setAttribute('class','btn-small waves-light');
      getFileButton.setAttribute('style','margin-right:5px');
      getFileButton.innerHTML = "DownLoad";
      var icon = document.createElement('i');
      icon.setAttribute("class","material-icons right");
      icon.innerHTML = "file_download";
      getFileButton.appendChild(icon);
      body.appendChild(getFileButton);
      if (d.link) {
        var getTransactionButton = document.createElement("button");
        getTransactionButton.setAttribute('class','btn-small waves-light modal-trigger');
        getTransactionButton.setAttribute('data-target','transactionView');
        
        getFileButton.setAttribute('style','margin-bottom:5px;margin-right:5px');
        getTransactionButton.setAttribute('style','margin-bottom:5px');
        getTransactionButton.setAttribute('onclick','setSelectedTransactionById('+JSON.stringify(d.link)+')');
        getTransactionButton.innerHTML = "Linked Transaction";
        var icon = document.createElement('i');
        icon.setAttribute("class","material-icons right");
        icon.innerHTML = "link";
        getTransactionButton.appendChild(icon);
        body.appendChild(getTransactionButton);
      };
      
      
      var updatedFooter = document.createElement('div');
      var footer = document.createElement('p');
      footer.setAttribute("style","font-size:12px");
      footer.innerHTML = "Updated On: " + d.updatedOn;
      updatedFooter.appendChild(footer);
      footer = document.createElement('p');
      footer.setAttribute("style","font-size:12px");
      footer.innerHTML = "Updated By: ";
      updatedFooter.appendChild(footer);
      body.appendChild(updatedFooter);
      objectsRow.appendChild(body);
      documentsList.appendChild (objectsRow);
      memberGet(d.updatedBy).then(function(author){
        footer.appendChild(memberLink(author));
        refCopropertyFiles.child("Documents").child(d.idFS).getDownloadURL().then(function(url) {
          getFileButton.setAttribute('onclick','showFile('+JSON.stringify(url)+')');
        });
      });
    };
    };

    function loadDocuments(){
    loadAll().then(function(){
      hideMenu();
      document.getElementById("logo-container").innerHTML = "Documents";
      if (!documentsLoaded) {
        refreshDocuments();
        documentsLoaded = true;
      };
    });
    };
    
    function prepareRemoveDocument(d) {
      if (d.link){
        M.toast({html:"Remove link or document from within linked transaction"});
      } else {
        paper=d;
        M.Modal.getInstance(document.getElementById("documentRemove")).open();
      }
    }

    function popupRemoveDocument(d){paper=d;};
    function removeDocument(){
      refCoproperty.collection("Documents").doc(paper.idFS).delete().then(function(){
        refreshDocuments();
        var fileRef = refCopropertyFiles.child("Documents").child(paper.idFS);
        fileRef.delete().then(function() {
        }).catch(function(error) {
          M.toast({html:"System error removing report file:" + error});           
        });
        M.Modal.getInstance(document.getElementById("documentRemove")).close();
      }).catch(function(error) {
          M.toast({html:"System error removing document:" + error});
      });
    };
    
    function newEmptyDocumentFields(){
      return {
        type: "",
        counterparty: "",
        before: "",
        link:"",
        freeType:"",
        updatedOn:"",
        comment: "",
        idFS:null
        };
    };
    
    function resetDocument(){
      selectDocument(newEmptyDocumentFields());
    };

    function selectDocument(object) {
      paper = object;
      document.getElementById("document_type").value=object.type;
      document.getElementById("document_counterparty").value=object.counterparty;
      document.getElementById("document_before").value=object.before;
      document.getElementById("document_freeType").value=object.freeType;
      document.getElementById("document_comment").value=object.comment;
      document.getElementById("documentFile").value="";
      documentFile =null;
      document.getElementById("documentFileText").value="";
      /*listTransactions(document.getElementById("document_link"),object.link)*/
      toggleDocument();
      document.getElementById("documentSubmitButton").disabled=false;
      var elems = document.querySelectorAll('select');
      M.FormSelect.init(elems);
      M.updateTextFields();
      var elems = document.querySelectorAll('textarea');
        M.CharacterCounter.init(elems);
        
    };

    function toggleDocument(){
      var typeElement = document.getElementById("document_type");
      /*
      if (["INVOI", "QUOTE","PAYRE"].includes(typeElement.value)) {
        document.getElementById("document_link_field").style.display = "block";
      } else {
        document.getElementById("document_link_field").style.display = "none";
      };*/
      if (typeElement.value == "OTHER") {
        document.getElementById("document_freeType_field").style.display = "block";
      } else {
        document.getElementById("document_freeType_field").style.display = "none";
      };
      if ((typeElement.value) && (typeElement.value != "GEASS"))  {
        document.getElementById("document_before_field").style.display = "block";
        document.getElementById("document_counterparty_field").style.display = "block";
      } else {
        document.getElementById("document_before_field").style.display = "none";
        document.getElementById("document_counterparty_field").style.display = "none";
      };
      var dUBL = document.getElementById("documentUploadButtonLabel");
      if (paper.idFS){dUBL.innerHTML = "option: replace PDF file with"}
      else {dUBL.innerHTML = "File<b><font color='red'>*</font></b>"};
    };

    function validateDocument(){
      var valid = true;
      if (!document.getElementById("document_type").checkValidity()) {
        M.toast({html:"Please enter type"});
        valid=false;
      };
      if (!document.getElementById("document_counterparty").checkValidity()) {
        M.toast({html:"Please enter counter party"});
        valid=false;
      };
      if (!document.getElementById("document_before").checkValidity()) {
        M.toast({html:"Please enter valid reminder date"});
        valid=false;
      };
      if (!document.getElementById("document_freeType").checkValidity()) {
        M.toast({html:"Please enter valid free text type"});
        valid=false;
      };
      if (!document.getElementById("document_comment").checkValidity()) {
        M.toast({html:"Please enter valid comment"});
        valid=false;
      };
      var typeElement = document.getElementById("document_type");
      if ((typeElement.value == "OTHER") && (!document.getElementById("document_freeType").value)){
        M.toast({html:"when Type = Other, Free text type is required"});
        valid=false;
      };
      if ((typeElement.value != "") && (typeElement.value != "GEASS") && (!document.getElementById("document_counterparty").value)){
        M.toast({html:"Please enter counterparty"});
        valid=false;
      };
      documentFile = document.getElementById('documentFile').files[0];
      if ((!paper.idFS) && (!documentFile)) {
        M.toast({html:"Please select file"});
        valid=false;
      } else if (documentFile){
        let allowed_mime_types = ['application/pdf','image/jpeg', 'image/png'];
        let allowed_size_kb = 5000;
        if(allowed_mime_types.indexOf(documentFile.type) == -1) {
            M.toast({html:"Incorrect file type (only pdf, jpeg or png files allowed)"});
            valid=false;
          };
        if(documentFile.size > allowed_size_kb*1024) {
          M.toast({html:"File exceeds max size 500KB"});
          valid=false;
        };
      };
      if(!valid) {
        document.getElementById("documentSubmitButton").disabled=false;
      };
      return valid;
    };
    
    function getToDaysDate(){
      var d = new Date(); 
      return (d.getFullYear()+"-"+(d.getMonth()+1)+"-"+d.getDate());
    };
    
    function getDocumentEntries(){
      var thisType = document.getElementById("document_type").value;
      var thisBefore;
      if (thisType == "GEASS"){thisBefore = ""}
      else {thisBefore = document.getElementById("document_before").value};
      return Object.assign({
        type: thisType,
        counterparty: document.getElementById("document_counterparty").value,
        before: thisBefore,
        link: paper.link, /*document.getElementById("document_link").value,*/
        freeType: document.getElementById("document_freeType").value,
        comment: document.getElementById("document_comment").value
      },getUpdateInfo());
    };
    
    function writeDocument(){
      if (validateDocument()) { 
        M.Modal.getInstance(document.getElementById("loading")).open();
        var entries =  getDocumentEntries();
        if (paper.idFS) {
          refCoproperty.collection("Documents").doc(paper.idFS).set(entries).then(function() {
            if (documentFile) {
              var fileRef = refCopropertyFiles.child("Documents").child(paper.idFS); 
              fileRef.put(documentFile).then (function (){
                refreshDocuments();
                M.Modal.getInstance(document.getElementById("loading")).close();
                M.Modal.getInstance(document.getElementById("documentEdit")).close();
              }).catch(function(error) {
                M.Modal.getInstance(document.getElementById("loading")).close();
                M.toast({html:"Error updating file: " + error});
              });
            } else {
              refreshDocuments();
              M.Modal.getInstance(document.getElementById("loading")).close();
              M.Modal.getInstance(document.getElementById("documentEdit")).close();
            };
          });
        } else {
          refCoproperty.collection("Documents").add(entries).then(function(docref) {
            var fileRef = refCopropertyFiles.child("Documents").child(docref.id); 
            fileRef.put(documentFile).then (function (){
              refreshDocuments();
              M.Modal.getInstance(document.getElementById("loading")).close();
              M.Modal.getInstance(document.getElementById("documentEdit")).close();
            }).catch(function(error) {
              M.Modal.getInstance(document.getElementById("loading")).close();
              M.toast({html:"Error adding document: " + error});
            });
          });
        };
      };
    };

    
    
   </script>
    <!--   Transaction scripts start here -->
    <script>
      var transactionsTable = document.getElementById("transactionsTable");
      var distributedAmount = 0;
      var selectedTransactionId;
      var lastVisibleTransaction;
      var transactionValueFilter = {};
      var transactionSubStringFilter = {};
      var transactionFilterOnBookDate="";
      var transaction;
      function TransactionObject() {
        this.type = "";
        this.costCenter="";
        this.account = "";
        this.name = "";
        this.amount = "";
        this.date = "";
        this.bookDate = "";
        this.communication = "";
        this.owner = "";
        this.distribution= [];
        this.evidence = [];
        this.updatedOn = "";
        this.updatedBy = "";
      };

      function loadTransaction (objectFS){
        var object = objectFS.data();
        if (passFilter(transactionValueFilter, transactionSubStringFilter, object)) {
        var objectsRow= document.createElement('tr');
        
        var viewButton = document.createElement('button');
        viewButton.setAttribute("data-target", "transactionView");
        viewButton.setAttribute('class','modal-trigger');
        viewButton.setAttribute('style','border:none;background-color:Transparent');
        viewButton.setAttribute('onclick','setSelectedTransaction('+JSON.stringify(objectFS.id)+','+JSON.stringify(object)+')');
        var cellButtonIcon = document.createElement('i');
        cellButtonIcon.setAttribute('class','material-icons right');
        cellButtonIcon.innerHTML="add";           
        viewButton.appendChild(cellButtonIcon);
        
        var cell = document.createElement('td');
        cell.appendChild(viewButton);
        objectsRow.appendChild(cell);   

        var amount = object.amount;
        var cellContent = document.createTextNode(amount.toLocaleString("nl-BE", currencyStyle));
        cell = document.createElement('td');
        cell.appendChild(cellContent);
        objectsRow.appendChild(cell);  
        
        cellContent = document.createTextNode(object.bookDate);
        cell = document.createElement('td');
        cell.appendChild(cellContent);
        objectsRow.appendChild(cell); 
        
        cell = document.createElement('td');
        cell.setAttribute("align","center");
        if (object.type !="TBSET") {
            cellContent = document.createElement("i");
            cellContent.setAttribute("class","material-icons  green ");
            cellContent.innerHTML = "done";
          } else {
            cellContent = document.createElement("i");
            cellContent.setAttribute("class","material-icons  red ");
            cellContent.innerHTML = "clear";
          };
        cell.appendChild(cellContent);
        objectsRow.appendChild(cell); 

        refCoproperty.collection("Documents").where("link","==",objectFS.id).get().then(function(objectsFSArray){
          if (objectsFSArray.docs.length > 0) {
            cellContent = document.createElement("i");
            cellContent.setAttribute("class","material-icons  green ");
            cellContent.innerHTML = "done";
          } else {
            cellContent = document.createElement("i");
            cellContent.setAttribute("class","material-icons  red ");
            cellContent.innerHTML = "clear";
          };
          cell = document.createElement('td');
          cell.setAttribute("align","center");
          cell.appendChild(cellContent);
          objectsRow.appendChild(cell);
        
          transactionsTable.appendChild (objectsRow);

          if (object.type == "OWNER") {
            memberGet(object.owner).then (function(m){
              viewButton.innerHTML = "<font color='blue'>" + denomination(m) + "</font>";
            });
          } else {
            viewButton.innerHTML = "<font color='blue'>" + object.name + "</font>";
          };

        });
        }; 
      };
          
      function passFilter (aValueFilter, aSubStringFilter, anObject)  {
        var pass = true;
        var filterFields =  Object.keys(aValueFilter);
        for (let i = 0; i < filterFields.length; i++) {
          var field = filterFields[i];
          if (aValueFilter[field] != anObject[field]){
            pass = false;
            break;
          };
        };
        filterFields =  Object.keys(aSubStringFilter);
        for (let i = 0; i < filterFields.length; i++) {
          var field = filterFields[i];
          if (!anObject[field].includes(aSubStringFilter[field])){
            pass = false;
            break;
          };
        };
        return pass;
      };
  
      function refreshTransactions(){
          emptyHTMLSet(transactionsTable);
          var lBL;
          if ((Object.keys(transactionValueFilter).length + Object.keys(transactionSubStringFilter).length) == 0) {lBL = loadBatchLength}
          else {lBL =loadBatchLength*5};
          var thisRefFS = refCoproperty.collection("Transactions");
          if (transactionFilterOnBookDate){thisRefFS = thisRefFS.where("bookDate","<=",transactionFilterOnBookDate)};
          thisRefFS.orderBy("bookDate","desc").limit(lBL).get().then(function(objectsFSArray){
            if (objectsFSArray.docs.length){
              lastVisibleTransaction = objectsFSArray.docs[objectsFSArray.docs.length-1];
              document.getElementById("transactionsTable_frame").style.display = "block";
              document.getElementById("transactions_absentPhrase").style.display = "none";
              objectsFSArray.forEach(function(objectFS){loadTransaction(objectFS);});
              if (objectsFSArray.docs.length < lBL){
                document.getElementById("transactions_more").style.display = "none";
                document.getElementById("transactions_noMore").style.display = "block";
              } else {
                document.getElementById("transactions_more").style.display = "block";
                document.getElementById("transactions_noMore").style.display = "none";
              };
            } else {
              document.getElementById("transactionsTable_frame").style.display = "none";
              document.getElementById("transactions_absentPhrase").style.display = "block";
            };
          });
        };

        function nextBatchTransactions() {
          var lBL;
          if ((Object.keys(transactionValueFilter).length + Object.keys(transactionSubStringFilter).length) == 0) {lBL = loadBatchLength}
          else {lBL =loadBatchLength*5};
          refCoproperty.collection("Transactions").orderBy("bookDate","desc").startAfter(lastVisibleTransaction).limit(lBL).get().then(function(objectsFSArray){
            if (objectsFSArray.docs.length){
              lastVisibleTransaction = objectsFSArray.docs[objectsFSArray.docs.length-1];
              objectsFSArray.forEach(function(objectFS){loadTransaction(objectFS);});
              if (objectsFSArray.docs.length < lBL){
                document.getElementById("transactions_more").style.display = "none";
                document.getElementById("transactions_noMore").style.display = "block";
              } else {
                document.getElementById("transactions_more").style.display = "block";
                document.getElementById("transactions_noMore").style.display = "none";
              };
            } else {
              document.getElementById("transactions_more").style.display = "none";
              document.getElementById("transactions_noMore").style.display = "block";
            };
          });
        };

        function prepareSetTransactionFilter(){
          if (transactionFilterOnBookDate) {document.getElementById("transactionFilter_bookDate").value=transactionFilterOnBookDate;}
          else {document.getElementById("transactionFilter_bookDate").value="";}
          if (transactionValueFilter.type) {document.getElementById("transactionFilter_type").value=transactionValueFilter.type;}
          else {document.getElementById("transactionFilter_type").value="";}
          if (transactionValueFilter.costCenter){ 
            listCostCenters(document.getElementById("transactionFilter_costCenter"), false, transactionValueFilter.costCenter);
          } else {listCostCenters(document.getElementById("transactionFilter_costCenter"), false, "");};
          if (transactionValueFilter.owner){ 
            listOwners(document.getElementById("transactionFilter_owner"), transactionValueFilter.owner, false);
          } else {listOwners(document.getElementById("transactionFilter_owner"), "", false);};
          if (transactionSubStringFilter.name){ 
            document.getElementById("transactionFilter_name").value=transactionSubStringFilter.name;
          } else {document.getElementById("transactionFilter_name").value="";};
          initialiseForm();
        };

        function setTransactionFilter(){
          transactionValueFilter = {};
          transactionSubStringFilter = {};
          transactionFilterOnBookDate = "";
          var filterSet=false;
          var x = document.getElementById("transactionFilter_bookDate").value;
          if (x) {
            transactionFilterOnBookDate = x;
            filterSet=true;
          };
          x = document.getElementById("transactionFilter_type").value;
          if (x) {
            transactionValueFilter.type = x;
            filterSet=true;
          };
          x = document.getElementById("transactionFilter_costCenter").value;
          if (x) {
            transactionValueFilter.costCenter = x;
            filterSet=true;
          };
          x = document.getElementById("transactionFilter_owner").value;
          if (x) {
            transactionValueFilter.owner = x;
            filterSet=true;
          };
          x = document.getElementById("transactionFilter_name").value;
          if (x) {
            transactionSubStringFilter.name = x;
            filterSet=true;
          };
          if (filterSet) {
            document.getElementById("transactions_filterOn").style.display="block";
            document.getElementById("transactions_filterOff").style.display="none";
          }
          else {
            document.getElementById("transactions_filterOn").style.display="none";
            document.getElementById("transactions_filterOff").style.display="block";};
          refreshTransactions();
          M.Modal.getInstance(document.getElementById("transactionFilter")).close();
        };

        function loadTransactions(){
        loadAll().then(function(){
          hideMenu();
          document.getElementById("logo-container").innerHTML = "Transactions";
          if (!transactionsLoaded) {
            refreshDocuments();refreshTransactions();
            transactionsLoaded = true;
            
          };
        });
        };
      
      function writeTransaction() {
        if (validateTransactionAdd()) { 
          var entries =  getTransactionEntriesAdd();
          if (entries.type == "PRIVA") {entries.distribution = transaction.distribution;};
          if (selectedTransactionId) {
            refCoproperty.collection("Transactions").doc(selectedTransactionId).set(entries).then(function(docref) {
              refreshTransactions();
              setSelectedTransaction(selectedTransactionId,entries)
              M.Modal.getInstance(document.getElementById("transactionAdd")).close();
            }).catch(function(error) {
              M.toast({html:"Error updating transaction: " + error});
            });
          } else {
            refCoproperty.collection("Transactions").add(entries).then(function(docref) {
              refreshTransactions();
              setSelectedTransaction(docref.id,entries);
              M.Modal.getInstance(document.getElementById("transactionAdd")).close();
              M.Modal.getInstance(document.getElementById("transactionView")).open();
            }).catch(function(error) {
              M.toast({html:"Error adding transaction: " + error});
            });
          };
        };
      };
            
    function copyToBookDate(){
      if (!document.getElementById("transaction_bookDate_add").checkValidity()) {
        document.getElementById("transaction_bookDate_add").value = document.getElementById("transaction_date_add").value;
        M.updateTextFields();
      };
    };
    
    function validateTransactionAdd() {
      var valid = true;
      if (!document.getElementById("transaction_type_add").checkValidity()) {
        M.toast({html:"Please enter type"});
        valid=false;
      };
      if (!document.getElementById("transaction_costCenter_add").checkValidity()) {
        M.toast({html:"Please enter cost center"});
        valid=false;
      };
      if ((hasCostCenter(document.getElementById("transaction_type_add").value)) && (!document.getElementById("transaction_costCenter_add").value)) {
        M.toast({html:"Please enter cost center"});
        valid=false;
      };
      if (!document.getElementById("transaction_account_add").checkValidity()) {
        M.toast({html:"Please enter valid account"});
        valid=false;
      };
      if (!document.getElementById("transaction_name_add").checkValidity()) {
        M.toast({html:"Please enter counter party"});
        valid=false;
      };
      if ((hasCounterparty(document.getElementById("transaction_type_add").value)) && (!document.getElementById("transaction_name_add").value)) {
        M.toast({html:"Please enter counterparty"});
        valid=false;
      };
      if (!document.getElementById("transaction_amount_add").checkValidity()) {
        M.toast({html:"Please enter amount"});
        valid=false;
      };
      if (!document.getElementById("transaction_date_add").checkValidity()) {
        M.toast({html:"Please enter transaction date"});
        valid=false;
      };
      if (!document.getElementById("transaction_bookDate_add").checkValidity()) {
        M.toast({html:"Please enter accountancy date"});
        valid=false;
      }else if (!checkBookDate(document.getElementById("transaction_bookDate_add").value)) {
          M.toast({html:"Accountancy date must be after last close data accountancy"});
          valid=false;
      };
      if (!document.getElementById("transaction_communication_add").checkValidity()) {
        M.toast({html:"Please enter valid communication"});
        valid=false;
      };
      if (!document.getElementById("transaction_owner_add").checkValidity()) {
        M.toast({html:"Please enter valid owner"});
        valid=false;
      };
      if ((document.getElementById("transaction_type_add").value == "OWNER") && (!document.getElementById("transaction_owner_add").value)) {
        M.toast({html:"Please enter owner"});
        valid=false;
      };
      if (document.getElementById("transaction_type_add").value == "PRIVA") {
        var amount = parseFloat(document.getElementById("transaction_amount_add").value);
        if (!(((amount >= distributedAmount) && ((amount - distributedAmount) < 0.05)) ||  ((amount <= distributedAmount) && ((distributedAmount - amount) < 0.05)))) {
          M.toast({html:"Transactaction amount too differnt from total assigned amounts: please correct"});
          valid=false;
        };
      };
      if (!valid) {document.getElementById("transaction_save_button").disabled=false;};
      return valid;
    };
    
    function getTransactionEntriesAdd() {
      var result = Object.assign({
        type: document.getElementById("transaction_type_add").value,
        costCenter:document.getElementById("transaction_costCenter_add").value,
        account: document.getElementById("transaction_account_add").value,
        name: document.getElementById("transaction_name_add").value,
        amount: Number(document.getElementById("transaction_amount_add").value),
        date: document.getElementById("transaction_date_add").value,
        communication: document.getElementById("transaction_communication_add").value,
        bookDate: document.getElementById("transaction_bookDate_add").value,
        owner: document.getElementById("transaction_owner_add").value,
      }, getUpdateInfo());
      if (!hasCostCenter(result.type)) { result.costCenter = ""};
      if (result.type == "OWNER") {
        memberGet(result.owner).then(function(m){result.name = denomination(m);});
      } else {result.owner = ""}
      return result;
    };
    
    function setSelectedTransactionById(id){
      refCoproperty.collection("Transactions").doc(id).get().then(function(trFS){setSelectedTransaction(id,trFS.data())});
    };

    function insertUpdatedBy(object, objectClassName){
      memberGet(object.updatedBy).then(function(updater) {
        var el = document.getElementById(objectClassName + "_updatedBy");
        emptyHTMLSet(el);
        el.appendChild(memberLink(updater));
      });
    };
    
    function hideEmptyFields(listOfFields){
      listOfFields.forEach(function(field){
        if (document.getElementById("transaction_"+field).value) {document.getElementById("transaction_"+field+"_field").style.display="block"}
        else {document.getElementById("transaction_"+field+"_field").style.display="none"};
      });
    };
    
    function setSelectedTransaction(id,object) {
      selectedTransactionId = id;
      transaction = object;
      document.getElementById("transaction_type").value=TransTypeRead[object.type];
      document.getElementById("transaction_account").value=object.account;
      document.getElementById("transaction_name").value=object.name;
      document.getElementById("transaction_amount").value=object.amount.toLocaleString("nl-BE", currencyStyle);
      document.getElementById("transaction_date").value=object.date;
      document.getElementById("transaction_bookDate").value=object.bookDate;
      document.getElementById("transaction_communication").value=object.communication;
      document.getElementById("transaction_costCenter").value="";
      document.getElementById("transaction_owner").value="";
      document.getElementById("transaction_save_button").disabled=false;
      document.getElementById("transaction_updatedOn").innerHTML  = object.updatedOn;
      if (object.type == "PRIVA") {
        transaction.distribution = object.distribution;
        document.getElementById("transaction_properties_frame").style.display = "block";
        showTransactionDistribution();
      } else {
        document.getElementById("transaction_properties_frame").style.display = "none";
      };
      if (checkBookDate(object.bookDate)){
        document.getElementById("transaction_edit_button").disabled = false;
        document.getElementById("transaction_remove_button").disabled = false}
      else {
        document.getElementById("transaction_edit_button").disabled = true;
        document.getElementById("transaction_remove_button").disabled = true};
      refreshTransactionEvidence();
      if (hasCounterparty(object.type)){document.getElementById("transaction_name_field").style.display = "block"; }
      else {document.getElementById("transaction_name_field").style.display = "none"; }
      if (hasCostCenter(object.type)) {
        document.getElementById("transaction_costCenter_field").style.display = "block";
        
          costCenterGet(object.costCenter).then(function (cc){
            document.getElementById("transaction_costCenter").value=cc.name;
            hideEmptyFields(["costCenter","name","account","owner","communication"]);
            var elems = document.querySelectorAll('select');
            M.FormSelect.init(elems);
            M.updateTextFields();
            insertUpdatedBy(object, "transaction");
          });
        
      } else {
        document.getElementById("transaction_costCenter_field").style.display = "none";
        if (object.type == "OWNER") {
          document.getElementById("transaction_owner_field").style.display = "block";
          memberGet(object.owner).then(function(m){
            document.getElementById("transaction_owner").value = denomination(m);
            hideEmptyFields(["costCenter","name","account","owner","communication"]);
            var elems = document.querySelectorAll('select');
            M.FormSelect.init(elems);
            M.updateTextFields();
            insertUpdatedBy(object, "transaction");
            
          })
        } else {document.getElementById("transaction_owner_field").style.display = "none";
          insertUpdatedBy(object, "member");
          hideEmptyFields(["costCenter","name","account","owner","communication"]);
          var elems = document.querySelectorAll('select');
          M.FormSelect.init(elems);
          M.updateTextFields();
          insertUpdatedBy(object, "transaction");
      };
      };
    };    

    function showTransactionDistribution(){
      var htmlTable = document.getElementById("transaction_distribution_table");
      emptyHTMLSet( htmlTable);
      i=0;
      var total = 0;
      transaction.distribution.forEach(function(dis){
      
        propertyGet(dis.property).then(function(p){
          var objectsRow= document.createElement('tr');
          var cellContent = propertyLink(p);
          var cell = document.createElement('td');
          cell.appendChild(cellContent);
          objectsRow.appendChild(cell);

          total = total + dis.amount;
          var cellContent = document.createTextNode(dis.amount.toLocaleString("nl-BE", currencyStyle));
          cell = document.createElement('td');
          cell.appendChild(cellContent);
          objectsRow.appendChild(cell);

          htmlTable.appendChild(objectsRow);
                    
          i = i+1;
          if (i == transaction.distribution.length){
            var objectsRow= document.createElement('tr');
            var cellContent = document.createTextNode("Total");
            var cell = document.createElement('td');cell.style.fontWeight = "bold";
            cell.appendChild(cellContent);
            objectsRow.appendChild(cell);
            cellContent = document.createTextNode(total.toLocaleString("nl-BE", currencyStyle));
            cell = document.createElement('td');cell.style.fontWeight = "bold";
            cell.appendChild(cellContent);
            objectsRow.appendChild(cell);     
            htmlTable.appendChild(objectsRow);
          };
         }).catch(function(error) {
            M.toast({html:"System error loading property in distribution list: " + error});
         });
      });     
    };
    
    function resetSelectedTransaction() {
      selectedTransactionId = null;
      transaction = new TransactionObject();
      document.getElementById("transaction_type_add").value="";
      listCostCenters(document.getElementById("transaction_costCenter_add"), true, "");
      document.getElementById("transaction_costCenter_add_field").style.display = "none";
      document.getElementById("transaction_account_add").value="";
      document.getElementById("transaction_name_add").value="";
      document.getElementById("transaction_amount_add").value="";
      document.getElementById("transaction_date_add").value="";
      document.getElementById("transaction_bookDate_add").value="";
      document.getElementById("transaction_communication_add").value="";
      listOwners(document.getElementById("transaction_owner_add"), "", true);
      toggleTransaction();
      document.getElementById("transaction_save_button").innerHTML = "Save and go to adding evidence";
      var buttonIcon = document.createElement("i");
      buttonIcon.setAttribute("class","material-icons right");
      buttonIcon.innerHTML = "send";
      document.getElementById("transaction_save_button").appendChild(buttonIcon);
      emptyHTMLSet(document.getElementById("transaction_distribution_table_add"));
      document.getElementById("transaction_save_button").disabled=false;
      var elems = document.querySelectorAll('select');
      M.FormSelect.init(elems);
      M.updateTextFields();  
    };
    function editTransaction(id,object) {
      document.getElementById("transaction_type_add").value=object.type;
      listCostCenters(document.getElementById("transaction_costCenter_add"), true, object.costCenter);
      document.getElementById("transaction_account_add").value=object.account;
      document.getElementById("transaction_name_add").value=object.name;
      document.getElementById("transaction_amount_add").value=object.amount;
      document.getElementById("transaction_date_add").value=object.date;
      document.getElementById("transaction_bookDate_add").value=object.bookDate;
      document.getElementById("transaction_communication_add").value=object.communication;
      if (object.owner) {listOwners(document.getElementById("transaction_owner_add"), object.owner, true);}
      else {listOwners(document.getElementById("transaction_owner_add"), "", true);};
      toggleTransaction();
      document.getElementById("transaction_save_button").innerHTML = "Save";
      var buttonIcon = document.createElement("i");
      buttonIcon.setAttribute("class","material-icons right");
      buttonIcon.innerHTML = "send";
      document.getElementById("transaction_save_button").appendChild(buttonIcon);
      document.getElementById("transaction_save_button").disabled=false;
      var elems = document.querySelectorAll('select');
      M.FormSelect.init(elems);
      M.updateTextFields();
    };

    function listProperties(el, selectedOption) {
      var option;
      emptyHTMLSet(el);
      if (!Boolean(selectedOption)) {
        option = document.createElement("option");
        option.setAttribute("value","");
        option.setAttribute("disabled",true);
        option.setAttribute("selected",true);
        option.innerHTML = "Select Property<b><font color='red'>*</font></b>";
        el.appendChild(option);
      };
      propertiesGet().then(function(querySnapshot) {
        querySnapshot.forEach(function(prop) {
            option = document.createElement("option");
            option.setAttribute("value",prop.idFS);
            if (prop.idFS == selectedOption) {option.setAttribute("selected",true);};
            option.innerHTML = prop.code;
            el.appendChild(option);
          });
        M.updateTextFields();
        var elems = document.querySelectorAll('select');        
	      M.FormSelect.init(elems);
      });
    };

    function removeTransactionDistribution(i){
      transaction.distribution.splice(i,1);
      refreshTransactionDistribution();
    };

    function addTransactionDistribution(){
      var valid = true;
      var propertyId = document.getElementById("transaction_properties_add").value;
      if (propertyId == "") {
        M.toast({html:"Please select property"});
        valid=false;
      };
      var amountString = document.getElementById("transaction_distribution_amount_add").value;
      if ((!amountString) || (!(document.getElementById("transaction_distribution_amount_add")).checkValidity())) {
        M.toast({html:"Please enter valid amount"});
        valid=false;
      };
      if (valid){
        transaction.distribution.push({
          property: propertyId,
          propertyCode: ((document.getElementById("transaction_properties_add")).item(document.getElementById("transaction_properties_add").selectedIndex)).innerHTML,
          amount: parseFloat(amountString),
        });
        refreshTransactionDistribution();
      };
    };
    
    function refreshTransactionDistribution(){
      var htmlTable = document.getElementById("transaction_distribution_table_add");
      emptyHTMLSet( htmlTable);
      i=0;
      distributedAmount = 0;
      
      while (i<transaction.distribution.length){
        var transactionData = transaction.distribution[i];
        var objectsRow= document.createElement('tr');
        var cellContent = document.createTextNode(transactionData.propertyCode);
        var cell = document.createElement('td');
        cell.appendChild(cellContent);
        objectsRow.appendChild(cell);

        distributedAmount = distributedAmount + transactionData.amount;
        var cellContent = document.createTextNode(transactionData.amount.toLocaleString("nl-BE", currencyStyle));
        cell = document.createElement('td');
        cell.appendChild(cellContent);
        objectsRow.appendChild(cell);

        cellContent = document.createElement('button');
        cellContent.setAttribute('class','btn-floating waves-light red');
        cellContent.setAttribute('style','float: right;margin-left: 20px;margin-bottom: 3px');
        cellContent.setAttribute('onclick','removeTransactionDistribution('+JSON.stringify(i)+')');
        var cellButtonIcon = document.createElement('i');
        cellButtonIcon.setAttribute('class','material-icons right');
        cellButtonIcon.innerHTML="delete";           
        cellContent.appendChild(cellButtonIcon);
        cell.appendChild(cellContent);
        objectsRow.appendChild(cell);

        htmlTable.appendChild(objectsRow);
        i = i+1;
      };
      
      var objectsRow= document.createElement('tr');
      var cellContent = document.createTextNode("Total");
      var cell = document.createElement('td');cell.style.fontWeight = "bold";
      cell.appendChild(cellContent);
      objectsRow.appendChild(cell);
      cellContent = document.createTextNode(distributedAmount.toLocaleString("nl-BE", currencyStyle));
      cell = document.createElement('td');cell.style.fontWeight = "bold";
      cell.appendChild(cellContent);
      objectsRow.appendChild(cell);      
      htmlTable.appendChild(objectsRow);
    };
    
    function toggleTransaction(){
      var typeElement = document.getElementById("transaction_type_add");
      if (typeElement.value == "PRIVA") {
        document.getElementById("transaction_properties_add_frame").style.display = "block";
        document.getElementById("transaction_distribution_amount_add").value = "";
        listProperties(document.getElementById("transaction_properties_add"), "");
        if (!transaction.distribution) {transaction.distribution = [];};
        refreshTransactionDistribution();       
      } else {
        document.getElementById("transaction_properties_add_frame").style.display = "none";
      };
      if (hasCostCenter(typeElement.value)) {
        document.getElementById("transaction_costCenter_add_field").style.display = "block";
      } else {
        document.getElementById("transaction_costCenter_add_field").style.display = "none";
      };
      if (typeElement.value == "OWNER"){
        document.getElementById("transaction_owner_add_field").style.display = "block";
      } else {
        document.getElementById("transaction_owner_add_field").style.display = "none";
      };
      if (hasCounterparty(typeElement.value)){
        document.getElementById("transaction_name_add_field").style.display = "block";
      } else {
        document.getElementById("transaction_name_add_field").style.display = "none";
      };
    };

    function prepareRemoveTransaction(){
      refCoproperty.collection("Documents").where("link","==",selectedTransactionId).get().then(function(objectsFSArray){
        if (objectsFSArray.docs.length){M.toast({html:"Please remove evidence before deleting transaction"});}
        else {M.Modal.getInstance(document.getElementById("transactionRemove")).open();};
      });
    };

    function removeTransaction (){
      refCoproperty.collection("Transactions").doc(selectedTransactionId).delete().then(function(){
          refreshTransactions();
          M.Modal.getInstance(document.getElementById("transactionRemove")).close();
          M.Modal.getInstance(document.getElementById("transactionView")).close();
        }).catch(function(error) {
            M.toast({html:"System error removing transaction rule:" + error});
        });
    };

      /* Transaction Evidence scripts start here---------------------------------------------*/
    
      var transactionEvidenceLinkOptionEl = document.getElementById("transactionLink_document");
      function addEvidenceLinkOption(docHere){
        if ((!docHere.link) && (docHere.type != "GEASS")){
          var newEl = document.createElement("option");
          newEl.setAttribute("value", docHere.idFS);
          newEl.innerHTML = DocumentType[docHere.type]+" "+docHere.counterparty+" "+docHere.updatedOn;
          transactionEvidenceLinkOptionEl.insertAdjacentElement('beforeend', newEl);
        };
      };
      
      function emptyTransactionEvidenceLinkFields(){
        initialiseForm();
        /*
        documentsGet().then(function(docList){
        var thisSelectEl = document.getElementById("transactionLink_document");
        thisSelectEl.value = "";
        emptyHTMLSet(thisSelectEl);
        var thislist = {};
        document.getElementById("transactionEvidenceLinkSubmitButton").disabled=false;
        
          docList.forEach(function(docHere){
            if ((!docHere.link) && (docHere.type != "GEASS")) {
              if (passFilter(documentValueFilter, documentSubStringFilter, docHere)){
                var thisVisual=DocumentType[docHere.type]+" "+docHere.counterparty+" "+docHere.updatedOn;
                thislist[docHere.idFS]=thisVisual;
              };
            };
          });
          insertSelectOptions("transactionLink_document", thislist, true, "document","");
          M.updateTextFields();
          var elems = document.querySelectorAll('select');        
	        M.FormSelect.init(elems);
        });
        */
      };

      function writeTransactionLink(){
        var documentId = document.getElementById("transactionLink_document").value;
        refCoproperty.collection("Documents").doc(documentId).update({link:selectedTransactionId}).then(function(){
          refreshDocuments();
          refreshTransactions();
          refreshTransactionEvidence();
          M.Modal.getInstance(document.getElementById("transactionNewEvidenceLink")).close();
        }).catch(function(error) {
          M.toast({html:"System creating transaction evidence link: " + error});
        });
      };

      function emptyTransactionEvidenceFields(){
        document.getElementById("transactionEvidenceFile").value = "";
        document.getElementById("transactionEvidenceFileText").value = "";
        document.getElementById("transactionEvidence_type").value = "";
        document.getElementById("transactionEvidence_freeType").value = "";
        toggleTransactionEvidenceNew();
        document.getElementById("transactionEvidenceDocumentSubmitButton").disabled=false;
        M.updateTextFields();
        var elems = document.querySelectorAll('select');        
	      M.FormSelect.init(elems);
      };
      
      function toggleTransactionEvidenceNew(){
        var typeElement = document.getElementById("transactionEvidence_type");
        if (typeElement.value == "OTHER") {
          document.getElementById("transactionEvidence_freeType_field").style.display = "block";
        } else {
          document.getElementById("transactionEvidence_freeType_field").style.display = "none";
        };
      };

      function loadTransactionEvidence (objectFS){
        var object = objectFS.data();
        var objectsRow= document.createElement('tr');

        var cellContent = document.createTextNode(DocumentType[object.type]);
        var cell = document.createElement('td');
        cell.appendChild(cellContent);
        objectsRow.appendChild(cell);
        
        var getFileButton = document.createElement("button");
        getFileButton.setAttribute('class','btn-small waves-light');
        getFileButton.innerHTML = "DownLoad";
        var icon = document.createElement('i');
        icon.setAttribute("class","material-icons right");
        icon.innerHTML = "file_download";
        getFileButton.appendChild(icon);
        objectsRow.appendChild(getFileButton);
        cell = document.createElement('td');
        cell.appendChild(getFileButton);
        objectsRow.appendChild(cell);
          
        if (currentUser.role == roleAdministrator) {
          cellContent = document.createElement('button');
          cellContent.setAttribute('class','modal-trigger btn-floating waves-light red');
          cellContent.setAttribute("data-target", "transactionEvidenceRemove");
          cellContent.setAttribute('onclick','popupRemoveTransactionEvidence('+JSON.stringify(objectFS.id)+')');
          var cellButtonIcon = document.createElement('i');
          cellButtonIcon.setAttribute('class','material-icons right');
          cellButtonIcon.innerHTML="delete";           
          cellContent.appendChild(cellButtonIcon);
          cell = document.createElement('td');
          cell.appendChild(cellContent);
          objectsRow.appendChild(cell);    
        };
        transactionEvidenceTable.appendChild (objectsRow);
        refCopropertyFiles.child("Documents").child(objectFS.id).getDownloadURL().then(function(url) {
          getFileButton.setAttribute('onclick','showFile('+JSON.stringify(url)+')');
        }); 
      };

      function refreshTransactionEvidence(){
        emptyHTMLSet(transactionEvidenceTable);
        refCoproperty.collection("Documents").where("link","==",selectedTransactionId).get().then(function(objectsFSArray){
            objectsFSArray.forEach(function(objectFS){
              loadTransactionEvidence(objectFS);
            })
          });
       
      };

      var transactionEvidenceFile;
      function validateTransactionEvidenceEntries() {
        var valid = true
        if (!(document.getElementById("transactionEvidence_type").value)) {
          M.toast({html:"Please enter Type"});
          valid=false;
        };
      
        transactionEvidenceFile = document.getElementById('transactionEvidenceFile').files[0];
        let allowed_mime_types = ['application/pdf','image/jpeg', 'image/png'];
        let allowed_size_kb = 5000;
        if (transactionEvidenceFile) {
          if(allowed_mime_types.indexOf(transactionEvidenceFile.type) == -1) {
            M.toast({html:"Incorrect file type (only pdf, jpeg and png allowed)"});
            valid=false;
          };
          if(transactionEvidenceFile.size > allowed_size_kb*1024) {
            M.toast({html:"File exceeds max size 500KB"});
            valid=false;
          };
        } else {
            M.toast({html:"Please select PDF File"});
            valid=false;
        };
        if (!valid) {
          document.getElementById("transactionEvidenceDocumentSubmitButton").disabled=false;
        };
        return valid;
      };

      function getTransactionEvidenceEntries() {
        var d = Object.assign({
          type: document.getElementById("transactionEvidence_type").value,
          counterparty: transaction.name,
          before: "",
          link: selectedTransactionId,
          freeType: document.getElementById("transactionEvidence_freeType").value,
          updatedOn: getToDaysDate(),
        },getUpdateInfo());
        return d;
      };
      
      function writeTransactionEvidence() {
        if (validateTransactionEvidenceEntries()) {  
          M.Modal.getInstance(document.getElementById("loading")).open();
          var entries = getTransactionEvidenceEntries();
          refCoproperty.collection("Documents").add(entries).then(function(docref) {
            var fileRef = refCopropertyFiles.child("Documents").child(docref.id); 
            fileRef.put(transactionEvidenceFile).then (function (){
              refreshTransactionEvidence();
              refreshTransactions();
              documents = null;
              documentsLoaded = false;
              M.Modal.getInstance(document.getElementById("loading")).close();
              M.Modal.getInstance(document.getElementById("transactionNewDocument")).close();
            }).catch(function(error) {
              M.Modal.getInstance(document.getElementById("loading")).close();
              M.toast({html:"Error creating transaction evidence file: " + error});
            });
          }).catch(function(error) {
            M.Modal.getInstance(document.getElementById("loading")).close();
            M.toast({html:"System creating transaction evidence document: " + error});
          });

        };
      };

      var transactionEvidenceId_to_remove;
      function popupRemoveTransactionEvidence(transactionEvidenceId){
        transactionEvidenceId_to_remove = transactionEvidenceId;
        document.getElementById("transactionEvidenceFileDelete").checked = false;
      }
      
      function removeTransactionEvidence(transactionEvidenceId){
        if (document.getElementById("transactionEvidenceFileDelete").checked) {
          refCoproperty.collection("Documents").doc(transactionEvidenceId).delete().then(function(){
            refreshDocuments();
            refreshTransactionEvidence();
            var fileRef = refCopropertyFiles.child("Documents").child(transactionEvidenceId);
            fileRef.delete().then(function() {
            }).catch(function(error) {
              M.toast({html:"System error removing report file:" + error});           
            });
            M.Modal.getInstance(document.getElementById("transactionEvidenceRemove")).close();
          }).catch(function(error) {
              M.toast({html:"System error removing document:" + error});
          });
        } else {
          refCoproperty.collection("Documents").doc(transactionEvidenceId).update({link:""}).then(function(){
            refreshDocuments();
            refreshTransactionEvidence();
            M.Modal.getInstance(document.getElementById("transactionEvidenceRemove")).close();
          }).catch(function(error) {
            M.toast({html:"System error removing transaction evidence link:" + error});
          });
        };
      };
    /* TransactionLoadings scripts start here---------------------------------------------*/
    
    var transactionsLoadFile;
    function validateTransactionsLoadEntries(){
      var valid = true;
      transactionsLoadFile = document.getElementById('transactionLoadFile').files[0];
      let allowed_mime_types = ['application/vnd.ms-excel'];
      let allowed_size_kb = 100;
      if (transactionsLoadFile) {
        if(allowed_mime_types.indexOf(transactionsLoadFile.type) == -1) {
          valid=false;
          M.toast({html:"Incorrect file type (only csv allowed)"});
        };
        if(transactionsLoadFile.size > allowed_size_kb*1024) {
          valid=false;
          M.toast({html:"File exceeds max size 100KB"});
          
        };
      } else {
          valid=false;
          M.toast({html:"Please select CSV File"});       
      };
      return valid;
    };
    
    function emptyTransactionLoadFields(){
      document.getElementById("transactionLoadFile").value = "";
      document.getElementById("transactionLoadFileText").value = "";
    };

    function argentaCsvToArray(str, delimiter = ";") {
    // slice from \n index + 1 to the end of the text
    // use split to create an array of each csv value row
    var rows = str.slice(str.indexOf("\n") + 1).split("\n");
    rows.pop();

    const arr = rows.map(function (row) {
      const values = row.split(delimiter);
      var resultRow = {};
      resultRow.type = "TBSET";
      resultRow.account = values[8];
      resultRow.name = values[9];
      resultRow.amount = values[5].replace(".","").replace(",",".");
      var trDate = values[7];
      resultRow.date = trDate.substring(6,10) + "-" + trDate.substring(3,5) + "-" + trDate.substring(0,2);
      resultRow.bookDate = resultRow.date;
      resultRow.communication = values[10];
      return resultRow;
    });

    // return the array
    //arr.pop();
    return arr;
    };

    function belfiusCsvToArray(str, delimiter = ";") {
    // slice from \n index + 1 to the end of the text
    // use split to create an array of each csv value row
    var rows = str.slice(str.indexOf("\n") + 1).split("\n");
    for (let i = 0; i < 12; i++) {rows.shift();};
    rows.pop();
    
    const arr = rows.map(function (row) {
      const values = row.split(delimiter);
      var resultRow = {};
      resultRow.type = "TBSET";
      resultRow.account = values[4];
      resultRow.name = values[5];
      resultRow.amount = Number(values[10].replace(",","."));
      var trDate = values[1];
      resultRow.date = trDate.substring(6,10) + "-" + trDate.substring(3,5) + "-" + trDate.substring(0,2);
      resultRow.bookDate = resultRow.date;
      resultRow.communication = values[14];
      resultRow.costCenter = "";
      resultRow.owner = "";
      return Object.assign(resultRow, getUpdateInfo());
    });

    // return the array
    //arr.pop();
    return arr;
    };

    function appendTransactionRow(object){
      function createMyCell(myText) {
        var cellContent = document.createTextNode(myText);
        var cell = document.createElement('td');
        cell.appendChild(cellContent);
        return cell;
      };
      
      var objectsRow = document.createElement('tr');
      objectsRow.appendChild(createMyCell(TransTypeRead[object.type]));
      objectsRow.appendChild(createMyCell(object.name));
      objectsRow.appendChild(createMyCell(object.amount.toLocaleString("nl-BE", currencyStyle)));
      objectsRow.appendChild(createMyCell(object.date));
      objectsRow.appendChild(createMyCell(object.account));
      objectsRow.appendChild(createMyCell(object.communication));
      
      transactionsLoadConfirmTable.appendChild (objectsRow);
    };
    
    function applyTransactionRule(el) {
      transactionRulesGet().then(function(trs){
        for (i=0; i < trs.length; i++) {
          function matchHere() {
            el.type = trs[i].type;
            if ((trs[i].type == "OWNER") && (trs[i].owner)){
              el.owner = trs[i].owner;
            };
            if (hasCostCenter(trs[i].type) && (trs[i].costCenter)){
              el.costCenter = trs[i].costCenter;
            };
          };
          if (trs[i].account == el.account) {
            if (trs[i].communication) {
              if (el.communication.includes(trs[i].communication)) {
                matchHere();
                break;
              };
            } else {matchHere(); break;}
          };
        };
        appendTransactionRow(el);
      });
    };
    
    var transactionsBatchData;
    function loadTransactionsFile() {
      if (validateTransactionsLoadEntries()) {  
        M.Modal.getInstance(document.getElementById("transactionLoad")).close();
        M.Modal.getInstance(document.getElementById("transactionLoadConfirm")).open();
        const reader = new FileReader();
        reader.onload = function (e) {
          const text = e.target.result;
          /*transactionsBatchData = argentaCsvToArray(text);*/
          transactionsBatchData = belfiusCsvToArray(text);
          emptyHTMLSet(transactionsLoadConfirmTable);
          transactionsBatchData.map(function(el){applyTransactionRule(el);});
        };
        reader.readAsText(transactionsLoadFile);
      };
    };

    function writeTransactionsFile(){
      console.log("transactionsBatchData",transactionsBatchData);
      var batch = firestore.batch();
      transactionsBatchData.map(function(el){
        var docRef = refCoproperty.collection("Transactions").doc();
        batch.set(docRef, el);
      });
      batch.commit().then(function() {
        refreshTransactions();
        M.Modal.getInstance(document.getElementById("transactionLoadConfirm")).close();
      }).catch(function(error) {
        M.toast({html:"System error loading transactions: " + error});
      });
    };
    </script>
    <!-- TransactionRules scripts start here--------------------------------------------->
    <script>
      var transactionRules = null;
      async function transactionRulesGet(){
        if (transactionRules) {return transactionRules;}
        else {
          var querySnapshot = await refCoproperty.collection("TransactionRules").orderBy("owner").get();
          transactionRules = [];
          querySnapshot.forEach(function(objectFS) {
            var thisObject = objectFS.data();
            thisObject.idFS = objectFS.id;
            transactionRules.push(thisObject);
          });
          return transactionRules;
        };
      };

      var transactionRulesList = document.getElementById("transactionRulesList");
      function refreshTransactionRules(){
        emptyHTMLSet(transactionRulesList);
        transactionRules = null;
        transactionRulesGet().then(function(objectsArray){
          if (objectsArray.length){
            document.getElementById("transactionRulesList").style.display = "block";
            document.getElementById("transactionRules_absentPhrase").style.display = "none";
            objectsArray.forEach(function(tR){loadTransactionRule(tR);});
          } else {
            document.getElementById("transactionRulesList").style.display = "none";
            document.getElementById("transactionRules_absentPhrase").style.display = "block";
          };
        });
      };

      function loadTransactionRule(tR){
        
        var objectsRow= document.createElement('li');
        objectsRow.setAttribute("style","border-style:solid;border-color: darkgrey");
        var header = document.createElement('div');
        var headerIcon = document.createElement('i');
        headerIcon.setAttribute("class","material-icons");
        header.appendChild(headerIcon);
        
        header.setAttribute("class","collapsible-header");
        var title = document.createElement('span');
        header.appendChild (title);
        objectsRow.appendChild(header);
        var body= document.createElement('div');
        body.setAttribute("class","collapsible-body");
        var text = document.createElement('DIV');
        text.innerHTML = "<b>IF</b><br>    account = " +tR.account;
        if (tR.communication) {text.innerHTML += " <b>AND</b><br>   communication = "+tR.communication;};
        text.innerHTML += "<br><br><b>THEN</b><br>   type = " + TransTypeRead[tR.type];
        body.appendChild(text);
        if (currentUser.role == roleAdministrator) {
          var buttons = document.createElement('DIV');
          var removeButton = document.createElement('button');
          removeButton.setAttribute('style','float: right;margin-bottom: 3px');
          removeButton.setAttribute('class','modal-trigger btn-floating waves-light red');
          removeButton.setAttribute("data-target", "transactionRuleRemove");
          removeButton.setAttribute('onclick','popupRemoveTransactionRule('+JSON.stringify(tR)+')');
          var cellButtonIcon = document.createElement('i');
          cellButtonIcon.setAttribute('class','material-icons right');
          cellButtonIcon.innerHTML="delete";           
          removeButton.appendChild(cellButtonIcon);
          buttons.appendChild(removeButton);
          var editButton = document.createElement('button');
          editButton.setAttribute('style','float: right;margin-right: 5px;margin-bottom: 3px');
          editButton.setAttribute('class','modal-trigger btn-floating waves-light');
          editButton.setAttribute("data-target", "transactionRuleEdit");
          editButton.setAttribute('onclick','selectTransactionRule('+JSON.stringify(tR)+')');
          cellButtonIcon = document.createElement('i');
          cellButtonIcon.setAttribute('class','material-icons right');
          cellButtonIcon.innerHTML="edit";           
          editButton.appendChild(cellButtonIcon);
          buttons.appendChild(editButton);
          body.appendChild(buttons);
          var br = document.createElement('br');
          body.appendChild(br);
        };
        objectsRow.appendChild(body);
        transactionRulesList.appendChild (objectsRow);
        
        memberGet(tR.updatedBy).then (function(author){
          if (tR.type == "OWNER") {
            headerIcon.innerHTML = "input";
            memberGet(tR.owner).then (function(owner){
              title.innerHTML = "Owner payment from " + denomination(owner) ;
              text.innerHTML += " <b>AND</b><br>   owner = "+denomination(owner);
              text.innerHTML += "<hr>Updated on: " + tR.updatedOn + "<br>Updated by: ";
              text.appendChild(memberLink(author));
              
            });
          } else {
            headerIcon.innerHTML = "payment";
            title.innerHTML = "Expense " + tR.name;
            costCenterGet(tR.costCenter).then(function(cc){
              text.innerHTML += " <b>AND</b><br>   cost center = "+ cc.name;
              text.innerHTML += "<hr>Updated on: " + tR.updatedOn + "<br>Updated by: ";
              text.appendChild(memberLink(author));
              })
          };
        });
      };

      var transactionRulesLoaded = false;
      function loadTransactionRules(){
      loadAll().then(function(){
        hideMenu();
          document.getElementById("logo-container").innerHTML = "Transaction Rules";
          if (!transactionRulesLoaded) {
            refreshTransactionRules();
            transactionRulesLoaded = true;
          };
      });
      };

      var transactionRule;

      function popupRemoveTransactionRule(tR){transactionRule=tR;};
      function removeTransactionRule(){
        refCoproperty.collection("TransactionRules").doc(transactionRule.idFS).delete().then(function(){
          refreshTransactionRules();
          M.Modal.getInstance(document.getElementById("transactionRuleRemove")).close();
        }).catch(function(error) {
            M.toast({html:"System error removing transaction rule:" + error});
        });
      };
      
      function resetTransactionRule(){
        var trR = 
          {
          type: "",
          costCenter:"",
          account: "",
          name: "",
          communication:"",
          owner:"",
          idFS:null
          };
          selectTransactionRule(trR)

      };

      function selectTransactionRule(object) {
        transactionRule = object;
        document.getElementById("transactionRule_type").value=object.type;
        listCostCenters(document.getElementById("transactionRule_costCenter"), true, object.costCenter)
        document.getElementById("transactionRule_account").value=object.account;
        document.getElementById("transactionRule_name").value=object.name;
        document.getElementById("transactionRule_communication").value=object.communication;
        listOwners(document.getElementById("transactionRule_owner"), object.owner, true);
        toggleTransactionRule();
        document.getElementById("transactionRuleSubmitButton").disabled=false;;
        var elems = document.querySelectorAll('select');
        M.FormSelect.init(elems);
        M.updateTextFields();
      };

      function toggleTransactionRule(){
        var typeElement = document.getElementById("transactionRule_type");
        if ((!typeElement.value) ||(typeElement.value == "PRIVA") ||(typeElement.value == "PROVI")) {
          document.getElementById("transactionRule_costCenter_field").style.display = "none";
          document.getElementById("transactionRule_owner_field").style.display = "none";
        } else if (typeElement.value == "OWNER"){
          document.getElementById("transactionRule_costCenter_field").style.display = "none";
          document.getElementById("transactionRule_owner_field").style.display = "block";
        } else {
          document.getElementById("transactionRule_costCenter_field").style.display = "block";
          document.getElementById("transactionRule_owner_field").style.display = "none";
        };
        
      };

      function validateTransactionRule(){
        var valid = true;
        if (!document.getElementById("transactionRule_account").checkValidity()) {
          M.toast({html:"Please enter valid account"});
          valid=false;
        };
        if (!document.getElementById("transactionRule_name").checkValidity()) {
          M.toast({html:"Please enter counter party"});
          valid=false;
        };
        if (!document.getElementById("transactionRule_communication").checkValidity()) {
          M.toast({html:"Please enter valid communication"});
          valid=false;
        };
        if (!document.getElementById("transactionRule_type").checkValidity()) {
          M.toast({html:"Please enter type"});
          valid=false;
        };
        if (!document.getElementById("transactionRule_costCenter").checkValidity()) {
          M.toast({html:"Please enter cost center"});
          valid=false;
        };
        if ((document.getElementById("transactionRule_type").value != "OWNER") && (!document.getElementById("transactionRule_costCenter").value)){
          M.toast({html:"Please enter cost center"});
          valid=false;
        };

        if ((document.getElementById("transactionRule_type").value == "Owner Payment") && (!document.getElementById("transactionRule_owner").value)) {
            M.toast({html:"Please select owner"});
            valid=false;
        };
        if (!valid) {document.getElementById("transactionRuleSubmitButton").disabled=false;};
        return valid;
      };
      
      function getUpdateInfo(){
        return {
          updatedOn: getToDaysDate(),
          updatedBy: currentUser.id
        };
      };
      
      function getTransactionRuleEntries(){
        return Object.assign({
          type: document.getElementById("transactionRule_type").value,
          costCenter: document.getElementById("transactionRule_costCenter").value,
          account: document.getElementById("transactionRule_account").value,
          name: document.getElementById("transactionRule_name").value,
          communication:document.getElementById("transactionRule_communication").value,
          owner:document.getElementById("transactionRule_owner").value,
        },getUpdateInfo());
      };
      
      function writeTransactionRule(){
        if (validateTransactionRule()) { 
          var entries =  getTransactionRuleEntries();
          if (transactionRule.idFS) {
            refCoproperty.collection("TransactionRules").doc(transactionRule.idFS).set(entries).then(function(docref) {
              refreshTransactionRules();
              M.Modal.getInstance(document.getElementById("transactionRuleEdit")).close();
            }).catch(function(error) {
              M.toast({html:"Error updating transaction rule: " + error});
            });
          } else {
            refCoproperty.collection("TransactionRules").add(entries).then(function(docref) {
              refreshTransactionRules();
              M.Modal.getInstance(document.getElementById("transactionRuleEdit")).close();
            }).catch(function(error) {
              M.toast({html:"Error adding transaction rule: " + error});
            });
          };
        };
      };

      

    </script>
    <!--   Meter readings scripts start here -->
    <script>
      var meterReadingsLoaded = false;
      var meterReadings = null;

      async function meterReadingsGet(){
        if (meterReadings){return meterReadings;}
        else {
          meterReadings = [];
          var i = 0;
          var ps = await propertiesGet();
          while (i < ps.length) {
            var propertyMeterReadingsFSArray = await refCoproperty.collection("Properties").doc(ps[i].idFS).collection("Meters").orderBy("type").get();
            propertyMeterReadingsFSArray.forEach(function(objectFS){
              if (objectFS.data().status.normalize() === "ACTIF".normalize()) {
                var thisObject = objectFS.data();
                thisObject.idFS = objectFS.id;
                thisObject.property = ps[i].idFS;
                meterReadings.push(thisObject);
              };
            });
            i += 1; 
          };
          var copropertyMeterReadingsFSArray = await refCoproperty.collection("Meters").orderBy("type").get();
          copropertyMeterReadingsFSArray.forEach(function(objectFS){
            if (objectFS.data().status.normalize() === "ACTIF".normalize()) {
              var thisObject = objectFS.data();
              thisObject.idFS = objectFS.id;
              thisObject.property = "";
              meterReadings.push(thisObject);
            };
          });
          return meterReadings;
        }; 
      };

      async function meterReadingGet(thisIdFS){
        function checkId(mr){return (mr.idFS == thisIdFS)};
        var mrs = await meterReadingsGet();
        return mrs.find(checkId);
      };

      function loadMeterReading(mr){
        var objectsRow = document.createElement('tr');
        var cellContent = document.createElement('button');
        var cell;
        
        cellContent.setAttribute("data-target", "meterReadingView");
        cellContent.setAttribute('onclick','selectMeterReading('+JSON.stringify(mr)+')');
        cellContent.setAttribute('class','modal-trigger');
        cellContent.setAttribute('style','border:none;background-color:Transparent');
        cellContent.innerHTML = "<font color='blue'>" + MeterType[mr.type] + "</font>";
        cell = document.createElement('td');
        cell.appendChild(cellContent);
        objectsRow.appendChild(cell);  

        var propCell = document.createElement('td');

        objectsRow.appendChild(propCell);
        
        var readingPresent = (lastReguDate.localeCompare(mr.readings[0].date) == -1);
        if (readingPresent) {
           cellContent = document.createElement("i");
           cellContent.setAttribute("class","material-icons  green ");
           cellContent.innerHTML = "done";
        } else {
          cellContent = document.createElement("i");
          cellContent.setAttribute("class","material-icons  red ");
          cellContent.innerHTML = "clear";
        };
        cell = document.createElement('td');
        cell.setAttribute("align","center");
        cell.appendChild(cellContent);
        objectsRow.appendChild(cell);  

        if (readingPresent && (mr.readings[0].picture)) {
          cellContent = document.createElement("i");
          cellContent.setAttribute("class","material-icons  green ");
          cellContent.innerHTML = "done";
        } else {
          cellContent = document.createElement("i");
          cellContent.setAttribute("class","material-icons  red ");
          cellContent.innerHTML = "clear";
        };
        cell = document.createElement('td');
        cell.setAttribute("align","center");
        cell.appendChild(cellContent);
        objectsRow.appendChild(cell);  

        if (mr.readings[0]) {cellContent = document.createTextNode(mr.readings[0].date);}
        else {cellContent = document.createTextNode("");};
        cell = document.createElement('td');
        cell.appendChild(cellContent);
        objectsRow.appendChild(cell);

        if (mr.property){
          propertyGet(mr.property).then(function(prop){
            propCell.appendChild(propertyLink(prop));
            meterReadingsTable.appendChild (objectsRow);
          })
        } else {
          propCell.appendChild(document.createTextNode("Building"));
          meterReadingsTable.appendChild (objectsRow);
        };

      };

      var meterReadingsTable = document.getElementById("meterReadingsTable");
      function refreshMeterReadings(){
        emptyHTMLSet(meterReadingsTable);
        meterReadings = null;
        meterReadingsGet().then(function(mrs){
          if (mrs.length){
            document.getElementById("meterReadingsTable_frame").style.display = "block";
            document.getElementById("meterReadings_absentPhrase").style.display = "none";
            mrs.forEach(function(thisObject){loadMeterReading(thisObject);});
          } else {
            document.getElementById("meterReadingsTable_frame").style.display = "none";
            document.getElementById("meterReadings_absentPhrase").style.display = "block";
          };
        });
        
      };
      
      function loadMeterReadings() {
      loadAll().then(function(){  
        hideMenu();
        document.getElementById("logo-container").innerHTML = "Meter Readings";
        if (!meterReadingsLoaded) {
          refreshMeterReadings();
          meterReadingsLoaded = true;
        };
      });
      };
      
      var meterReading;
      var containsNewReading;
      var picturePresent;
      var canvasBlob;
      
      function selectMeterReading(mr){
        meterReading = mr;
        containsNewReading = null;
        picturePresent = null;
        canvasBlob = null;
        var thisPropertyCode;
        var thisPropertyOwner;
        var historyEl = document.getElementById("meterReadingHistory");
        
        function fillHistory(readingsHere){
          emptyHTMLSet(historyEl);
          readingsHere.forEach(function(r){
            var row = document.createElement('tr');
            var columnLink = document.createElement('td');
            var cellLink = document.createTextNode(r.reading);
            columnLink.appendChild(cellLink);
            row.appendChild(columnLink);
            var column = document.createElement('td');
            var cell = document.createTextNode(r.date);
            column.appendChild(cell);
            row.appendChild(column);
            column = document.createElement('td');
            memberGet(r.updatedBy).then (function(author){
              column.appendChild(memberLink(author));
              cell = document.createTextNode(" ");
              column.appendChild(cell);
              row.appendChild(column);
              historyEl.appendChild(row);
              if (r.picture){
                var cellB = document.createElement("button");
                cellB.setAttribute('style','border:none;background-color:Transparent');
                cellB.setAttribute('class','modal-trigger');
                cellB.setAttribute('data-target','fileShow');
                refCopropertyFiles.child(mr.property).child("Meters").child(mr.idFS).child((r.counter).toString()).getDownloadURL().then(function(url){
                  cellB.setAttribute('onclick','showFile('+JSON.stringify(url)+')');
                  cellB.innerHTML = "<font color='#0000FF'>" + r.reading + "</font>";
                  emptyHTMLSet(columnLink);
                  columnLink.appendChild(cellB);
                });
              };
            });
          });
        };
        var fileStoreRef;
        if (mr.property){
          var thisProperty = propertyGetSynchrone(mr.property);
          thisPropertyCode= thisProperty.code;
          thisPropertyOwner = thisProperty.owner;
          fileStoreRef = refCopropertyFiles.child(mr.property);
        }
        else {
          thisPropertyCode= "Building";
          thisPropertyOwner = "";
          fileStoreRef = refCopropertyFiles;
        };
        document.getElementById("meterReading_property").value = thisPropertyCode;
        document.getElementById("meterReading_type").value = MeterType[mr.type];
        document.getElementById("meterReading_id").value = mr.meter;
        if ((currentUser.role == roleAdministrator) || (currentUser.id == thisProperty.owner)) {
         document.getElementById("meterReading_edit_button_frame").style.display= "block";
        } else{document.getElementById("meterReading_edit_button_frame").style.display= "none"};
        containsNewReading = (lastReguDate.localeCompare(mr.readings[0].date) == -1);
        if (containsNewReading) {
          document.getElementById("meterReading_reading").value = mr.readings[0].reading;
          document.getElementById("meterReading_date").value = mr.readings[0].date;
          emptyHTMLSet(document.getElementById("meterReading_updatedBy"));
          memberGet(mr.readings[0].updatedBy).then (function(author){
            document.getElementById("meterReading_updatedBy").appendChild(memberLink(author));
            fillHistory(mr.readings.slice(1,mr.readings.length));
            if (mr.readings[0].picture) {
              picturePresent = true;
              fileStoreRef.child("Meters").child(mr.idFS).child((mr.readings[0].counter).toString()).getDownloadURL().then(function(url) {
                document.getElementById("meterReading_picture_img").setAttribute("src",url);
                document.getElementById("meterReading_picture_frame").style.display="block";
                meterReading.img = url;
                var elems = document.querySelectorAll('select');
                M.FormSelect.init(elems);
                M.updateTextFields();
              });
            } else {
              document.getElementById("meterReading_picture_frame").style.display="none";
              picturePresent = false;
            };
          });
        } else {
          document.getElementById("meterReading_reading").value = "";
          document.getElementById("meterReading_date").value ="";
          document.getElementById("meterReading_picture_frame").style.display="none";
          document.getElementById("meterReading_updatedBy").innerHTML="";
          picturePresent = false;
          fillHistory(mr.readings);
        };
        var elems = document.querySelectorAll('select');
        M.FormSelect.init(elems);
        M.updateTextFields();
      };

      function meterFormat(prefix, digits, decimals){
        var nine = "9";
        var maxAtt = nine.repeat(digits);
        document.getElementById(prefix + "_edit").setAttribute("max",maxAtt);
        var stepAtt;
        if (decimals){
          stepAtt = "0.";
          var nul = "0";
          var stepAttPart = nul.repeat(decimals - 1);
          stepAtt += stepAttPart; stepAtt += "1";
          document.getElementById(prefix + "_helper_edit").innerHTML =  "maximum " + digits + " digits before and " + decimals + " digits after the comma";
          document.getElementById(prefix + "_helper_edit").setAttribute("data-error", "maximum " + digits + " digits before and " + decimals + " digits after the comma");
        } else {
            document.getElementById(prefix + "_helper_edit").innerHTML =  "maximum " + digits + " digits";
            document.getElementById(prefix + "_helper_edit").setAttribute("data-error", "maximum " + digits + " digits");
            stepAtt = "1";
          };
        document.getElementById(prefix + "_edit").setAttribute("step",stepAtt);
        
      };
      
      function prepareMeterReadingEdit(){
        meterFormat("meterReading_reading", meterReading.digits,meterReading.decimals);
        if (containsNewReading) {
          document.getElementById("meterReading_reading_edit").value = meterReading.readings[0].reading;
          document.getElementById("meterReading_date_edit").value = meterReading.readings[0].date;
          if (meterReading.readings[0].picture) {
            document.getElementById("meterReading_picture_edit_frame").style.display="block";
            document.getElementById("meterReading_picture_form").style.display="none";
            document.getElementById("meterReading_picture_edit_img").setAttribute("src",meterReading.img);
            M.updateTextFields();
          } else {
            document.getElementById("meterReading_picture_edit_frame").style.display="none";
            document.getElementById("meterReading_picture_form").style.display="block";
          };
        } else {
          document.getElementById("meterReading_reading_edit").value = "";
          document.getElementById("meterReading_date_edit").value ="";
          document.getElementById("meterReading_picture_edit_frame").style.display="none";
          document.getElementById("meterReading_picture_form").style.display="block";
        };
        document.getElementById("meterReading_picture_edit_text").value ="";
        document.getElementById("meterReading_picture_edit_file").value = [];
        document.getElementById("meterReadingSubmitButton").disabled=false;
        M.updateTextFields();
      };
      

      function removePicture(){
        document.getElementById("meterReading_picture_form").style.display = "block";
        document.getElementById("meterReading_picture_edit_frame").style.display = "none";
        document.getElementById("meterReading_picture_edit_file").value = [];
        document.getElementById("meterReading_picture_edit_text").value = "";
        picturePresent = false;
        M.Modal.getInstance(document.getElementById("pictureRemove")).close();
      };
      

      function showPictureMeterReadingEdit (){
        if (document.getElementById("meterReading_picture_edit_text").value){
          if (reduceImage( document.getElementById('meterReading_picture_edit_file').files[0], "meterReading_picture_edit_img")){
            document.getElementById("meterReading_picture_form").style.display = "none";
            document.getElementById("meterReading_picture_edit_frame").style.display = "block";
          } else {removePicture()};
        };
      };

      function reduceImage(im, elIdShowPicture) {
        let allowed_mime_types = [ 'image/jpeg', 'image/png' ];
        let allowed_size_kb = 6000;
        var valid = true;
        if (allowed_mime_types.indexOf(im.type) == -1) {
          M.toast({html:"Incorrect file type (only jpeg or png allowed)"});
          valid=false;
        } else if(im.size > allowed_size_kb*1024) {
          M.toast({html:"Picture exceeds max size 6MB"});
          valid=false;
        };
        if (valid){
          picturePresent = true;
          var canvas = document.createElement("canvas");
              
          var reader = new FileReader();
          reader.readAsDataURL(im);
          reader.onload = function (event) {
            var imgElement = document.createElement("img");
            /*imgElement.setAttribute("width","300");
            imgElement.setAttribute("heigth","225");*/
            imgElement.src = event.target.result;
            imgElement.onload = function (e) {
              var originalWith = e.target.width;
              var originalHeigth = Math.ceil(originalWith * 621/828);
              var targetHeigth = Math.ceil(300 * 621/828);
              var ctx = canvas.getContext("2d");
              /*ctx.drawImage(e.target,0,0,e.target.width,e.target.width * scaleSize,0,0,300,225);*/
              /*ctx.rotate(-90 * Math.PI / 180);*/
              ctx.drawImage(e.target,0,0,originalWith,originalWith,0,0,300,targetHeigth);
              canvas.toBlob(function(imgBlob){
                var uri = URL.createObjectURL(imgBlob);
                canvasBlob = imgBlob;
                document.getElementById(elIdShowPicture).setAttribute("src",uri);
              },"image/jpg",0.5);
            };
          };
        };
        return valid;
      };

      

      function validateMeterReading(){
        var valid= true;
        if (!document.getElementById("meterReading_reading_edit").checkValidity()) {
          M.toast({html:"Please enter valid reading"});
          valid=false;
        };
        if (!document.getElementById("meterReading_date_edit").checkValidity()) {
          M.toast({html:"Please enter Reading Date"});
          valid=false;
        }; 
        if (lastReguDate.localeCompare((document.getElementById("meterReading_date_edit").value)) != -1) {
          M.toast({html:"Reading date must be after last meters regulation date being "+lastReguDate});
          valid=false;
        };
        
       if (!valid) {
          document.getElementById("meterReadingSubmitButton").disabled=false;
        };
        return valid;
      };

      function writeMeterReading(){
        var pictureFileText = document.getElementById("meterReading_picture_edit_text").value;
        if (validateMeterReading()) {
          M.Modal.getInstance(document.getElementById("loading")).open();
          var thisReading = meterReading.readings;
          if (containsNewReading){
            thisReading[0].reading = Number(document.getElementById("meterReading_reading_edit").value);
            thisReading[0].date = document.getElementById("meterReading_date_edit").value;
            thisReading[0].picture = picturePresent;
            thisReading[0].updatedBy = currentUser.id;
          } else {
            var oldCounter;
            if (thisReading[0]) {oldCounter = thisReading[0].counter}
            else {oldCounter= -1};
            thisReading.unshift({
              counter : oldCounter + 1,
              picture : picturePresent,
              reading : Number(document.getElementById("meterReading_reading_edit").value),
              date: document.getElementById("meterReading_date_edit").value,
              updatedBy: currentUser.id
            });
          };
          var thisRefFS;
          var fileStoreRef;
          if (meterReading.property){
            thisRefFS = refCoproperty.collection("Properties").doc(meterReading.property);
            fileStoreRef = refCopropertyFiles.child(meterReading.property);
          } else {
            thisRefFS = refCoproperty;
            fileStoreRef = refCopropertyFiles;
          };
          var thisMeterIdFS = meterReading.idFS;
          if (document.getElementById('meterReading_picture_edit_file').files[0]) { 
            // A new picture has been attached
            thisRefFS.collection("Meters").doc(thisMeterIdFS).update({readings:thisReading}).then(function() {
              /*var pictureFile = document.getElementById('meterReading_picture_edit_file').files[0];*/
              var fileRef = fileStoreRef.child("Meters").child(thisMeterIdFS).child((thisReading[0].counter).toString());  
              /*fileRef.put(pictureFile).then (function (){*/
              /*fileRef.putString(pictureFile, "base64", {contentType:"image/jpg"}).then (function (){*/
              
                fileRef.put(canvasBlob).then (function (){
                  refreshMeterReadings();
                  selectMeterReading(meterReading);
                  M.Modal.getInstance(document.getElementById("loading")).close();
                  M.Modal.getInstance(document.getElementById("meterReadingEdit")).close();
                });
                
            }).catch(function(error) {
              M.Modal.getInstance(document.getElementById("loading")).close();
                /*M.toast({html:"Error occurred updating meter reading:" + error}); */
            });
          } else {
            // No new picture attached: either existing picture or no picture or pictuture was removed
            //thisReading.picture= picturePresent;
            thisRefFS.collection("Meters").doc(thisMeterIdFS).update({readings:thisReading}).then(function() {
              refreshMeterReadings();
              selectMeterReading(meterReading);
              M.Modal.getInstance(document.getElementById("loading")).close();
                M.Modal.getInstance(document.getElementById("meterReadingEdit")).close();
            }).catch(function(error) {
              M.Modal.getInstance(document.getElementById("loading")).close();
                M.toast({html:"Error occurred updating meter reading:" + error}); 
            });
          };
        };
      };
    </script>
    <!--   Members scripts start here -->
    <script>
      var membersLoaded = false;
      var members = null;

      async function membersGet() {
      if (members) {return members;}
        else {
          var querySnapshot = await refCoproperty.collection("Members").orderBy("firstName").get();
          members = [];
          querySnapshot.forEach(function(objectFS) {
            var thisObject = objectFS.data();
            thisObject.idFS = objectFS.id;
            members.push(thisObject);
          });
          return members;
        };
      }; 
      
      function denomination(m) {
              if (m.type == "PERSO") {return m.firstName + " "+ m.lastName}
              else {return m.companyName};
      };

      async function memberGet(id){
        function checkId(m){return m.idFS == id};
        var ms = await membersGet();
        return ms.find(checkId);
      };

      function refreshMembers() {
        emptyHTMLSet(membersTable);
        members = null;
        membersGet().then(function(objectsArray){
          objectsArray.forEach(function(thisObject){loadMember(thisObject);});  
        });    
      };

      function loadMembers(){
      loadAll().then(function(){
        hideMenu();
        document.getElementById("logo-container").innerHTML = "Members";
        if (!membersLoaded) {
          refreshMembers();
          membersLoaded = true;
        };
      });
      };


      function insertAdrressCoproperty(){
        refCoproperty.get().then(function(copropertyFS){
          var object = copropertyFS.data();
          document.getElementById("member_country_edit").value=object.country;
          document.getElementById("member_zip_edit").value=object.zip;
          document.getElementById("member_town_edit").value=object.town;
          document.getElementById("member_street_edit").value=object.street;
          document.getElementById("member_houseNumber_edit").value=object.houseNumber;
          M.updateTextFields();
        });
      };
      
      function memberLink(m) {
        var elA = document.createElement('button');
        elA.setAttribute("data-target", "memberView");
        elA.setAttribute('class','modal-trigger');
        elA.setAttribute('style','border:none;background-color:Transparent');
        elA.setAttribute('onclick','setSelectedMember('+JSON.stringify(m)+',"")');
        elA.innerHTML = "<font color='#0000FF'>"+denomination(m)+"</font>";
        return elA;
      };

      var membersTable = document.getElementById("membersTable");
      function loadMember (m){
        var objectsRow= document.createElement('tr');
        var cellContent = memberLink(m);
        var cell = document.createElement('td');
        cell.setAttribute("style","white-space: nowrap");
        cell.appendChild(cellContent);
        objectsRow.appendChild(cell);
        /*
        cellContent = document.createTextNode(m.email);
        cell = document.createElement('td');
        cell.appendChild(cellContent);
        objectsRow.appendChild(cell);  
        */
        cellContent = document.createTextNode(m.phoneMobile);
        cell = document.createElement('td');
        cell.appendChild(cellContent);
        objectsRow.appendChild(cell);
        membersTable.appendChild (objectsRow);
        /*cell = document.createElement('td');
        propertiesBy(m).then(function(propertiesByResult){
          propertiesByResult.owns.forEach (function (property) {cell.appendChild(propertyLinkFromMemberView(property));});
        
          objectsRow.appendChild(cell);  

          cellContent = document.createTextNode(m.phoneMobile);
          cell = document.createElement('td');
          cell.appendChild(cellContent);
          objectsRow.appendChild(cell);  

          membersTable.appendChild (objectsRow);
        });*/
      };
      
      

      function addMember(member){
        refCoproperty.collection("Members").add(member)
          .then(function(docref) {
            refreshMembers();
            firebase.auth().createUserWithEmailAndPassword(member.email, Math.random().toString(36).substring(3,11)).then(function(u){});
            M.Modal.getInstance(document.getElementById("memberWrite")).close();
          }).catch(function(error) {
            M.toast({html:"Error occurred adding this member:" + error}); 
          });
      };

      function updateMember(member){
        refCoproperty.collection("Members").doc(selectedMemberId).update(member)
          .then(function(docref) {
            var updatedSelectedMember = getMemberEntries();
            updatedSelectedMember.idFS = selectedMemberId;
            setSelectedMember(updatedSelectedMember,"");
            refreshMembers();
            var docUserRef = firestore.collection("Users").doc(updatedSelectedMember.email);
            docUserRef.get().then(function(user){
              if (!user.exists)  {
                firebase.auth().createUserWithEmailAndPassword(updatedSelectedMember.email, Math.random().toString(36).substring(3,11)).then(function(u){});
                propertiesBy(updatedSelectedMember).then(function(ps){ 
                  if (ps.length) {
                    firestore.collection("Users").doc(updatedSelectedMember.email).set({}).then(function(x){});
                  };
                  M.Modal.getInstance(document.getElementById("memberWrite")).close();
                });
              } else {
                M.Modal.getInstance(document.getElementById("memberWrite")).close();
              };
            }).catch (function(error) {
              M.toast({html:"Error occurred registering this member as owner:" + error}); 
            });
          }).catch(function(error) {
            M.toast({html:"Error occurred updating this member:" + error}); 
          });
      };

      
      function writeMember() {
        if (validateMemberEntries()) {  
          var entries = getMemberEntries();
          if (mode === "add"){
            if (entries.email) {
              refCoproperty.collection("Members").where("email", "==", entries.email).get()
                .then(function(existingList) {
                  if (existingList.docs.length > 0) {
                    M.toast({html:"Error: member with this email already exists"}); 
                  } else {addMember(entries);};
                }) .catch (function(error) {
                  M.toast({html:"Error occurred checking email uniqueness:" + error}); 
                });
            } else {
                    addMember(entries);
            };
          } else {
            if ((entries.email) && (! (entries.email.normalize() === selectedMemberObject.email.normalize()))) {
              refCoproperty.collection("Members").where("email", "==", entries.email).get()
                .then(function(existingList) {
                  if (existingList.docs.length > 0) {
                    M.toast({html:"Error: member with this email already exists"}); 
                  } else {
                      updateMember(entries);
                    };
                }) .catch (function(error) {
                  M.toast({html:"Error occurred checking email uniqueness:" + error}); 
                });
            } else {
                    updateMember(entries);
            };
          };
        };
      };        

        function getMemberEntries() {
          return Object.assign({
            type: document.getElementById("member_type_edit").value,
            firstName: document.getElementById("member_firstName_edit").value,
            lastName: document.getElementById("member_lastName_edit").value,
            companyName: document.getElementById("member_companyName_edit").value,
            registrationNumber: document.getElementById("member_registrationNumber_edit").value,
            email: document.getElementById("member_email_edit").value,
            phoneHome: document.getElementById("member_phoneHome_edit").value,
            phoneMobile: document.getElementById("member_phoneMobile_edit").value,
            country: document.getElementById("member_country_edit").value,
            zip: document.getElementById("member_zip_edit").value,
            town: document.getElementById("member_town_edit").value,
            street: document.getElementById("member_street_edit").value,
            houseNumber: document.getElementById("member_houseNumber_edit").value,
            bus: document.getElementById("member_bus_edit").value
          }, getUpdateInfo());
        };
        
        
        function propertyJump (propertyId, propertyObject){
          
          M.Modal.getInstance(document.getElementById("memberView")).close();
          setSelectedProperty(propertyId,propertyObject,"");
        };

        
        function propertyLinkFromMemberView(property) {
          var elA = document.createElement('a');
          elA.setAttribute("data-target", "propertyView");
          elA.setAttribute('class','btn-flat modal-trigger');
          elA.setAttribute('onclick','propertyJump('+JSON.stringify(property.id)+','+JSON.stringify(property.data())+')');
          elA.innerHTML = "<font color='blue'>"+property.data().code+"</font>"+ "  ";
          return elA;
        };

        
        
        var mode;
        var selectedMemberId;
        var selectedMemberObject;
        function setSelectedMember(object,modeArg) {
          selectedMemberId=object.idFS;
          selectedMemberObject=object;
          mode="edit";
          document.getElementById("member_firstName"+modeArg).value=object.firstName;
          document.getElementById("member_lastName"+modeArg).value=object.lastName;
          document.getElementById("member_companyName"+modeArg).value=object.companyName;
          document.getElementById("member_registrationNumber"+modeArg).value=object.registrationNumber;
          document.getElementById("member_email"+modeArg).value=object.email;
          document.getElementById("member_phoneHome"+modeArg).value=object.phoneHome;
          document.getElementById("member_phoneMobile"+modeArg).value=object.phoneMobile;
          document.getElementById("member_country"+modeArg).value=object.country;
          document.getElementById("member_zip"+modeArg).value=object.zip;
          document.getElementById("member_town"+modeArg).value=object.town;
          document.getElementById("member_street"+modeArg).value=object.street;
          document.getElementById("member_houseNumber"+modeArg).value=object.houseNumber;
          document.getElementById("member_bus"+modeArg).value=object.bus;
          document.getElementById("memberSubmitButton").disabled=false;
          if (modeArg) {
            document.getElementById("member_type"+modeArg).value=object.type;
            toggleMember_edit();}
          else {
            toggleMember_view();
            document.getElementById("member_updatedOn").innerHTML  = object.updatedOn;
            if ((currentUser.role == roleAdministrator) ||(object.updatedBy == currentUser.id)) {document.getElementById("Members_Edit").setAttribute("class","displayBlock");}
            else {document.getElementById("Members_Edit").setAttribute("class","displayHidden");};
            memberGet(object.updatedBy).then(function(updater) {
              emptyHTMLSet(document.getElementById("member_updatedBy"));
              document.getElementById("member_updatedBy").appendChild(memberLink(updater));
              var ownerOfEl = document.getElementById("member_ownerOf");
              emptyHTMLSet(ownerOfEl);
              refCoproperty.collection("Properties").where("owner", "==", object.idFS).get().then (function (querySnapshot){
                querySnapshot.forEach (function (property) {
                  ownerOfEl.appendChild(propertyLinkFromMemberView(property));
                });
              });
              var occupantOfEl = document.getElementById("member_occupantOf");
              emptyHTMLSet(occupantOfEl);
              refCoproperty.collection("Properties").get().then (function (querySnapshotProperties){
                querySnapshotProperties.forEach (function (property) {
                  property.ref.collection("Occupants").where("occupant", "==", object.idFS).get().then (function (querySnapshotOccupants){
                    if (querySnapshotOccupants.docs.length > 0) {
                      occupantOfEl.appendChild(propertyLinkFromMemberView(property));
                    };
                  });
                });
              });
            });
          };
          var elems = document.querySelectorAll('select');
          M.FormSelect.init(elems);
          M.updateTextFields();
        };

        function toggleMember_edit() {
          if (document.getElementById("member_type_edit").value == "PERSO"){
            document.getElementById("member_firstName_edit_frame").style.display="block";
            document.getElementById("member_lastName_edit_frame").style.display="block";
            document.getElementById("member_companyName_edit_frame").style.display="none";
            document.getElementById("member_registrationNumber_edit_frame").style.display="none";
          } else {
            document.getElementById("member_firstName_edit_frame").style.display="none";
            document.getElementById("member_lastName_edit_frame").style.display="none";
            document.getElementById("member_companyName_edit_frame").style.display="block";
            document.getElementById("member_registrationNumber_edit_frame").style.display="block";
          };
        };

        function toggleMember_view() {
          if (selectedMemberObject.type == "PERSO"){
            document.getElementById("member_firstName_frame").style.display="block";
            document.getElementById("member_lastName_frame").style.display="block";
            document.getElementById("member_companyName_frame").style.display="none";
            document.getElementById("member_registrationNumber_frame").style.display="none";
          } else {
            document.getElementById("member_firstName_frame").style.display="none";
            document.getElementById("member_lastName_frame").style.display="none";
            document.getElementById("member_companyName_frame").style.display="block";
            document.getElementById("member_registrationNumber_frame").style.display="block";
          };
        };


        function resetSelectedMember() {
          selectedMemberId=null;
          selectedMemberObject={};
          mode="add";
          selectedMemberObject.type="PERSO";
          selectedMemberObject.firstName="";
          selectedMemberObject.lastName="";
          selectedMemberObject.companyName="";
          selectedMemberObject.registrationNumber="";
          selectedMemberObject.email="";
          selectedMemberObject.phoneHome="";
          selectedMemberObject.phoneMobile="";
          selectedMemberObject.country="";
          selectedMemberObject.zip="";
          selectedMemberObject.town="";
          selectedMemberObject.street="";
          selectedMemberObject.houseNumber="";
          selectedMemberObject.bus="";
          selectedMemberObject.idFS=null;
          setSelectedMember(selectedMemberObject,"_edit");
          mode="add";
          document.getElementById("memberSubmitButton").disabled=false;
          
          var elems = document.querySelectorAll('select');
          M.FormSelect.init(elems);
          M.updateTextFields();
        };

        function validateMemberEntries() {
              var valid= true;
              var typeHere = document.getElementById("member_type_edit").value;
              if ((typeHere == "PERSO") && (!document.getElementById("member_firstName_edit").value)) {
                M.toast({html:"Please enter First Name"});
                valid=false; 
              };
              if ((typeHere == "PERSO") && (!document.getElementById("member_lastName_edit").value)) {
                M.toast({html:"Please enter Last Name"});
                valid=false;
              };
              if ((typeHere == "COMPA") && (!document.getElementById("member_companyName_edit").value)) {
                M.toast({html:"Please enter Company Name"});
                valid=false;
              };
              if ((typeHere == "COMPA") && (!document.getElementById("member_registrationNumber_edit").value)) {
                M.toast({html:"Please enter Registration Number"});
                valid=false;
              };
              if (!document.getElementById("member_email_edit").checkValidity()) {
                M.toast({html:"Please enter valid Email"});
                valid=false;
              };
              if (!document.getElementById("member_phoneHome_edit").checkValidity()) {
                M.toast({html:"Please enter valid Phone Home"});
                valid=false;
              };
              if (!document.getElementById("member_phoneMobile_edit").checkValidity()) {
                M.toast({html:"Please enter valid Mobile"});
                valid=false;
              };
              if (!document.getElementById("member_zip_edit").checkValidity()) {
                M.toast({html:"Please enter valid Zip"});
                valid=false;
              };
              if (!document.getElementById("member_bus_edit").checkValidity()) {
                M.toast({html:"Please enter valid Bus"});
                valid=false;
              };
              if (!valid) {document.getElementById("memberSubmitButton").disabled=false;};
              return valid;
        };
    </script>
    <!--   Properties scripts start here -->
    <script>
      var propertiesLoaded = false;
      var properties = null;
      async function propertiesGet(){
        if (properties) {return properties;}
        else {
          var querySnapshot = await refCoproperty.collection("Properties").orderBy("code").get();
          properties = [];
          querySnapshot.forEach(function(objectFS) {
            var thisObject = objectFS.data();
            thisObject.idFS = objectFS.id;
            properties.push(thisObject);
          });
          return properties;
        }; 
      }; 
      async function propertyGet(idFS){
        function checkId(p){return p.idFS == idFS};
        var ps = await propertiesGet();
        return ps.find(checkId);
      };
      function propertyGetSynchrone(idFS){
        function checkId(p){return p.idFS == idFS};
        return properties.find(checkId);
      };
      async function propertiesBy(aMember) {
        function checkOwnership(p){return p.owner == aMember.idFS};
        var ps = await propertiesGet();
        var result = ps.filter(checkOwnership);
        return result;
      };
      function propertiesBySynchrone(aMember) {
        function checkOwnership(p){return p.owner == aMember.idFS};
        var result = properties.filter(checkOwnership);
        return result;
      };
      
      var propertiesTable = document.getElementById("propertiesTable");

      function loadProperty (object){
        var objectsRow= document.createElement('tr');
        var cellContent = propertyLink(object);
        var cell = document.createElement('td');
        cell.appendChild(cellContent);
        objectsRow.appendChild(cell);
        
        cellContent = document.createTextNode(PropType[object.type]);
        cell = document.createElement('td');
        cell.appendChild(cellContent);
        objectsRow.appendChild(cell); 
        
        cellContent = document.createTextNode("");
        var ownerCell = document.createElement('td');
        ownerCell.setAttribute("style","white-space: nowrap");
        ownerCell.appendChild(cellContent);
        objectsRow.appendChild(ownerCell); 

        propertiesTable.appendChild (objectsRow);

        if (Boolean(object.owner)) {
          memberGet(object.owner).then(function(thisOwner) {
            ownerCell.removeChild(ownerCell.firstChild);
            ownerCell.appendChild(memberLink(thisOwner));
          }).catch(function(error) {
            console.log("Error getting document:", error);
          });
        }; 
      }; 

      function refreshProperties() {
        emptyHTMLSet(propertiesTable);
        properties = null;
        propertiesGet().then(function(ps){
          if (ps.length){
            document.getElementById("propertiesTable_frame").style.display = "block";
            document.getElementById("properties_absentPhrase").style.display = "none";
            ps.forEach(function(p){loadProperty(p);});
          } else {
            document.getElementById("propertiesTable_frame").style.display = "none";
            document.getElementById("properties_absentPhrase").style.display = "block";
          };
        });
      };

      var propertiesLoaded = false;
      function loadProperties(){
      loadAll().then(function(){
        hideMenu();
        document.getElementById("logo-container").innerHTML = "Properties";
        if (!propertiesLoaded) {
          refreshProperties();
          propertiesLoaded = true;
        };
      });
      };

      function propertyLink(property) {
        var elA = document.createElement('button');
        elA.setAttribute("data-target", "propertyView");
        elA.setAttribute('class','modal-trigger');
        elA.setAttribute('style','border:none;background-color:Transparent');
        elA.setAttribute('onclick','setSelectedProperty('+JSON.stringify(property.idFS)+','+JSON.stringify(property)+',"")');
        elA.innerHTML = "<font color='#0000FF'>"+property.code+"</font>";
        return elA;
      };

      function addProperty(){
       if (validateAddPropertyEntries()) {  
        var entries = getAddPropertyEntries();
        refCoproperty.collection("Properties").where("code", "==", entries.code).get().then(function(existingList) {
            if (existingList.docs.length > 0) {
              M.toast({html:"Error: property with this code already exists"}); 
              document.getElementById("propertyAddButton").disabled=false;
            } else {
              refCoproperty.collection("Properties").add(entries).then(function(pFS) {
                  memberGet(entries.owner).then(function (ownerHere){
                    var docUserRef = firestore.collection("Users").doc(ownerHere.email);
                    docUserRef.get().then(function(user){
                      if (!user.exists)  {
                        firestore.collection("Users").doc(ownerHere.email).set({}).then(function(x){
                          refreshProperties();
                          setSelectedProperty(pFS.id, entries);
                          M.Modal.getInstance(document.getElementById("propertyAdd")).close();
                          M.Modal.getInstance(document.getElementById("propertyView")).open();
                        });
                      }else {
                        refreshProperties();
                        setSelectedProperty(pFS.id, entries);
                        M.Modal.getInstance(document.getElementById("propertyAdd")).close();
                        M.Modal.getInstance(document.getElementById("propertyView")).open();
                      };
                    });
                      
                    
                  });
                }).catch(function(error) {
                  M.toast({html:"Error occurred adding this property:" + error}); 
                });
            };
          }).catch (function(error) {
            M.toast({html:"Error occurred checking code uniqueness:" + error}); 
          });
       };
      };

      function updateProperty(property){
        refCoproperty.collection("Properties").doc(selectedPropertyId).update(property)
          .then(function(docref) {
            refreshProperties();
            selectedPropertyObject.code=property.code;
            selectedPropertyObject.type=property.type;
            selectedPropertyObject.cellar=property.cellar;
            selectedPropertyObject.owner=property.owner;
            /*document.getElementById("property_code").value=property.code;
            document.getElementById("property_type").value=PropType[property.type];
            document.getElementById("property_cellar").value=property.cellar;*/
            setSelectedProperty(selectedPropertyId,selectedPropertyObject);
            document.getElementById("property_owner").value=property.owner;
            M.Modal.getInstance(document.getElementById("propertyWrite")).close();
          }).catch(function(error) {
            M.toast({html:"Error occurred updating this property:" + error}); 
          });
      };

      function writeProperty() {
        if (validateEditPropertyEntries()) {  
          var entries = getEditPropertyEntries();
          if (! (entries.code.normalize() === selectedPropertyObject.code.normalize())) {
            refCoproperty.collection("Properties").where("code", "==", entries.code).get()
              .then(function(existingList) {
                if (existingList.docs.length > 0) {
                  M.toast({html:"Error: property with this code already exists"}); 
                  document.getElementById("propertyWriteButton").disabled=false;
                } else {
                    updateProperty(entries);
                  };
              }) .catch (function(error) {
                M.toast({html:"Error occurred checking code uniqueness:" + error}); 
              });
          } else {
                  updateProperty(entries);
          };
        };
      };

      function enableOccupantAdd() {
        document.getElementById("buttonOccupantAdd").setAttribute("class","btn-floating waves-light");
      };

      function disableOccupantAdd() {
        document.getElementById("buttonOccupantAdd").setAttribute("class","btn-floating waves-light disabled");
      }

      var selectedPropertyId;
      var selectedPropertyObject;
      var selectedPropertyOccupants;
      var selectedMeterId;
      var selectedMeterData;
      var occupantsTable = document.getElementById("property_occupants");
      var metersTable = document.getElementById("property_meters");
      var handlingCopropertyMeter = false;
        
      function displayOccupant(propertyId,occupant){
        /*refCoproperty.collection("Members").doc(occupant.data().occupant).get().then(function(member) {*/
        memberGet(occupant.data().occupant).then(function(member) {
          var objectsRow= document.createElement('tr');
          var cell = document.createElement('td');
          var cellContent = memberLink(member);
          cell.appendChild(cellContent);
          objectsRow.appendChild(cell); 
          if (currentUser.role == roleAdministrator || currentUser.id == selectedPropertyObject.owner) {
            cell = document.createElement('td');
            cellContent = document.createElement('a'); 
            cellContent.setAttribute('style',"float: right");
            cellContent.setAttribute('class','waves-light btn-floating red');
            cellContent.setAttribute('onclick','removeOccupant('+JSON.stringify(propertyId)+',' +JSON.stringify(occupant.id)+')');
            objectsRow.setAttribute("id", occupant.id)
            cellButtonIcon = document.createElement('i');
            cellButtonIcon.setAttribute('class','material-icons right');
            cellButtonIcon.innerHTML="delete";           
            cellContent.appendChild(cellButtonIcon);
            cell.appendChild(cellContent);
            objectsRow.appendChild(cell); 
          };
          occupantsTable.appendChild (objectsRow);
        }).catch (function(error) {
          M.toast({html:"Error occurred during displaying occupant:" + error}); 
        });
      };

      function toggleMeter(){
        var digitsString = document.getElementById("meter_digits").value;
        var decimalsString = document.getElementById("meter_decimals").value;
        var digits = Number(digitsString);
        var decimals = Number(decimalsString);
        if ((digitsString != "") && (decimalsString != "") && ((!selectedMeterData)|| (selectedMeterData.readings.length < 2))) {
          document.getElementById("meter_initialReading_edit").disabled= false;
          document.getElementById("meterinitialReading_picture_button").setAttribute("class","btn-small ");
          meterFormat("meter_initialReading", digits, decimals);
        } else {
          document.getElementById("meter_initialReading_edit").disabled= true;
          document.getElementById("meterinitialReading_picture_button").setAttribute("class","btn-small disabled");
          document.getElementById("meter_initialReading_helper_edit").innerHTML =  "";
          document.getElementById("meter_initialReading_helper_edit").setAttribute("data-error", "");
        };
      };
       
      function editMeter(meter, meterData){
        selectedMeterId = meter;
        selectedMeterData = meterData;
        handlingCopropertyMeter = false;
        document.getElementById("meter_type").value=meterData.type;
        document.getElementById("meter_id").value=meterData.meter;
        document.getElementById("meter_status").value=meterData.status;
        document.getElementById("meter_digits").value=meterData.digits;
        document.getElementById("meter_decimals").value=meterData.decimals;
        document.getElementById("meter_initialReading_edit").value=meterData.readings[0].reading;
        document.getElementById("meterSubmitButton").disabled=false;
        toggleMeter();
        if (meterData.readings[0].picture){
          picturePresent = true;
          document.getElementById("meterInitialReading_picture_form").style.display = "none";
          document.getElementById("meterInitialReading_picture_edit_frame").style.display = "block";
          refCopropertyFiles.child(selectedPropertyId).child("Meters").child(meter).child("0").getDownloadURL().then(function(url) {
            document.getElementById("meterInitialReading_picture_edit_img").setAttribute("src",url);
            var elems = document.querySelectorAll('select');
            M.FormSelect.init(elems);
            M.updateTextFields();
          });
        } else { 
          prepareNoInitialPicture();
          var elems = document.querySelectorAll('select');
          M.FormSelect.init(elems);
          M.updateTextFields();
        };
      };

      function prepareNoInitialPicture(){
        document.getElementById("meterInitialReading_picture_form").style.display = "block";
        document.getElementById("meterInitialReading_picture_edit_frame").style.display = "none";
        document.getElementById("meterInitialReading_picture_edit_file").value = [];
        document.getElementById("meterInitialReading_picture_edit_text").value="";
        picturePresent = false;
      };
      
      function addMeter(property){
        selectedMeterId = "";
        selectedMeterData = null;
        document.getElementById("meter_type").value="";
        document.getElementById("meter_id").value="";
        document.getElementById("meter_status").value="ACTIF";
        document.getElementById("meter_digits").value="";
        document.getElementById("meter_decimals").value="";
        document.getElementById("meter_initialReading_edit").value="";
        toggleMeter();
        prepareNoInitialPicture();
        document.getElementById("meterSubmitButton").disabled=false;
        var elems = document.querySelectorAll('select');
        M.FormSelect.init(elems);
        M.updateTextFields();
      };

      function removeInitialPicture(){
        prepareNoInitialPicture();
        M.Modal.getInstance(document.getElementById("initialPictureRemove")).close();
      };
      

      function showPictureMeterInitialReadingEdit (){
        if (document.getElementById("meterInitialReading_picture_edit_text").value){
          if (reduceImage( document.getElementById('meterInitialReading_picture_edit_file').files[0], "meterInitialReading_picture_edit_img")){
            document.getElementById("meterInitialReading_picture_form").style.display = "none";
            document.getElementById("meterInitialReading_picture_edit_frame").style.display = "block";
          } else {removeInitialPicture()}
        };
      };

      function validateMeterEntries(){
        var valid= true;
        if (!document.getElementById("meter_type").checkValidity()) {
          M.toast({html:"Please enter Type"});
          valid=false;
        };
        if (!document.getElementById("meter_id").checkValidity()) {
          M.toast({html:"Please enter valid Meter ID"});
          valid=false;
        };
        if (!document.getElementById("meter_status").checkValidity()) {
          M.toast({html:"Please enter Status"});
          valid=false;
        };
        if (!document.getElementById("meter_digits").checkValidity()) {
          M.toast({html:"Please enter number of digits before the comma"});
          valid=false;
        };
        if (!document.getElementById("meter_decimals").checkValidity()) {
          M.toast({html:"Please enter number of digits after the comma"});
          valid=false;
        };
        if (!document.getElementById("meter_initialReading_edit").checkValidity()) {
          M.toast({html:"Please enter valid reading"});
          valid=false;
        };
        
        if (!valid) {
          document.getElementById("meterSubmitButton").disabled=false;
          
        };
        return valid;
      };
      
      function writeMeter(){
        if (validateMeterEntries()) {
          M.Modal.getInstance(document.getElementById("loading")).open();
          var entries = {
            type: document.getElementById("meter_type").value,
            meter: document.getElementById("meter_id").value,
            status: document.getElementById("meter_status").value,
            digits: Number(document.getElementById("meter_digits").value),
            decimals: Number(document.getElementById("meter_decimals").value),
            readings:[{}],
          };
          entries.readings[0].reading = Number(document.getElementById("meter_initialReading_edit").value);
          entries.readings[0].date = currentCoproperty.initialStartDate;
          entries.readings[0].counter = 0;
          entries.readings[0].updatedBy = currentUser.id;
          var newPicture = false;
          var thisRefFS;
          var fileStoreRef;
          if (((!selectedMeterId) && handlingCopropertyMeter) || (selectedMeterId && Boolean(selectedMeterData.coproperty))){
            thisRefFS = refCoproperty;
            fileStoreRef = refCopropertyFiles;
            entries.coproperty = true;
          } else {
            thisRefFS = refCoproperty.collection("Properties").doc(selectedPropertyId);
            fileStoreRef = refCopropertyFiles.child(selectedPropertyId);
            entries.coproperty = false;
          };
          if (selectedMeterId) {
            if (document.getElementById("meterInitialReading_picture_edit_text").value){entries.readings[0].picture = true; newPicture = true}
            else {entries.readings[0].picture = picturePresent};
            thisRefFS.collection("Meters").doc(selectedMeterId).update(entries).then(function(docrefmeter) {
              if (newPicture){
                /*var pictureFile = document.getElementById('meterInitialReading_picture_edit_file').files[0];*/
                var fileRef = fileStoreRef.child("Meters").child(selectedMeterId).child("0");  
                fileRef.put(canvasBlob).then (function (){
                  meterReadingsLoaded = false;
                  if (entries.coproperty){refreshCopropertyMeters();}
                  else {displayMeters(selectedPropertyId)};
                  M.Modal.getInstance(document.getElementById("loading")).close();
                  M.Modal.getInstance(document.getElementById("meterWrite")).close();
                }).catch(function(error) {
                  M.Modal.getInstance(document.getElementById("loading")).close();
                  M.toast({html:"Error occurred editing picture initial reading:" + error}); 
                });  
              } else {
                meterReadingsLoaded = false;
                if (entries.coproperty){refreshCopropertyMeters();}
                else {displayMeters(selectedPropertyId)};
                M.Modal.getInstance(document.getElementById("loading")).close();
                  M.Modal.getInstance(document.getElementById("meterWrite")).close();
              };
            }).catch(function(error) {
              M.Modal.getInstance(document.getElementById("loading")).close();
              M.toast({html:"Error occurred editing meter:" + error}); 
            });
          } else {
            if (document.getElementById("meterInitialReading_picture_edit_text").value){entries.readings[0].picture = true; newPicture = true}
            else {entries.readings[0].picture = false};
            thisRefFS.collection("Meters").add(entries).then(function(docrefmeter) {
              if (newPicture){
                /*var pictureFile = document.getElementById('meterInitialReading_picture_edit_file').files[0];*/
                var fileRef = fileStoreRef.child("Meters").child(docrefmeter.id).child("0");  
                fileRef.put(canvasBlob).then (function (){
                  handlingCopropertyMeter = false;
                  meterReadingsLoaded = false;
                  if (entries.coproperty){refreshCopropertyMeters();}
                  else {displayMeters(selectedPropertyId)};
                  M.Modal.getInstance(document.getElementById("loading")).close();
                  M.Modal.getInstance(document.getElementById("meterWrite")).close();
                }).catch(function(error) {
                  M.Modal.getInstance(document.getElementById("loading")).close();
                  M.toast({html:"Error occurred editing picture initial reading:" + error}); 
                });  
              } else {
                handlingCopropertyMeter = false;
                meterReadingsLoaded = false;
                if (entries.coproperty){refreshCopropertyMeters();}
                else {displayMeters(selectedPropertyId)};
                M.Modal.getInstance(document.getElementById("loading")).close();
                M.Modal.getInstance(document.getElementById("meterWrite")).close();
              };
            }).catch(function(error) {
              M.Modal.getInstance(document.getElementById("loading")).close();
              M.toast({html:"Error occurred editing meter:" + error}); 
            });
          };
        };
      };

      
      
      function displayMeter(meterFS){
        var meterData = meterFS.data();
        var objectsRow= document.createElement('tr');
        var cell = document.createElement('td');
        var cellContent = document.createTextNode(MeterType[meterData.type]);
        cell.appendChild(cellContent);
        objectsRow.appendChild(cell); 

        cell = document.createElement('td');
        cellContent = document.createTextNode(meterData.meter);
        cell.appendChild(cellContent);
        objectsRow.appendChild(cell);

        cell = document.createElement('td');
        cellContent = document.createTextNode(MeterStatus[meterData.status]);
        cell.appendChild(cellContent);
        objectsRow.appendChild(cell);

        if (currentUser.role == roleAdministrator) {
          cell = document.createElement('td');
          cellContent = document.createElement('button'); 
          cellContent.setAttribute('class','waves-light btn-floating modal-trigger');
          cellContent.setAttribute("data-target", "meterWrite");
          cellContent.setAttribute('onclick','editMeter('+JSON.stringify(meterFS.id)+',' +JSON.stringify(meterData)+')');
          var cellButtonIcon = document.createElement('i');
          cellButtonIcon.setAttribute('class','material-icons right');
          cellButtonIcon.innerHTML="edit";         
          cellContent.appendChild(cellButtonIcon);
          cell.appendChild(cellContent);
          objectsRow.appendChild(cell); 
        };
        if (Boolean(meterData.coproperty)) {copropertyMetersTable.appendChild (objectsRow);}
        else {metersTable.appendChild (objectsRow);};
      };
      
      
      function addOccupant() {
        var selectedOccupant = document.getElementById("property_occupant_add").value;
        var collRef = refCoproperty.collection("Properties").doc(selectedPropertyId).collection("Occupants");
        collRef.where("occupant", "==", selectedOccupant).get()
        .then(function(existingList) {
          if (existingList.docs.length > 0) {
            M.toast({html:"Error: This member is already occupant"}); 
          } else {
              collRef.add({occupant:selectedOccupant}).then(function(docRef){
                docRef.get().then(function(newOccupant) {
                  displayOccupant(selectedPropertyId,newOccupant);
                  document.getElementById("property_occupant_add").value = "";
                  disableOccupantAdd();
                  var elems = document.querySelectorAll('select');
                  M.FormSelect.init(elems);
                });
              });
            };
        }) .catch (function(error) {
          M.toast({html:"Error occurred checking code uniqueness:" + error}); 
        });
      };
      
      function removeOccupant(property,occupant){
        refCoproperty.collection("Properties").doc(property).collection("Occupants").doc(occupant).delete().then(function(){
          document.getElementById(occupant).remove();
        }).catch(function(error) {
            M.toast({html:"Error removing occupant:" + error});
        });
      };

      function listMembers(el, selectedOption) {
        var option;
        emptyHTMLSet(el);
        if (!Boolean(selectedOption)) {
          option = document.createElement("option");
          option.setAttribute("value","");
          option.setAttribute("disabled",true);
          option.setAttribute("selected",true);
          option.innerHTML = "Select Member<b><font color='red'>*</font></b>";
          el.appendChild(option);
        };
        refCoproperty.collection("Members").get().then(function(querySnapshot) {
          querySnapshot.forEach(function(member) {
             option = document.createElement("option");
              option.setAttribute("value",member.id);
              if (member.id == selectedOption) {option.setAttribute("selected",true);};
              option.innerHTML = denomination(member.data());
              el.appendChild(option);
          });
          var elems = document.querySelectorAll('select');
          M.FormSelect.init(elems);
        });  
      };

      function listOwners(el, selectedOption, mandatory) {
        var option;
        emptyHTMLSet(el);
        if (!Boolean(selectedOption) ||(!mandatory)) {
          option = document.createElement("option");
          option.setAttribute("value","");
          if (mandatory){option.setAttribute("disabled",true);};
          option.setAttribute("selected",true);
          if (mandatory){option.innerHTML = "Select Owner<b><font color='red'>*</font></b>";}
          else {option.innerHTML = "Select Owner";}
          el.appendChild(option);
        };
        membersGet().then(function(membersHere) {
          membersHere.forEach(function(memberHere) {
            propertiesBy(memberHere).then(function (ps){
              if (ps.length) {
                option = document.createElement("option");
                option.setAttribute("value",memberHere.idFS);
                if (memberHere.idFS == selectedOption) {option.setAttribute("selected",true);};
                option.innerHTML = denomination(memberHere);
                el.appendChild(option);
              };
              var elems = document.querySelectorAll('select');
              M.FormSelect.init(elems);  
            });
          });
        });  
      };
      
      function displayOccupants(property) {
        emptyHTMLSet(occupantsTable);
        refCoproperty.collection("Properties").doc(property).collection("Occupants").get().then( function (querySnapshot) {
          if (Boolean(querySnapshot)) {
            querySnapshot.forEach(function(occupant) {
              displayOccupant(property,occupant);
            });
          };
        });
        listMembers(document.getElementById("property_occupant_add"),"");   
      };

      
      function displayMeters(property) {
        emptyHTMLSet(metersTable);
        refCoproperty.collection("Properties").doc(property).collection("Meters").get().then( function (querySnapshot) {
          if (Boolean(querySnapshot)) {
            querySnapshot.forEach(function(meterFS) {displayMeter(meterFS);});
          };
        });  
      };

      function displayMember(el,memberId){
        // displays the member into a yet defined HTML hyperlink element
        M.toast({html:"System eroor: displayMember."});
        /*refCoproperty.collection("Members").doc(memberId).get().then(function(member) {
              el.setAttribute('onclick','setSelectedMember('+JSON.stringify(member.id)+','+JSON.stringify(member.data())+',"")');
              el.innerHTML = "<u><font color='blue'>"+member.data().firstName + " " + member.data().lastName+"</font></u>";
              el.setAttribute("style","white-space: nowrap");
        });
        */
      };

      function createMemberLink(memberId){
        // creates the member HTML hyperlink element
        var el = document.createElement('a');
        el.setAttribute("data-target", "memberView");
        el.setAttribute('class','btn-flat modal-trigger');
        displayMember(el,memberId);
        return el;
      };
      
      function setSelectedProperty(id,object) {
        selectedPropertyId=id;
        selectedPropertyObject=object;
        if (currentUser.role == roleAdministrator || currentUser.id == selectedPropertyObject.owner){
          document.getElementById("Properties_OccupantsAdd").setAttribute("class","displayBlock");
          document.getElementById("buttonOccupantAdd").setAttribute("class","btn-floating waves-light disabled");
        } else {
          document.getElementById("Properties_OccupantsAdd").setAttribute("class","displayHidden");
        };
        document.getElementById("property_code").value=object.code;
        document.getElementById("property_type").value=PropType[object.type];
        document.getElementById("property_cellar").value=object.cellar;
        document.getElementById("property_updatedOn").innerHTML  = object.updatedOn;
        memberGet(object.updatedBy).then(function(updater) {
              emptyHTMLSet(document.getElementById("property_updatedBy"));
              document.getElementById("property_updatedBy").appendChild(memberLink(updater));
              memberGet(object.owner).then().then(function(ownerMember) {
                emptyHTMLSet(document.getElementById("property_owner"));
                document.getElementById("property_owner").appendChild(memberLink(ownerMember));

                displayOccupants(id); 
                displayMeters(id);
                var elems = document.querySelectorAll('select');
                M.FormSelect.init(elems);
                M.updateTextFields();
              });
        });
        /*
        refCoproperty.collection("Properties").doc(id).collection("PreviousOwners").get().then(function(existingList) {
          if (existingList.docs.length > 0) {
            document.getElementById("previousOwnersButton").setAttribute("class","displayBlock");
          } else {
            document.getElementById("previousOwnersButton").setAttribute("class","displayHidden");
          };
        */
        
      };

      function resetSelectedProperty() {
        selectedPropertyId=null;
        selectedPropertyObject=null;
        document.getElementById("property_code_add").value="";
        document.getElementById("property_type_add").value="";
        document.getElementById("property_cellar_add").value="";
        document.getElementById("property_owner_add").value="";
        listMembers(document.getElementById("property_owner_add"),"");
        document.getElementById("propertyAddButton").disabled=false;
        M.updateTextFields();
        M.FormSelect.init(document.querySelectorAll('select'));
      };

      function validateAddPropertyEntries() {
        var valid= true;
        if (!document.getElementById("property_code_add").checkValidity()) {
          M.toast({html:"Please enter Code"});
          valid=false;
        };
        if (!document.getElementById("property_type_add").checkValidity()) {
          M.toast({html:"Please enter valid Type"});
          valid=false;
        };
        if (!document.getElementById("property_owner_add").checkValidity()) {
          M.toast({html:"Please select Owner"});
          valid=false;
        };
        if (!valid) {document.getElementById("propertyAddButton").disabled=false;};
        return valid;
      };

      function validateEditPropertyEntries() {
        var valid= true;
        if (!document.getElementById("property_code_edit").checkValidity()) {
          M.toast({html:"Please enter Code"});
          valid=false;
        };
        if (!document.getElementById("property_type_edit").checkValidity()) {
          M.toast({html:"Please enter valid Type"});
          valid=false;
        };
        if (!document.getElementById("property_owner_edit").checkValidity()) {
          M.toast({html:"Please select Owner"});
          valid=false;
        };
        if (!valid) {document.getElementById("propertyWriteButton").disabled=false;};
        return valid;
      };

      function getAddPropertyEntries() {
        return Object.assign({
              code: document.getElementById("property_code_add").value,
              type: document.getElementById("property_type_add").value,
              cellar: document.getElementById("property_cellar_add").value,
              owner: document.getElementById("property_owner_add").value,
            },getUpdateInfo());
      };

      function getEditPropertyEntries() {
        return Object.assign({
              code: document.getElementById("property_code_edit").value,
              type: document.getElementById("property_type_edit").value,
              cellar: document.getElementById("property_cellar_edit").value,
              owner: document.getElementById("property_owner_edit").value,
            },getUpdateInfo());
      };

      function setEditPropertyEntries() {
        document.getElementById("property_code_edit").value=selectedPropertyObject.code;
        document.getElementById("property_type_edit").value=selectedPropertyObject.type;
        document.getElementById("property_cellar_edit").value=selectedPropertyObject.cellar;
        listMembers(document.getElementById("property_owner_edit"), selectedPropertyObject.owner);
        document.getElementById("property_owner_edit").value=selectedPropertyObject.owner;
        document.getElementById("propertyWriteButton").disabled=false;
        M.updateTextFields();
        M.FormSelect.init(document.querySelectorAll('select')); 
      };

      function newOwner() {
        document.getElementById("property_transferDate").value="";
        document.getElementById("property_newOwner").value="";
        listMembers(document.getElementById("property_newOwner"),"");
        M.updateTextFields();
        M.FormSelect.init(document.querySelectorAll('select'));
      };

      function validateNewOwnerEntries() {
        var valid= true;
        if (!document.getElementById("property_transferDate").checkValidity()) {
          M.toast({html:"Please enter Code"});
          valid=false;
        };
        if (!document.getElementById("property_newOwner").checkValidity()) {
          M.toast({html:"Please enter valid Quota"});
          valid=false;
        };
        return valid;
      };

      function getNewOwnerEntries(){
        return {
              date: document.getElementById("property_transferDate").value,
              owner: document.getElementById("property_newOwner").value,
            };
      };


      var previousOwnerId;
      function setPreviousOwner(poId, poObject) {
        previousOwnerId = poId;
        listMembers(document.getElementById("property_previousOwner"), poObject.owner); 
        document.getElementById("property_transferDatePrevious").value = poObject.date;
        M.updateTextFields();
        M.FormSelect.init(document.querySelectorAll('select'));
      };

      function writeNewOwner() {
        if (validateNewOwnerEntries()) {  
          var entries = getNewOwnerEntries();
          if (entries.owner == selectedPropertyObject.owner) {
            M.toast({html:"Error: new and existing owner must be different"});
          } else {
            refCoproperty.collection("Properties").doc(selectedPropertyId).update({owner:(entries.owner)})
              .then(function(docrefProperty) {
                var po = {
                  owner: selectedPropertyObject.owner,
                  date: entries.date,
                };
                refCoproperty.collection("Properties").doc(selectedPropertyId).collection("PreviousOwners").add(po).then(function(docrefPreviousOwner) {
                  refreshProperties();
                  displayMember(document.getElementById("property_owner"),entries.owner);
                  document.getElementById("previousOwnersButton").setAttribute("class","displayBlock");
                  M.Modal.getInstance(document.getElementById("newOwner")).close();
                }).catch(function(error) {
                  M.toast({html:"Error occurred updating current owner:" + error}); 
                });
              }).catch(function(error) {
                M.toast({html:"Error occurred updating previous owners:" + error}); 
              });
          };
        };
      };

      var propertyPreviousOwnersTable = document.getElementById("propertyPreviousOwnersTable");

      function loadPreviousOwner(objectFS){
        var object = objectFS.data();
        var objectsRow= document.createElement('tr');
        var cellContent = createMemberLink(object.owner);
        var cell = document.createElement('td');
        cell.appendChild(cellContent);
        objectsRow.appendChild(cell);
        
        cellContent = document.createTextNode(object.date);
        cell = document.createElement('td');
        cell.appendChild(cellContent);
        objectsRow.appendChild(cell);  
        
        cellContent = document.createElement('button');
        cellContent.setAttribute("data-target", "previousOwner");
        cellContent.setAttribute('class','btn-small waves-light modal-trigger');
        cellContent.setAttribute('onclick','setPreviousOwner('+JSON.stringify(objectFS.id)+','+JSON.stringify(object)+')');
        cellContent.innerHTML = "Edit";

        cell = document.createElement('td');
        cell.appendChild(cellContent);
        objectsRow.appendChild(cell);    
        
        propertyPreviousOwnersTable.appendChild (objectsRow);
      };
      
      function showPreviousOwnersTable(){
        emptyHTMLSet(propertyPreviousOwnersTable);
        refCoproperty.collection("Properties").doc(selectedPropertyId).collection("PreviousOwners").orderBy("date").get().then(function(objectsFSArray){
          objectsFSArray.forEach(function(objectFS){
            loadPreviousOwner(objectFS);
          });
        });
      };

      function validatePreviousOwnerEntries(){
        var valid= true;
        if (!document.getElementById("property_previousOwner").checkValidity()) {
          M.toast({html:"Please enter Owner"});
          valid=false;
        };
        if (!document.getElementById("property_transferDatePrevious").checkValidity()) {
          M.toast({html:"Please enter Transfer Date"});
          valid=false;
        };
        return valid;
      };
      
      function getPreviousOwnerEntries() {
        return {
              owner: document.getElementById("property_previousOwner").value, 
              date: document.getElementById("property_transferDatePrevious").value,
              };
      };
      
      function writePreviousOwner(){
        
        if (validatePreviousOwnerEntries()) {
          var entries = getPreviousOwnerEntries();
          
          refCoproperty.collection("Properties").doc(selectedPropertyId).collection("PreviousOwners").doc(previousOwnerId).set(entries).then(function(docrefPreviousOwner) {
            showPreviousOwnersTable();
            M.Modal.getInstance(document.getElementById("previousOwner")).close();
          }).catch(function(error) {
            M.toast({html:"Error occurred updating previous owner:" + error}); 
          });
        };
      };
    </script>
    <!--   Settings scripts start here -->
    <script>
      var copropertyMetersLoaded = false;
      var copropertyMetersTable = document.getElementById("coproperty_meters");
      
      function refreshCopropertyMeters() {
        emptyHTMLSet(copropertyMetersTable);
        refCoproperty.collection("Meters").get().then( function (querySnapshot) {
          if (Boolean(querySnapshot)) {
            querySnapshot.forEach(function(meterFS) {displayMeter(meterFS);});
          };
        });  
      };
      var costCentersLoaded = false;
      var costCenters = null;
      async function costCentersGet(){
        if (costCenters) {return costCenters;}
        else {
          var querySnapshot = await refCoproperty.collection("CostCenters").orderBy("name").get();
          costCenters = [];
          querySnapshot.forEach(function(objectFS) {
            var thisObject = objectFS.data();
            thisObject.idFS = objectFS.id;
            costCenters.push(thisObject);
          });
          return costCenters;
        };
      };   

      async function costCenterGet(id){
        function checkId(cc){return cc.idFS == id};
        if (id == "PRIVA") {return {name: "private"}}
        else {
          var ccs = await costCentersGet();
          return ccs.find(checkId);
        };
      };

      function listCostCenters(el, mandatory, selectedOption) {
        var option;
        emptyHTMLSet(el);
        if (!Boolean(selectedOption) ||(!mandatory)) {
          option = document.createElement("option");
          option.setAttribute("value","");
          if (mandatory){option.setAttribute("disabled",true);};
          option.setAttribute("selected",true);
          if (mandatory){option.innerHTML = "Select Cost Center<b><font color='red'>*</font></b>";}
          else {option.innerHTML = "Select Cost Center";}
          el.appendChild(option);
        };
        costCentersGet().then(function(querySnapshot) {
          querySnapshot.forEach(function(cc) {
              option = document.createElement("option");
              option.setAttribute("value",cc.idFS);
              if (cc.idFS == selectedOption) {option.setAttribute("selected",true);};
              option.innerHTML = cc.name;
              el.appendChild(option);
            });
          var elems = document.querySelectorAll('select');
          M.FormSelect.init(elems);
        });       
      };     
      
      function getCostCentersUpdateInfo(){
        return {
          costCentersUpdatedOn: getToDaysDate(),
          costCentersUpdatedBy: currentUser.id
        };
      };
      async function costCenterAdd(ccName){
        var cc = {
          name: ccName,
          distribution: {},
        };
        refCoproperty.collection("CostCenters").add(cc).then(function(newCC) {
          refCoproperty.update(getCostCentersUpdateInfo()).then(function(){
            refCoproperty.update(getCostCentersUpdateInfo()).then(function(){
              refreshCostCenters();
              refreshHome();
            });
          });
        });
      };

      async function costCenterNameEdit(id, newName){
        refCoproperty.collection("CostCenters").doc(id).update({"name": newName}).then(function(newCC) {  
          refCoproperty.update(getCostCentersUpdateInfo()).then(function(){refreshCostCenters();});
        });
      };

      async function costCenterQuotaEdit(ccId, pId, newQuota){
        var update = {};
        update["distribution."+pId] = newQuota;
        refCoproperty.collection("CostCenters").doc(ccId).update(update).then(function() {  
          refCoproperty.update(getCostCentersUpdateInfo()).then(function(){
            refreshCostCenters();
            });
        });
      };

      function costCenterAddPrepare(){
        if (document.getElementById("costCenter_name_add").checkValidity()) {
          costCenterAdd(document.getElementById("costCenter_name_add").value).then(function(cc) {
            refreshCostCenters();
            M.Modal.getInstance(document.getElementById("costCenterAdd")).close();
            document.getElementById("costCenter_name_add").value ="";
            document.getElementById("costCenterAddSubmitButton").disabled=false;
          })
        }  else {
          M.toast({html:"Please enter cost center name"});
          document.getElementById("costCenterAddSubmitButton").disabled=false;
        };
      };

      
      var selectedCostCenterId = null;
      function costCenterSelect(id, name){
        selectedCostCenterId = id;
        document.getElementById("costCenter_name_edit").value = name ;
        M.updateTextFields();
      };
      var selectedCCPropertyId = null;
      function costCenterQuotaSelect(ccId, pId, quota){
        selectedCostCenterId = ccId;
        selectedCCPropertyId = pId;
        if (quota == null) {quota = 0};
        document.getElementById("costCenter_quota_edit").value = quota ;
        M.updateTextFields();
      };
      var costCenter_to_remove;
      function prepareRemoveCostCenter(cc){
        document.getElementById("costCenter_to_remove").innerHTML=cc.name;
        costCenter_to_remove = cc;
      };
      function removeCostCenter(){
        refCoproperty.collection("Transactions").where("costCenter","==",costCenter_to_remove.idFS).get().then(function(trArray){
          if (trArray.length>0) {
            M.toast({html:"Cost Center is in use and cannot be removed"});
          } else {
            refCoproperty.collection("CostCenters").doc(costCenter_to_remove.idFS).delete().then(function(){
              refreshCostCenters();
              M.Modal.getInstance(document.getElementById("costCenterPrepareRemove")).close();
            }).catch(function(error) {
                M.toast({html:"System error removing cost center:" + error});
            });
          };
        });
      
      }; 

      function costCenterNameEditPrepare(){
        if (document.getElementById("costCenter_name_edit").checkValidity()) {
          costCenterNameEdit(selectedCostCenterId, document.getElementById("costCenter_name_edit").value).then(function() {
            refreshCostCenters();
            M.Modal.getInstance(document.getElementById("costCenterNameEdit")).close();
          })
        } else {
          M.toast({html:"Please enter cost center name"});
        };
      }; 
 
      function costCenterQuotaEditPrepare(){
        if (document.getElementById("costCenter_quota_edit").checkValidity()) {
          costCenterQuotaEdit(selectedCostCenterId, selectedCCPropertyId, Number(document.getElementById("costCenter_quota_edit").value)).then(function() {
            refreshCostCenters();
            M.Modal.getInstance(document.getElementById("costCenterQuotaEdit")).close();
          })
        } else {
          M.toast({html:"Please enter valid quota"});
        };
      };

      
      function refreshCostCenters() {
        refreshCopropertyCostCentersUpdateInfo();
        selectedCostCenterId = null; selectedCCPropertyId = null;
        costCenters = null;
        var ccBodyEl = document.getElementById("costCenters_tableBody");
        emptyHTMLSet(ccBodyEl);
        var ccHeadEl = document.getElementById("costCenters_tableHead");
        emptyHTMLSet(ccHeadEl);
        var headerCol = document.createElement("th");
        headerCol.innerHTML = "";
        ccHeadEl.appendChild(headerCol);
        costCentersGet().then(function (ccs){
          var totals = [];
          ccs.forEach(function(cc){
            headerCol = document.createElement("th");
            headerCol.setAttribute("style","text-align: right");
            /*headerCol.setAttribute("align","right");*/
            var headerText = document.createElement("b");
            headerText.setAttribute("style","writing-mode: vertical-rl");
            headerText.innerHTML = cc.name;
            headerCol.appendChild(headerText);
            ccHeadEl.appendChild(headerCol);
            totals[cc.name]=0;
            if (currentUser.role == roleAdministrator) {
              headerCol = document.createElement("th");
              var cellContent = document.createElement('button');
              cellContent.setAttribute("style", "float:left");
              cellContent.setAttribute("data-target", "costCenterNameEdit");
              cellContent.setAttribute('class','btn-floating waves-light modal-trigger');
              cellContent.setAttribute('onclick','costCenterSelect('+JSON.stringify(cc.idFS)+','+JSON.stringify(cc.name)+')');
              var cellButtonIcon = document.createElement('i');
              cellButtonIcon.setAttribute('class','material-icons right');
              cellButtonIcon.innerHTML="edit";         
              cellContent.appendChild(cellButtonIcon);
              headerCol.appendChild(cellContent);
              /*
              cellContent = document.createElement('button');
              cellContent.setAttribute("style", "float:left");
              cellContent.setAttribute("data-target", "costCenterPrepareRemove");
              cellContent.setAttribute('class','btn-floating waves-light modal-trigger red');
              cellContent.setAttribute('onclick','prepareRemoveCostCenter('+JSON.stringify(cc)+')');
              var cellButtonIcon = document.createElement('i');
              cellButtonIcon.setAttribute('class','material-icons right');
              cellButtonIcon.innerHTML="delete";         
              cellContent.appendChild(cellButtonIcon);
              headerCol.appendChild(cellContent);
              */
              ccHeadEl.appendChild(headerCol);
            };
          });
          propertiesGet().then(function(ps){
            ps.forEach(function(p){
              var row = document.createElement("tr");
              var cell = document.createElement("td");
              var cellContent = propertyLink(p);
              cell.appendChild(cellContent);
              row.appendChild(cell);

              ccs.forEach(function(cc){
                cell = document.createElement("td");
                cell.setAttribute("align","Center");
                cell.setAttribute("style","text-align: right");
                var quota = cc.distribution[p.idFS];
                if (quota) {
                  cell.innerHTML = quota;
                  totals[cc.name] += quota;
                };
                row.appendChild(cell);
                if (currentUser.role == roleAdministrator) {
                  cell = document.createElement("th");
                  cellContent = document.createElement('button');
                  cellContent.setAttribute("style", "float:left");
                  cellContent.setAttribute("data-target", "costCenterQuotaEdit");
                  cellContent.setAttribute('class','btn-floating waves-light modal-trigger');
                  if (!quota) {quota = 0};
                  cellContent.setAttribute('onclick','costCenterQuotaSelect('+JSON.stringify(cc.idFS)+','+JSON.stringify(p.idFS)+','+JSON.stringify(quota)+')');
                  var cellButtonIcon = document.createElement('i');
                  cellButtonIcon.setAttribute('class','material-icons right');
                  cellButtonIcon.innerHTML="edit";         
                  cellContent.appendChild(cellButtonIcon);
                  cell.appendChild(cellContent);
                  row.appendChild(cell);
                };
              });

              ccBodyEl.appendChild(row);
            });
            var totalsRow = document.createElement("tr");
            var cell = document.createElement("td");
            cell.innerHTML = "<b>Total quotas</b>";
            totalsRow.appendChild(cell);
            ccs.forEach(function(cc){
              var cell = document.createElement("td");
              cell.setAttribute("style","text-align: right");
              cell.innerHTML = totals[cc.name];
              totalsRow.appendChild(cell);
              if (currentUser.role == roleAdministrator) {
                  cell = document.createElement("th");
                  cellContent = document.createTextNode("");
                  cell.appendChild(cellContent);
                  totalsRow.appendChild(cell);
              };
            });
            ccBodyEl.appendChild(totalsRow);
          });
        });
      };
    
      var initialSaldosLoaded = false;
      var copropertyAttributesLoaded = false;
      function loadSettings() {
      loadAll().then(function(){
        hideMenu();
        document.getElementById("logo-container").innerHTML = "Settings";
        if (!copropertyMetersLoaded) {
          refreshCopropertyMeters();
          copropertyMetersLoaded = true;
        };
        if (!costCentersLoaded) {
          refreshCostCenters();
          costCentersLoaded = true;
        };
        if (!initialSaldosLoaded) {
          refreshInitialSaldos();
          initialSaldosLoaded = true;
        };
        if (!copropertyAttributesLoaded) {
          refreshCopropertyAttributes();
          copropertyAttributesLoaded = true;
        };
        refreshCopropertyUpdateInfo();
      });
      };

      function refreshCopropertyUpdateInfo() {
        document.getElementById("coproperty_updatedOn").innerHTML  = currentCoproperty.updatedOn;
        if (currentCoproperty.updatedBy == "SYSTE") {
          emptyHTMLSet(document.getElementById("coproperty_updatedBy"));
          document.getElementById("coproperty_updatedBy").appendChild(document.createTextNode("System"));
        } else {
        memberGet(currentCoproperty.updatedBy).then(function(updater) {
          emptyHTMLSet(document.getElementById("coproperty_updatedBy"));
          document.getElementById("coproperty_updatedBy").appendChild(memberLink(updater));
        });
        };
      };
      function refreshCopropertyCostCentersUpdateInfo() {
        document.getElementById("costCenters_updatedOn").innerHTML  = currentCoproperty.costCentersUpdatedOn;
        if (currentCoproperty.updatedBy == "SYSTE") {
          emptyHTMLSet(document.getElementById("costCenters_updatedBy"));
          document.getElementById("costCenters_updatedBy").appendChild(document.createTextNode("System"));
        } else {
          memberGet(currentCoproperty.costCentersUpdatedBy).then(function(updater) {
            emptyHTMLSet(document.getElementById("costCenters_updatedBy"));
            document.getElementById("costCenters_updatedBy").appendChild(memberLink(updater));
          });
        };
      };
      
      function addCopropertyMeter(){
        addMeter();
        handlingCopropertyMeter = true;
      };

      function toPercentageString(n) {
          return n * 100 + "%";
      }

      function refreshCopropertyAttributes(){
        var CAEl = document.getElementById("provisions");
        CAEl.innerHTML = currentCoproperty.provisions.toLocaleString("nl-BE",currencyStyle);
        CAEl = document.getElementById("provisionsCostCenterView");
        if (currentCoproperty.provisionsCC){
          costCenterGet(currentCoproperty.provisionsCC).then(function(cc){
            CAEl.innerHTML = "cost center : " + cc.name;
          })
        } else {CAEl.innerHTML = "";};
        var heatingCPEl = document.getElementById("heatingCommon");
        heatingCPEl.innerHTML = toPercentageString(currentCoproperty.heatingCommon);
      };
      
      function refreshInitialSaldos(){
        var ISEl = document.getElementById("initialSaldo");
        ISEl.innerHTML = currentCoproperty.initialSaldo.toLocaleString("nl-BE",currencyStyle);
        ISEl = document.getElementById("initialSaldos");
        emptyHTMLSet(ISEl);
        membersGet().then(function(membersHere){
          membersHere.forEach(function(memberHere){
            propertiesBy(memberHere).then(function(propertiesHere){
              if (propertiesHere.length) {
                var memberHereSaldo = 0;
                if(currentCoproperty.initialSaldos[memberHere.idFS]) {memberHereSaldo = currentCoproperty.initialSaldos[memberHere.idFS] };
                var row = document.createElement("tr");
                var column = document.createElement("td");
                column.appendChild(memberLink(memberHere));
                row.appendChild(column);
                column = document.createElement("td");
                column.innerHTML = memberHereSaldo.toLocaleString("nl-BE",currencyStyle) ;
                row.appendChild(column);
                if (currentUser.role == roleAdministrator) {
                  column = document.createElement("td");
                  var cellContent = document.createElement('button');
                  cellContent.setAttribute("style", "float:left");
                  cellContent.setAttribute("data-target", "initialSaldoEdit");
                  cellContent.setAttribute('class','btn-floating waves-light modal-trigger');
                  cellContent.setAttribute('onclick','initialSaldoSelect('+JSON.stringify(memberHere.idFS)+','+JSON.stringify(memberHereSaldo)+')');
                  var cellButtonIcon = document.createElement('i');
                  cellButtonIcon.setAttribute('class','material-icons right');
                  cellButtonIcon.innerHTML="edit";         
                  cellContent.appendChild(cellButtonIcon);
                  column.appendChild(cellContent);
                  row.appendChild(column);
                };
                ISEl.appendChild(row);
              };
            })
          })
        })
      };
      var selectedMemberForInitialSaldo;

      function initialSaldoSelect(memberIdFS, saldo) {
        selectedMemberForInitialSaldo = memberIdFS;
        document.getElementById("initialSaldo_amount").value = saldo;
        M.updateTextFields();
      };

      function initialSaldoWrite(){
        currentCoproperty.initialSaldos[selectedMemberForInitialSaldo]= Number(document.getElementById("initialSaldo_amount").value);
        refCoproperty.update(
          Object.assign({initialSaldos:currentCoproperty.initialSaldos},getUpdateInfo())
          ).then(function(){
          refreshHome();
          refreshInitialSaldos();
          M.Modal.getInstance(document.getElementById("initialSaldoEdit")).close();
        }).catch(function(error) {
          M.toast({html:"System error writing initial salso:" + error});
        });
      };

      function initialCopropertySaldoEditPrepare(){
        document.getElementById("initialCopropertySaldo_amount").value = currentCoproperty.initialSaldo;
        M.updateTextFields();
      };

      function provisionsEditPrepare(){
        document.getElementById("provisions_edit").value = currentCoproperty.provisions;
        listCostCenters(document.getElementById("provisions_costCenter_edit"),true, currentCoproperty.provisionsCC);
        var elems = document.querySelectorAll('select');
        M.FormSelect.init(elems);
        M.updateTextFields();
      };

      function heatingCommonEditPrepare(){
        document.getElementById("heatingCommon_edit").value = currentCoproperty.heatingCommon * 100;
        M.updateTextFields();
      };

      function initialCopropertySaldoWrite(){
        currentCoproperty.initialSaldo = Number(document.getElementById("initialCopropertySaldo_amount").value);
        refCoproperty.update(
          Object.assign({initialSaldo:currentCoproperty.initialSaldo},getUpdateInfo())
          ).then(function(){
          refreshHome();
          refreshInitialSaldos();
          M.Modal.getInstance(document.getElementById("initialCopropertySaldoEdit")).close();
        }).catch(function(error) {
          M.toast({html:"System error writing initial salso:" + error});
        });
      };

      function provisionsWrite(){
        currentCoproperty.provisions = Number(document.getElementById("provisions_edit").value);
        currentCoproperty.provisionsCC = document.getElementById("provisions_costCenter_edit").value;
        refCoproperty.update(
          Object.assign({provisions:currentCoproperty.provisions, provisionsCC:currentCoproperty.provisionsCC},getUpdateInfo())
          ).then(function(){
          refreshHome();
          refreshCopropertyAttributes();
          M.Modal.getInstance(document.getElementById("provisionsEdit")).close();
        }).catch(function(error) {
          M.toast({html:"System error writing provisions:" + error});
        });
      };

      function heatingCommonWrite(){
        currentCoproperty.heatingCommon = Number(document.getElementById("heatingCommon_edit").value) / 100;
        refCoproperty.update(
          Object.assign({heatingCommon:currentCoproperty.heatingCommon},getUpdateInfo())
          ).then(function(){
          refreshHome();
          refreshCopropertyAttributes();
          M.Modal.getInstance(document.getElementById("heatingCommonEdit")).close();
        }).catch(function(error) {
          M.toast({html:"System error writing common heating:" + error});
        });
      };

      function emptyDataCash() {
      homeLoaded = false;
      chargesReportsLoaded = false;
      chargesReports = null;
      documentsLoaded = false;
      documents = null;
      transactionsLoaded = false;
      transactionRulesLoaded = false;
      transactionRules = null;
      meterReadingsLoaded = false;
      /*meterReadings = null;*/
      membersLoaded = false;
      members = null;
      propertiesLoaded = false;
      properties = null;
      copropertyMetersLoaded = false;
      costCentersLoaded = false;
      costCenters = null;
      initialSaldosLoaded = false;
      copropertyAttributesLoaded = false;
      };
    </script>
    <!-- Charges report ----------------------------------------------------->
    <script>
      
      var headerCommon = [
        {id:"type",name:"type",prompt:"type",width: 35,align: "center",padding: 0},
        {id:"name",name:"name",prompt:"counter party",width: 50,align: "center",padding: 0},
        {id:"date",name:"date",prompt:"date",width: 35,align: "center",padding: 0},
        {id:"communication",name:"communication",prompt:"communication",width: 87,align: "center",padding: 0},
        {id:"amount",name:"amount",prompt:"amount",width: 38,align: "right",padding: 0}
      ];
      var headerPrivate = [
        {id:"name",name:"name",prompt:"counter party",width: 50,align: "center",padding: 0},
        {id:"date",name:"date",prompt:"date",width: 35,align: "center",padding: 0},
        {id:"communication",name:"communication",prompt:"communication",width: 87,align: "center",padding: 0},
        {id:"assignments",name:"assignments",prompt:"assigned to",width: 145,align: "center",padding: 0},
        {id:"amount",name:"amount",prompt:"amount",width: 38,align: "right",padding: 0}
      ];
      var headerWH = [
        {id:"name",name:"name",prompt:"counter party",width: 50,align: "center",padding: 0},
        {id:"date",name:"date",prompt:"date",width: 35,align: "center",padding: 0},
        {id:"communication",name:"communication",prompt:"communication",width: 122,align: "center",padding: 0},
        {id:"amount",name:"amount",prompt:"amount",width: 38,align: "right",padding: 0}
      ];
      
      var headerConsumption = [
        {id:"property",name:"property",prompt:"property",width: 20,align: "center",padding: 0},
        {id:"meter",name:"meter",prompt:"meter",width: 30,align: "center",padding: 0},
        {id:"type",name:"type",prompt:"type",width: 18,align: "center",padding: 0},
        {id:"last_reading",name:"last_reading",prompt:"last reading",width: 28,align: "center",padding: 0},
        {id:"reading",name:"reading",prompt:"new reading",width: 28,align: "center",padding: 0},
        {id:"difference",name:"difference",prompt:"difference",width: 28,align: "center",padding: 0},
        {id:"water",name:"water",prompt:"water consumed",width: 30,align: "center",padding: 0},
        {id:"water_payed",name:"water_payed",prompt:"water payed",width: 30,align: "center",padding: 0},
        {id:"water_regu",name:"water_regu",prompt:"water regularisation",width: 30,align: "center",padding: 0},
        {id:"heating",name:"heating",prompt:"heating consumed",width: 30,align: "center",padding: 0},
        {id:"heating_payed",name:"heating_payed",prompt:"heating  payed",width: 30,align: "center",padding: 0},
        {id:"heating_regu",name:"heating_regu",prompt:"heating regularisation",width: 30,align: "center",padding: 0},
      ];
      var emptyConsumptionLine = {owner:"", property:"", meter:"", type:"", last_reading:"", reading:"", difference:"", water:"", water_payed:"", water_regu:"", heating:"", heating_payed:"", heating_regu:""};
     var headerChargesMetersIncluded = [
        {id:"owner",name:"owner",prompt:"owner",width: 60,align: "center",padding: 0},
        {id:"property",name:"property",prompt:"property",width: 20,align: "center",padding: 0},
        {id:"private",name:"private",prompt:"private charges",width: 40,align: "center",padding: 0},
        {id:"water_regu",name:"water_regu",prompt:"regularisation water",width: 40,align: "center",padding: 0},
        {id:"heating_regu",name:"heating_regu",prompt:"regularisation heating",width: 40,align: "center",padding: 0},
        {id:"Total",name:"Total",prompt:"Total",width: 55,align: "right",padding: 0}
      ];
      var headerCharges = [
        {id:"owner",name:"owner",prompt:"owner",width: 60,align: "center",padding: 0},
        {id:"property",name:"property",prompt:"property",width: 20,align: "center",padding: 0},
        {id:"private",name:"private",prompt:"private charges",width: 35,align: "center",padding: 0},
        {id:"Total",name:"Total",prompt:"Total",width: 35,align: "right",padding: 0}
      ];

      var headerCopropertySaldo = [
        {id:"oldSaldo",name:"oldSaldo",prompt:"last saldo",width: 45,align: "center",padding: 0},
        {id:"income",name:"income",prompt:"income",width: 45,align: "center",padding: 0},
        {id:"expenses",name:"expenses",prompt:"expenses",width: 45,align: "center",padding: 0},
        {id:"expensesProvisions",name:"expensesProvisions",prompt:"expenses payed with provisions",width: 50,align: "center",padding: 0},
        {id:"newSaldo",name:"newSaldo",prompt:"new saldo",width: 45,align: "right",padding: 0}
      ];

      var headerOwnersSaldo = [
        {id:"owner",name:"owner",prompt:"owner",width: 60,align: "center",padding: 0},
        {id:"oldSaldo",name:"oldSaldo",prompt:"last saldo",width: 35,align: "center",padding: 0},
        {id:"payments",name:"payments",prompt:"payments",width: 35,align: "center",padding: 0},
        {id:"charges",name:"charges",prompt:"charges",width: 35,align: "center",padding: 0},
        {id:"provisions",name:"provisions",prompt:"provisions",width: 35,align: "center",padding: 0},
        {id:"newSaldo",name:"newSaldo",prompt:"new saldo",width: 35,align: "right",padding: 0}
      ];

      var headerAmountsDue = [
        {id:"owner",name:"owner",prompt:"owner",width: 60,align: "center",padding: 0},
        {id:"amount",name:"amount",prompt:"amount due",width: 35,align: "right",padding: 0}
      ];

      var headerBuildingWater = [
        {id:"meter",name:"meter",prompt:"meter",width: 35,align: "center",padding: 0},
        {id:"last_reading",name:"last_reading",prompt:"last reading",width: 33,align: "center",padding: 0},
        {id:"reading",name:"reading",prompt:"new reading",width: 33,align: "center",padding: 0},
        {id:"difference",name:"difference",prompt:"difference",width: 35,align: "center",padding: 0},
        {id:"differenceCommon",name:"differenceCommon",prompt:"difference Common Parts",width: 35,align: "center",padding: 0},
        {id:"common",name:"common",prompt:"consumption common parts",width: 38,align: "center",padding: 0},
        {id:"private",name:"private",prompt:"total private consumption",width: 38,align: "center",padding: 0},
      ];
      
      var ccsInReport;
      var propertiesInReport;
      var membersInReport;

      function reportTransaction(trData){
        trData.type = TransTypeRead[trData.type];
        if (!trData.communication) { trData.communication= " ";} 
        else {trData.communication = trData.communication.substr(0,62);};
        trData.name=trData.name.substr(0,25);
        return trData.amount;
      };

      function convertToCurrency (aTable, listOfFields) {
        aTable.forEach(function(aRow){
          listOfFields.forEach(function(anAmountField){
            if (aRow[anAmountField] === 0) {
              if (aRow.owner) { 
                if ((aRow.owner == "Grand Total") && (anAmountField == "heating_regu")){
                  aRow[anAmountField]=aRow[anAmountField].toLocaleString("nl-BE",currencyStyle);
                } else {aRow[anAmountField]=" ";};
              } else {aRow[anAmountField]=" ";};
            } else if (aRow[anAmountField] == "") {aRow[anAmountField]="";}
            else {aRow[anAmountField] = aRow[anAmountField].toLocaleString("nl-BE",currencyStyle);};
          });        
        });
        return aTable;
      };

      function totalHorizontal (aTable, listOfFields, totalfield) {
        aTable.forEach(function(aRow){
          var total = 0;
          listOfFields.forEach(function(anAmountField){total+= aRow[anAmountField];});
          aRow[totalfield] = total;
        });
        return aTable;
      };

      function totalVertical (aTable, listOfFieldsToTotal, fieldTotal) {
        if (aTable.length) {
          var columns = Object.keys(aTable[0]);
          var totalsRow={};
          columns.forEach(function(column){totalsRow[column]=""});
          totalsRow[fieldTotal]="Total";
          listOfFieldsToTotal.forEach(function(column){totalsRow[column]=0});
          aTable.forEach(function(aRow){
            listOfFieldsToTotal.forEach(function(column){totalsRow[column]+= aRow[column];});
          });
          aTable.push(totalsRow);
        };
        return aTable;
      };

      var costCenterWater;
      var costCenterHeating;
      async function getConsumptionTransactions(closeDateTransactions, metersIncluded, consumptionType, consumptionTable){
        if (metersIncluded){
          var transactionsFS= await refCoproperty.collection("Transactions").where("type", "==", consumptionType).where("bookDate", ">", lastReguDate).where("bookDate", "<=", closeDateTransactions).orderBy("bookDate").get();
          var total = 0;
          transactionsFS.forEach(function(transactionFS){
            var resultRow = transactionFS.data();
            total += reportTransaction(resultRow);
            consumptionTable.push(resultRow);
            function checkIdConsumptionCC(cc){return cc.idFS == resultRow.costCenter};
                
            if (consumptionType == "WATER") {if (!costCenterWater) {costCenterWater = ccsInReport.find(checkIdConsumptionCC);};};
            if (consumptionType == "HEATI") {if (!costCenterHeating) {costCenterHeating = ccsInReport.find(checkIdConsumptionCC);};};
          });
          return total;
        } else { return 0;};
      };

          
      async function generateChargesReport(closeDateTransactions, metersIncluded){  
        ccsInReport = await costCentersGet(); 
        if (!ccsInReport.length){
          M.toast({html:"Please enter cost centers first" });
          document.getElementById("chargesReportSubmitButton").disabled=false;
          M.Modal.getInstance(document.getElementById("loading")).close();
        return;
        };
        var transactionsFS = await refCoproperty.collection("Transactions").where("bookDate", ">", lastCloseDate).where("bookDate", "<=", closeDateTransactions).orderBy("bookDate").get();
        for (let ii=0; ii<transactionsFS.docs.length; ii++ ){
         var trData = transactionsFS.docs[ii].data();
          if (trData.type == "TBSET") {
            M.toast({html:"Some transactions in period still need to be classified first" });
            document.getElementById("chargesReportSubmitButton").disabled=false;
            M.Modal.getInstance(document.getElementById("loading")).close();
            return;
          }; 
        };
        ccsInReport.forEach(function(cc){
          var totalQuota =0;
          Object.values(cc.distribution).forEach(function(quota){totalQuota +=quota;});
          cc.totalQuota = totalQuota;
        });
        propertiesInReport = await propertiesGet(); 
        membersInReport = await membersGet();
        var commonCharges = {}; 
        var privateCharges = [];
        var privateTotal = 0;
        var totalCharges = [];
        var totalledCharges = [];
        var waterCharges = [];
        var totalWater = await getConsumptionTransactions(closeDateTransactions, metersIncluded,"WATER",waterCharges);
        var heatingCharges = [];
        var totalHeating = await getConsumptionTransactions(closeDateTransactions, metersIncluded,"HEATI",heatingCharges);
        var regulations = [];
        var mrsInReport;
        var consumptions = [];
        var totalledConsumptions = [];
        var payedByProvisions = [];
        var ownersSaldo = [];
        var amountsDue = [];
        if (metersIncluded){
          headerCharges = headerChargesMetersIncluded;
          meterReadings = null;
          mrsInReport = await meterReadingsGet(); 
          function meterReadingInPeriod(mr){
            return (lastReguDate.localeCompare(mr.readings[0].date) < 0) && (closeDateTransactions.localeCompare(mr.readings[0].date) >= 0);
          };
          if (!mrsInReport.every(meterReadingInPeriod)) {
            M.toast({html:"Not all meter readings are within regularisation period" });
            document.getElementById("chargesReportSubmitButton").disabled=false;
            M.Modal.getInstance(document.getElementById("loading")).close();
            return;
          }; 
        };
        
        var totalWaterDifference = 0;
        var buildingWaterData = [];
        var totalColdWaterDifference = 0;
        var totalHotWaterDifference = 0;
        var totalHeatingDifference = 0;
        var copropertySaldo = [{
          oldSaldo: lastCopropertySaldo,
          income: 0,
          expenses: 0,
          expensesProvisions: 0,
          newSaldo: 0
        }];
        var newOwnersSaldo = {};
        var newCopropertySaldo;
        var payedByProvisionsTotal = 0;
        var totalPayments = 0;

        /* make table saldos per owner and yet complete last saldo and provisions*/
        function checkCCId(cc) {return (cc.idFS == currentCoproperty.provisionsCC)};
        var ccHere = ccsInReport.find(checkCCId);
        if (!ccHere) {
          M.toast({html:"Please first select cost center for provision handling"});
          document.getElementById("chargesReportSubmitButton").disabled=false;
          M.Modal.getInstance(document.getElementById("loading")).close();
          return;
        };
        if (!ccHere.totalQuota){
          M.toast({html:"Cost center for provision handling must have total > 0"});
          document.getElementById("chargesReportSubmitButton").disabled=false;
          M.Modal.getInstance(document.getElementById("loading")).close();
          return;
        };
              
        membersInReport.forEach(function(m){
          var hisProperties = propertiesBySynchrone(m);
          if (hisProperties.length){
            var lastOS = 0;
            if (lastOwnersSaldo[m.idFS]) {lastOS = lastOwnersSaldo[m.idFS]};
            var provisionHere = 0;
            if (currentCoproperty.provisionsCC){
              var quotaHere = 0;
              hisProperties.forEach(function(p){
                if(ccHere.distribution[p.idFS]) {quotaHere += ccHere.distribution[p.idFS]};
              });
              var provisionHere = -1 * Number((currentCoproperty.provisions * quotaHere / ccHere.totalQuota).toFixed(2));
            };
            ownersSaldo.push({ownerId: m.idFS, owner: denomination(m), oldSaldo: lastOS, payments: 0, charges:0, provisions:provisionHere , newSaldo:0});
          };
        });
        
        /* initialise common charges holder tabels*/
        var i = 0;
        ccsInReport.forEach(function(cc) {
          var ccId = cc.idFS;
          function checkId(ccHere){return ccHere.idFS == ccId};
          commonCharges[ccId] ={};
          commonCharges[ccId].total = 0;
          commonCharges[ccId].transactions = [];
          headerCharges.splice(2+i, 0, {id:ccId,name:ccId,prompt:"common charges " + ccsInReport.find(checkId).name,width: 40,align: "center",padding: 0});
          i += 1;
        });
        
        /*refCoproperty.collection("Transactions").where("bookDate", ">", lastCloseDate).where("bookDate", "<=", closeDateTransactions).orderBy("bookDate").get().then(function(transactionsFS){*/
          /* fill common charges tables */
         transactionsFS.forEach(function(transactionFS){
            var trData = transactionFS.data();
            if (hasCostCenter(trData.type)) {
              commonCharges[trData.costCenter].total += reportTransaction(trData);
              commonCharges[trData.costCenter].transactions.push(trData);
            };
          });
          /* build empty total charges table and fill totalled common charges*/
          propertiesInReport.forEach(function (p){
            function checkMemberId(thisM) {return thisM.idFS == p.owner};
            var rowTotalCharges= {};
            rowTotalCharges.propertyId = p.idFS;
            rowTotalCharges.property = p.code; 
            rowTotalCharges.ownerId = p.owner;
            var thisOwner= membersInReport.find(checkMemberId);
            rowTotalCharges.owner = denomination(thisOwner);
            rowTotalCharges.private = 0;
            ccsInReport.forEach(function(cc) {
              var quotaHere = cc.distribution[p.idFS];
              if (!quotaHere) {quotaHere = 0};
              rowTotalCharges[cc.idFS] = Number(((commonCharges[cc.idFS].total)*quotaHere/(cc.totalQuota)).toFixed(2));
            });
            if (metersIncluded){
              rowTotalCharges.water_regu = 0;
              rowTotalCharges.heating_regu = 0;
            };
            totalCharges.push(rowTotalCharges);
          });

          /* fill private charges table and fill totalled private charges */ 
          transactionsFS.forEach(function(transactionFS){
            var trData = transactionFS.data();
            if (trData.type == "PRIVA") {
              privateTotal += reportTransaction(trData);
              var distributionStringHere = " ";
              
              trData.distribution.forEach(function (ds){
                distributionStringHere += ds.propertyCode + ": " + ds.amount.toLocaleString("nl-BE",currencyStyle) + " | ";
                function checkProp(tC){return tC.propertyId == ds.property};
                totalCharges.find(checkProp).private += ds.amount;
              });
              
              trData.assignments = distributionStringHere;
              trData.distribution = distributionStringHere;
              privateCharges.push(trData);
            };
          });
          /* fill payments by provisions */
          transactionsFS.forEach(function(transactionFS){
            var trData = transactionFS.data();
            if (trData.type == "PROVI") {
              payedByProvisionsTotal += reportTransaction(trData);
              payedByProvisions.push(trData);
            };
          });

          payedByProvisions.push({name:"Total",date:" ",communication:" ",amount:payedByProvisionsTotal});
          convertToCurrency(payedByProvisions, ["amount"]);

          privateCharges.push({name: "Total", date: " ", communication: " ", assignments: " ", amount: privateTotal});
          convertToCurrency(privateCharges, ["amount"]);
          
          Object.keys(commonCharges).forEach(function(cc){
            commonCharges[cc].transactions.push({type:"Total",name:" ",date:" ",communication:" ",amount:commonCharges[cc].total});
            convertToCurrency(commonCharges[cc].transactions, ["amount"]);
          });
          /* water and heating*/
          if (metersIncluded) {
            waterCharges.push({type:"Total",name:" ",date:" ",communication:" ",amount:totalWater});
            convertToCurrency(waterCharges, ["amount"]);
            heatingCharges.push({type:"Total",name:" ",date:" ",communication:" ",amount:totalHeating});
            convertToCurrency(heatingCharges, ["amount"]);
            /* caculate individual differences and total differences */
            mrsInReport.forEach(function(mr){
              var row = {};
              row.meter = mr.meter;
              row.type = mr.type;  
              row.last_reading= mr.readings[1].reading;
              row.reading= mr.readings[0].reading;
              /*row.difference= (row.reading*10000 - row.last_reading*10000)/10000;*/
              var td = parseFloat(row.reading).toFixed(4) - parseFloat(row.last_reading).toFixed(4);
              row.difference= parseFloat(td);
              if (mr.property) {
                row.property = propertyGetSynchrone(mr.property).code;
                row.propertyId = mr.property;
                if (mr.type == "COLWA") {
                  totalColdWaterDifference += row.difference;
                } else if (mr.type == "HEATI") {
                  totalHeatingDifference += row.difference;
                } else if (mr.type == "HOTWA"){
                  totalHotWaterDifference += row.difference;
                };
                consumptions.push(row);
              }
              else {
                if (mr.type == "COLWA") {
                  totalWaterDifference += row.difference;
                  buildingWaterData.push(row);
                }
              };
            });
            if (!totalWaterDifference){
              M.toast({html:"Cold Water Meter for Building is missing: please enter it first"});
              document.getElementById("chargesReportSubmitButton").disabled=false;
              M.Modal.getInstance(document.getElementById("loading")).close();
              return;
            };
            /* calculate water building and common */
            function convertToStringHere(n){if (n) {return n.toString()} else {return " "} };
            function convertNumberToStringHere(n){if (n) {return n.toFixed(2);} else {return " "} };
            function convertNumberToReadingStringHere(n){if (n) {return n.toFixed(4);} else {return " "} };
            function convertNumberToCurrencyHere(n){if (n) {return n.toLocaleString("nl-BE",currencyStyle);} else {return " "} };
            var thisBuildingWaterData= buildingWaterData[0];
            thisBuildingWaterData.last_reading = convertNumberToStringHere(thisBuildingWaterData.last_reading);
            thisBuildingWaterData.reading = convertNumberToStringHere(thisBuildingWaterData.reading);
            thisBuildingWaterData.difference = convertNumberToReadingStringHere(thisBuildingWaterData.difference);
            var differenceCommonHere = totalWaterDifference - (totalColdWaterDifference + totalHotWaterDifference);
            var waterCommonHere = Number((totalWater * differenceCommonHere / (totalWaterDifference)).toFixed(2));
            thisBuildingWaterData.differenceCommon = convertNumberToReadingStringHere(differenceCommonHere);
            thisBuildingWaterData.common = convertNumberToCurrencyHere(waterCommonHere);
            thisBuildingWaterData.private = convertNumberToCurrencyHere(totalWater - waterCommonHere);
            console.log("buildingWaterData ",buildingWaterData);
            /* calculate individual comsumed amounts */
            consumptions.forEach(function(c){
              c.water = 0;c.water_payed = 0;c.water_regu = 0;
              c.heating = 0;c.heating_payed = 0;c.heating_regu = 0;
              if (c.type != "HEATI") {
                c.water = Number((totalWater * c.difference / (totalWaterDifference)).toFixed(2));
              };
              if (c.type != "COLWA") {
                var energyDifference;
                if (c.type == "HOTWA") {energyDifference = c.difference * 1.5}
                else {/* thus central heating*/energyDifference = c.difference};
                c.heating = Number((totalHeating * energyDifference / (totalHeatingDifference + (totalHotWaterDifference *1.5))).toFixed(2));
              };
            });
            /* calculate totals including payed and regu */
            function generateEmptyRowTotalledConsumption(){
              var result = {};
              result.property = "";
              result.meter = "";
              result.water = 0;
              result.type="";
              result.last_reading=0;
              result.reading=0;
              result.difference=0;
              result.water=0;
              result.water_payed=0;
              result.water_regu=0;
              result.heating=0;
              result.heating_payed=0;
              result.heating_regu=0;
              return result;
            };
            function generateNewTotalledConsumption(propertyCode, propertyId){
              var result = {};
              result.property = propertyCode;
              result.propertyId = propertyId;
              result.meter = "Total";
              result.type="";
              result.last_reading="";
              result.difference=0;
              result.water = 0;
              result.water_payed=0;
              result.water_regu=0;
              result.heating = 0;
              result.heating_payed=0;
              result.heating_regu=0;
              
              return result;
            };
            var positionInConsumptions = 1;
            var totalConsumptionRow = generateNewTotalledConsumption(consumptions[0].property,consumptions[0].propertyId);
            var grandTotalConsumtions = {};
            grandTotalConsumtions.property = " ";
            grandTotalConsumtions.meter = "Grand Total";
            grandTotalConsumtions.type=" ";
            grandTotalConsumtions.reading=" ";
            grandTotalConsumtions.last_reading=" ";
            grandTotalConsumtions.difference=" ";
            grandTotalConsumtions.water = 0;
            grandTotalConsumtions.water_payed=0;
            grandTotalConsumtions.water_regu=0;
            grandTotalConsumtions.heating = 0;
            grandTotalConsumtions.heating_payed=0;
            grandTotalConsumtions.heating_regu=0;
            consumptions.forEach(function(c){
              
              function completeAndPushTotal() {
                function getQuota(cc, propertyId){
                  if (cc.distribution[propertyId]) {return cc.distribution[propertyId]}
                  else {return 0} ;
                };
                function checkPropInTotals(tc) {return (tc.propertyId == totalConsumptionRow.propertyId);};
                var totalChargesRow = totalCharges.find(checkPropInTotals);
                if (costCenterWater){
                  totalConsumptionRow.water_payed= Number((totalWater * getQuota(costCenterWater,totalConsumptionRow.propertyId)/ costCenterWater.totalQuota).toFixed(2));
                  grandTotalConsumtions.water_payed += totalConsumptionRow.water_payed;
                  totalConsumptionRow.water_regu = Number((totalConsumptionRow.water_payed + totalConsumptionRow.water).toFixed(2));
                  totalChargesRow.water_regu = totalConsumptionRow.water_regu;
                  grandTotalConsumtions.water_regu += totalConsumptionRow.water_regu;
                };
                if (costCenterHeating){
                  totalConsumptionRow.heating_payed= Number((totalHeating * getQuota(costCenterHeating,totalConsumptionRow.propertyId)/ costCenterHeating.totalQuota).toFixed(2));
                  grandTotalConsumtions.heating_payed += totalConsumptionRow.heating_payed;
                  totalConsumptionRow.heating_regu = Number((totalConsumptionRow.heating_payed + totalConsumptionRow.heating).toFixed(2));
                  grandTotalConsumtions.heating_regu += totalConsumptionRow.heating_regu;
                  totalChargesRow.heating_regu = totalConsumptionRow.heating_regu;
                };
                totalledConsumptions.push(totalConsumptionRow);
              };
              if (c.property != totalConsumptionRow.property){
                completeAndPushTotal();
                totalledConsumptions.push(generateEmptyRowTotalledConsumption());
                totalConsumptionRow = generateNewTotalledConsumption(c.property, c.propertyId);
              };
              if (c.property == "Common") {
                c.water_payed = 0; c.water_regu = 0;
                c.heating_payed = 0; c.heating_regu = 0;
              };
              totalledConsumptions.push(c);
            
              totalConsumptionRow.water += c.water;grandTotalConsumtions.water += c.water;
              totalConsumptionRow.heating += c.heating;grandTotalConsumtions.heating += c.heating;
              
              if ((positionInConsumptions == consumptions.length)&& (c.property != "Common")){completeAndPushTotal();};
              
              positionInConsumptions +=1;
            });
            /* convert amounts to euro strings */
            totalledConsumptions.forEach(function(c){  
              
              if (c.property == "") {
                c.meter="";c.type = "";c.reading= "";c.last_reading= "";c.difference= "";  
                c.water= "";c.water_payed= "";c.water_regu= "";  
                c.heating= "";c.heating_payed= "";c.heating_regu= "";
              } else if (c.property == "Common")  {
                c.propertyId=" ";
                c.type = ConsumptionTableType[c.type];
                c.reading= convertToStringHere(c.reading);
                c.last_reading= convertToStringHere(c.last_reading);
                c.difference= convertNumberToReadingStringHere(c.difference);  
                c.water= convertNumberToCurrencyHere(c.water);
                c.water_payed= " ";c.water_regu= " ";  
                c.heating= " ";c.heating_payed= " ";c.heating_regu= " ";
              } else {
                if (c.type) {c.type = ConsumptionTableType[c.type]; } else {c.type = " "};
                c.reading= convertToStringHere(c.reading);
                c.last_reading= convertToStringHere(c.last_reading);
                c.difference= convertNumberToReadingStringHere(c.difference);  
                c.water= convertNumberToCurrencyHere(c.water);  
                c.heating= convertNumberToCurrencyHere(c.heating);     
                c.water_payed= convertNumberToCurrencyHere(c.water_payed);  
                c.heating_payed= convertNumberToCurrencyHere(c.heating_payed);     
                c.water_regu= convertNumberToCurrencyHere(c.water_regu);  
                c.heating_regu= convertNumberToCurrencyHere(c.heating_regu);     
              };           
            });  
            totalledConsumptions.push(generateEmptyRowTotalledConsumption());
            grandTotalConsumtions.water= grandTotalConsumtions.water.toLocaleString("nl-BE",currencyStyle);  
            grandTotalConsumtions.heating= grandTotalConsumtions.heating.toLocaleString("nl-BE",currencyStyle);     
            grandTotalConsumtions.water_payed= grandTotalConsumtions.water_payed.toLocaleString("nl-BE",currencyStyle);  
            grandTotalConsumtions.heating_payed= grandTotalConsumtions.heating_payed.toLocaleString("nl-BE",currencyStyle);     
            grandTotalConsumtions.water_regu= grandTotalConsumtions.water_regu.toLocaleString("nl-BE",currencyStyle);  
            grandTotalConsumtions.heating_regu= grandTotalConsumtions.heating_regu.toLocaleString("nl-BE",currencyStyle);   
            totalledConsumptions.push(grandTotalConsumtions);
          };
          /* total each line in total charges */
          totalCharges.forEach(function(tC){
            var totalRow = 0;
            ccsInReport.forEach(function(cc){totalRow += tC[cc.idFS]});
            totalRow += tC.private;
            if (metersIncluded){
              totalRow += tC.water_regu;totalRow += tC.heating_regu;
            }
            tC.Total = totalRow; 
          });
          /* sort total charges */
          function compareTC(tc1, tc2){if (tc1.owner < tc2.owner) {return -1} else {return 1}};
          totalCharges.sort(compareTC);
          
          /* add totalling lines in total charges */
          function generateNewRowTotalledCharges() {
            var result = {};
            result.owner = "";result.ownerid = "";result.property = "";
            ccsInReport.forEach(function(cc){result[cc.idFS] = 0});
            result.private = 0;result.water_regu = 0;result.heating_regu = 0;result.Total = 0;
            return result;
          };
          function generateEmptyRowTotalledCharges() {
            var result = {};
            result.owner = "";result.ownerid = "";result.property = "";
            ccsInReport.forEach(function(cc){result[cc.idFS] = ""});
            result.private = "";result.water_regu = "";result.heating_regu = "";result.Total = "";
            return result;
          };
          var totallsRow = generateNewRowTotalledCharges();
          var grandTotalsRow = generateNewRowTotalledCharges();
          grandTotalsRow.owner = "Grand Total";
          var positionTotalCharges = 1;
          var nrOfProperties = 0;
          totalCharges.forEach(function(tc){
            if (tc.ownerId != totallsRow.ownerId) {
              if (nrOfProperties > 1){totalledCharges.push(totallsRow);};
              if (positionTotalCharges > 1) {totalledCharges.push(generateEmptyRowTotalledCharges());};
              totallsRow = generateNewRowTotalledCharges();
              nrOfProperties = 0;
            };
            
            totalledCharges.push(tc);
            totallsRow.owner = "Total";
            totallsRow.ownerId = tc.ownerId;
            ccsInReport.forEach(function(cc){
              totallsRow[cc.idFS] += tc[cc.idFS];
              grandTotalsRow[cc.idFS] += tc[cc.idFS];
            });
            totallsRow.private += tc.private; grandTotalsRow.private += tc.private;
            if (metersIncluded){
              totallsRow.water_regu += tc.water_regu; grandTotalsRow.water_regu += tc.water_regu;
              totallsRow.heating_regu += tc.heating_regu; grandTotalsRow.heating_regu += tc.heating_regu;
            };
            totallsRow.Total += tc.Total; grandTotalsRow.Total += tc.Total;
              /* fill charges colun in owner saldos table */
              function checkOwner(os){return os.ownerId == tc.ownerId};
              ownersSaldo.find(checkOwner).charges = totallsRow.Total;

            nrOfProperties += 1;
            if ((nrOfProperties > 1) && (positionTotalCharges ==  totalCharges.length)) {totalledCharges.push(totallsRow);};
            positionTotalCharges += 1;  
          });
          totalledCharges.push(generateEmptyRowTotalledCharges());
          totalledCharges.push(grandTotalsRow);
 
          ccsInReport.forEach(function(cc){
            copropertySaldo[0].expenses += grandTotalsRow[cc.idFS];});
          copropertySaldo[0].expenses += grandTotalsRow.private;
          copropertySaldo[0].expensesProvisions += payedByProvisionsTotal;
          
          function getId(cc){return cc.idFS};
          var totalChargesAmountFields = ccsInReport.map(getId);
          totalChargesAmountFields.push("private");
          if (metersIncluded) {
            totalChargesAmountFields.push("water_regu");
            totalChargesAmountFields.push("heating_regu");
          };
          totalChargesAmountFields.push("Total");

          /* handle payments by owners -------------------------------------*/
          transactionsFS.forEach(function(transactionFS){
            var trData = transactionFS.data();
            if (trData.type == "OWNER") {
              function checkOwner(os){return os.ownerId == trData.owner};
              ownersSaldo.find(checkOwner).payments += trData.amount;
              totalPayments += trData.amount;
            };
          });
          copropertySaldo[0].income = totalPayments;
          totalHorizontal(copropertySaldo,["oldSaldo","income","expenses","expensesProvisions"],"newSaldo" );
          newCopropertySaldo = copropertySaldo[0].newSaldo;
          totalHorizontal(ownersSaldo,["oldSaldo","payments","charges","provisions"],"newSaldo" );
          ownersSaldo.forEach(function(os){
            newOwnersSaldo[os.ownerId] = os.newSaldo;
            if (os.newSaldo < 0) {amountsDue.push({owner: os.owner, amount: -1 * os.newSaldo })};
          });
          totalVertical(ownersSaldo,["oldSaldo","payments","charges","provisions","newSaldo"],"owner");
                   

          convertToCurrency(totalledCharges, totalChargesAmountFields);
          convertToCurrency(copropertySaldo, ["oldSaldo","income","expenses","expensesProvisions","newSaldo"]);
          convertToCurrency(ownersSaldo, ["oldSaldo","payments","charges","provisions","newSaldo"]);
          convertToCurrency(amountsDue, ["amount"]);
          
          
          writePDF (closeDateTransactions, newCopropertySaldo, newOwnersSaldo, metersIncluded,commonCharges,privateCharges,totalledCharges,waterCharges,heatingCharges,totalledConsumptions,payedByProvisions, copropertySaldo,ownersSaldo, amountsDue, buildingWaterData);
        /*});*/
      
      };
      /*  print starts here ---------------------------------------------------------------------------------*/
      function writePDF (closeDateTransactions, newCopropertySaldo, newOwnersSaldo, metersIncludedHere, commonCharges ,privateCharges, totalCharges, waterCharges,heatingCharges,totalledConsumptionsHere,payedByProvisions, copropertySaldo,ownersSaldo, amountsDue, buildingWaterData){
        const rowsLandscapeConsumptions =16;
        const rowsLandscapePrivate =12;
        const rowsLandscapeTotal =15;
        const rowsPortrait =17;
        var numPages = 0;
        Object.values(commonCharges).forEach(function(cC){numPages += Math.ceil(cC.transactions.length/rowsPortrait)});
        if (metersIncludedHere) {
          numPages += 3 + Math.ceil(privateCharges.length/rowsLandscapePrivate) + Math.ceil(totalCharges.length/rowsLandscapeTotal) + Math.ceil(waterCharges.length/rowsPortrait) + Math.ceil(heatingCharges.length/rowsPortrait) + Math.ceil(totalledConsumptionsHere.length/rowsLandscapeConsumptions)+ Math.ceil(((payedByProvisions.length-1)/rowsPortrait));
        } else {
          numPages += 3 + Math.ceil(privateCharges.length/rowsLandscapePrivate) + Math.ceil(totalCharges.length/rowsLandscapeTotal) + Math.ceil(((payedByProvisions.length-1)/rowsPortrait));
        };
        window.jsPDF = window.jspdf.jsPDF;
        var currentPage = 1;
        
        var startDateHere = new Date(lastCloseDate);
        startDateHere.setDate(startDateHere.getDate() + 1);
        var startDateString = startDateHere.toISOString().substr(0,10);
        const footerText = "Charges Report " + currentCoproperty.name + " " + startDateString + " to " + closeDateTransactions;
        
        function printFooterPortrait () {
          doc.line(15, 280, 200, 280);
          doc.setFontSize(10);
          doc.setTextColor("green");doc.text("MyDigitalCondo " ,15, 285);doc.setTextColor("black");
          doc.text(footerText,45, 285);
          doc.text("Page " + currentPage + "/" + numPages, 185, 285);
          currentPage = currentPage + 1;
        };
        function printFooterLandscape () {
          doc.line(10, 190, 280, 190);
          doc.setFontSize(10);
          doc.setTextColor("green");doc.text("MyDigitalCondo" ,10, 195);doc.setTextColor("black");
          doc.text(footerText,42, 195);
          doc.text("Page " + currentPage + "/" + numPages, 265, 195);
          currentPage = currentPage + 1;
        };
        function printTablePortrait(title, table, header) {
          for (i = 0; i < Math.ceil(table.length/rowsPortrait); i= i + 1) {
            doc.addPage("a4", "portrait");
            doc.setFontSize(16);
            doc.text(title, 15, 15);
            doc.table(15, 20, table.slice(i*rowsPortrait, Math.min(((i+1)*rowsPortrait),table.length)), header,{fontSize:10});
            printFooterPortrait ();
          };
        };
        function printTableLandscape(title, table, header, fontSizeP, rowsOnPage) {
          for (i = 0; i < Math.ceil(table.length/rowsOnPage); i= i + 1) {
            doc.addPage("a4", "landscape");
            doc.setFontSize(16);
            doc.text(title, 15, 15);
            doc.table(10, 20, table.slice(i*rowsOnPage, Math.min(((i+1)*rowsOnPage),table.length)), header,{fontSize:fontSizeP});
            printFooterLandscape ();
          };
        };
        
        var doc = new jsPDF({ putOnlyUsedFonts: true, orientation: "portrait" });
        doc.setTextColor("green"); doc.setFontSize(32);
        doc.text("MyDigitalCondo", 60, 20);
        doc.setTextColor("black"); doc.setFontSize(24); 
        doc.text("Report of Charges", 40, 40);
        doc.setFontSize(16);
        doc.text("Condomynium:", 15, 55);
        doc.setFontSize(14);
        doc.text("Name:", 30, 65);doc.text(currentCoproperty.name, 90, 65);
        doc.text("Address:", 30, 75);doc.text(currentCoproperty.street + " " + currentCoproperty.houseNumber + ", "+ currentCoproperty.zip + " " + currentCoproperty.town, 90, 75);
        doc.text("Administrator:", 30, 85);doc.text("Marc Van Limberghen", 90, 85);
        doc.setFontSize(16);
        doc.text("Period:", 15, 105);
        doc.setFontSize(14);
        doc.text(startDateString + " to " + closeDateTransactions, 90, 105);
        if (metersIncludedHere){
          doc.text("including regularisation meter readings", 90, 115);
        } else {
          doc.text("without regularisation meter readings", 90, 115);
        };
        doc.setFontSize(16);
        doc.text("List of tables:", 15, 135);
        doc.setFontSize(14);
        doc.text("Common charges per cost center", 30, 145);
        doc.text("Private expenses", 30, 155);
        if (metersIncludedHere){
          doc.text("Water expenses since previous regularisation", 30, 165);
          doc.text("Heating expenses since previous regularisation", 30, 175);
          doc.text("Regularisation Water and Heating", 30, 185);
          doc.text("Total charges", 30, 195);
          if (payedByProvisions.length > 1) {
            doc.text("Expenses payed with provisions", 30, 205);
            doc.text("Saldos", 30, 215);
            doc.text("Amounts Due", 30, 225);
          } else {
            doc.text("Saldos", 30, 205);
            doc.text("Amounts Due", 30, 215);
          };
        } else {
          doc.text("Total charges", 30, 165);
          if (payedByProvisions.length > 1) {
            doc.text("Expenses payed with provisions", 30, 175);
            doc.text("Saldos owners and condomynium", 30, 185);
            doc.text("Amounts Due", 30, 195);
          }else {
            doc.text("Saldos owners and condomynium", 30, 175);
            doc.text("Amounts Due", 30, 185);
          };
        };

        printFooterPortrait();
        Object.keys(commonCharges).forEach(function(cc){
          function checkId(ccHere){return ccHere.idFS == cc};
          printTablePortrait("Common charges for cost center " + ccsInReport.find(checkId).name, commonCharges[cc].transactions, headerCommon);});
        printTableLandscape("Private expenses", privateCharges, headerPrivate, 10, rowsLandscapePrivate );
        if (metersIncludedHere){
          printTablePortrait("Water expenses since previous regularisation" , waterCharges, headerWH);
          doc.setFontSize(16);
          doc.text("Cold Water Building", 15, 240);
          doc.table(15, 245, buildingWaterData, headerBuildingWater,{fontSize:10});
        printTablePortrait("Heating expenses since previous regularisation" , heatingCharges, headerWH);
          printTableLandscape("Regularisation Water and Heating (CW = Cold Water, HW= Hot Water, HE = Heating)", totalledConsumptionsHere, headerConsumption,8, rowsLandscapeConsumptions );
        };
        printTableLandscape("Total charges", totalCharges, headerCharges, 8, rowsLandscapeTotal );
        if (payedByProvisions.length > 1){
          printTablePortrait("Expenses payed with provisions" , payedByProvisions, headerWH);
        };
        printTablePortrait(" Owner Saldos", ownersSaldo, headerOwnersSaldo);
        /*printTablePortrait("Saldos", copropertySaldo, headerCopropertySaldo);*/
        doc.setFontSize(16);
        doc.text("Saldo Condomynium", 15, 240);
        doc.table(15, 245, copropertySaldo, headerCopropertySaldo,{fontSize:10});
        printTablePortrait("Amounts Due" , amountsDue, headerAmountsDue);
        newCopropertySaldo = Number(newCopropertySaldo.toFixed(2));
        Object.keys(newOwnersSaldo).forEach(function(k){newOwnersSaldo[k]= Number(newOwnersSaldo[k].toFixed(2))});  
        refCoproperty.collection("ChargesReports").add({startDate: startDateString, endDate: closeDateTransactions, metersIncluded: metersIncludedHere, copropertySaldo: newCopropertySaldo, ownersSaldo: newOwnersSaldo, confirmed: false }).then (function (chargesReportFS){
          var fileRef = refCopropertyFiles.child("ChargesReports").child(chargesReportFS.id);  
          fileRef.put(doc.output("blob")).then(function(snapshot) {
              refreshChargesReports();
              M.Modal.getInstance(document.getElementById("loading")).close();
              M.Modal.getInstance(document.getElementById("chargesReportAdd")).close();
          }).catch(function(error) {
            M.Modal.getInstance(document.getElementById("loading")).close();
            M.toast({html:"Error writing report file in store:" + error});
          });
        }).catch(function(error) {
          M.Modal.getInstance(document.getElementById("loading")).close();
          M.toast({html:"Error saving charges report:" + error});
        });
      };
      
    </script>
</body>
</html>