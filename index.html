<!DOCTYPE html>
<html>

<head>
  <base target="_top">
  <title style:"color:#00796b bold">MyCondos</title>
  <link rel="icon"
    href="https://firebasestorage.googleapis.com/v0/b/slimmeeigendomdb.appspot.com/o/Building-32.png?alt=media&token=9754f9c3-9d56-42fc-bd61-839ce2354a95">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.98.0/css/materialize.min.css">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />


  <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
  <!--<script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.98.0/js/materialize.min.js"></script>-->

  <script src="https://www.gstatic.com/firebasejs/8.2.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com//firebasejs/8.2.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.2.0/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.2.0/firebase-storage.js"></script>

  <script>
    var firebaseConfig = {
        apiKey: "AIzaSyDVT644vSE0ue8KyDy-o9YwbYPX3m0ZmSc",
        authDomain: "slimmeeigendomdb.firebaseapp.com",
        projectId: "slimmeeigendomdb",
        storageBucket: "slimmeeigendomdb.appspot.com",
        messagingSenderId: "636221237434",
        appId: "1:636221237434:web:3db507acbf4a6a1e0d7a83",
        measurementId: "G-2JL08QYJJ3"
      };
      firebase.initializeApp(firebaseConfig);
      var firestore=firebase.firestore();
      var fileStorageRef =firebase.storage().ref();
  </script>
  <style>
    .content {
      max-width: 500px;
      margin: auto;
    }
  </style>

</head>

<body>
  <center>
    <div id="loginPanel" <h6 style="font-size:36px;color:#00796b">MyCondos</h6>
      <h6 style="font-size:12px;color:black">Stay connected to your properties</h6>
      <h6 style="font-size:20px;color:black">Please login </h6>
      <div style="width:500px">
        <form class="col s12" target="_top">
          <div class="input-field col s12">
            <input id="login_email" type="email" maxlength="50" class="validate" required aria-required="true">
            <label for="login_email">Email</label>
            <span class="helper-text" data-error="please enter valid email" ></span>
          </div>
          <div class="input-field col s12">
            <input id="login_password" type="password" class="validate" required aria-required="true">
            <label for="login_password">Password</label>
          </div>
        </form>
      </div>

      <button class="btn waves-effect waves-light" type="submit" onclick="login()">Log in<i class="material-icons right">perm_identity</i></button>
      <br>
      <button class="btn-flat" onclick="showPasswordSet()">
        <font color='blue'>Forgot password? First time user?</font>
      </button>
    </div>

    <div id="setPasswordPanel" class="displayHidden">
      <h6 style="font-size:36px;color:#00796b">MyCondos</h6>
      <h6 style="font-size:12px;color:black">Stay connected to your properties</h6>
      <h6 style="font-size:20px;color:black">Please enter your email address and</h6>
      <h6 style="font-size:20px;color:black">further instructions will be sent by email.</h6>
      <div style="width:500px">
        <form class="col s12">
          <div class="input-field col s12">
            <input id="passwordSet_email" type="email" maxlength="50" class="validate" required aria-required="true">
            <label for="passwordSet_email">Email</label>
            <span class="helper-text" data-error="please enter valid email" ></span>
          </div>
        </form>
      </div>

      <button class="btn waves-effect waves-light" type="submit" onclick="passwordSet()">Submit<i class="material-icons right">send</i></button>
      <br>
      <button class="btn-flat" onclick="backToLogin()">
        <font color='blue'>Back to Login</font>
      </button>
    </div>
  </center>

  <div id="applicationPanel" class="displayHidden">
    <header>
      <nav id="header" class="nav-fixed teal lighten-1">
        <div class="nav-wrapper container center-align">
          <a href="javascript:void(0)" class="brand-logo right right-align" id="logo-container">MyCondos: Home</a>
          <a href="#" data-target="slide-out" class="btn-collapsible sidenav-trigger left left-align"
            onclick="showMenu()"><i class="material-icons">menu</i></a>
        </div>
      </nav>
      <ul class="side-nav fixed tabs collapsible" id="slide-out">
        <li>
          <div class="userView">
            <div class="background">
              <img style="width:100%" src="https://img1.goodfon.com/wallpaper/big/6/d8/android-material-fon-linii.jpg">
            </div>
            <img width="150" height="100"" class="center" src="https://firebasestorage.googleapis.com/v0/b/slimmeeigendomdb.appspot.com/o/Azur_small.gif?alt=media&token=289506e5-49da-435a-877d-bd00757f3aac">
            <span class="white-text name">Condomynium: Azur</span>
          </div>
        </li>
        <li id="homeTab" class="tab side text-teal"><a class=" active waves-effect" href="#Home" onclick="loadHome()">Home</a>
        </li>
        <li class="tab side text-teal"><a class="waves-effect" href="#Reports" onclick="loadReports()">Reports</a></li>
        <li class="tab side text-teal"><a class="waves-effect" href="#Transactions"
            onclick="loadTransactions()">Transactions</a></li>
      </ul>

      <script>
        function showMenu(){
          var el = document.getElementById("slide-out");
          M.Sidenav.init(el);
          var instance = M.Sidenav.getInstance(el);
          instance.open();
        };
        function hideMenu(){
          var el = document.getElementById("slide-out");
          M.Sidenav.init(el);
          var instance = M.Sidenav.getInstance(el);
          instance.close();
        };
        var elemshier = document.querySelectorAll('.sidenav');
        var instanceshier = M.Sidenav.init(elemshier);

        var collapsibleElemhier = document.querySelector('.collapsible');
        var collapsibleInstancehier = M.Collapsible.init(collapsibleElemhier);
        
        const tabsContainer = document.querySelector(".tabs");
        M.Tabs.init(tabsContainer);
        var instance = M.Tabs.getInstance(document.getElementById("slide-out"));
        instance.select("#Home");
      </script>
    </header>
    <main>
      <div class="row">
        <div id="Home" class="col s12">
          <p>Welcome to MyCondos! Your role is Administrator. </p>
          <br>
          <h6>Annoucements</h6>
          <p> Chère / Cher Copropriétaire,
            A défaut d'une Assemblée Générale au cours de laquelle nous pouvions vous tenir au courant de la
            situation générale de notre immeuble et des travaux en cours, nous vous proposons de trouver ici touts les
            infos
            sur notre immeuble. </p>
          <div class="row">
            <div class="col s12 m6">
              <table>
                <tr>
                  <td>Name Condomynium</td>
                  <td>Azur</td>
                </tr>
                <tr>
                  <td>Address</td>
                  <td>Helihavenlaan 1-3, 1000, Brussels, Belgium</td>
                </tr>
                <tr>
                  <td>Administrator</td>
                  <td>Marc Van Limberghen</td>
                </tr>
              </table>
            </div>
            <div class="col s12 m6">
              <img width="300" height="175"" class="center" src="https://firebasestorage.googleapis.com/v0/b/slimmeeigendomdb.appspot.com/o/Azur_small.gif?alt=media&token=289506e5-49da-435a-877d-bd00757f3aac">
            </div>
          </div>
        </div>
        <!------------------------------------------------------------------------------------------------------>
        <div id="Reports" class="col s12">
          <h6>Individual Reports</h6>
        </div>
        <!------------------------------------------------------------------------------------------------------>
        <div id="modalTransactionClassify" class="modal">
          <div class="modal-content">
            <a style="float: right" class="modal-close waves-light btn-small"><i class="material-icons right">cancel</i>
              Cancel</a>
            <div class="row">
              <form class="col s12">
                <div class="row">
                  <div class="input-field col s12 m4">
                    <input id="transaction_account" type="text" readonly>
                    <label for="transaction_account">Account</label>
                  </div>
                  <div class="input-field col s12 m8">
                    <input id="transaction_name" type="text" readonly>
                    <label for="transaction_name">Name</label>
                  </div>
                </div>
                <div class="row">
                  <div class="input-field col s12 m4">
                    <input id="transaction_amount" type="text" readonly>
                    <label for="transaction_amount">Amount</label>
                  </div>
                  <div class="input-field col s12 m8">
                    <input id="transaction_date" type="text" readonly>
                    <label for="transaction_date">Transaction Date</label>
                  </div>
                </div>
                <div class="input-field col s12">
                  <input id="transaction_communication" type="text" readonly>
                  <label for="transaction_communication">Communication</label>
                </div>
                <h4>Enter classification</h4>
                <div class="input-field col s6">
                  <select id="transaction_classification" required required="true">
                          <option value="" disabled selected>Select the classification</option>
                          <option>61050 - NETTOYAGE</option>
                          <option>61051 - ENTRETIENT</option>
                          <option>61052 - REPARATION</option>
                        </select>
                  <label>Classification<b><font color='red'>*</font></b></label>
                </div>
              </form>
            </div>
          </div>
          <div class="modal-footer">
            <button style="float: right" class="btn-small waves-light" type="submit" onclick="classifyTransaction()">Submit<i class="material-icons right">send</i></button>
            <a style="float: right" class="modal-close waves-light btn-small"><i class="material-icons right">cancel</i>
              Cancel</a>
          </div>
        </div>
        <div id="Transactions" class="col s12">
          <table class="striped">
            <thead>
              <tr>
                <th> Name </th>
                <th> Amount</th>
                <th> Transaction Date</th>
                <th> Classification</th>
              </tr>
            </thead>
            <tbody id="transactionsTable">
            </tbody>
          </table>
          <h6> <b id="totalAmounts"> </b></h6>


        </div>
        <!------------------------------------------------------------------------------------------------------>
        <div id="Meters" class="col s12">
          <table class="striped">
            <thead>
              <tr>
                <th> Property </th>
                <th> Type</th>
                <th> Reading </th>
                <th> Date</th>
              </tr>
            </thead>
            <tbody id="metersTable">
            </tbody>
          </table>   
          <br>
          <button data-target="meterWrite" class="btn-small waves-light modal-trigger" onclick="resetSelectedMeter()"><i class="material-icons right">add</i>New Meter Reading</button>
          
          <div id="meterView" class="modal">
            <div class="modal-content">
              <a style="float: right" class="modal-close waves-light btn-small"><i class="material-icons right">cancel</i>Close</a>
              <div class="w3-panel w3-border" style="box-shadow: 5px 10px 8px #888888">
              <form class="col s12">
                <div class="input-field col s12 m4">
                  <i class="material-icons prefix">account_circle</i>
                  <input id="member_firstName" type="text" readonly>
                  <label for="member_firstName" >First Name</label>
                </div>
                <div class="input-field col s12 m8">
                  <i class="material-icons prefix">account_circle</i>
                  <input id="member_lastName" type="text" readonly>
                  <label for="member_lastName" >Last Name</label>
                </div>
                <div class="input-field col s12">
                  <input id="member_email" type="email" readonly>
                  <label for="member_email" >Email</label>
                </div>
                <div class="input-field col s12 m6">
                  <i class="material-icons prefix">phone</i>
                  <input id="member_phoneHome" type="tel" readonly>
                  <label for="member_phoneHome">Telephone Home</label>
                </div>
                <div class="input-field col s12 m6">
                  <i class="material-icons prefix">phone</i>
                  <input id="member_phoneMobile" type="tel" readonly>
                  <label for="member_phoneMobile">Mobile</label>
                </div>
                <p>  </p>
                <div class="input-field col s12 m4">
                  <input  id="member_country" type="text" readonly >
                  <label for="member_country" >Country</label>
                </div>
                <div class="input-field col s12 m2">
                  <input  id="member_zip" type="number" readonly>
                  <label for="member_zip" >Zip</label>
                </div>
                <div class="input-field col s12 m6">
                  <input  id="member_town" type="text" readonly >
                  <label for="member_town">Town</label>
                </div>
                <div class="input-field col s12 m4">
                  <input  id="member_street" type="text" readonly >
                  <label for="member_street">Street</label>
                </div>
                <div class="input-field col s6 m2">
                  <input  id="member_houseNumber" type="text" readonly >
                  <label for="member_houseNumber">Number</label>
                </div>
                <div class="input-field col s6 m2">
                  <input  id="member_bus" type="number" readonly >
                  <label for="member_bus">Bus</label>
                </div>
                <button style="float: right" data-target="memberWrite" class="btn-small waves-light modal-trigger" onclick="setSelectedMember(selectedMemberId, selectedMemberObject,editMode)">Edit<i class="material-icons right">edit</i></button>
              </form>
              </div>
              <div class="col s12 m4">
                  <h6>Owner of:</h6>
                  <p id="member_ownerOf"> </p>
              </div>
              <div class="col s12 m4">
                  <h6>Occupant of:</h6>
                  <p id="member_occupantOf"> </p>
              </div>
            </div>
            <div class="modal-footer">
              <a class="modal-close waves-light btn-small"><i class="material-icons right">cancel</i>Close</a>
            </div>
          </div>

          <div id="meterWrite" class="modal">
            <div class="modal-content">
              <a style="float: right" class="modal-close waves-light btn-small"><i class="material-icons right">cancel</i> Cancel</a>
              <form class="col s12">
                <div class="input-field col s12 m4">
                  <i class="material-icons prefix">account_circle</i>
                  <input id="member_firstName_edit" type="text" class="validate" maxlength="50" required aria-required="true">
                  <label for="member_firstName_edit" >First Name<b><font color='red'>*</font></b></label>
                  <span class="helper-text" data-error="required field" ></span>
                </div>
                <div class="input-field col s12 m8">
                  <i class="material-icons prefix">account_circle</i>
                  <input id="member_lastName_edit" type="text" class="validate" maxlength="50" required aria-required="true">
                  <label for="member_lastName_edit" >Last Name <b><font color='red'>*</font></b></label>
                  <span class="helper-text" data-error="required field" ></span>
                </div>
                <div class="input-field col s12">
                  <input id="member_email_edit" type="email" class="validate" maxlength="70" >
                  <label for="member_email_edit" >Email</label>
                  <span class="helper-text" data-error="email must contain @" ></span>
                </div>
                <div class="input-field col s12 m6">
                  <i class="material-icons prefix">phone</i>
                  <input id="member_phoneHome_edit" type="tel" pattern="[+]?([0-9]|[ ])*" class="validate">
                  <label for="member_phoneHome_edit">Telephone Home</label>
                  <span class="helper-text" data-error="only + , digits and spaces allowed" ></span>
                </div>
                <div class="input-field col s12 m6">
                  <i class="material-icons prefix">phone</i>
                  <input id="member_phoneMobile_edit" type="tel" pattern="[+]?([0-9]|[ ])*" class="validate">
                  <label for="member_phoneMobile_edit">Mobile</label>
                  <span class="helper-text" data-error="only + , digits and spaces allowed" ></span>
                </div>
                <p> Principal residence (only to be completed if not in co-property)</p>
                <div class="input-field col s12 m4">
                  <input  id="member_country_edit" type="text" class="validate" maxlength="30" >
                  <label for="member_country_edit" >Country</label>
                </div>
                <div class="input-field col s6 m2">
                  <input  id="member_zip_edit" type="number" class="validate" min="0" max="99999">
                  <label for="member_zip_edit" >Zip</label>
                  <span class="helper-text" data-error="please enter digits only" ></span>
                </div>
                <div class="input-field col s6 m6">
                  <input  id="member_town_edit" type="text" class="validate" maxlength="30" >
                  <label for="member_town_edit">Town</label>
                </div>
                <div class="input-field col s12 m8">
                  <input  id="member_street_edit" type="text" class="validate" maxlength="30" >
                  <label for="member_street_edit">Street</label>
                </div>
                <div class="input-field col s6 m2">
                  <input  id="member_houseNumber_edit" type="text" class="validate" maxlength="10" >
                  <label for="member_houseNumber_edit">Number</label>
                </div>
                <div class="input-field col s6 m2">
                  <input  id="member_bus_edit" type="number" class="validate" min="0" max="99" >
                  <label for="member_bus_edit">Bus</label>
                  <span class="helper-text" data-error="please enter digits only" ></span>
                </div>
              </form>
              <button style="float: right" class="btn-small waves-light" type="submit" onclick="writeMember()">Submit<i class="material-icons right">send</i></button>
                <a style="float: right" class="modal-close waves-light btn-small"><i class="material-icons right">cancel</i> Cancel</a>
            </div>
          </div>
        </div>

      </div>
    </main>
    <script>
      function showPasswordSet() {
      document.getElementById("loginPanel").setAttribute("class","displayHidden");
      document.getElementById("setPasswordPanel").setAttribute("class","displayBlock");
    };

    function validateLoginEntries() {
      var valid= true;
      if (!document.getElementById("login_email").checkValidity()) {
        M.toast({html:"Please enter your email"});
        valid=false;
      };
      if (!document.getElementById("login_password").checkValidity()) {
        M.toast({html:"Please enter your password"});
        valid=false;
      };
      return valid;
    };

    function openApplication() {
      document.getElementById("loginPanel").setAttribute("class","displayHidden");
      document.getElementById("applicationPanel").setAttribute("class","displayBlock");
    };
    
    function login(){
      if (validateLoginEntries()) {
        var email = document.getElementById("login_email").value;
        var password = document.getElementById("login_password").value;

        var docUserRef = firestore.collection("Users").doc(email);
        docUserRef.get().then(function(user){
          if (user.exists)  {
            firebase.auth().setPersistence(firebase.auth.Auth.Persistence.SESSION)
              .then(function() {
                  firebase.auth().signInWithEmailAndPassword(email, password)
                    .then(function(user){openApplication();
                    })
                    .catch(function(error) {
                      M.toast({html:"Invalid email or password"});
                    });
              })
              .catch (function(error) {
                M.toast({html:error.message + "...authentication server not accessible"});
              });  
          }
          else {
            M.toast({html:"Unknown email: Please contact your administartor"});
          };
        });
      };
    };

    function backToLogin() {
      document.getElementById("setPasswordPanel").setAttribute("class","displayHidden");
      document.getElementById("loginPanel").setAttribute("class","displayBlock"); 
    };
    function showLogin() {
      setTimeout(function(){}, 2000);  
      backToLogin();
    };
    
    function validatePasswordSetEntries() {
        var valid= true;
        if (!document.getElementById("passwordSet_email").checkValidity()) {
          M.toast({html:"Please enter your email"});
          valid=false;
        };
        return valid;
    };

      
    function passwordSet(){
      if (validatePasswordSetEntries()) {
        var email = document.getElementById("passwordSet_email").value;
            firebase.auth().sendPasswordResetEmail(email).then(function() {
                M.toast({html:"Please follow instructions sent by mail"});
                showLogin();
              }).catch(function(error) {
                M.toast({html:"Unknown email: Please contact your administrator"});
              });
      };
    };
    </script>
    <!--   Application scripts starts here -->
    <script>
      const options = {
        duration: 300,
        onShow: null,
        swipeable: false,
        responsiveThreshold: Infinity
    };
    var elems = document.querySelectorAll('select');
    var instances = M.FormSelect.init(elems); 

    const tabsContainer = document.querySelector(".tabs");
    M.Tabs.init(tabsContainer,options);
    elems = document.querySelectorAll('.datepicker');
    instances = M.Datepicker.init(elems);

    
    elems = document.querySelectorAll('.modal');
    instances = M.Modal.init(elems, {dismissible:false,preventScrolling:false});

    var refCoproperty = firestore.doc("CoProperties/OrncEBHp37pJYisfxf79");
    var refCopropertyFiles = fileStorageRef.child("OrncEBHp37pJYisfxf79");
    const editMode = "_edit";
        
    function emptyHTMLSet(set) {
      while(set.hasChildNodes()){
        set.removeChild(set.firstChild);
      };
    };

    elems = document.querySelectorAll('.sidenav');
    instances = M.Sidenav.init(elems);

    var collapsibleElem = document.querySelector('.collapsible');
    var collapsibleInstance = M.Collapsible.init(collapsibleElem);

    
    </script>

    <!--   Home scripts start here -->
    <script>
      function loadHome() {
        hideMenu();
        document.getElementById("logo-container").innerHTML = "MyCondos: Home";
      }
    </script>
    <!--   reports scripts start here -->
    <script>
      function loadReports() {
      hideMenu();
      document.getElementById("logo-container").innerHTML = "MyCondos: Reports";
    }
    </script>
    <!--   Transaction scripts start here -->
    <script>
      var totalAmount = 0;
          var transactionsTable = document.getElementById("transactionsTable");
          function loadTransaction (objectFS){
              var object = objectFS.data();
              var objectsRow= document.createElement('tr');
              
              var cellContent = document.createTextNode(object.name);
              var cell = document.createElement('td');
              var cellButtonIcon;
              cell.appendChild(cellContent);
              objectsRow.appendChild(cell);
              
              totalAmount = totalAmount + parseInt(object.amount);
              cellContent = document.createTextNode(object.amount);
              cell = document.createElement('td');
              cell.appendChild(cellContent);
              objectsRow.appendChild(cell);  
              
              cellContent = document.createTextNode(object.date);
              cell = document.createElement('td');
              cell.appendChild(cellContent);
              objectsRow.appendChild(cell); 
              
              cellContent = document.createTextNode(object.classification);
              cell = document.createElement('td');
              cell.appendChild(cellContent);
              objectsRow.appendChild(cell); 

              cellContent = document.createElement('button');
              cellContent.setAttribute("data-target", "modalTransactionClassify");
              cellContent.setAttribute('class','btn-small waves-light modal-trigger');
              cellContent.setAttribute('onclick','setSelectedTransaction('+JSON.stringify(objectFS.id)+','+JSON.stringify(object)+')');
              cellButtonIcon = document.createElement('i');
              cellButtonIcon.setAttribute('class','material-icons right');
              cellButtonIcon.innerHTML="add";           
              cellContent.appendChild(cellButtonIcon);
              cellContent.innerHTML = "Classify";


              cell = document.createElement('td');
              cell.appendChild(cellContent);
              objectsRow.appendChild(cell);    
              
              transactionsTable.appendChild (objectsRow);
            };
          
        function refreshTransactions(){
          emptyHTMLSet(transactionsTable);
          totalAmount = 0;
          refCoproperty.collection("Transactions").orderBy("date","desc").get().then(function(objectsFSArray){
              objectsFSArray.forEach(function(objectFS){
                loadTransaction(objectFS);
                document.getElementById("totalAmounts").innerHTML = "Total Amounts = " + totalAmount;
              })
            });
        };

        var transactionsLoaded = false;
        function loadTransactions(){
          hideMenu();
          document.getElementById("logo-container").innerHTML = "MyCondos: Transactions";
          if (!transactionsLoaded) {
            refreshTransactions();
            transactionsLoaded = true;
          };
        };

      function classifyTransaction() {
        if (validateTransactionEntries()) {  
            refCoproperty.collection("Transactions").doc(selectedTransactionId).set(getTransactionEntries())
          .then(function(docref) {
              M.Modal.getInstance(document.getElementById("modalTransactionClassify")).close();
              refreshTransactions();
          }).catch(function(error) {
            console.error("Error writing document: ", error);
          });
        };
      };
    function validateTransactionEntries() {
      var valid = true
      if (!document.getElementById("transaction_classification").checkValidity()) {
        M.toast({html:"Please enter classification"});
        valid=false;
      };
      return valid;
    };

    function getTransactionEntries() {
      return {
        account: document.getElementById("transaction_account").value,
        name: document.getElementById("transaction_name").value,
        amount: document.getElementById("transaction_amount").value,
        date: document.getElementById("transaction_date").value,
        communication:document.getElementById("transaction_communication").value,
        classification: document.getElementById("transaction_classification").value
      };
    };

    var selectedTransactionId;
    var selectedTransactionObject;
    function setSelectedTransaction(id,object) {
      selectedTransactionId = id;
      selectedTransactionObject = object;
    
      document.getElementById("transaction_account").value=object.account;
      document.getElementById("transaction_name").value=object.name;
      document.getElementById("transaction_amount").value=object.amount;
      document.getElementById("transaction_date").value=object.date;
      document.getElementById("transaction_communication").value=object.communication;
      document.getElementById("transaction_classification").value=object.classification;
      var elems = document.querySelectorAll('select');
      M.FormSelect.init(elems);
      M.updateTextFields();
      elems = document.querySelectorAll('.modal');
      instances = M.Modal.init(elems, {dismissible:false});
    };
    </script>
    <!--   Meters scripts start here -->
    <script>
      var meterMode;
      var selectedMeterId;
      var selectedMeterObject;
      var selectedMeterPhotoURL;
      function setSelectedMeter(propertyCode, id,object,modeArg) {
        selectedMeterId=id;
        selectedMeterObject=object;
        meterMode="edit";
        document.getElementById("meter_type"+modeArg).value=object.type;
        document.getElementById("meter_date"+modeArg).value=object.date;
        document.getElementById("meter_reading"+modeArg).value=object.reading;
        var el;
        if (modeArg) {
          // in edit mode
          emptyHTMLSet(document.getElementById("meter_photo_text_edit"));
          if (selectedMeterPhotoURL) {
            el = document.createElement("a");
            el.setAttribute("href",selectedMeterPhotoURL);
            el.setAttribute("target","_blank"); 
            el.innerHTML = "<font color='blue'>EXISTING PHOTO</font> can be replaced here below";
            document.getElementById("meter_photo_text_edit").appendChild(el);
          };
          listProperties (document.getElementById("meter_property"+modeArg), object.property, object.meter);
        } else {
          // in view mode        
          document.getElementById("meter_meter"+modeArg).value=object.meter;
          document.getElementById("meter_property"+modeArg).value=propertyCode;
          emptyHTMLSet(document.getElementById("meter_photo"));
          
          refCopropertyFiles.child(object.property).child("Meters").child(id).getDownloadURL().then(function(url) {
            el = document.createElement("a");
            el.setAttribute("href",url);
            el.setAttribute("target","_blank"); 
            el.innerHTML = "<font color='blue'>PHOTO</font>";
            document.getElementById("meter_photo").appendChild(el);
            selectedMeterPhotoURL = url;
          }).catch(function(error) {
            el = document.createElement("p");
            el.innerHTML = "No photo available";
            document.getElementById("meter_photo").appendChild(el);
          });
          
        };
        M.updateTextFields();
        var elems = document.querySelectorAll('select');
        M.FormSelect.init(elems);
      };
      
      var meterFile;

      function getMeterEntries() {
        return {
          property: document.getElementById("meter_property_edit").value,
          meter: document.getElementById("meter_meter_edit").value,
          type: document.getElementById("meter_type_edit").value,
          date:document.getElementById("meter_date_edit").value,
          reading: document.getElementById("meter_reading_edit").value
        };
      };

      function validateMeterEntries() {
        var valid = true
        if (!(document.getElementById("meter_property_edit").value)) {
          M.toast({html:"Please enter Property"});
          valid=false;
        };
        if (!(document.getElementById("meter_meter_edit").value)) {
          M.toast({html:"Please enter Meter"});
          valid=false;
        };
        if (!document.getElementById("meter_date_edit").checkValidity()) {
          M.toast({html:"Please enter valid Date"});
          valid=false;
        };
        if (!document.getElementById("meter_reading_edit").checkValidity()) {
          M.toast({html:"Please enter valid Reading"});
          valid=false;
        };

        meterFile = document.getElementById('meterFile').files[0];
        let allowed_mime_types = [ 'image/jpeg', 'image/png' ];
        let allowed_size_kb = 500;
        if (meterFile) {
          if(allowed_mime_types.indexOf(meterFile.type) == -1) {
            M.toast({html:"Incorrect file type (only jpeg or png allowed)"});
            valid=false;
          };
          if(meterFile.size > allowed_size_kb*1024) {
            M.toast({html:"Photo exceeds max size 500KB"});
            valid=false;
          };

        }
        return valid;
      };

      var metersMatrix = new Map();
      function listProperties(el, selectedOption, selectedMeter) {
        var option;
        emptyHTMLSet(el);
        if (!Boolean(selectedOption)) {
          option = document.createElement("option");
          option.setAttribute("value","");
          option.setAttribute("disabled",true);
          option.setAttribute("selected",true);
          option.innerHTML = "Select Property";
          el.appendChild(option);
        };
        refCoproperty.collection("Properties").get().then(function(querySnapshot) {
          querySnapshot.forEach(function(property) {
              option = document.createElement("option");
              option.setAttribute("value",property.id);
              propertyData = property.data();
              if (property.id == selectedOption) {
                option.setAttribute("selected",true);
                //  meters invullen!!!!!!!!!!!!!!
              };
              option.innerHTML = propertyData.code;
              el.appendChild(option);
              var meters= new Set();
              if (propertyData.meterColdWater) {meters.add({type:"cold water",meter:propertyData.meterColdWater})};
              if (propertyData.meterHotWater) {meters.add({type:"hot water",meter:propertyData.meterHotWater})};
              if (propertyData.meterHeating) {meters.add({type:"heating",meter:propertyData.meterHeating})};
              metersMatrix.set(property.id,meters);
            });
          if (selectedMeter) {listMeters(selectedMeter)};
          var elems = document.querySelectorAll('select');
          M.FormSelect.init(elems);
        });
      };

      function listMeters(selectedOption){
        var el = document.getElementById("meter_meter_edit");
        emptyHTMLSet(el);
        if (!Boolean(selectedOption)) {
          option = document.createElement("option");
          option.setAttribute("value","");
          option.setAttribute("disabled",true);
          option.setAttribute("selected",true);
          option.innerHTML = "Select Meter";
          el.appendChild(option);
        };
        
        metersMatrix.get(document.getElementById("meter_property_edit").value).forEach(function(meterCouple){
          option = document.createElement("option");
          option.setAttribute("value",meterCouple.meter);
          option.innerHTML = meterCouple.meter + "  " + meterCouple.type;
          el.appendChild(option);
        });
        var elems = document.querySelectorAll('select');
        M.FormSelect.init(elems);
      };

      function editType() {
        var property = document.getElementById("meter_property_edit").value;
        var meter = document.getElementById("meter_meter_edit").value;
        metersMatrix.get(document.getElementById("meter_property_edit").value).forEach(function(meterCouple){
          if (meterCouple.meter === meter) {document.getElementById("meter_type_edit").value = meterCouple.type }
        });
      };

      function resetSelectedMeter() {
        selectedMeterId=null;
        selectedMeterObject=null;
        selectedMeterPhotoURL=null;
        meterFile=null;
        meterMode="add";
        document.getElementById("meter_property_edit").value="";
        document.getElementById("meter_meter_edit").value="";
        document.getElementById("meter_type_edit").value="";
        document.getElementById("meter_date_edit").value="";
        document.getElementById("meter_reading_edit").value="";
        document.getElementById("meterFile").value="";
        document.getElementById("meterFileText").value="";
        emptyHTMLSet(document.getElementById("meter_photo_text_edit"));
        listProperties(document.getElementById("meter_property_edit"),"",null);
        M.updateTextFields();
        M.FormSelect.init(document.querySelectorAll('select'));
      };
    </script>
    <!--   Members scripts start here -->
    <script>
        function getMemberEntries() {
      return {
            firstName: document.getElementById("member_firstName_edit").value,
            lastName: document.getElementById("member_lastName_edit").value,
            email: document.getElementById("member_email_edit").value,
            phoneHome: document.getElementById("member_phoneHome_edit").value,
            phoneMobile: document.getElementById("member_phoneMobile_edit").value,
            country: document.getElementById("member_country_edit").value,
            zip: document.getElementById("member_zip_edit").value,
            town: document.getElementById("member_town_edit").value,
            street: document.getElementById("member_street_edit").value,
            houseNumber: document.getElementById("member_houseNumber_edit").value,
            bus: document.getElementById("member_bus_edit").value
      };
    };
    
    function propertyJump (propertyId, propertyObject){
      
      M.Modal.getInstance(document.getElementById("memberView")).close();
      setSelectedProperty(propertyId,propertyObject,"");
    };

    
    function propertyLinkFromMemberView(property) {
      var elA = document.createElement('a');
      elA.setAttribute("data-target", "propertyView");
      elA.setAttribute('class','btn-flat modal-trigger');
      elA.setAttribute('onclick','propertyJump('+JSON.stringify(property.id)+','+JSON.stringify(property.data())+')');
      elA.innerHTML = "<font color='blue'>"+property.data().code+"</font>"+ "  ";
      return elA;
    };

    
    
    var mode;
    var selectedMemberId;
    var selectedMemberObject;
    function setSelectedMember(id,object,modeArg) {
      selectedMemberId=id;
      selectedMemberObject=object;
      mode="edit";
      document.getElementById("member_firstName"+modeArg).value=object.firstName;
      document.getElementById("member_lastName"+modeArg).value=object.lastName;
      document.getElementById("member_email"+modeArg).value=object.email;
      document.getElementById("member_phoneHome"+modeArg).value=object.phoneHome;
      document.getElementById("member_phoneMobile"+modeArg).value=object.phoneMobile;
      document.getElementById("member_country"+modeArg).value=object.country;
      document.getElementById("member_zip"+modeArg).value=object.zip;
      document.getElementById("member_town"+modeArg).value=object.town;
      document.getElementById("member_street"+modeArg).value=object.street;
      document.getElementById("member_houseNumber"+modeArg).value=object.houseNumber;
      document.getElementById("member_bus"+modeArg).value=object.bus;
      if (!modeArg) {
        var ownerOfEl = document.getElementById("member_ownerOf");
        emptyHTMLSet(ownerOfEl);
        refCoproperty.collection("Properties").where("owner", "==", id).get().then (function (querySnapshot){
          querySnapshot.forEach (function (property) {
            ownerOfEl.appendChild(propertyLinkFromMemberView(property));
          });
        });
        var occupantOfEl = document.getElementById("member_occupantOf");
        emptyHTMLSet(occupantOfEl);
        refCoproperty.collection("Properties").get().then (function (querySnapshotProperties){
          querySnapshotProperties.forEach (function (property) {
            property.ref.collection("Occupants").where("occupant", "==", id).get().then (function (querySnapshotOccupants){
              if (querySnapshotOccupants.docs.length > 0) {
                occupantOfEl.appendChild(propertyLinkFromMemberView(property));
              };
            });
          });
        });
      };
      M.updateTextFields();
    };

    function resetSelectedMember() {
      selectedMemberId=null;
      selectedMemberObject=null;
      mode="add";
      document.getElementById("member_firstName_edit").value="";
      document.getElementById("member_lastName_edit").value="";
      document.getElementById("member_email_edit").value="";
      document.getElementById("member_phoneHome_edit").value="";
      document.getElementById("member_phoneMobile_edit").value="";
      document.getElementById("member_country_edit").value="";
      document.getElementById("member_zip_edit").value="";
      document.getElementById("member_town_edit").value="";
      document.getElementById("member_street_edit").value="";
      document.getElementById("member_houseNumber_edit").value="";
      document.getElementById("member_bus_edit").value="";
      M.updateTextFields();
    };


    </script>
</body>

</html>